---
phase: "02.1-testing-infrastructure"
plan: "01"
subsystem: "testing"
tags: ["vitest", "msw", "pglite", "testing", "coverage"]
depends:
  requires: ["01-foundation", "02-core-slack"]
  provides: ["test-infrastructure", "msw-handlers", "pglite-helpers"]
  affects: ["02.1-02", "02.1-03", "all-future-tests"]
tech-stack:
  added: ["vitest", "@vitest/coverage-v8", "@vitest/ui", "msw", "@electric-sql/pglite", "supertest"]
  patterns: ["setupFiles for global test setup", "MSW request interception", "PGlite in-memory database"]
key-files:
  created:
    - "apps/slack-backend/vitest.config.ts"
    - "apps/slack-backend/test/setup.ts"
    - "apps/slack-backend/test/helpers/db.ts"
    - "apps/slack-backend/test/helpers/mocks.ts"
    - "packages/database/vitest.config.ts"
    - "packages/database/test/setup.ts"
  modified:
    - "package.json"
    - "apps/slack-backend/package.json"
    - "packages/database/package.json"
    - "packages/database/src/encryption.test.ts"
decisions:
  - id: "vitest-v3"
    choice: "Vitest 3.x with v8 coverage provider"
    rationale: "Latest stable, excellent monorepo support, fast execution"
  - id: "msw-v2"
    choice: "MSW 2.7 for HTTP mocking"
    rationale: "Industry standard, supports both Node and browser, clean handler API"
  - id: "pglite-memory"
    choice: "PGlite for in-memory PostgreSQL"
    rationale: "Real PostgreSQL semantics without Docker, instant startup, isolated tests"
  - id: "coverage-thresholds"
    choice: "90% for slack-backend, 85% for database"
    rationale: "High bar for services with handlers, slightly lower for schema-focused package"
metrics:
  duration: "6 min"
  completed: "2026-01-26"
---

# Phase 2.1 Plan 01: Testing Infrastructure Summary

Vitest with MSW for API mocking and PGlite for in-memory PostgreSQL testing.

## What Was Built

### 1. Vitest Configuration (Task 1)

Installed and configured Vitest across the monorepo:

- **Root workspace:** vitest, @vitest/coverage-v8, @vitest/ui
- **slack-backend:** Full test suite with MSW and PGlite
- **database package:** Schema and query testing with PGlite

Coverage thresholds set:
- slack-backend: 90% lines/functions/statements, 85% branches
- database: 85% lines/functions/statements, 80% branches

### 2. MSW API Mocking (Task 2)

Created comprehensive mock handlers for:

**Anthropic Claude API:**
- POST /v1/messages - Returns mock AI suggestion response

**Slack API Endpoints:**
- chat.postEphemeral - Ephemeral message delivery
- conversations.history - Channel message history
- conversations.replies - Thread replies
- users.info - User profile lookup
- auth.test - Bot authentication verification
- views.open / views.update - Modal interactions
- chat.postMessage / chat.update / chat.delete - Message management

Mock data factories created:
- `createMockSlackMessage()` - Slack message objects
- `createMockSlackEvent()` - Event payloads
- `createMockInstallation()` - OAuth installation records
- `createMockWorkspace()` - Workspace records
- `createMockContextMessage()` - AI context messages
- `createMockThreadContext()` - Thread conversation arrays
- `createMockAppMentionEvent()` - @mention events
- `createMockMessageShortcut()` - Message action payloads
- `createMockSlackUser()` - User profile objects

Consistent test IDs: T123 (team), U123/U456/U789 (users), C123 (channel), B123 (bot)

### 3. PGlite Database Helpers (Task 3)

In-memory PostgreSQL for isolated test execution:

- `setupTestDb()` - Initialize fresh PGlite with schema
- `cleanupTestDb()` - Release resources
- `getTestDb()` - Get Drizzle instance
- `getPGlite()` - Get raw PGlite for SQL
- `clearAllTables()` - Reset between tests
- `seedWorkspace()` - Quick workspace+installation creation

Schema mirrors production exactly: workspaces, installations, users, watched_conversations, thread_participants with all indexes.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Converted legacy encryption.test.ts to Vitest syntax**
- **Found during:** Task 1 verification
- **Issue:** Existing test file used `process.exit()` which crashes Vitest
- **Fix:** Rewrote as proper Vitest describe/it blocks with expect assertions
- **Files modified:** packages/database/src/encryption.test.ts
- **Commit:** 7b62200

## Test Results

```
npm run test -- --run

 RUN  v3.2.4
 âœ“ packages/database/src/encryption.test.ts (7 tests) 3ms
 Test Files  1 passed (1)
      Tests  7 passed (7)
```

Coverage configuration verified:
```
npm run test:coverage -- --run
Coverage enabled with v8
```

## Files Changed

| File | Change | Purpose |
|------|--------|---------|
| package.json | Modified | Added vitest, coverage, UI dependencies and scripts |
| apps/slack-backend/package.json | Modified | Added vitest, MSW, PGlite, supertest dependencies |
| packages/database/package.json | Modified | Added vitest, PGlite dependencies |
| apps/slack-backend/vitest.config.ts | Created | Vitest config with 90% coverage thresholds |
| apps/slack-backend/test/setup.ts | Created | MSW server with Anthropic and Slack handlers |
| apps/slack-backend/test/helpers/mocks.ts | Created | Mock data factory functions |
| apps/slack-backend/test/helpers/db.ts | Created | PGlite database helpers |
| packages/database/vitest.config.ts | Created | Vitest config with 85% coverage thresholds |
| packages/database/test/setup.ts | Created | PGlite setup for database package |
| packages/database/src/encryption.test.ts | Modified | Converted to Vitest syntax |

## Verification Checklist

- [x] `npm run test -- --run` executes without errors
- [x] `npm run test:coverage -- --run` shows coverage configuration working
- [x] MSW handlers configured for Anthropic and Slack APIs
- [x] PGlite helpers create in-memory database matching production schema
- [x] Coverage thresholds set at 90% for services, 85% for database
- [x] Test scripts added to all package.json files

## Next Steps

Ready for:
- 02.1-02: Security and AI service unit tests
- 02.1-03: Handler integration tests

All test infrastructure is now in place. Tests can import from:
- `../test/setup` for MSW server
- `../test/helpers/mocks` for mock factories
- `../test/helpers/db` for PGlite helpers
