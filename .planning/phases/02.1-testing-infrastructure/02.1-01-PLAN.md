---
phase: 02.1-testing-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/slack-backend/vitest.config.ts
  - apps/slack-backend/test/setup.ts
  - apps/slack-backend/test/helpers/db.ts
  - apps/slack-backend/test/helpers/mocks.ts
  - apps/slack-backend/package.json
  - packages/database/vitest.config.ts
  - packages/database/test/setup.ts
  - packages/database/package.json
  - package.json
autonomous: true

must_haves:
  truths:
    - "npm run test runs without errors"
    - "MSW intercepts HTTP requests to Slack and Anthropic APIs"
    - "PGlite provides in-memory PostgreSQL for tests"
    - "Test setup automatically loads before each test file"
  artifacts:
    - path: "apps/slack-backend/vitest.config.ts"
      provides: "Vitest configuration with coverage thresholds"
      contains: "coverage"
    - path: "apps/slack-backend/test/setup.ts"
      provides: "MSW server setup for API mocking"
      contains: "setupServer"
    - path: "apps/slack-backend/test/helpers/db.ts"
      provides: "PGlite database helpers"
      contains: "PGlite"
    - path: "apps/slack-backend/test/helpers/mocks.ts"
      provides: "Shared mock data factories"
      contains: "mock"
  key_links:
    - from: "apps/slack-backend/vitest.config.ts"
      to: "apps/slack-backend/test/setup.ts"
      via: "setupFiles"
      pattern: "setupFiles.*test/setup"
    - from: "apps/slack-backend/test/setup.ts"
      to: "msw/node"
      via: "import setupServer"
      pattern: "import.*setupServer.*from.*msw/node"
---

<objective>
Set up Vitest testing infrastructure with MSW for API mocking and PGlite for database testing.

Purpose: Foundation for all tests - without this, no unit, integration, or E2E tests can run
Output: Working test runner with MSW handlers for Slack/Anthropic APIs and PGlite database helpers
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.1-testing-infrastructure/02.1-RESEARCH.md
@apps/slack-backend/package.json
@packages/database/package.json
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Vitest dependencies and configure root/workspace</name>
  <files>
    - package.json
    - apps/slack-backend/package.json
    - packages/database/package.json
    - apps/slack-backend/vitest.config.ts
    - packages/database/vitest.config.ts
  </files>
  <action>
Install test dependencies in root and workspaces:

**Root package.json:**
- Add devDependencies: `vitest`, `@vitest/coverage-v8`, `@vitest/ui`
- Add scripts: `"test": "vitest"`, `"test:coverage": "vitest run --coverage"`, `"test:ui": "vitest --ui"`

**apps/slack-backend/package.json:**
- Add devDependencies: `vitest`, `@vitest/coverage-v8`, `msw`, `@electric-sql/pglite`, `supertest`, `@types/supertest`, `@testcontainers/postgresql` (for Redis tests)
- Add scripts: `"test": "vitest"`, `"test:coverage": "vitest run --coverage"`

**packages/database/package.json:**
- Add devDependencies: `vitest`, `@vitest/coverage-v8`, `@electric-sql/pglite`
- Add scripts: `"test": "vitest"`, `"test:coverage": "vitest run --coverage"`

**apps/slack-backend/vitest.config.ts:**
Create with:
- `name: 'slack-backend'`
- `environment: 'node'`
- `setupFiles: ['./test/setup.ts']`
- `coverage.provider: 'v8'`
- `coverage.thresholds: { lines: 90, functions: 90, branches: 85, statements: 90 }`
- `coverage.exclude: ['test/**', '**/*.test.ts', 'src/routes/test.ts']`
- `include: ['src/**/*.test.ts', 'test/**/*.test.ts']`

**packages/database/vitest.config.ts:**
Create with:
- `name: 'database'`
- `environment: 'node'`
- `setupFiles: ['./test/setup.ts']`
- `coverage.provider: 'v8'`
- `coverage.thresholds: { lines: 85, functions: 85, branches: 80, statements: 85 }`

Run: `npm install` to install all dependencies
  </action>
  <verify>
`npm run test -- --run` executes (may show no tests yet, but no config errors)
`cat apps/slack-backend/vitest.config.ts` shows coverage thresholds
  </verify>
  <done>
Vitest installed in all workspaces with coverage thresholds configured
  </done>
</task>

<task type="auto">
  <name>Task 2: Create MSW setup and API mock handlers</name>
  <files>
    - apps/slack-backend/test/setup.ts
    - apps/slack-backend/test/helpers/mocks.ts
  </files>
  <action>
**apps/slack-backend/test/setup.ts:**
Create MSW server setup with handlers for:

1. Anthropic Claude API (`https://api.anthropic.com/v1/messages`):
   - POST returns mock response: `{ id: 'msg_test', type: 'message', role: 'assistant', content: [{ type: 'text', text: 'Mocked AI suggestion' }], model: 'claude-sonnet-4-20250514', stop_reason: 'end_turn', usage: { input_tokens: 100, output_tokens: 50 } }`

2. Slack API handlers:
   - `https://slack.com/api/chat.postEphemeral` - returns `{ ok: true, message_ts: '1234567890.123456' }`
   - `https://slack.com/api/conversations.history` - returns mock messages array
   - `https://slack.com/api/conversations.replies` - returns mock thread replies
   - `https://slack.com/api/users.info` - returns mock user info
   - `https://slack.com/api/auth.test` - returns `{ ok: true, team_id: 'T123', user_id: 'U123', bot_id: 'B123' }`
   - `https://slack.com/api/views.open` - returns `{ ok: true, view: { id: 'V123' } }`
   - `https://slack.com/api/views.update` - returns `{ ok: true, view: { id: 'V123' } }`

Include:
- `beforeAll(() => server.listen({ onUnhandledRequest: 'warn' }))`
- `afterEach(() => server.resetHandlers())`
- `afterAll(() => server.close())`

Export `server` and `handlers` for use in tests.

Also set env vars:
- `process.env.SLACK_SKIP_SIGNATURE_VERIFICATION = 'true'`
- `process.env.NODE_ENV = 'test'`

**apps/slack-backend/test/helpers/mocks.ts:**
Create mock data factories:
- `createMockSlackMessage({ user, text, ts, channel, threadTs })`
- `createMockSlackEvent({ type, user, channel, ts, text, threadTs })`
- `createMockInstallation({ teamId, botToken, botUserId })`
- `createMockWorkspace({ teamId, name })`
- `createMockContextMessage({ userId, text, ts })`

Use consistent test IDs: `T123` for team, `U123` for user, `C123` for channel, `B123` for bot
  </action>
  <verify>
`cat apps/slack-backend/test/setup.ts` shows MSW setupServer with Anthropic and Slack handlers
`cat apps/slack-backend/test/helpers/mocks.ts` shows factory functions
  </verify>
  <done>
MSW server configured with all necessary Slack and Anthropic API mock handlers
Mock data factories ready for test use
  </done>
</task>

<task type="auto">
  <name>Task 3: Create PGlite database helpers</name>
  <files>
    - apps/slack-backend/test/helpers/db.ts
    - packages/database/test/setup.ts
  </files>
  <action>
**apps/slack-backend/test/helpers/db.ts:**
Create PGlite helpers for integration tests:

```typescript
import { PGlite } from '@electric-sql/pglite';
import { drizzle } from 'drizzle-orm/pglite';
import * as schema from '@slack-speak/database';

let pgLite: PGlite | null = null;
let testDb: ReturnType<typeof drizzle> | null = null;

export async function setupTestDb() {
  pgLite = new PGlite();
  testDb = drizzle(pgLite, { schema });

  // Create tables manually (push schema)
  await pgLite.exec(`
    CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

    CREATE TABLE workspaces (
      id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
      team_id TEXT NOT NULL UNIQUE,
      enterprise_id TEXT,
      name TEXT,
      created_at TIMESTAMP DEFAULT NOW(),
      updated_at TIMESTAMP DEFAULT NOW()
    );

    CREATE TABLE installations (
      id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
      workspace_id UUID NOT NULL REFERENCES workspaces(id),
      bot_token TEXT NOT NULL,
      bot_user_id TEXT,
      bot_scopes TEXT,
      user_token TEXT,
      user_id TEXT,
      user_scopes TEXT,
      installed_at TIMESTAMP DEFAULT NOW()
    );

    CREATE TABLE watched_conversations (
      id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
      workspace_id UUID NOT NULL REFERENCES workspaces(id),
      user_id TEXT NOT NULL,
      channel_id TEXT NOT NULL,
      watched_at TIMESTAMP DEFAULT NOW()
    );
    CREATE UNIQUE INDEX watched_unique ON watched_conversations(workspace_id, user_id, channel_id);

    CREATE TABLE thread_participants (
      id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
      workspace_id UUID NOT NULL REFERENCES workspaces(id),
      user_id TEXT NOT NULL,
      channel_id TEXT NOT NULL,
      thread_ts TEXT NOT NULL,
      last_message_at TIMESTAMP DEFAULT NOW()
    );
    CREATE UNIQUE INDEX thread_unique ON thread_participants(workspace_id, user_id, channel_id, thread_ts);
  `);

  return testDb;
}

export async function cleanupTestDb() {
  if (pgLite) {
    await pgLite.close();
    pgLite = null;
    testDb = null;
  }
}

export function getTestDb() {
  if (!testDb) throw new Error('Test DB not initialized');
  return testDb;
}
```

**packages/database/test/setup.ts:**
Create minimal setup for database package tests:
- Export same PGlite helpers pattern
- Simpler since this package tests schema, not services
  </action>
  <verify>
`cat apps/slack-backend/test/helpers/db.ts` shows PGlite setup with schema creation
`cat packages/database/test/setup.ts` exists
  </verify>
  <done>
PGlite helpers provide in-memory PostgreSQL for isolated test execution
Schema matches production database structure
  </done>
</task>

</tasks>

<verification>
Run these commands to verify test infrastructure:

1. `npm run test -- --run` - Should execute without errors (even if no tests exist yet)
2. `npm run test:coverage -- --run` - Should show coverage configuration is working
3. Check MSW server starts: Import and verify server.listen() works
</verification>

<success_criteria>
- Vitest runs in all workspaces without configuration errors
- MSW handlers configured for Anthropic and Slack APIs
- PGlite helpers create in-memory database matching production schema
- Coverage thresholds set at 90% for services/handlers, 85% for database
- Test scripts added to all package.json files
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-testing-infrastructure/02.1-01-SUMMARY.md`
</output>
