---
phase: 02.1-testing-infrastructure
plan: 09
type: execute
wave: 2
depends_on: ["02.1-01"]
files_modified:
  - apps/slack-backend/src/routes/test.ts
  - apps/slack-backend/src/app.ts
autonomous: true

must_haves:
  truths:
    - "Testing page accessible at /test in non-production"
    - "Testing page can simulate app_mention events"
    - "Testing page can simulate message events"
    - "Testing page can test AI generation directly"
    - "Testing page is protected from production access"
  artifacts:
    - path: "apps/slack-backend/src/routes/test.ts"
      provides: "Manual testing UI and API endpoints"
      min_lines: 200
  key_links:
    - from: "apps/slack-backend/src/routes/test.ts"
      to: "services/ai.ts"
      via: "generateSuggestion import"
      pattern: "generateSuggestion"
    - from: "apps/slack-backend/src/app.ts"
      to: "routes/test.ts"
      via: "router registration"
      pattern: "testRouter|/test"
---

<objective>
Create a manual testing UI at /test for debugging and demonstrating functionality without Slack.

Purpose: Enable manual testing, debugging, and demos without needing full Slack integration
Output: HTML page with forms to trigger handlers and test AI directly
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02.1-testing-infrastructure/02.1-RESEARCH.md
@apps/slack-backend/src/app.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create testing routes and UI</name>
  <files>
    - apps/slack-backend/src/routes/test.ts
  </files>
  <action>
Create Express router with HTML UI and API endpoints for manual testing.

**Routes to implement:**

`GET /test` - Serve HTML testing page

`POST /api/test/app-mention` - Simulate app_mention event
- Accepts: { user, channel, text, threadTs? }
- Calls handler logic directly (bypass Bolt)
- Returns: Job ID or error

`POST /api/test/message` - Simulate message event
- Accepts: { user, channel, text, threadTs? }
- Calls message handler logic
- Returns: Result or error

`POST /api/test/ai` - Test AI generation directly
- Accepts: { context, prompt, triggeredBy }
- Calls generateSuggestion directly
- Returns: { suggestion, processingTimeMs }

`POST /api/test/refine` - Test AI refinement
- Accepts: { originalSuggestion, refinementRequest, history? }
- Calls refineSuggestion directly
- Returns: { suggestion, processingTimeMs }

`GET /api/test/watches/:teamId/:userId` - List watches for user
- Returns: Array of channel IDs

`POST /api/test/watch` - Add watch
- Accepts: { teamId, userId, channelId }
- Calls watchConversation

`DELETE /api/test/watch` - Remove watch
- Accepts: { teamId, userId, channelId }
- Calls unwatchConversation

**HTML UI:**

```html
<!DOCTYPE html>
<html>
<head>
  <title>Slack App Testing</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; max-width: 1200px; margin: 50px auto; padding: 20px; }
    h1 { color: #1264A3; }
    .warning { background: #FFF3CD; border: 1px solid #FFE69C; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .test-section { margin: 30px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
    .test-section h2 { margin-top: 0; color: #333; }
    input, textarea { width: 100%; padding: 10px; margin: 5px 0 15px 0; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
    textarea { height: 100px; font-family: monospace; }
    button { padding: 12px 24px; background: #1264A3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin-right: 10px; }
    button:hover { background: #0D4F7E; }
    button.secondary { background: #6c757d; }
    .result { background: #f8f9fa; padding: 15px; margin-top: 15px; border-radius: 4px; white-space: pre-wrap; font-family: monospace; font-size: 13px; max-height: 300px; overflow-y: auto; }
    .result.error { background: #F8D7DA; color: #842029; }
    .result.success { background: #D1E7DD; color: #0F5132; }
    label { font-weight: 600; color: #555; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
  </style>
</head>
<body>
  <h1>Slack Speak for Me - Testing Interface</h1>

  <div class="warning">
    <strong>Development Only:</strong> This page is only available in non-production environments.
    It allows testing handlers and AI without connecting to Slack.
  </div>

  <div class="test-section">
    <h2>Test app_mention Event</h2>
    <p>Simulate a user mentioning the bot in a channel.</p>
    <div class="grid">
      <div>
        <label>User ID</label>
        <input type="text" id="mention-user" placeholder="U123" value="U123" />
      </div>
      <div>
        <label>Channel ID</label>
        <input type="text" id="mention-channel" placeholder="C456" value="C456" />
      </div>
    </div>
    <label>Thread TS (optional)</label>
    <input type="text" id="mention-thread" placeholder="1234567890.000001" />
    <label>Message Text</label>
    <textarea id="mention-text" placeholder="@bot help me respond to this difficult email">@bot Can you help me draft a response to this customer complaint?</textarea>
    <button onclick="testAppMention()">Send app_mention</button>
    <div id="mention-result" class="result" style="display:none"></div>
  </div>

  <div class="test-section">
    <h2>Test Message Event</h2>
    <p>Simulate a message in a channel/thread to test reply detection.</p>
    <div class="grid">
      <div>
        <label>User ID</label>
        <input type="text" id="msg-user" placeholder="U456" value="U456" />
      </div>
      <div>
        <label>Channel ID</label>
        <input type="text" id="msg-channel" placeholder="C456" value="C456" />
      </div>
    </div>
    <label>Thread TS (for thread replies)</label>
    <input type="text" id="msg-thread" placeholder="1234567890.000001" value="1234567890.000001" />
    <label>Message Text</label>
    <textarea id="msg-text">This is a reply in the thread that might trigger a suggestion.</textarea>
    <button onclick="testMessage()">Send Message Event</button>
    <div id="msg-result" class="result" style="display:none"></div>
  </div>

  <div class="test-section">
    <h2>Test AI Generation Directly</h2>
    <p>Call the AI service directly without going through Slack events.</p>
    <label>Context (previous messages)</label>
    <textarea id="ai-context" placeholder="Previous conversation context...">Customer: I've been waiting 3 weeks for my order and no one has responded to my emails.
Support: We apologize for the delay. Let me look into this immediately.</textarea>
    <label>Trigger Message</label>
    <textarea id="ai-trigger" placeholder="The message to respond to...">This is unacceptable. I want a full refund and I'm reporting this to the BBB.</textarea>
    <label>Trigger Type</label>
    <select id="ai-trigger-type" style="width: 100%; padding: 10px; margin: 5px 0 15px 0;">
      <option value="mention">Mention</option>
      <option value="reply">Reply</option>
      <option value="thread">Thread</option>
      <option value="message_action">Message Action</option>
    </select>
    <button onclick="testAI()">Generate Suggestion</button>
    <div id="ai-result" class="result" style="display:none"></div>
  </div>

  <div class="test-section">
    <h2>Test AI Refinement</h2>
    <p>Refine an existing suggestion with additional instructions.</p>
    <label>Original Suggestion</label>
    <textarea id="refine-original">I understand your frustration and apologize for the delay in processing your order.</textarea>
    <label>Refinement Request</label>
    <textarea id="refine-request" style="height: 60px;">Make it more empathetic and offer compensation</textarea>
    <button onclick="testRefine()">Refine Suggestion</button>
    <div id="refine-result" class="result" style="display:none"></div>
  </div>

  <div class="test-section">
    <h2>Manage Watches</h2>
    <p>View and manage watched conversations for a user.</p>
    <div class="grid">
      <div>
        <label>Team ID</label>
        <input type="text" id="watch-team" placeholder="T123" value="T123" />
      </div>
      <div>
        <label>User ID</label>
        <input type="text" id="watch-user" placeholder="U123" value="U123" />
      </div>
    </div>
    <label>Channel ID</label>
    <input type="text" id="watch-channel" placeholder="C456" value="C456" />
    <button onclick="addWatch()">Add Watch</button>
    <button onclick="removeWatch()" class="secondary">Remove Watch</button>
    <button onclick="listWatches()" class="secondary">List Watches</button>
    <div id="watch-result" class="result" style="display:none"></div>
  </div>

  <script>
    function showResult(elementId, data, isError = false) {
      const el = document.getElementById(elementId);
      el.style.display = 'block';
      el.className = 'result ' + (isError ? 'error' : 'success');
      el.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
    }

    async function testAppMention() {
      const result = await fetch('/api/test/app-mention', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          user: document.getElementById('mention-user').value,
          channel: document.getElementById('mention-channel').value,
          text: document.getElementById('mention-text').value,
          threadTs: document.getElementById('mention-thread').value || undefined,
        }),
      }).then(r => r.json());
      showResult('mention-result', result, !result.success);
    }

    async function testMessage() {
      const result = await fetch('/api/test/message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          user: document.getElementById('msg-user').value,
          channel: document.getElementById('msg-channel').value,
          text: document.getElementById('msg-text').value,
          threadTs: document.getElementById('msg-thread').value || undefined,
        }),
      }).then(r => r.json());
      showResult('msg-result', result, !result.success);
    }

    async function testAI() {
      showResult('ai-result', 'Generating suggestion...', false);
      const result = await fetch('/api/test/ai', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          context: document.getElementById('ai-context').value,
          trigger: document.getElementById('ai-trigger').value,
          triggeredBy: document.getElementById('ai-trigger-type').value,
        }),
      }).then(r => r.json());
      showResult('ai-result', result, !result.success);
    }

    async function testRefine() {
      showResult('refine-result', 'Refining suggestion...', false);
      const result = await fetch('/api/test/refine', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          originalSuggestion: document.getElementById('refine-original').value,
          refinementRequest: document.getElementById('refine-request').value,
        }),
      }).then(r => r.json());
      showResult('refine-result', result, !result.success);
    }

    async function addWatch() {
      const result = await fetch('/api/test/watch', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          teamId: document.getElementById('watch-team').value,
          userId: document.getElementById('watch-user').value,
          channelId: document.getElementById('watch-channel').value,
        }),
      }).then(r => r.json());
      showResult('watch-result', result, !result.success);
    }

    async function removeWatch() {
      const result = await fetch('/api/test/watch', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          teamId: document.getElementById('watch-team').value,
          userId: document.getElementById('watch-user').value,
          channelId: document.getElementById('watch-channel').value,
        }),
      }).then(r => r.json());
      showResult('watch-result', result, !result.success);
    }

    async function listWatches() {
      const teamId = document.getElementById('watch-team').value;
      const userId = document.getElementById('watch-user').value;
      const result = await fetch(`/api/test/watches/${teamId}/${userId}`).then(r => r.json());
      showResult('watch-result', result, !result.success);
    }
  </script>
</body>
</html>
```

**Security:** Gate all routes behind environment check:
```typescript
if (process.env.NODE_ENV === 'production') {
  router.use((req, res) => {
    res.status(403).json({ error: 'Test routes disabled in production' });
  });
}
```
  </action>
  <verify>
Start dev server: `npm run dev`
Visit http://localhost:3000/test
Verify UI loads with all test sections
Test AI generation directly - should return suggestion
  </verify>
  <done>
Testing routes and UI created with all required test endpoints
  </done>
</task>

<task type="auto">
  <name>Task 2: Register test routes in app</name>
  <files>apps/slack-backend/src/app.ts</files>
  <action>
Update app.ts to register the test routes:

1. Import the test router
2. Register routes only in non-production:

```typescript
import testRouter from './routes/test.js';

// After Bolt app setup but before starting server
if (process.env.NODE_ENV !== 'production') {
  // Get the Express app from Bolt receiver
  const expressApp = receiver.app;

  // Register test routes
  expressApp.use(testRouter);

  console.log('Test routes enabled at /test');
}
```

Note: Need to ensure the receiver exposes the Express app. With Bolt's ExpressReceiver, this is `receiver.app`.
  </action>
  <verify>
`npm run dev` starts without errors
`curl http://localhost:3000/test` returns HTML
`curl http://localhost:3000/api/test/watches/T123/U123` returns JSON
  </verify>
  <done>
Test routes registered and accessible in development
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Manual testing page at /test for debugging without Slack</what-built>
  <how-to-verify>
1. Start the dev server: `npm run dev` (in apps/slack-backend)
2. Open http://localhost:3000/test in browser
3. Verify the testing UI loads with all sections:
   - Test app_mention Event
   - Test Message Event
   - Test AI Generation Directly
   - Test AI Refinement
   - Manage Watches
4. Test AI generation:
   - Keep default context and trigger text
   - Click "Generate Suggestion"
   - Verify suggestion is generated (may take a few seconds)
5. Test watch management:
   - Click "Add Watch"
   - Click "List Watches" - should show the channel
   - Click "Remove Watch"
   - Click "List Watches" - should be empty
  </how-to-verify>
  <resume-signal>Type "approved" if testing page works, or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. Dev server starts without errors
2. /test page loads in browser
3. AI generation works directly via UI
4. Watch management works via UI
5. Route is not accessible when NODE_ENV=production
</verification>

<success_criteria>
- Testing page serves at /test
- All test endpoints functional (/api/test/*)
- AI generation testable without Slack
- Watch/unwatch testable without Slack
- Page protected from production access
- UI is clean and usable
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-testing-infrastructure/02.1-09-SUMMARY.md`
</output>
