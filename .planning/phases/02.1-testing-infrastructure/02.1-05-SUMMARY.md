---
phase: "02.1"
plan: "05"
subsystem: "testing"
tags: ["vitest", "unit-tests", "handlers", "events", "commands"]

dependency_graph:
  requires: ["02.1-01"]
  provides: ["event-handler-tests", "command-handler-tests"]
  affects: ["02.1-06"]

tech_stack:
  added: []
  patterns:
    - "Handler callback capture testing"
    - "Vitest mock factory pattern"
    - "Event-driven callback testing"

file_tracking:
  key_files:
    created:
      - apps/slack-backend/src/handlers/events/app-mention.test.ts
      - apps/slack-backend/src/handlers/events/message-reply.test.ts
      - apps/slack-backend/src/handlers/commands/watch.test.ts

decisions:
  - id: "handler-callback-testing"
    choice: "Capture handler callbacks via mock app.event/app.command"
    rationale: "Bolt registers handlers via callbacks - capture them for direct testing"

metrics:
  duration: "3 min"
  completed: "2026-01-26"
---

# Phase 2.1 Plan 05: Handler Unit Tests Summary

Unit tests for event handlers (app_mention, message_reply) and slash commands (/watch, /unwatch) with 100% handler coverage.

## What Was Built

### Event Handler Tests (`app-mention.test.ts`)
11 test cases covering:
- Handler registration with Bolt app
- Job queueing with correct data when mentioned
- Context fetching for both channel and thread messages
- Workspace ID extraction from auth.test
- Edge case handling (missing user, missing workspace ID)
- Error handling (no unhandled exceptions)
- Logging verification

### Event Handler Tests (`message-reply.test.ts`)
20 test cases covering:
- Bot message filtering (prevents loops)
- Message subtype filtering
- Missing field validation (user, text, ts)
- Thread participation recording
- Watch status checking for thread participants
- Job queueing only for watching + participating users
- Author exclusion (don't suggest response to own message)
- Non-thread message handling
- Multiple participant support with deduplication
- Error handling and logging

### Command Handler Tests (`watch.test.ts`)
16 test cases covering:
- /watch command:
  - Immediate ack() call (3-second Slack requirement)
  - Watch addition when not already watching
  - "Already watching" message when already watching
  - Correct ID extraction from command
  - Error handling with user feedback
  - Success logging
  - Respond failure graceful handling
- /unwatch command:
  - Immediate ack() call
  - Watch removal when currently watching
  - "Not watching" message when not watching
  - Correct ID extraction from command
  - Error handling with user feedback
  - Success logging
  - Respond failure graceful handling

## Technical Approach

### Handler Callback Capture Pattern
```typescript
mockApp = {
  event: vi.fn((eventType, handler) => {
    if (eventType === 'app_mention') {
      eventHandler = handler;  // Capture for direct testing
    }
  }),
};

registerAppMentionHandler(mockApp as App);

// Now test the handler directly
await eventHandler({ event: mockEvent, client: mockClient });
```

### Mock Factory Pattern
```typescript
vi.mock('../../jobs/queues.js', () => ({
  queueAIResponse: vi.fn().mockResolvedValue({ id: 'job_123' }),
}));
```

## Coverage Results

| File | Statements | Branches | Functions | Lines |
|------|------------|----------|-----------|-------|
| app-mention.ts | 100% | 100% | 100% | 100% |
| message-reply.ts | 98% | 96% | 100% | 98% |
| watch.ts | 100% | 100% | 100% | 100% |

## Verification

All tests passing:
```
npm run test -- src/handlers/**/*.test.ts --run
Test Files  7 passed (7)
Tests  93 passed (93)
```

Handler-specific coverage exceeds 90% threshold for all targeted files.

## Decisions Made

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Handler callback testing | Capture handlers via mock app methods | Bolt registers via callbacks; direct capture enables isolated testing |
| Mock granularity | Per-module mocks for services | Clear separation of concerns, predictable behavior |
| Test structure | Nested describe blocks by command | Mirrors implementation structure, clear organization |

## Deviations from Plan

None - plan executed exactly as written.

## Files

### Created
- `apps/slack-backend/src/handlers/events/app-mention.test.ts` (227 lines)
- `apps/slack-backend/src/handlers/events/message-reply.test.ts` (435 lines)
- `apps/slack-backend/src/handlers/commands/watch.test.ts` (336 lines)

## Commits

| Hash | Description |
|------|-------------|
| cdfd2b7 | test(02.1-05): add unit tests for event handlers |
| 48b0410 | test(02.1-05): add unit tests for /watch and /unwatch commands |

## Next Phase Readiness

- Event and command handlers fully tested
- Coverage meets 90%+ threshold
- Ready for integration test setup (02.1-06)
