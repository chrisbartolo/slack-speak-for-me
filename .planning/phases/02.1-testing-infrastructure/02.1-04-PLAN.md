---
phase: 02.1-testing-infrastructure
plan: 04
type: execute
wave: 2
depends_on: ["02.1-01"]
files_modified:
  - apps/slack-backend/src/oauth/installation-store.test.ts
autonomous: true

must_haves:
  truths:
    - "Installation store tests verify token encryption/decryption"
    - "Store, fetch, and delete operations tested with database"
    - "Error cases handled for missing installations"
  artifacts:
    - path: "apps/slack-backend/src/oauth/installation-store.test.ts"
      provides: "Unit tests for OAuth installation storage"
      min_lines: 80
  key_links:
    - from: "apps/slack-backend/src/oauth/installation-store.test.ts"
      to: "test/helpers/db.ts"
      via: "PGlite database"
      pattern: "setupTestDb"
---

<objective>
Create unit tests for OAuth installation store with token encryption/decryption.

Purpose: Verify OAuth tokens are correctly encrypted before storage and decrypted on retrieval
Output: Unit tests achieving 90%+ coverage for installation-store.ts
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/slack-backend/src/oauth/installation-store.ts
@packages/database/src/encryption.ts
@apps/slack-backend/test/helpers/db.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unit tests for installation store (installation-store.ts)</name>
  <files>apps/slack-backend/src/oauth/installation-store.test.ts</files>
  <action>
Create comprehensive unit tests for the installation store. Need to:
1. Mock database operations or use PGlite
2. Mock encryption key retrieval
3. Test encrypt/decrypt cycle

**Test storeInstallation:**
1. `should store new installation with encrypted bot token`
   - Create Installation object with bot.token
   - Call storeInstallation
   - Query database, verify bot_token is not plaintext
   - Decrypt stored token, verify matches original

2. `should encrypt user token when provided`
   - Include user.token in installation
   - Verify user_token stored encrypted

3. `should create workspace on first installation`
   - Store installation for new team
   - Verify workspace record created with teamId and name

4. `should update workspace on reinstallation`
   - Store installation, then store again with different name
   - Verify workspace updated (not duplicate)

5. `should update installation on reinstall (upsert)`
   - Store installation, then store with new token
   - Verify only one installation, with new token

6. `should throw when neither teamId nor enterpriseId provided`
   - Call with installation missing both
   - Expect error

7. `should handle enterprise installation`
   - Include enterpriseId in installation
   - Verify stored correctly

**Test fetchInstallation:**
1. `should fetch and decrypt bot token`
   - Store installation
   - Fetch it back
   - Verify bot.token matches original (decrypted)

2. `should fetch and decrypt user token when present`
   - Store with user token
   - Fetch, verify user.token matches

3. `should return workspace team/enterprise info`
   - Verify team.id and team.name populated
   - Verify enterprise.id when applicable

4. `should throw when installation not found`
   - Query for non-existent teamId
   - Expect "Installation not found" error

5. `should throw when neither teamId nor enterpriseId in query`
   - Call with empty query
   - Expect error

6. `should handle enterprise query correctly`
   - Store enterprise installation
   - Fetch with enterpriseId
   - Verify found

**Test deleteInstallation:**
1. `should delete installation for workspace`
   - Store installation
   - Delete it
   - Verify fetch throws "not found"

2. `should handle delete of non-existent installation (no-op)`
   - Delete non-existent installation
   - Should not throw

3. `should only delete installation, not workspace`
   - Store installation
   - Delete installation
   - Verify workspace still exists (if checking)

**Encryption verification:**
- Use a known encryption key for tests
- Verify encrypted token != plaintext
- Verify decrypt(encrypt(x)) === x

Structure:
```typescript
import { describe, it, expect, beforeEach, afterEach, vi } from 'vitest';
import type { Installation, InstallationQuery } from '@slack/bolt';
import { installationStore } from './installation-store';
import { setupTestDb, cleanupTestDb, getTestDb } from '../../test/helpers/db';

// Mock env to provide encryption key
vi.mock('../env.js', () => ({
  getEncryptionKey: () => Buffer.from('0'.repeat(64), 'hex'), // 32-byte key
  env: {
    ANTHROPIC_API_KEY: 'test-key',
  },
}));

describe('Installation Store', () => {
  beforeEach(async () => {
    await setupTestDb();
  });

  afterEach(async () => {
    await cleanupTestDb();
  });

  describe('storeInstallation', () => {
    it('should store installation with encrypted bot token', async () => {
      const installation: Installation = {
        team: { id: 'T123', name: 'Test Team' },
        bot: {
          token: 'xoxb-secret-token',
          userId: 'B123',
          scopes: ['chat:write', 'commands'],
          id: 'B123',
        },
        user: { id: 'U123', scopes: [] },
      };

      await installationStore.storeInstallation(installation);

      // Fetch back and verify
      const fetched = await installationStore.fetchInstallation({
        teamId: 'T123',
        isEnterpriseInstall: false,
      });

      expect(fetched.bot?.token).toBe('xoxb-secret-token');
      expect(fetched.team?.id).toBe('T123');
    });
    // ... more tests
  });

  describe('fetchInstallation', () => {
    // ... tests
  });

  describe('deleteInstallation', () => {
    // ... tests
  });
});
```

**Important:** The installation store uses imported db from @slack-speak/database. You'll need to either:
1. Mock the entire database module
2. Configure the test database to be used by the actual code

Consider creating a test-specific setup that overrides the db connection.
  </action>
  <verify>
`npm run test -- src/oauth/installation-store.test.ts --run` passes all tests
`npm run test:coverage -- src/oauth/installation-store.test.ts --run` shows >90% coverage
  </verify>
  <done>
Installation store has comprehensive tests verifying:
- Token encryption on store
- Token decryption on fetch
- Workspace upsert behavior
- Error handling for missing data
  </done>
</task>

</tasks>

<verification>
Run installation store tests:
1. `npm run test -- src/oauth/*.test.ts --run`
2. `npm run test:coverage -- src/oauth/*.test.ts --run`

Verify encryption/decryption cycle works correctly.
</verification>

<success_criteria>
- installation-store.test.ts has 15+ test cases
- Store, fetch, delete operations all tested
- Encryption verified (stored token != plaintext)
- Decryption verified (fetched token == original)
- Error cases tested (missing installation, invalid query)
- Coverage exceeds 90% for installation-store.ts
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-testing-infrastructure/02.1-04-SUMMARY.md`
</output>
