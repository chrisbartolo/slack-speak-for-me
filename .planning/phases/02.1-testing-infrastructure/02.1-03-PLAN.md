---
phase: 02.1-testing-infrastructure
plan: 03
type: execute
wave: 2
depends_on: ["02.1-01"]
files_modified:
  - apps/slack-backend/src/services/context.test.ts
  - apps/slack-backend/src/services/suggestion-delivery.test.ts
autonomous: true

must_haves:
  truths:
    - "Context service tests verify Slack API calls are rate limited"
    - "Context service tests cover thread vs channel context selection"
    - "Suggestion delivery tests verify Block Kit structure"
  artifacts:
    - path: "apps/slack-backend/src/services/context.test.ts"
      provides: "Unit tests for context retrieval functions"
      min_lines: 80
    - path: "apps/slack-backend/src/services/suggestion-delivery.test.ts"
      provides: "Unit tests for Block Kit message building"
      min_lines: 60
  key_links:
    - from: "apps/slack-backend/src/services/context.test.ts"
      to: "test/setup.ts"
      via: "MSW Slack API mocks"
      pattern: "conversations\\.history|conversations\\.replies"
---

<objective>
Create unit tests for context retrieval service and suggestion delivery service.

Purpose: Verify Slack API integration works correctly with rate limiting and Block Kit message formatting
Output: Unit tests achieving 90%+ coverage for context.ts and suggestion-delivery.ts
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/slack-backend/src/services/context.ts
@apps/slack-backend/src/services/suggestion-delivery.ts
@apps/slack-backend/test/setup.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unit tests for context service (context.ts)</name>
  <files>apps/slack-backend/src/services/context.test.ts</files>
  <action>
Create unit tests for context retrieval functions. Need to mock WebClient.

**Setup:**
Create a mock WebClient that the tests will pass to the context functions:
```typescript
const mockClient = {
  conversations: {
    history: vi.fn(),
    replies: vi.fn(),
  },
} as unknown as WebClient;
```

**Test getConversationContext:**
1. `should fetch channel history and return formatted messages`
   - Mock conversations.history to return messages
   - Verify returns array of ContextMessage with userId, text, ts
   - Verify messages are in chronological order (reversed)

2. `should filter out bot messages`
   - Include bot messages in mock response (bot_id field)
   - Verify they're excluded from result

3. `should respect maxMessages option`
   - Pass maxMessages: 5
   - Verify API called with limit: 5

4. `should respect contextWindowMinutes option`
   - Pass contextWindowMinutes: 30
   - Verify API called with oldest timestamp ~30 mins ago

5. `should return empty array on API failure`
   - Mock API to return { ok: false, error: 'channel_not_found' }
   - Verify returns []

6. `should handle empty messages array`
   - Mock API to return empty messages
   - Verify returns []

**Test getThreadContext:**
1. `should fetch thread replies and return formatted messages`
   - Mock conversations.replies
   - Verify returns thread messages

2. `should filter out bot messages in thread`

3. `should maintain chronological order (no reverse needed)`

4. `should return empty array on API failure`

**Test getContextForMessage:**
1. `should use thread context when threadTs differs from messageTs`
   - Call with threadTs different from messageTs
   - Verify conversations.replies called (not history)

2. `should check if message is thread parent`
   - Call without threadTs
   - Should call conversations.replies to check for replies
   - If replies exist (length > 1), use thread context

3. `should fall back to channel context for non-thread messages`
   - Mock replies to return single message (just parent)
   - Verify falls back to conversations.history

4. `should handle replies check failure gracefully`
   - Mock replies to throw
   - Verify falls back to channel context

Structure:
```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { WebClient } from '@slack/web-api';
import {
  getConversationContext,
  getThreadContext,
  getContextForMessage,
} from './context';

describe('Context Service', () => {
  let mockClient: WebClient;

  beforeEach(() => {
    mockClient = {
      conversations: {
        history: vi.fn().mockResolvedValue({
          ok: true,
          messages: [
            { type: 'message', user: 'U123', text: 'Hello', ts: '1234567890.000001' },
            { type: 'message', user: 'U456', text: 'World', ts: '1234567891.000002' },
          ],
        }),
        replies: vi.fn().mockResolvedValue({
          ok: true,
          messages: [
            { type: 'message', user: 'U123', text: 'Thread start', ts: '1234567890.000001' },
            { type: 'message', user: 'U456', text: 'Reply', ts: '1234567891.000002' },
          ],
        }),
      },
    } as unknown as WebClient;
  });

  describe('getConversationContext', () => {
    it('should fetch and format channel messages', async () => {
      const result = await getConversationContext(mockClient, 'C123');

      expect(mockClient.conversations.history).toHaveBeenCalledWith(
        expect.objectContaining({ channel: 'C123' })
      );
      expect(result).toHaveLength(2);
      expect(result[0].userId).toBe('U456'); // Reversed order
    });
    // ... more tests
  });
});
```
  </action>
  <verify>
`npm run test -- src/services/context.test.ts --run` passes all tests
`npm run test:coverage -- src/services/context.test.ts --run` shows >90% coverage
  </verify>
  <done>
Context service has comprehensive tests for all retrieval scenarios and edge cases
  </done>
</task>

<task type="auto">
  <name>Task 2: Unit tests for suggestion delivery service (suggestion-delivery.ts)</name>
  <files>apps/slack-backend/src/services/suggestion-delivery.test.ts</files>
  <action>
Create unit tests for Block Kit message building and delivery.

**Test buildSuggestionBlocks:**
1. `should include header with suggestion title`
   - Verify first block is header type
   - Verify text includes "Suggested Response"

2. `should include context label for mention trigger`
   - Call with triggerContext: 'mention'
   - Verify context block text includes "someone mentioned you"

3. `should include context label for reply trigger`
   - Call with triggerContext: 'reply'
   - Verify context block includes "someone replied to you"

4. `should include context label for thread trigger`
   - Call with triggerContext: 'thread'
   - Verify context block includes "new activity in a thread"

5. `should include context label for message_action trigger`
   - Call with triggerContext: 'message_action'
   - Verify context block includes "you requested"

6. `should include suggestion text in section block`
   - Pass suggestion text
   - Verify section block contains the suggestion

7. `should include Copy, Refine, and Dismiss buttons`
   - Verify actions block has 3 buttons
   - Verify action_ids: 'copy_suggestion', 'refine_suggestion', 'dismiss_suggestion'
   - Verify Copy button is primary style

8. `should include suggestionId in button values`
   - Pass suggestionId
   - Verify all buttons have value set to suggestionId

**Test sendSuggestionEphemeral:**
1. `should call chat.postEphemeral with correct parameters`
   - Mock WebClient
   - Call sendSuggestionEphemeral
   - Verify client.chat.postEphemeral called with channel, user, text, blocks

2. `should pass built blocks to API`
   - Verify blocks array is passed to postEphemeral

3. `should handle API errors`
   - Mock postEphemeral to throw
   - Verify error propagates

Structure:
```typescript
import { describe, it, expect, vi, beforeEach } from 'vitest';
import { WebClient } from '@slack/web-api';
import {
  buildSuggestionBlocks,
  sendSuggestionEphemeral,
} from './suggestion-delivery';

describe('Suggestion Delivery Service', () => {
  describe('buildSuggestionBlocks', () => {
    it('should build valid Block Kit structure', () => {
      const blocks = buildSuggestionBlocks('sug_123', 'Test suggestion', 'mention');

      expect(blocks).toHaveLength(6); // header, context, divider, section, actions, context
      expect(blocks[0].type).toBe('header');
      expect(blocks[4].type).toBe('actions');
    });

    it('should include correct trigger context for mention', () => {
      const blocks = buildSuggestionBlocks('sug_123', 'Test', 'mention');
      const contextBlock = blocks.find(b => b.type === 'context');

      expect(JSON.stringify(contextBlock)).toContain('mentioned you');
    });
    // ... more tests
  });

  describe('sendSuggestionEphemeral', () => {
    let mockClient: WebClient;

    beforeEach(() => {
      mockClient = {
        chat: {
          postEphemeral: vi.fn().mockResolvedValue({ ok: true }),
        },
      } as unknown as WebClient;
    });

    it('should send ephemeral message to correct user and channel', async () => {
      await sendSuggestionEphemeral({
        client: mockClient,
        channelId: 'C123',
        userId: 'U456',
        suggestionId: 'sug_789',
        suggestion: 'Test suggestion',
        triggerContext: 'mention',
      });

      expect(mockClient.chat.postEphemeral).toHaveBeenCalledWith(
        expect.objectContaining({
          channel: 'C123',
          user: 'U456',
        })
      );
    });
    // ... more tests
  });
});
```
  </action>
  <verify>
`npm run test -- src/services/suggestion-delivery.test.ts --run` passes all tests
`npm run test:coverage -- src/services/suggestion-delivery.test.ts --run` shows >90% coverage
  </verify>
  <done>
Suggestion delivery service has comprehensive tests for Block Kit building and ephemeral delivery
  </done>
</task>

</tasks>

<verification>
Run all service tests:
1. `npm run test -- src/services/*.test.ts --run`
2. `npm run test:coverage -- src/services/*.test.ts --run`

All services should have >90% coverage.
</verification>

<success_criteria>
- context.test.ts has 12+ test cases covering all context retrieval scenarios
- suggestion-delivery.test.ts has 10+ test cases covering Block Kit and delivery
- Rate limiting behavior is not blocked in tests (limiter allows requests)
- All trigger context types tested (mention, reply, thread, message_action)
- Coverage exceeds 90% for both services
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-testing-infrastructure/02.1-03-SUMMARY.md`
</output>
