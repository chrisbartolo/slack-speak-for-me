---
phase: 16-response-time-analytics
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - apps/slack-backend/src/services/suggestion-metrics.ts
autonomous: true

must_haves:
  truths:
    - "Each pipeline stage has a dedicated recording function that never throws"
    - "All recording functions use upsert (onConflictDoUpdate) so stages can be recorded independently"
    - "Metrics recording failures are logged as warnings but never block the suggestion pipeline"
    - "organizationId is resolved and denormalized at the first recording call"
  artifacts:
    - path: "apps/slack-backend/src/services/suggestion-metrics.ts"
      provides: "Fire-and-forget recording functions for all 6 pipeline stages plus error/action tracking"
      exports: ["generateSuggestionId", "recordEventReceived", "recordJobQueued", "recordAIStarted", "recordAICompleted", "recordDelivered", "recordUserAction", "recordError"]
  key_links:
    - from: "apps/slack-backend/src/services/suggestion-metrics.ts"
      to: "packages/database/src/schema.ts"
      via: "import suggestionMetrics"
      pattern: "import.*suggestionMetrics"
    - from: "apps/slack-backend/src/services/suggestion-metrics.ts"
      to: "workspaces table"
      via: "lookup organizationId from workspaceId"
      pattern: "workspaces.*organizationId"
---

<objective>
Create the suggestion-metrics service with fire-and-forget recording functions for each pipeline stage.

Purpose: This service provides the recording API that handlers, workers, and services call at each stage of the suggestion pipeline. It must never block or break the suggestion path.
Output: `suggestion-metrics.ts` with exported functions for all 6 stages plus ID generation, error tracking, and user action recording.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@packages/database/src/schema.ts
@apps/slack-backend/src/services/feedback-tracker.ts
@.planning/phases/16-response-time-analytics/16-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create suggestion-metrics.ts service</name>
  <files>apps/slack-backend/src/services/suggestion-metrics.ts</files>
  <action>
Create `apps/slack-backend/src/services/suggestion-metrics.ts` with these functions:

1. **`generateSuggestionId()`** — Returns a unique string ID: `sug_${Date.now()}_${Math.random().toString(36).slice(2, 9)}`. This replaces the inline ID generation currently in workers.ts.

2. **`resolveOrganizationId(workspaceId: string)`** — Internal helper (not exported). Queries workspaces table for organizationId by workspace UUID. Caches results in a simple Map with 5-minute TTL to avoid repeated lookups. Returns `string | null`.

3. **`recordEventReceived(params)`** — Records initial event with INSERT + onConflictDoUpdate on suggestionId. Params: `{ suggestionId, workspaceId, userId, channelId?, triggerType? }`. Resolves and stores organizationId. Sets `eventReceivedAt: new Date()`.

4. **`recordJobQueued(params)`** — Upserts jobQueuedAt. Params: `{ suggestionId, jobQueuedAt?: Date }`. Default to `new Date()`.

5. **`recordAIStarted(params)`** — Upserts aiStartedAt. Params: `{ suggestionId }`.

6. **`recordAICompleted(params)`** — Upserts aiCompletedAt and computes aiProcessingMs from aiStartedAt if available. Params: `{ suggestionId, aiProcessingMs?: number }`. If aiProcessingMs is provided directly (from generateSuggestion return value), use it. Otherwise, query existing record for aiStartedAt and compute.

7. **`recordDelivered(params)`** — Upserts deliveredAt and computes totalDurationMs and queueDelayMs. Params: `{ suggestionId }`. Query existing record for eventReceivedAt and jobQueuedAt to compute durations.

8. **`recordUserAction(params)`** — Upserts userActionAt and userAction. Params: `{ suggestionId, action: 'accepted' | 'refined' | 'dismissed' | 'sent' | 'liked' | 'disliked' }`.

9. **`recordError(params)`** — Upserts errorType. Params: `{ suggestionId, errorType: 'usage_limit' | 'guardrail' | 'ai_error' | 'delivery_error' }`.

**Critical patterns to follow:**

- Every function wraps its body in try/catch. On error, call `logger.warn({ error, suggestionId }, 'Failed to record [stage] - non-fatal')`. NEVER throw.
- Use `db.insert(suggestionMetrics).values({...}).onConflictDoUpdate({ target: [suggestionMetrics.suggestionId], set: {...} })` for all recording.
- For computed durations in recordDelivered and recordAICompleted, do a SELECT first to get the prior timestamps, then compute. If prior timestamps are missing, skip duration computation (set to null).
- Import from `@slack-speak/database`: `db, suggestionMetrics, workspaces`.
- Import `eq` from `drizzle-orm`.
- Import `logger` from `../utils/logger.js`.

**organizationId caching pattern:**
```typescript
const orgCache = new Map<string, { orgId: string | null; expiry: number }>();
const CACHE_TTL = 5 * 60 * 1000; // 5 minutes

async function resolveOrganizationId(workspaceId: string): Promise<string | null> {
  const cached = orgCache.get(workspaceId);
  if (cached && cached.expiry > Date.now()) return cached.orgId;

  try {
    const [ws] = await db.select({ organizationId: workspaces.organizationId })
      .from(workspaces).where(eq(workspaces.id, workspaceId)).limit(1);
    const orgId = ws?.organizationId ?? null;
    orgCache.set(workspaceId, { orgId, expiry: Date.now() + CACHE_TTL });
    return orgId;
  } catch {
    return null;
  }
}
```
  </action>
  <verify>
TypeScript compiles:
```bash
cd apps/slack-backend && npx tsc --noEmit
```
Verify all exports:
```bash
grep "export.*function\|export.*async" apps/slack-backend/src/services/suggestion-metrics.ts
```
Should show: generateSuggestionId, recordEventReceived, recordJobQueued, recordAIStarted, recordAICompleted, recordDelivered, recordUserAction, recordError
  </verify>
  <done>
suggestion-metrics.ts exists with 8 exported functions, all using fire-and-forget pattern with try/catch + logger.warn. Every function uses upsert on suggestionId. organizationId resolved and cached. TypeScript compiles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Export from services index</name>
  <files>apps/slack-backend/src/services/index.ts</files>
  <action>
Add the re-export to the services index file:
```typescript
export { generateSuggestionId, recordEventReceived, recordJobQueued, recordAIStarted, recordAICompleted, recordDelivered, recordUserAction, recordError } from './suggestion-metrics.js';
```

Place this alongside the existing exports. This makes the functions available to workers and handlers via the barrel export.
  </action>
  <verify>
```bash
grep "suggestion-metrics" apps/slack-backend/src/services/index.ts
```
  </verify>
  <done>
suggestion-metrics functions are re-exported from the services barrel file.
  </done>
</task>

</tasks>

<verification>
1. `suggestion-metrics.ts` exists with 8 exported functions
2. All functions have try/catch with logger.warn (never throw)
3. All functions use onConflictDoUpdate upsert pattern
4. organizationId is resolved via cached lookup
5. Computed durations (totalDurationMs, aiProcessingMs, queueDelayMs) are calculated when recording delivery/completion
6. Functions are re-exported from services/index.ts
7. TypeScript compiles without errors
</verification>

<success_criteria>
- suggestion-metrics.ts provides fire-and-forget recording for all 6 pipeline stages
- No function can throw an error that would break the suggestion pipeline
- organizationId denormalization happens automatically
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/16-response-time-analytics/16-02-SUMMARY.md`
</output>
