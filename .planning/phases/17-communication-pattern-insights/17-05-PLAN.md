---
phase: 17-communication-pattern-insights
plan: 05
type: execute
wave: 4
depends_on: ["17-04"]
files_modified:
  - apps/web-portal/app/admin/communication-insights/page.tsx
  - apps/web-portal/components/admin/communication-insights-charts.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view topic distribution as a stacked area chart over time"
    - "Admin can view sentiment trend as a line chart over time"
    - "Admin can see channel hotspots table with complaint rate and risk score"
    - "Admin can see week-over-week comparison with percent change indicators"
    - "Admin can see escalation summary with severity breakdown"
    - "Dashboard shows meaningful empty states when no data is available"
    - "Page is admin-gated via requireAdmin()"
  artifacts:
    - path: "apps/web-portal/app/admin/communication-insights/page.tsx"
      provides: "Communication insights dashboard page"
      min_lines: 80
    - path: "apps/web-portal/components/admin/communication-insights-charts.tsx"
      provides: "Tremor chart components for communication insights"
      exports: ["TopicTrendChart", "SentimentTrendChart", "ChannelHotspotTable", "WeekOverWeekCards", "EscalationSummaryCard"]
  key_links:
    - from: "apps/web-portal/app/admin/communication-insights/page.tsx"
      to: "apps/web-portal/lib/admin/communication-insights.ts"
      via: "imports and calls all 6 query functions"
      pattern: "getTopicOverview|getTopicTrend|getSentimentTrend|getChannelHotspots|getWeekOverWeek|getEscalationSummary"
    - from: "apps/web-portal/app/admin/communication-insights/page.tsx"
      to: "apps/web-portal/components/admin/communication-insights-charts.tsx"
      via: "renders chart components with data props"
      pattern: "TopicTrendChart|SentimentTrendChart|ChannelHotspotTable"
---

<objective>
Build the admin communication insights dashboard page with Tremor charts and data visualizations.

Purpose: Give admins a visual overview of communication patterns — topic distribution, sentiment trends, channel hotspots, period comparisons, and escalation activity — to identify problem areas before they escalate.

Output: Dashboard page at /admin/communication-insights with chart components.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@apps/web-portal/app/admin/response-times/page.tsx
@apps/web-portal/components/admin/response-time-charts.tsx
@apps/web-portal/lib/admin/communication-insights.ts
@.planning/phases/17-communication-pattern-insights/17-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create chart components for communication insights</name>
  <files>apps/web-portal/components/admin/communication-insights-charts.tsx</files>
  <action>
Create `apps/web-portal/components/admin/communication-insights-charts.tsx` as a 'use client' component file following the `response-time-charts.tsx` pattern:

1. Imports:
```typescript
'use client';

import { Card, AreaChart, LineChart } from '@tremor/react';
import type {
  TopicTrendPoint,
  SentimentTrendPoint,
  ChannelHotspot,
  PeriodComparison,
  EscalationSummary,
} from '@/lib/admin/communication-insights';
```

2. `TopicTrendChart` component:
   - Props: `{ data: TopicTrendPoint[] }`
   - Renders Tremor AreaChart (stacked) with:
     - index: "date"
     - categories: ['complaint', 'escalation', 'technical', 'request', 'scheduling', 'status_update', 'general'] (ordered by severity)
     - colors: ['red', 'orange', 'blue', 'green', 'indigo', 'purple', 'gray']
     - stack={true}, showAnimation, className="mt-4 h-72"
   - Wrapped in Card with heading "Topic Distribution Over Time" and description "Daily message count by topic category"

3. `SentimentTrendChart` component:
   - Props: `{ data: SentimentTrendPoint[] }`
   - Renders Tremor LineChart with:
     - index: "date"
     - categories: ['angry', 'frustrated', 'tense', 'neutral', 'positive'] (ordered by severity)
     - colors: ['red', 'orange', 'yellow', 'blue', 'emerald']
     - showAnimation, connectNulls, className="mt-4 h-72"
   - Wrapped in Card with heading "Sentiment Trend" and description "Communication tone distribution over time"

4. `ChannelHotspotTable` component:
   - Props: `{ hotspots: ChannelHotspot[] }`
   - Renders an HTML table inside a Card with columns: Channel ID, Total, Complaints, Escalations, Complaint Rate (%), Risk Score
   - Risk score cell color-coded:
     - riskScore > 50: text-red-600 font-bold
     - riskScore > 25: text-orange-600
     - else: text-yellow-600
   - Complaint rate formatted to 1 decimal place with % sign
   - Empty state: "No channel hotspots detected in this period." if no data

5. `WeekOverWeekCards` component:
   - Props: `{ data: PeriodComparison }`
   - Shows a grid of comparison cards:
     - Total Suggestions: current count vs previous count with % change
     - Escalations: current count vs previous count with % change
     - Top 3 topic changes (biggest absolute percent changes)
   - Change indicators: green for decrease in complaints/escalations (improvement), red for increase
   - Format: current value with arrow up/down and percent change below
   - If data.warnings.length > 0, show a warning banner above the cards with the warning text
   - Use Tailwind classes, no external dependencies beyond what's imported

6. `EscalationSummaryCard` component:
   - Props: `{ data: EscalationSummary }`
   - Shows:
     - Total escalations count (large number)
     - Open vs Resolved counts with a simple bar/progress visual
     - Severity breakdown as a small inline list: critical (red), high (orange), medium (yellow)
     - Average resolution time (if available, formatted as hours/days)
   - Wrapped in Card with heading "Escalation Summary"
  </action>
  <verify>Run `npx tsc --noEmit` in apps/web-portal. Verify all 5 chart components are exported.</verify>
  <done>Five chart components created: TopicTrendChart (stacked area), SentimentTrendChart (line), ChannelHotspotTable (table), WeekOverWeekCards (comparison grid), EscalationSummaryCard (summary). All use Tremor and Tailwind.</done>
</task>

<task type="auto">
  <name>Task 2: Create communication insights dashboard page</name>
  <files>apps/web-portal/app/admin/communication-insights/page.tsx</files>
  <action>
Create `apps/web-portal/app/admin/communication-insights/page.tsx` as a server component following the `response-times/page.tsx` pattern EXACTLY:

1. Imports:
```typescript
import { requireAdmin } from '@/lib/auth/admin';
import {
  getTopicOverview,
  getTopicTrend,
  getSentimentTrend,
  getChannelHotspots,
  getWeekOverWeek,
  getEscalationSummary,
} from '@/lib/admin/communication-insights';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import {
  TopicTrendChart,
  SentimentTrendChart,
  ChannelHotspotTable,
  WeekOverWeekCards,
  EscalationSummaryCard,
} from '@/components/admin/communication-insights-charts';
```

2. Export default async function `CommunicationInsightsPage`:

a. Call `requireAdmin()` to get session:
```typescript
const session = await requireAdmin();
if (!session.organizationId) {
  return <div className="p-6"><p className="text-muted-foreground">No organization found</p></div>;
}
```

b. Fetch all data in parallel with error handling:
```typescript
let topicOverview, topicTrend, sentimentTrend, hotspots, weekComparison, escalations;
try {
  [topicOverview, topicTrend, sentimentTrend, hotspots, weekComparison, escalations] = await Promise.all([
    getTopicOverview(session.organizationId, session.workspaceId, 30),
    getTopicTrend(session.organizationId, session.workspaceId, 30),
    getSentimentTrend(session.organizationId, session.workspaceId, 30),
    getChannelHotspots(session.organizationId, session.workspaceId, 7),
    getWeekOverWeek(session.organizationId, session.workspaceId),
    getEscalationSummary(session.organizationId, session.workspaceId, 30),
  ]);
} catch (error) {
  console.error('Failed to fetch communication insights:', error);
  return (
    <div className="p-6 space-y-6">
      <h1 className="text-3xl font-bold">Communication Insights</h1>
      <p className="text-muted-foreground">
        No communication data available yet. Insights will appear once suggestions are generated and classified.
      </p>
    </div>
  );
}
```

c. Render the dashboard layout:

```
<div className="p-6 space-y-6">
  {/* Header */}
  <div>
    <h1 className="text-3xl font-bold">Communication Insights</h1>
    <p className="text-muted-foreground mt-1">
      Topic trends, sentiment patterns, and communication hotspots
    </p>
  </div>

  {/* Week-over-Week Comparison */}
  <WeekOverWeekCards data={weekComparison} />

  {/* Topic Overview Cards */}
  <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
    {/* Total Classifications card */}
    <Card>
      <CardHeader className="pb-3">
        <CardDescription>Total Classifications</CardDescription>
        <CardTitle className="text-3xl">{topicOverview.totalClassifications.toLocaleString()}</CardTitle>
      </CardHeader>
      <CardContent>
        <p className="text-xs text-muted-foreground">Last 30 days</p>
      </CardContent>
    </Card>

    {/* Top Topic card - show the most common topic */}
    {/* Avg Confidence card */}
    {/* Active Hotspots card - count from hotspots array */}
  </div>

  {/* Charts Row */}
  <div className="grid gap-6 lg:grid-cols-1">
    {topicTrend.length > 0 ? (
      <TopicTrendChart data={topicTrend} />
    ) : (
      <Card><CardHeader><CardTitle>Topic Distribution</CardTitle></CardHeader>
        <CardContent><p className="text-sm text-muted-foreground">Not enough data to show topic trends.</p></CardContent>
      </Card>
    )}
  </div>

  {sentimentTrend.length > 0 ? (
    <SentimentTrendChart data={sentimentTrend} />
  ) : (
    <Card><CardHeader><CardTitle>Sentiment Trend</CardTitle></CardHeader>
      <CardContent><p className="text-sm text-muted-foreground">Not enough data to show sentiment trends.</p></CardContent>
    </Card>
  )}

  {/* Bottom Row: Hotspots + Escalations */}
  <div className="grid gap-6 lg:grid-cols-2">
    <ChannelHotspotTable hotspots={hotspots} />
    <EscalationSummaryCard data={escalations} />
  </div>
</div>
```

Key points:
- Server component (no 'use client') — data fetching happens server-side
- All data fetched in parallel with Promise.all
- Graceful error handling with meaningful empty states
- Responsive grid layout matching response-times page
- Card components from shadcn/ui for summary cards
- Tremor charts for visualizations
  </action>
  <verify>Run `npx tsc --noEmit` in apps/web-portal. Navigate to /admin/communication-insights in the browser (if dev server running) to verify page renders without errors.</verify>
  <done>Communication insights dashboard page created at /admin/communication-insights with topic overview cards, stacked area chart for topics, line chart for sentiment, hotspot table, week-over-week comparison, and escalation summary. All data fetched server-side with proper error handling.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes in apps/web-portal
2. /admin/communication-insights page renders without errors
3. TopicTrendChart shows stacked area chart
4. SentimentTrendChart shows line chart
5. ChannelHotspotTable shows table with risk scores
6. WeekOverWeekCards shows comparison with percent changes
7. EscalationSummaryCard shows severity breakdown
8. Empty states shown when no data available
9. Page is admin-gated
</verification>

<success_criteria>
Complete communication insights dashboard at /admin/communication-insights with 5 visualization components. Admin can view topic distribution trends, sentiment patterns, channel hotspots, week-over-week comparisons, and escalation summaries. All data loaded server-side with React cache() and proper error handling.
</success_criteria>

<output>
After completion, create `.planning/phases/17-communication-pattern-insights/17-05-SUMMARY.md`
</output>
