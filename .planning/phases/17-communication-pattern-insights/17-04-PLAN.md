---
phase: 17-communication-pattern-insights
plan: 04
type: execute
wave: 3
depends_on: ["17-01", "17-02", "17-03"]
files_modified:
  - apps/web-portal/lib/admin/communication-insights.ts
autonomous: true

must_haves:
  truths:
    - "getTopicOverview returns topic distribution with counts and percentages for a given date range"
    - "getTopicTrend returns daily topic counts over time for area chart visualization"
    - "getSentimentTrend returns daily sentiment tone counts for line chart visualization"
    - "getChannelHotspots returns channels with high complaint/escalation rates and risk scores"
    - "getWeekOverWeek returns current vs previous week comparison with percent changes"
    - "getEscalationSummary returns escalation counts by severity with period comparison"
    - "All functions require admin auth and filter by organizationId and workspaceId"
  artifacts:
    - path: "apps/web-portal/lib/admin/communication-insights.ts"
      provides: "Communication insights query functions"
      exports: ["getTopicOverview", "getTopicTrend", "getSentimentTrend", "getChannelHotspots", "getWeekOverWeek", "getEscalationSummary"]
  key_links:
    - from: "apps/web-portal/lib/admin/communication-insights.ts"
      to: "packages/database/src/schema.ts"
      via: "queries topicClassifications and communicationTrends tables"
      pattern: "topicClassifications|communicationTrends"
    - from: "apps/web-portal/lib/admin/communication-insights.ts"
      to: "apps/web-portal/lib/auth/admin"
      via: "requireAdmin() guard"
      pattern: "requireAdmin"
---

<objective>
Create the communication insights query library for the web portal admin dashboard.

Purpose: Server-side data fetching functions that query topic_classifications and communication_trends tables to power the insights dashboard charts and tables.

Output: communication-insights.ts with cached query functions following the response-time-analytics.ts pattern.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@apps/web-portal/lib/admin/response-time-analytics.ts
@packages/database/src/schema.ts
@.planning/phases/17-communication-pattern-insights/17-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create topic overview and trend query functions</name>
  <files>apps/web-portal/lib/admin/communication-insights.ts</files>
  <action>
Create `apps/web-portal/lib/admin/communication-insights.ts` following the EXACT pattern of `response-time-analytics.ts`:

1. Imports (same pattern):
```typescript
import 'server-only';
import { cache } from 'react';
import { sql, eq, and, gte, lt } from 'drizzle-orm';
import { db, schema } from '../db';
import { requireAdmin } from '../auth/admin';

const { topicClassifications, communicationTrends, escalationAlerts, clientProfiles } = schema;
```

2. Define interfaces:

```typescript
export interface TopicOverview {
  topics: Array<{
    topic: string;
    count: number;
    percentage: number;
  }>;
  totalClassifications: number;
  avgConfidence: number;
}

export interface TopicTrendPoint {
  date: string;
  scheduling: number;
  complaint: number;
  technical: number;
  status_update: number;
  request: number;
  escalation: number;
  general: number;
}

export interface SentimentTrendPoint {
  date: string;
  positive: number;
  neutral: number;
  tense: number;
  frustrated: number;
  angry: number;
}

export interface ChannelHotspot {
  channelId: string;
  totalMessages: number;
  complaintCount: number;
  escalationCount: number;
  complaintRate: number;
  riskScore: number;
}

export interface PeriodComparison {
  current: {
    totalSuggestions: number;
    topicCounts: Record<string, number>;
    escalationCount: number;
    topComplaintChannels: string[];
  };
  previous: {
    totalSuggestions: number;
    topicCounts: Record<string, number>;
    escalationCount: number;
    topComplaintChannels: string[];
  };
  changes: {
    totalSuggestionsChange: number; // percent
    escalationChange: number; // percent
    topicChanges: Record<string, number>; // percent per topic
  };
  warnings: string[];
}

export interface EscalationSummary {
  total: number;
  bySeverity: Record<string, number>;
  openCount: number;
  resolvedCount: number;
  avgResolutionHours: number | null;
}
```

3. `getTopicOverview` — cached function:
   - Parameters: organizationId, workspaceId, days (default 30)
   - Calls `requireAdmin()`
   - Queries `topicClassifications` table:
     ```sql
     SELECT topic, COUNT(*) as count, AVG(confidence) as avg_confidence
     FROM topic_classifications
     WHERE organization_id = $orgId AND created_at >= $startDate
     GROUP BY topic
     ORDER BY count DESC
     ```
   - Calculates percentages (count / total * 100)
   - Returns TopicOverview

4. `getTopicTrend` — cached function:
   - Parameters: organizationId, workspaceId, days (default 30)
   - Calls `requireAdmin()`
   - Queries `topicClassifications` grouped by DATE and topic:
     ```sql
     SELECT DATE(created_at) as date, topic, COUNT(*) as count
     FROM topic_classifications
     WHERE organization_id = $orgId AND created_at >= $startDate
     GROUP BY DATE(created_at), topic
     ORDER BY date ASC
     ```
   - Pivots results into TopicTrendPoint array (one row per date with all 7 topic counts, defaulting to 0 for missing topics)
   - Returns TopicTrendPoint[]

5. `getSentimentTrend` — cached function:
   - Parameters: organizationId, workspaceId, days (default 30)
   - Calls `requireAdmin()`
   - Queries `topicClassifications` where sentiment IS NOT NULL, grouped by DATE and sentiment->>'tone':
     ```sql
     SELECT DATE(created_at) as date, sentiment->>'tone' as tone, COUNT(*) as count
     FROM topic_classifications
     WHERE organization_id = $orgId AND created_at >= $startDate AND sentiment IS NOT NULL
     GROUP BY DATE(created_at), sentiment->>'tone'
     ORDER BY date ASC
     ```
   - Pivots into SentimentTrendPoint array (one row per date with 5 tone counts)
   - Returns SentimentTrendPoint[]

For all queries, use the `db.execute(sql`...`)` pattern from response-time-analytics.ts with proper row parsing using Number() and String() casts. Handle the `result` parsing pattern: `const rows = Array.isArray(result) ? result : (result as unknown as { rows: unknown[] }).rows ?? [];`
  </action>
  <verify>Run `npx tsc --noEmit` in apps/web-portal. Verify getTopicOverview, getTopicTrend, getSentimentTrend exports exist.</verify>
  <done>Topic overview and trend query functions created with proper caching, admin auth, and org-scoped filtering.</done>
</task>

<task type="auto">
  <name>Task 2: Create hotspot, period comparison, and escalation query functions</name>
  <files>apps/web-portal/lib/admin/communication-insights.ts</files>
  <action>
Add three more cached query functions to communication-insights.ts:

1. `getChannelHotspots` — cached function:
   - Parameters: organizationId, workspaceId, days (default 7)
   - Calls `requireAdmin()`
   - Queries `topicClassifications` for channels with high complaint/escalation rates:
     ```sql
     SELECT
       channel_id,
       COUNT(*) as total_messages,
       COUNT(*) FILTER (WHERE topic = 'complaint') as complaint_count,
       COUNT(*) FILTER (WHERE topic = 'escalation') as escalation_count
     FROM topic_classifications
     WHERE organization_id = $orgId
       AND created_at >= $startDate
       AND channel_id IS NOT NULL
     GROUP BY channel_id
     HAVING COUNT(*) >= 10
     ORDER BY (COUNT(*) FILTER (WHERE topic IN ('complaint', 'escalation'))::float / COUNT(*)) DESC
     LIMIT 20
     ```
   - Calculate complaintRate = (complaintCount / totalMessages) * 100
   - Calculate riskScore = ((complaintCount + escalationCount) / totalMessages) * 100
   - Returns ChannelHotspot[]

2. `getWeekOverWeek` — cached function:
   - Parameters: organizationId, workspaceId
   - Calls `requireAdmin()`
   - Calculate date ranges:
     - thisWeekStart = most recent Monday 00:00:00
     - lastWeekStart = thisWeekStart - 7 days
     - lastWeekEnd = thisWeekStart
     - today = now
   - Query current period (thisWeekStart to today) from topicClassifications:
     ```sql
     SELECT topic, COUNT(*) as count
     FROM topic_classifications
     WHERE organization_id = $orgId
       AND created_at >= $thisWeekStart AND created_at < $today
     GROUP BY topic
     ```
   - Query previous period (lastWeekStart to lastWeekEnd) similarly
   - Query escalation counts for both periods from escalationAlerts
   - Calculate percent changes: `((current - previous) / max(previous, 1)) * 100`
   - Add warnings array:
     - If current week has < 3 days of data: "This week has only N days of data. Comparison may not be meaningful."
   - Returns PeriodComparison

3. `getEscalationSummary` — cached function:
   - Parameters: organizationId, workspaceId, days (default 30)
   - Calls `requireAdmin()`
   - Queries escalation_alerts:
     ```sql
     SELECT
       COUNT(*) as total,
       COUNT(*) FILTER (WHERE status = 'open') as open_count,
       COUNT(*) FILTER (WHERE status = 'resolved') as resolved_count,
       severity,
       COUNT(*) as sev_count
     FROM escalation_alerts
     WHERE organization_id = $orgId AND created_at >= $startDate
     GROUP BY severity
     ```
   - Also query average resolution time:
     ```sql
     SELECT AVG(EXTRACT(EPOCH FROM (resolved_at - created_at)) / 3600) as avg_hours
     FROM escalation_alerts
     WHERE organization_id = $orgId AND created_at >= $startDate AND resolved_at IS NOT NULL
     ```
   - Returns EscalationSummary

Use the same result parsing pattern from Task 1 for all queries.
  </action>
  <verify>Run `npx tsc --noEmit` in apps/web-portal. Verify getChannelHotspots, getWeekOverWeek, getEscalationSummary exports exist. Verify all 6 functions are properly cached and use requireAdmin().</verify>
  <done>All 6 communication insights query functions created: getTopicOverview, getTopicTrend, getSentimentTrend, getChannelHotspots, getWeekOverWeek, getEscalationSummary. All cached, admin-gated, org-scoped.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes in apps/web-portal
2. communication-insights.ts exports 6 functions
3. All functions use `cache()` wrapper
4. All functions call `requireAdmin()`
5. All queries filter by organizationId
6. Period comparison includes warnings for partial data
7. Hotspot detection uses minimum 10 message threshold
</verification>

<success_criteria>
Complete query library for communication insights dashboard. Six cached, admin-gated functions providing topic overview, topic trends, sentiment trends, channel hotspots, week-over-week comparison, and escalation summary. All queries are org-scoped and follow the response-time-analytics.ts pattern.
</success_criteria>

<output>
After completion, create `.planning/phases/17-communication-pattern-insights/17-04-SUMMARY.md`
</output>
