---
phase: 17-communication-pattern-insights
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/src/schema.ts
autonomous: true

must_haves:
  truths:
    - "topic_classifications table exists with topic, confidence, reasoning, sentiment columns"
    - "communication_trends table exists with JSONB columns for topic/sentiment/escalation/hotspot distribution"
    - "Both tables have proper indexes for org-scoped time-range queries"
    - "Type exports exist for both new tables"
  artifacts:
    - path: "packages/database/src/schema.ts"
      provides: "topic_classifications and communication_trends table definitions"
      contains: "topicClassifications"
  key_links:
    - from: "packages/database/src/schema.ts"
      to: "organizations table"
      via: "organizationId foreign key reference"
      pattern: "references.*organizations"
---

<objective>
Add topic_classifications and communication_trends tables to the database schema.

Purpose: Foundation tables for storing per-suggestion topic classification results and precomputed daily trend aggregates used by the communication insights dashboard.

Output: Two new Drizzle ORM table definitions in schema.ts with proper indexes, foreign keys, and type exports.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@packages/database/src/schema.ts
@.planning/phases/17-communication-pattern-insights/17-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add topic_classifications table</name>
  <files>packages/database/src/schema.ts</files>
  <action>
Add a `topicClassifications` table to schema.ts after the `suggestionMetrics` table and its type exports. Follow the exact Drizzle ORM patterns already used in the file.

Table name: `topic_classifications`

Columns:
- `id`: uuid, primaryKey, defaultRandom
- `organizationId`: uuid('organization_id'), notNull, references organizations.id
- `workspaceId`: uuid('workspace_id'), notNull, references workspaces.id
- `userId`: text('user_id'), notNull — Slack user ID
- `channelId`: text('channel_id') — nullable
- `suggestionId`: text('suggestion_id'), notNull — links to suggestion (NOT a foreign key, same as suggestionMetrics pattern)
- `topic`: text('topic'), notNull — one of: 'scheduling', 'complaint', 'technical', 'status_update', 'request', 'escalation', 'general'
- `confidence`: integer('confidence') — 0-100 (stored as integer, converted from 0.0-1.0 float at insert time by multiplying by 100)
- `reasoning`: text('reasoning') — brief explanation from classifier
- `sentiment`: jsonb('sentiment') — nullable, stores SentimentAnalysis object (same as escalationAlerts.sentiment)
- `createdAt`: timestamp('created_at'), defaultNow, notNull

Indexes (using the table callback pattern):
- `orgTimeIdx`: index on (organizationId, createdAt) — for org-scoped time queries
- `topicIdx`: index on (topic, createdAt) — for topic distribution queries
- `suggestionIdx`: uniqueIndex on (suggestionId) — one classification per suggestion
- `channelIdx`: index on (channelId, createdAt) — for channel hotspot queries
- `userIdx`: index on (userId, createdAt) — for user pattern queries

Add type exports:
```typescript
export type TopicClassification = typeof topicClassifications.$inferSelect;
export type NewTopicClassification = typeof topicClassifications.$inferInsert;
```
  </action>
  <verify>Run `npx tsc --noEmit` in packages/database to confirm no type errors. Grep for `topicClassifications` to confirm the table and type exports exist.</verify>
  <done>topicClassifications table defined in schema.ts with all columns, indexes, and type exports. No TypeScript errors.</done>
</task>

<task type="auto">
  <name>Task 2: Add communication_trends table</name>
  <files>packages/database/src/schema.ts</files>
  <action>
Add a `communicationTrends` table to schema.ts immediately after the topicClassifications table and its type exports.

Table name: `communication_trends`

Columns:
- `id`: uuid, primaryKey, defaultRandom
- `organizationId`: uuid('organization_id'), notNull, references organizations.id
- `trendDate`: timestamp('trend_date'), notNull — the date this aggregate covers
- `trendPeriod`: text('trend_period'), notNull — 'daily' (future: 'weekly', 'monthly')
- `topicDistribution`: jsonb('topic_distribution') — `Record<string, number>` mapping topic to count, e.g. `{ "complaint": 5, "scheduling": 12 }`
- `sentimentDistribution`: jsonb('sentiment_distribution') — `Record<string, number>` mapping tone to count, e.g. `{ "angry": 2, "neutral": 15 }`
- `escalationCounts`: jsonb('escalation_counts') — `Record<string, number>` mapping severity to count, e.g. `{ "high": 1, "critical": 0 }`
- `channelHotspots`: jsonb('channel_hotspots') — `Array<{ channelId: string; complaintCount: number; escalationCount: number; totalCount: number; hotspotRatio: number }>` — channels flagged as hotspots that day
- `totalClassifications`: integer('total_classifications'), default(0) — total suggestions classified that day
- `avgConfidence`: integer('avg_confidence') — average classifier confidence 0-100
- `createdAt`: timestamp('created_at'), defaultNow, notNull

Indexes:
- `orgDateIdx`: uniqueIndex on (organizationId, trendDate, trendPeriod) — one aggregate per org per date per period
- `trendDateIdx`: index on (trendDate) — for period-over-period range queries

Add type exports:
```typescript
export type CommunicationTrend = typeof communicationTrends.$inferSelect;
export type NewCommunicationTrend = typeof communicationTrends.$inferInsert;
```

After adding both tables, run `npm run db:push --workspace=@slack-speak-for-me/database` to push the schema to the database (this is the standard way to apply schema changes in this project — no migration files needed, drizzle-kit push handles it).
  </action>
  <verify>Run `npx tsc --noEmit` in packages/database. Run `npm run db:push --workspace=@slack-speak-for-me/database` to verify schema applies cleanly. Grep for `communicationTrends` to confirm table and type exports.</verify>
  <done>communicationTrends table defined in schema.ts with JSONB columns for aggregated data, proper indexes including unique constraint on (org, date, period), and type exports. Schema pushed to database.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes in packages/database
2. Both `topicClassifications` and `communicationTrends` tables exist in schema.ts
3. All columns match the specification above
4. Indexes are properly defined
5. Type exports exist for both tables
6. `npm run db:push` completes without errors
</verification>

<success_criteria>
Two new tables (topic_classifications, communication_trends) are defined in the Drizzle schema with proper columns, indexes, foreign keys, and type exports. The schema pushes cleanly to the database.
</success_criteria>

<output>
After completion, create `.planning/phases/17-communication-pattern-insights/17-01-SUMMARY.md`
</output>
