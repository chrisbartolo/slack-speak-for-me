---
phase: 06-production-polish-and-admin
plan: 06
type: execute
wave: 4
depends_on: ["06-02", "06-04"]
files_modified:
  - apps/web-portal/components/dashboard/conversation-list.tsx
  - apps/web-portal/lib/db/queries.ts
  - apps/web-portal/app/api/slack/channels/route.ts
autonomous: true

must_haves:
  truths:
    - "Conversations page shows channel names from database (not API)"
    - "Each conversation shows inline action buttons"
    - "Users can add context for conversation participants"
  artifacts:
    - path: "apps/web-portal/components/dashboard/conversation-list.tsx"
      provides: "Enhanced conversation list with actions"
      contains: "channelName"
    - path: "apps/web-portal/lib/db/queries.ts"
      provides: "Query returning channel names"
      contains: "channelName"
  key_links:
    - from: "apps/web-portal/components/dashboard/conversation-list.tsx"
      to: "lib/db/queries.ts"
      via: "getWatchedConversations"
      pattern: "channelName"
---

<objective>
Enhance Conversations page with cached channel names and inline actions

Purpose: The current conversations page calls Slack API on every load to get channel names (slow, rate-limited). After Plan 02, channel names are stored in the database. This plan uses that cached data and adds inline action buttons for manage context and other actions.

Output: Conversations page that loads instantly with channel names from DB, plus inline actions for context management.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-production-polish-and-admin/06-02-PLAN.md
@apps/web-portal/components/dashboard/conversation-list.tsx
@apps/web-portal/lib/db/queries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update queries to return channel names from database</name>
  <files>apps/web-portal/lib/db/queries.ts</files>
  <action>
  Update getWatchedConversations query to include channel name and type:

  ```typescript
  /**
   * Full list of watched conversations with channel info
   */
  export const getWatchedConversations = cache(async () => {
    const session = await verifySession();

    const conversations = await db
      .select({
        id: watchedConversations.id,
        channelId: watchedConversations.channelId,
        channelName: watchedConversations.channelName,
        channelType: watchedConversations.channelType,
        watchedAt: watchedConversations.watchedAt,
      })
      .from(watchedConversations)
      .where(
        and(
          eq(watchedConversations.workspaceId, session.workspaceId),
          eq(watchedConversations.userId, session.userId)
        )
      )
      .orderBy(desc(watchedConversations.watchedAt));

    return conversations;
  });
  ```

  The query now returns channelName and channelType directly from the database (populated by /watch command).
  </action>
  <verify>
  - Build succeeds: `npm run build --workspace=@slack-speak-for-me/web-portal`
  - TypeScript types include channelName and channelType
  </verify>
  <done>
  Query returns channel names from database without Slack API call
  </done>
</task>

<task type="auto">
  <name>Task 2: Update conversation list to use cached names and add actions</name>
  <files>apps/web-portal/components/dashboard/conversation-list.tsx</files>
  <action>
  Refactor ConversationList to use database channel names and add inline actions:

  1. Update the Conversation interface:
     ```typescript
     interface Conversation {
       id: string;
       channelId: string;
       channelName?: string | null;
       channelType?: string | null;
       watchedAt: Date | null;
     }
     ```

  2. Remove the useEffect that fetches channel names from API (no longer needed):
     ```typescript
     // REMOVE this entire useEffect block:
     // useEffect(() => {
     //   async function fetchChannelNames() { ... }
     //   fetchChannelNames();
     // }, [conversations]);
     ```

  3. Remove channelNames state and loadingChannels state.

  4. Update the display to use channelName from props:
     ```tsx
     <p className="font-medium text-gray-900">
       {conversation.channelName
         ? `#${conversation.channelName}`
         : conversation.channelId}
     </p>
     ```

  5. Determine icon from channelType:
     ```tsx
     const isPrivate = conversation.channelType === 'group';
     const isDM = conversation.channelType === 'im' || conversation.channelType === 'mpim';

     // Icon selection
     {isDM ? (
       <MessageSquare className="h-5 w-5 text-gray-600" />
     ) : isPrivate ? (
       <Lock className="h-5 w-5 text-gray-600" />
     ) : (
       <Hash className="h-5 w-5 text-gray-600" />
     )}
     ```

  6. Add inline action buttons (after the delete button):
     ```tsx
     <div className="flex items-center gap-2">
       <Button
         variant="ghost"
         size="sm"
         asChild
       >
         <Link href={`/dashboard/people?channel=${conversation.channelId}`}>
           <Users className="h-4 w-4 mr-1" />
           Add Context
         </Link>
       </Button>

       {/* Existing delete button */}
       <AlertDialog>...</AlertDialog>
     </div>
     ```

  7. Import Users, MessageSquare from lucide-react and Link from next/link.

  8. If channelName is null (legacy data), show the channelId with a "name unavailable" subtitle or fetch on-demand as fallback.
  </action>
  <verify>
  - Build succeeds: `npm run build --workspace=@slack-speak-for-me/web-portal`
  - Component renders without API calls
  - Actions are visible on each conversation row
  </verify>
  <done>
  Conversations page loads instantly with cached channel names and shows inline action buttons
  </done>
</task>

<task type="auto">
  <name>Task 3: Add fallback API route for legacy data</name>
  <files>apps/web-portal/app/api/slack/channels/route.ts</files>
  <action>
  Keep the existing API route as a fallback for conversations that don't have cached names (watched before Plan 02).

  Update the route to handle single channel lookup more efficiently:

  ```typescript
  // Add a function to refresh a single channel's name in DB
  // This can be called when displaying a conversation with no cached name

  export async function GET(request: Request) {
    // Existing logic...
    // Add optional refresh parameter that updates DB

    const { searchParams } = new URL(request.url);
    const refresh = searchParams.get('refresh') === 'true';

    if (refresh && channels) {
      // Update channel names in watchedConversations table
      for (const [channelId, info] of Object.entries(channels)) {
        await db.update(watchedConversations)
          .set({ channelName: info.name, channelType: info.isPrivate ? 'group' : 'channel' })
          .where(
            and(
              eq(watchedConversations.channelId, channelId),
              eq(watchedConversations.workspaceId, session.workspaceId)
            )
          );
      }
    }

    return NextResponse.json({ channels });
  }
  ```

  This allows the frontend to trigger a one-time refresh for legacy data.
  </action>
  <verify>
  - Build succeeds: `npm run build --workspace=@slack-speak-for-me/web-portal`
  - API route still works for legacy fallback
  </verify>
  <done>
  API route supports refresh parameter to backfill channel names for legacy data
  </done>
</task>

</tasks>

<verification>
1. Build succeeds: `npm run build --workspace=@slack-speak-for-me/web-portal`
2. Conversations page loads without calling Slack API (check network tab)
3. Channel names display correctly from database
4. DM conversations show message icon instead of hash
5. "Add Context" button links to people page
</verification>

<success_criteria>
- Conversations page loads instantly (no Slack API calls on render)
- Channel names from database are displayed
- DM/private channels show appropriate icons
- Inline action buttons are visible and functional
- Fallback exists for legacy data without cached names
</success_criteria>

<output>
After completion, create `.planning/phases/06-production-polish-and-admin/06-06-SUMMARY.md`
</output>
