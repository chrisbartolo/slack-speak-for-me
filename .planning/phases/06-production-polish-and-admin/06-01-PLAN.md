---
phase: 06-production-polish-and-admin
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/slack-backend/src/handlers/events/app-mention.ts
  - apps/slack-backend/src/handlers/events/app-mention.test.ts
autonomous: true

must_haves:
  truths:
    - "Bot only triggers suggestions when user has /watch active on channel"
    - "app_mention without /watch is silently ignored"
    - "app_mention with /watch active queues AI response"
  artifacts:
    - path: "apps/slack-backend/src/handlers/events/app-mention.ts"
      provides: "Watch check before AI suggestion"
      contains: "isWatching"
    - path: "apps/slack-backend/src/handlers/events/app-mention.test.ts"
      provides: "Tests for watch filtering"
      contains: "should not trigger when not watching"
  key_links:
    - from: "apps/slack-backend/src/handlers/events/app-mention.ts"
      to: "services/watch.ts"
      via: "isWatching function call"
      pattern: "await isWatching\\("
---

<objective>
Fix app_mention handler to check /watch status before triggering AI suggestions

Purpose: Currently the bot responds to @mentions regardless of whether the user has enabled /watch. This causes unwanted suggestions and violates user expectations. The fix adds an isWatching() check early in the handler.

Output: Updated app_mention handler that silently exits when channel is not watched, with comprehensive tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-production-polish-and-admin/06-RESEARCH.md
@apps/slack-backend/src/handlers/events/app-mention.ts
@apps/slack-backend/src/services/watch.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add isWatching check to app_mention handler</name>
  <files>apps/slack-backend/src/handlers/events/app-mention.ts</files>
  <action>
  Modify the app_mention event handler to check if the mentioned user is watching the channel before proceeding:

  1. Import `isWatching` from `../../services/watch.js` (already importing getWorkspaceId)
  2. After getting workspaceId, add the watch check:
     ```typescript
     // Check if user is watching this channel
     const isWatchingChannel = await isWatching(workspaceId, event.user, event.channel);
     if (!isWatchingChannel) {
       logger.debug({
         channel: event.channel,
         user: event.user,
       }, 'Ignoring app_mention - channel not watched');
       return;
     }
     ```
  3. Place this check BEFORE the context retrieval (avoid unnecessary API calls)
  4. Keep all existing error handling and logging

  This follows the pattern from 06-RESEARCH.md Pattern 1.
  </action>
  <verify>
  - TypeScript compiles: `npm run build --workspace=slack-backend`
  - Code review: isWatching check appears before getContextForMessage call
  </verify>
  <done>
  app_mention handler returns early when isWatching returns false, preventing unwanted AI suggestions
  </done>
</task>

<task type="auto">
  <name>Task 2: Update tests for app_mention watch filtering</name>
  <files>apps/slack-backend/src/handlers/events/app-mention.test.ts</files>
  <action>
  Add test cases to verify the watch check behavior:

  1. Add test: "should not trigger AI response when channel is not watched"
     - Mock isWatching to return false
     - Trigger app_mention event
     - Assert queueAIResponse was NOT called
     - Assert logger.debug was called with "channel not watched" message

  2. Add test: "should trigger AI response when channel is watched"
     - Mock isWatching to return true
     - Trigger app_mention event
     - Assert queueAIResponse WAS called

  3. Update existing tests to properly mock isWatching (default to true for backward compatibility)

  Follow existing test patterns in the file (Vitest, mock setup/teardown).
  </action>
  <verify>
  - Tests pass: `npm test --workspace=slack-backend -- app-mention`
  - Coverage includes the new isWatching branch
  </verify>
  <done>
  Tests verify that app_mention respects watch status, with both positive and negative cases covered
  </done>
</task>

</tasks>

<verification>
1. Build succeeds: `npm run build --workspace=slack-backend`
2. Tests pass: `npm test --workspace=slack-backend -- app-mention`
3. Code review confirms isWatching check is early in handler (before API calls)
</verification>

<success_criteria>
- app_mention handler checks isWatching before processing
- Handler returns early with debug log when not watching
- All existing tests still pass
- New tests cover the watch check logic
</success_criteria>

<output>
After completion, create `.planning/phases/06-production-polish-and-admin/06-01-SUMMARY.md`
</output>
