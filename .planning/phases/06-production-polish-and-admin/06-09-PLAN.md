---
phase: 06-production-polish-and-admin
plan: 09
type: execute
wave: 6
depends_on: ["06-07", "06-08"]
files_modified:
  - apps/web-portal/app/admin/billing/page.tsx
  - apps/web-portal/app/api/stripe/webhook/route.ts
  - apps/web-portal/app/api/stripe/portal/route.ts
  - apps/web-portal/lib/stripe.ts
autonomous: false
user_setup:
  - service: stripe
    why: "Subscription billing for per-seat pricing"
    env_vars:
      - name: STRIPE_SECRET_KEY
        source: "Stripe Dashboard -> Developers -> API keys -> Secret key"
      - name: STRIPE_PUBLISHABLE_KEY
        source: "Stripe Dashboard -> Developers -> API keys -> Publishable key"
      - name: STRIPE_WEBHOOK_SECRET
        source: "Stripe Dashboard -> Developers -> Webhooks -> Signing secret"
    dashboard_config:
      - task: "Create per-seat price"
        location: "Stripe Dashboard -> Products -> Create product with recurring price"
      - task: "Configure Customer Portal"
        location: "Stripe Dashboard -> Settings -> Billing -> Customer portal"
      - task: "Create webhook endpoint"
        location: "Stripe Dashboard -> Developers -> Webhooks -> Add endpoint for checkout.session.completed, customer.subscription.updated, customer.subscription.deleted"

must_haves:
  truths:
    - "Admin can view current subscription status"
    - "Admin can access Stripe Customer Portal for self-service billing"
    - "Stripe webhooks update organization subscription status"
  artifacts:
    - path: "apps/web-portal/app/admin/billing/page.tsx"
      provides: "Billing dashboard with subscription info"
      contains: "stripeSubscriptionId"
    - path: "apps/web-portal/lib/stripe.ts"
      provides: "Stripe client and helpers"
      exports: ["stripe", "createPortalSession"]
  key_links:
    - from: "apps/web-portal/app/api/stripe/webhook/route.ts"
      to: "packages/database/src/schema.ts"
      via: "update organization subscription"
      pattern: "organizations.*subscriptionStatus"
---

<objective>
Implement Stripe billing with customer portal integration

Purpose: Admin panel needs billing capabilities. Using Stripe's Customer Portal for self-service (subscription management, payment methods, invoices) minimizes custom UI work while providing a professional billing experience.

Output: Billing page with subscription status, Stripe Customer Portal button, and webhook handlers.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-production-polish-and-admin/06-RESEARCH.md
@.planning/phases/06-production-polish-and-admin/06-07-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Stripe client and helpers</name>
  <files>apps/web-portal/lib/stripe.ts</files>
  <action>
  Create Stripe client with helper functions:

  ```typescript
  import 'server-only';
  import Stripe from 'stripe';

  if (!process.env.STRIPE_SECRET_KEY) {
    throw new Error('STRIPE_SECRET_KEY is required');
  }

  export const stripe = new Stripe(process.env.STRIPE_SECRET_KEY, {
    apiVersion: '2024-11-20.acacia',
    typescript: true,
  });

  /**
   * Create Stripe Customer Portal session
   */
  export async function createPortalSession(
    customerId: string,
    returnUrl: string
  ): Promise<Stripe.BillingPortal.Session> {
    return stripe.billingPortal.sessions.create({
      customer: customerId,
      return_url: returnUrl,
    });
  }

  /**
   * Get customer's active subscription
   */
  export async function getSubscription(
    subscriptionId: string
  ): Promise<Stripe.Subscription | null> {
    try {
      return await stripe.subscriptions.retrieve(subscriptionId);
    } catch {
      return null;
    }
  }

  /**
   * Update subscription quantity (seats)
   */
  export async function updateSeats(
    subscriptionId: string,
    subscriptionItemId: string,
    quantity: number
  ): Promise<Stripe.Subscription> {
    return stripe.subscriptions.update(subscriptionId, {
      items: [{
        id: subscriptionItemId,
        quantity,
      }],
      proration_behavior: 'create_prorations',
    });
  }

  /**
   * Create Stripe customer for organization
   */
  export async function createCustomer(
    email: string,
    name: string,
    metadata: Record<string, string>
  ): Promise<Stripe.Customer> {
    return stripe.customers.create({
      email,
      name,
      metadata,
    });
  }
  ```

  Install stripe package:
  ```bash
  npm install stripe --workspace=@slack-speak-for-me/web-portal
  ```
  </action>
  <verify>
  - Package installed
  - Build succeeds: `npm run build --workspace=@slack-speak-for-me/web-portal`
  </verify>
  <done>
  Stripe client created with portal session, subscription, and customer helpers
  </done>
</task>

<task type="auto">
  <name>Task 2: Create billing page with Customer Portal</name>
  <files>apps/web-portal/app/admin/billing/page.tsx</files>
  <action>
  Create billing dashboard:

  ```tsx
  import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
  import { Button } from '@/components/ui/button';
  import { Badge } from '@/components/ui/badge';
  import { CreditCard, ExternalLink } from 'lucide-react';
  import { requireAdmin, getOrganization } from '@/lib/auth/admin';
  import { getSubscription } from '@/lib/stripe';
  import { redirect } from 'next/navigation';

  export default async function BillingPage() {
    const session = await requireAdmin();

    if (!session.organizationId) {
      return (
        <div className="p-8 space-y-6">
          <div>
            <h1 className="text-3xl font-bold">Billing</h1>
            <p className="text-muted-foreground mt-1">
              Subscription and payment settings
            </p>
          </div>

          <Card>
            <CardContent className="pt-6">
              <div className="text-center py-8">
                <CreditCard className="h-12 w-12 text-muted-foreground mx-auto mb-4" />
                <h2 className="text-lg font-semibold mb-2">No Organization</h2>
                <p className="text-muted-foreground mb-4">
                  Billing is managed at the organization level.
                  Contact support to set up your organization.
                </p>
              </div>
            </CardContent>
          </Card>
        </div>
      );
    }

    const org = await getOrganization(session.organizationId);
    const subscription = org?.stripeSubscriptionId
      ? await getSubscription(org.stripeSubscriptionId)
      : null;

    const statusColors: Record<string, string> = {
      active: 'bg-green-100 text-green-700',
      past_due: 'bg-yellow-100 text-yellow-700',
      canceled: 'bg-red-100 text-red-700',
      trialing: 'bg-blue-100 text-blue-700',
    };

    return (
      <div className="p-8 space-y-6">
        <div>
          <h1 className="text-3xl font-bold">Billing</h1>
          <p className="text-muted-foreground mt-1">
            Subscription and payment settings for {org?.name}
          </p>
        </div>

        <div className="grid gap-4 md:grid-cols-2">
          <Card>
            <CardHeader>
              <CardTitle>Current Plan</CardTitle>
              <CardDescription>Your subscription details</CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="flex items-center justify-between">
                <span className="text-sm text-muted-foreground">Plan</span>
                <span className="font-medium">{org?.planId || 'Free'}</span>
              </div>
              <div className="flex items-center justify-between">
                <span className="text-sm text-muted-foreground">Status</span>
                <Badge className={statusColors[org?.subscriptionStatus || ''] || 'bg-gray-100 text-gray-700'}>
                  {org?.subscriptionStatus || 'No subscription'}
                </Badge>
              </div>
              <div className="flex items-center justify-between">
                <span className="text-sm text-muted-foreground">Seats</span>
                <span className="font-medium">{org?.seatCount || 1}</span>
              </div>
              {subscription?.current_period_end && (
                <div className="flex items-center justify-between">
                  <span className="text-sm text-muted-foreground">Renews</span>
                  <span className="font-medium">
                    {new Date(subscription.current_period_end * 1000).toLocaleDateString()}
                  </span>
                </div>
              )}
            </CardContent>
          </Card>

          <Card>
            <CardHeader>
              <CardTitle>Manage Subscription</CardTitle>
              <CardDescription>Update payment and subscription settings</CardDescription>
            </CardHeader>
            <CardContent>
              {org?.stripeCustomerId ? (
                <form action="/api/stripe/portal" method="POST">
                  <Button type="submit" className="w-full">
                    <ExternalLink className="h-4 w-4 mr-2" />
                    Open Customer Portal
                  </Button>
                </form>
              ) : (
                <div className="text-center py-4">
                  <p className="text-sm text-muted-foreground mb-4">
                    No Stripe customer yet.
                  </p>
                  <Button disabled>
                    Upgrade to Pro
                  </Button>
                </div>
              )}
            </CardContent>
          </Card>
        </div>

        <Card>
          <CardHeader>
            <CardTitle>Billing FAQ</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4 text-sm text-muted-foreground">
            <div>
              <p className="font-medium text-foreground">How does per-seat pricing work?</p>
              <p>You pay for each active user in your workspace. Seats are prorated when added mid-cycle.</p>
            </div>
            <div>
              <p className="font-medium text-foreground">How do I add more seats?</p>
              <p>Use the Customer Portal to update your subscription quantity, or new users are automatically added.</p>
            </div>
            <div>
              <p className="font-medium text-foreground">How do I cancel?</p>
              <p>Use the Customer Portal to cancel your subscription. You'll have access until the end of your billing period.</p>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }
  ```
  </action>
  <verify>
  - Build succeeds: `npm run build --workspace=@slack-speak-for-me/web-portal`
  - Page renders with subscription info
  </verify>
  <done>
  Billing page shows subscription status and Customer Portal button
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Stripe Customer Portal and webhook endpoints</name>
  <files>
    apps/web-portal/app/api/stripe/portal/route.ts
    apps/web-portal/app/api/stripe/webhook/route.ts
  </files>
  <action>
  **portal/route.ts - Customer Portal redirect:**

  ```typescript
  import { NextResponse } from 'next/server';
  import { requireAdmin, getOrganization } from '@/lib/auth/admin';
  import { createPortalSession } from '@/lib/stripe';

  export async function POST() {
    try {
      const session = await requireAdmin();

      if (!session.organizationId) {
        return NextResponse.json({ error: 'No organization' }, { status: 400 });
      }

      const org = await getOrganization(session.organizationId);

      if (!org?.stripeCustomerId) {
        return NextResponse.json({ error: 'No Stripe customer' }, { status: 400 });
      }

      const portalSession = await createPortalSession(
        org.stripeCustomerId,
        `${process.env.NEXT_PUBLIC_APP_URL}/admin/billing`
      );

      return NextResponse.redirect(portalSession.url);
    } catch (error) {
      console.error('Portal session error:', error);
      return NextResponse.json({ error: 'Failed to create portal session' }, { status: 500 });
    }
  }
  ```

  **webhook/route.ts - Stripe webhook handler:**

  ```typescript
  import { NextRequest, NextResponse } from 'next/server';
  import { headers } from 'next/headers';
  import Stripe from 'stripe';
  import { stripe } from '@/lib/stripe';
  import { db, schema } from '@/lib/db';
  import { eq } from 'drizzle-orm';

  const { organizations } = schema;

  export async function POST(request: NextRequest) {
    const body = await request.text();
    const headersList = await headers();
    const signature = headersList.get('stripe-signature');

    if (!signature || !process.env.STRIPE_WEBHOOK_SECRET) {
      return NextResponse.json({ error: 'Missing signature' }, { status: 400 });
    }

    let event: Stripe.Event;

    try {
      event = stripe.webhooks.constructEvent(
        body,
        signature,
        process.env.STRIPE_WEBHOOK_SECRET
      );
    } catch (err) {
      console.error('Webhook signature verification failed:', err);
      return NextResponse.json({ error: 'Invalid signature' }, { status: 400 });
    }

    try {
      switch (event.type) {
        case 'customer.subscription.created':
        case 'customer.subscription.updated': {
          const subscription = event.data.object as Stripe.Subscription;
          const customerId = subscription.customer as string;

          await db
            .update(organizations)
            .set({
              stripeSubscriptionId: subscription.id,
              subscriptionStatus: subscription.status,
              seatCount: subscription.items.data[0]?.quantity || 1,
              updatedAt: new Date(),
            })
            .where(eq(organizations.stripeCustomerId, customerId));

          break;
        }

        case 'customer.subscription.deleted': {
          const subscription = event.data.object as Stripe.Subscription;
          const customerId = subscription.customer as string;

          await db
            .update(organizations)
            .set({
              subscriptionStatus: 'canceled',
              updatedAt: new Date(),
            })
            .where(eq(organizations.stripeCustomerId, customerId));

          break;
        }

        case 'checkout.session.completed': {
          const session = event.data.object as Stripe.Checkout.Session;
          const customerId = session.customer as string;
          const subscriptionId = session.subscription as string;

          // Link subscription to organization
          if (session.metadata?.organizationId) {
            await db
              .update(organizations)
              .set({
                stripeCustomerId: customerId,
                stripeSubscriptionId: subscriptionId,
                subscriptionStatus: 'active',
                planId: session.metadata.planId || 'pro',
                updatedAt: new Date(),
              })
              .where(eq(organizations.id, session.metadata.organizationId));
          }

          break;
        }

        default:
          console.log(`Unhandled event type: ${event.type}`);
      }

      return NextResponse.json({ received: true });
    } catch (error) {
      console.error('Webhook processing error:', error);
      return NextResponse.json({ error: 'Webhook processing failed' }, { status: 500 });
    }
  }
  ```
  </action>
  <verify>
  - Build succeeds: `npm run build --workspace=@slack-speak-for-me/web-portal`
  - Routes compile without errors
  </verify>
  <done>
  Customer Portal redirect and webhook endpoints created
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
  Complete Stripe billing integration with:
  - Billing dashboard showing subscription status
  - Customer Portal access for self-service billing
  - Webhook handlers for subscription events
  </what-built>
  <how-to-verify>
  1. Ensure Stripe environment variables are set (STRIPE_SECRET_KEY, STRIPE_PUBLISHABLE_KEY, STRIPE_WEBHOOK_SECRET)
  2. Visit /admin/billing as an admin user
  3. Verify the page shows subscription information (or "No organization" message)
  4. If org has Stripe customer, test Customer Portal button redirects to Stripe
  5. Test webhook endpoint with Stripe CLI: `stripe listen --forward-to localhost:3001/api/stripe/webhook`
  </how-to-verify>
  <resume-signal>Type "approved" after verifying billing functionality, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. Build succeeds: `npm run build --workspace=@slack-speak-for-me/web-portal`
2. Billing page renders with subscription info
3. Customer Portal button redirects to Stripe
4. Webhook endpoint processes subscription events
</verification>

<success_criteria>
- Stripe client and helpers work correctly
- Billing page shows subscription status and seat count
- Customer Portal button creates portal session and redirects
- Webhooks update organization subscription status in database
- User setup items documented in frontmatter
</success_criteria>

<output>
After completion, create `.planning/phases/06-production-polish-and-admin/06-09-SUMMARY.md`
</output>
