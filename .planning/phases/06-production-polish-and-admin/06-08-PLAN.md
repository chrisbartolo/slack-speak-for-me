---
phase: 06-production-polish-and-admin
plan: 08
type: execute
wave: 5
depends_on: ["06-07"]
files_modified:
  - apps/web-portal/app/admin/layout.tsx
  - apps/web-portal/app/admin/page.tsx
  - apps/web-portal/app/admin/organizations/page.tsx
  - apps/web-portal/app/admin/users/page.tsx
  - apps/web-portal/lib/db/admin-queries.ts
  - apps/web-portal/components/dashboard/sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view list of organizations in their scope"
    - "Admin can view users per organization"
    - "Admin sidebar link only visible to admins"
  artifacts:
    - path: "apps/web-portal/app/admin/layout.tsx"
      provides: "Admin layout with role check"
      contains: "requireAdmin"
    - path: "apps/web-portal/app/admin/organizations/page.tsx"
      provides: "Organization list page"
      contains: "getOrganizations"
  key_links:
    - from: "apps/web-portal/app/admin/layout.tsx"
      to: "lib/auth/admin.ts"
      via: "requireAdmin call"
      pattern: "await requireAdmin"
---

<objective>
Create admin panel with organization and user management

Purpose: Admins need visibility into organizations and users in their scope. This plan creates the admin section of the web portal with organization listing and user management pages.

Output: Admin layout, organizations page, and users page with data from database.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-production-polish-and-admin/06-07-PLAN.md
@apps/web-portal/app/dashboard/layout.tsx
@apps/web-portal/components/dashboard/sidebar.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin queries</name>
  <files>apps/web-portal/lib/db/admin-queries.ts</files>
  <action>
  Create admin-specific database queries:

  ```typescript
  import 'server-only';
  import { cache } from 'react';
  import { eq, desc, count } from 'drizzle-orm';
  import { db, schema } from './index';
  import { requireAdmin } from '../auth/admin';

  const { organizations, workspaces, users } = schema;

  /**
   * Get all organizations (for super-admin)
   * Or get the admin's own organization
   */
  export const getOrganizations = cache(async () => {
    const session = await requireAdmin();

    // If user has an organization, show just that one
    // Otherwise, for now, show nothing (future: super-admin sees all)
    if (session.organizationId) {
      const [org] = await db
        .select()
        .from(organizations)
        .where(eq(organizations.id, session.organizationId))
        .limit(1);

      return org ? [org] : [];
    }

    // No org yet - return empty
    return [];
  });

  /**
   * Get workspaces for an organization
   */
  export const getOrganizationWorkspaces = cache(async (organizationId: string) => {
    await requireAdmin(); // Verify admin access

    const results = await db
      .select()
      .from(workspaces)
      .where(eq(workspaces.organizationId, organizationId))
      .orderBy(desc(workspaces.createdAt));

    return results;
  });

  /**
   * Get users for a workspace
   */
  export const getWorkspaceUsers = cache(async (workspaceId: string) => {
    await requireAdmin(); // Verify admin access

    const results = await db
      .select()
      .from(users)
      .where(eq(users.workspaceId, workspaceId))
      .orderBy(desc(users.createdAt));

    return results;
  });

  /**
   * Get user count per workspace
   */
  export const getUserCounts = cache(async (organizationId: string) => {
    await requireAdmin();

    const results = await db
      .select({
        workspaceId: workspaces.id,
        userCount: count(users.id),
      })
      .from(workspaces)
      .leftJoin(users, eq(users.workspaceId, workspaces.id))
      .where(eq(workspaces.organizationId, organizationId))
      .groupBy(workspaces.id);

    return Object.fromEntries(results.map(r => [r.workspaceId, r.userCount]));
  });
  ```
  </action>
  <verify>
  - Build succeeds: `npm run build --workspace=@slack-speak-for-me/web-portal`
  - Queries export correctly
  </verify>
  <done>
  Admin queries for organizations, workspaces, and users created
  </done>
</task>

<task type="auto">
  <name>Task 2: Create admin layout and pages</name>
  <files>
    apps/web-portal/app/admin/layout.tsx
    apps/web-portal/app/admin/page.tsx
    apps/web-portal/app/admin/organizations/page.tsx
    apps/web-portal/app/admin/users/page.tsx
  </files>
  <action>
  Create admin section pages:

  **layout.tsx:**
  ```tsx
  import { requireAdmin } from '@/lib/auth/admin';
  import { Sidebar } from '@/components/dashboard/sidebar';

  export default async function AdminLayout({
    children,
  }: {
    children: React.ReactNode;
  }) {
    await requireAdmin(); // Blocks non-admins

    return (
      <div className="flex min-h-screen">
        <Sidebar isAdmin />
        <main className="flex-1 bg-gray-50">
          {children}
        </main>
      </div>
    );
  }
  ```

  **page.tsx (admin dashboard):**
  ```tsx
  import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
  import { Building2, Users, CreditCard } from 'lucide-react';
  import Link from 'next/link';

  export default function AdminPage() {
    return (
      <div className="p-8 space-y-6">
        <div>
          <h1 className="text-3xl font-bold">Admin Dashboard</h1>
          <p className="text-muted-foreground mt-1">
            Manage organizations, users, and billing
          </p>
        </div>

        <div className="grid gap-4 md:grid-cols-3">
          <Link href="/admin/organizations">
            <Card className="hover:border-primary transition-colors cursor-pointer">
              <CardHeader>
                <Building2 className="h-8 w-8 text-primary mb-2" />
                <CardTitle>Organizations</CardTitle>
                <CardDescription>Manage workspaces and settings</CardDescription>
              </CardHeader>
            </Card>
          </Link>

          <Link href="/admin/users">
            <Card className="hover:border-primary transition-colors cursor-pointer">
              <CardHeader>
                <Users className="h-8 w-8 text-primary mb-2" />
                <CardTitle>Users</CardTitle>
                <CardDescription>View and manage team members</CardDescription>
              </CardHeader>
            </Card>
          </Link>

          <Link href="/admin/billing">
            <Card className="hover:border-primary transition-colors cursor-pointer">
              <CardHeader>
                <CreditCard className="h-8 w-8 text-primary mb-2" />
                <CardTitle>Billing</CardTitle>
                <CardDescription>Subscription and payment settings</CardDescription>
              </CardHeader>
            </Card>
          </Link>
        </div>
      </div>
    );
  }
  ```

  **organizations/page.tsx:**
  ```tsx
  import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
  import { EmptyState } from '@/components/dashboard/empty-state';
  import { Building2 } from 'lucide-react';
  import { getOrganizations } from '@/lib/db/admin-queries';
  import { formatDistanceToNow } from 'date-fns';

  export default async function OrganizationsPage() {
    const organizations = await getOrganizations();

    return (
      <div className="p-8 space-y-6">
        <div>
          <h1 className="text-3xl font-bold">Organizations</h1>
          <p className="text-muted-foreground mt-1">
            Manage your organizations and workspaces
          </p>
        </div>

        <Card>
          <CardHeader>
            <CardTitle>Your Organizations</CardTitle>
            <CardDescription>
              {organizations.length === 0
                ? 'No organizations found'
                : `${organizations.length} organization(s)`}
            </CardDescription>
          </CardHeader>
          <CardContent>
            {organizations.length === 0 ? (
              <EmptyState
                icon={Building2}
                title="No organizations"
                description="Organizations are created when workspaces subscribe to a paid plan."
              />
            ) : (
              <div className="space-y-4">
                {organizations.map((org) => (
                  <div key={org.id} className="flex items-center justify-between p-4 border rounded-lg">
                    <div>
                      <p className="font-medium">{org.name}</p>
                      <p className="text-sm text-muted-foreground">
                        {org.planId || 'Free'} plan - {org.seatCount} seats
                      </p>
                    </div>
                    <div className="text-sm text-muted-foreground">
                      Status: {org.subscriptionStatus || 'None'}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </CardContent>
        </Card>
      </div>
    );
  }
  ```

  **users/page.tsx:**
  ```tsx
  import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
  import { EmptyState } from '@/components/dashboard/empty-state';
  import { Users } from 'lucide-react';
  import { requireAdmin } from '@/lib/auth/admin';
  import { getWorkspaceUsers } from '@/lib/db/admin-queries';
  import { Badge } from '@/components/ui/badge';

  export default async function UsersPage() {
    const session = await requireAdmin();
    const users = await getWorkspaceUsers(session.workspaceId);

    return (
      <div className="p-8 space-y-6">
        <div>
          <h1 className="text-3xl font-bold">Users</h1>
          <p className="text-muted-foreground mt-1">
            Team members in your workspace
          </p>
        </div>

        <Card>
          <CardHeader>
            <CardTitle>Team Members</CardTitle>
            <CardDescription>
              {users.length} user(s) in this workspace
            </CardDescription>
          </CardHeader>
          <CardContent>
            {users.length === 0 ? (
              <EmptyState
                icon={Users}
                title="No users"
                description="Users appear here when they interact with the app."
              />
            ) : (
              <div className="space-y-2">
                {users.map((user) => (
                  <div key={user.id} className="flex items-center justify-between p-3 border rounded-lg">
                    <div>
                      <p className="font-medium">{user.email || user.slackUserId}</p>
                      <p className="text-sm text-muted-foreground">
                        {user.slackUserId}
                      </p>
                    </div>
                    <Badge variant={user.role === 'admin' ? 'default' : 'secondary'}>
                      {user.role || 'member'}
                    </Badge>
                  </div>
                ))}
              </div>
            )}
          </CardContent>
        </Card>
      </div>
    );
  }
  ```
  </action>
  <verify>
  - Build succeeds: `npm run build --workspace=@slack-speak-for-me/web-portal`
  - Pages render correctly
  </verify>
  <done>
  Admin layout, dashboard, organizations page, and users page created
  </done>
</task>

<task type="auto">
  <name>Task 3: Add admin link to sidebar for admins</name>
  <files>apps/web-portal/components/dashboard/sidebar.tsx</files>
  <action>
  Update sidebar to show admin link conditionally:

  1. Accept isAdmin prop:
     ```tsx
     interface SidebarProps {
       isAdmin?: boolean;
     }

     export function Sidebar({ isAdmin }: SidebarProps) {
     ```

  2. Add admin section at the bottom (before logout):
     ```tsx
     {isAdmin && (
       <div className="border-t pt-4 mt-4">
         <Link
           href="/admin"
           className={cn(
             "flex items-center gap-2 px-3 py-2 rounded-lg text-sm",
             pathname.startsWith('/admin')
               ? "bg-primary text-primary-foreground"
               : "text-gray-600 hover:bg-gray-100"
           )}
         >
           <Settings className="h-4 w-4" />
           Admin
         </Link>
       </div>
     )}
     ```

  3. In dashboard layout, fetch isAdmin status and pass to Sidebar:
     ```tsx
     // In dashboard/layout.tsx
     import { isAdmin } from '@/lib/auth/admin';

     export default async function DashboardLayout({ children }) {
       const adminStatus = await isAdmin();

       return (
         <div className="flex min-h-screen">
           <Sidebar isAdmin={adminStatus} />
           <main>{children}</main>
         </div>
       );
     }
     ```

  4. Import Settings icon from lucide-react.
  </action>
  <verify>
  - Build succeeds: `npm run build --workspace=@slack-speak-for-me/web-portal`
  - Admin link only appears for admin users
  </verify>
  <done>
  Sidebar shows Admin link only for users with admin role
  </done>
</task>

</tasks>

<verification>
1. Build succeeds: `npm run build --workspace=@slack-speak-for-me/web-portal`
2. /admin routes require admin role
3. Admin dashboard shows navigation cards
4. Organizations page lists user's org
5. Users page lists workspace members
6. Sidebar Admin link only visible to admins
</verification>

<success_criteria>
- Admin layout uses requireAdmin for protection
- Admin dashboard has cards linking to sections
- Organizations page shows org details
- Users page shows workspace members with role badges
- Sidebar conditionally shows Admin link
</success_criteria>

<output>
After completion, create `.planning/phases/06-production-polish-and-admin/06-08-SUMMARY.md`
</output>
