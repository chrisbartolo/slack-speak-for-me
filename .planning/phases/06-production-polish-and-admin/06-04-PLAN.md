---
phase: 06-production-polish-and-admin
plan: 04
type: execute
wave: 3
depends_on: ["06-03"]
files_modified:
  - apps/slack-backend/src/handlers/actions/copy-suggestion.ts
  - apps/slack-backend/src/handlers/actions/dismiss-suggestion.ts
  - apps/slack-backend/src/handlers/actions/copy-final-suggestion.ts
  - apps/slack-backend/src/handlers/views/refinement-modal.ts
autonomous: true

must_haves:
  truths:
    - "Clicking Copy without refinement tracks 'accepted' action"
    - "Submitting refinement modal tracks 'refined' action"
    - "Clicking Dismiss tracks 'dismissed' action"
  artifacts:
    - path: "apps/slack-backend/src/handlers/actions/copy-suggestion.ts"
      provides: "Acceptance tracking on copy"
      contains: "trackAcceptance"
    - path: "apps/slack-backend/src/handlers/views/refinement-modal.ts"
      provides: "Refinement tracking on submit"
      contains: "trackRefinement"
  key_links:
    - from: "apps/slack-backend/src/handlers/actions/copy-suggestion.ts"
      to: "services/feedback-tracker.ts"
      via: "trackAcceptance call"
      pattern: "await trackAcceptance\\("
    - from: "apps/slack-backend/src/handlers/views/refinement-modal.ts"
      to: "services/feedback-tracker.ts"
      via: "trackRefinement call"
      pattern: "await trackRefinement\\("
---

<objective>
Wire feedback tracking into action handlers

Purpose: Connect the feedback-tracker service to the user action handlers so that Copy, Refine, and Dismiss actions are tracked in the database. This enables the AI Learning tab to show accurate acceptance vs refinement statistics.

Output: All suggestion action handlers track user feedback to suggestionFeedback table.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/06-production-polish-and-admin/06-03-PLAN.md
@apps/slack-backend/src/handlers/actions/copy-suggestion.ts
@apps/slack-backend/src/handlers/actions/dismiss-suggestion.ts
@apps/slack-backend/src/handlers/views/refinement-modal.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Track acceptance in copy-suggestion handler</name>
  <files>apps/slack-backend/src/handlers/actions/copy-suggestion.ts</files>
  <action>
  Update the copy-suggestion action handler to track acceptance:

  1. Import trackAcceptance:
     ```typescript
     import { trackAcceptance } from '../../services/feedback-tracker.js';
     ```

  2. Extract suggestion text and ID from the action payload. The suggestion text is typically in the action value or message blocks. Look at the existing code to find where the suggestion content comes from.

  3. After the existing logic (before returning), add tracking:
     ```typescript
     // Track acceptance (user copied without refinement)
     const suggestionId = action.value || `${message.ts}-${user.id}`;
     const suggestionText = /* extract from blocks or message */;

     await trackAcceptance(
       workspaceId,
       user.id,
       suggestionId,
       suggestionText,
       body.channel?.id
     );
     ```

  Note: The suggestion ID should be unique per suggestion. If action.value contains a unique ID, use that. Otherwise, generate one from timestamp + user.
  </action>
  <verify>
  - Build succeeds: `npm run build --workspace=slack-backend`
  - TypeScript compiles without errors
  </verify>
  <done>
  Clicking Copy on an unmodified suggestion tracks 'accepted' in database
  </done>
</task>

<task type="auto">
  <name>Task 2: Track dismissal in dismiss-suggestion handler</name>
  <files>apps/slack-backend/src/handlers/actions/dismiss-suggestion.ts</files>
  <action>
  Update the dismiss-suggestion action handler to track dismissal:

  1. Import trackDismissal:
     ```typescript
     import { trackDismissal } from '../../services/feedback-tracker.js';
     ```

  2. Add tracking before deleting the ephemeral message:
     ```typescript
     const suggestionId = action.value || `${message.ts}-${user.id}`;

     await trackDismissal(
       workspaceId,
       user.id,
       suggestionId,
       undefined, // Don't need to store text for dismissals
       body.channel?.id
     );
     ```

  3. Keep existing ephemeral message deletion logic.
  </action>
  <verify>
  - Build succeeds: `npm run build --workspace=slack-backend`
  </verify>
  <done>
  Clicking Dismiss tracks 'dismissed' in database
  </done>
</task>

<task type="auto">
  <name>Task 3: Track refinement in refinement-modal submission</name>
  <files>
    apps/slack-backend/src/handlers/views/refinement-modal.ts
    apps/slack-backend/src/handlers/actions/copy-final-suggestion.ts
  </files>
  <action>
  Update refinement modal and copy-final handlers to track refinement:

  **In refinement-modal.ts:**

  1. Import trackRefinement:
     ```typescript
     import { trackRefinement } from '../../services/feedback-tracker.js';
     ```

  2. When the user submits the refinement modal (either final copy or another refinement iteration), track it. Find the submission handler and add:
     ```typescript
     // Track refinement feedback
     // originalText = the initial AI suggestion
     // refinedText = the user's modified version
     await trackRefinement(
       workspaceId,
       user.id,
       suggestionId,
       originalText,
       refinedText,
       channelId
     );
     ```

  **In copy-final-suggestion.ts:**

  If this handler is used for copying after refinement (vs the initial copy), update it similarly:
  - Check if the text was refined (compare to original)
  - If refined: use trackRefinement
  - If unchanged: use trackAcceptance

  Note: The existing refinementFeedback table tracks the modification type. The new suggestionFeedback table tracks the action (accepted vs refined). Both can coexist for different purposes.
  </action>
  <verify>
  - Build succeeds: `npm run build --workspace=slack-backend`
  - No TypeScript errors
  </verify>
  <done>
  Refinement modal submission tracks 'refined' action with original and final text
  </done>
</task>

</tasks>

<verification>
1. Build succeeds: `npm run build --workspace=slack-backend`
2. All action handlers import and call feedback-tracker functions
3. No runtime errors when testing via /test page
</verification>

<success_criteria>
- Copy action tracks 'accepted' for unmodified suggestions
- Dismiss action tracks 'dismissed'
- Refinement submission tracks 'refined' with text diff
- All tracking is non-blocking (errors logged but don't break flow)
</success_criteria>

<output>
After completion, create `.planning/phases/06-production-polish-and-admin/06-04-SUMMARY.md`
</output>
