---
phase: 11.1-usage-tracking
plan: 04
subsystem: billing
tags: [stripe, billing-meters, bullmq, cron, idempotency, batch-reporting]

# Dependency graph
requires:
  - phase: 11.1-usage-tracking
    plan: 01
    provides: stripeReportedAt tracking column and usage infrastructure
provides:
  - Stripe meter reporter service with dual-path customer lookup
  - Daily BullMQ job for batch usage reporting to Stripe
  - Idempotent event reporting prevents duplicate charges
  - Graceful handling of missing Stripe config
affects: [11.1-usage-enforcement, stripe-billing]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Lazy Stripe client initialization for optional config"
    - "Dual-path customer lookup (individual -> organization)"
    - "Idempotency keys prevent duplicate billing on retries"
    - "Daily cron scheduler with 2 AM UTC timing"
    - "Batch processing limited to 500 events per run"

key-files:
  created:
    - apps/slack-backend/src/services/stripe-meter-reporter.ts
  modified:
    - apps/slack-backend/src/services/index.ts
    - apps/slack-backend/src/jobs/types.ts
    - apps/slack-backend/src/jobs/queues.ts
    - apps/slack-backend/src/jobs/workers.ts
    - apps/slack-backend/src/jobs/schedulers.ts
    - apps/slack-backend/src/jobs/index.ts
    - apps/slack-backend/src/index.ts

key-decisions:
  - "reportUsageToStripe() uses ${workspaceId}-${userId}-${eventId} as idempotency identifier"
  - "Dual-path lookup: individual subscription first, organization fallback second"
  - "Skip events without Stripe customer (free tier users)"
  - "Handle resource_already_exists error as success (idempotent)"
  - "Limit batch to 500 events per run to avoid long-running jobs"
  - "35-day lookback matches Stripe's maximum event age"
  - "Daily 2 AM UTC scheduling avoids peak usage times"

patterns-established:
  - "Lazy Stripe client with null return for missing config"
  - "Batch job returns summary object (total, reported, skipped, failed)"
  - "Worker concurrency: 1 for batch jobs to avoid conflicts"
  - "Exponential backoff: 1 min, 2 min, 4 min for retries"

# Metrics
duration: 5min
completed: 2026-02-03
---

# Phase 11.1 Plan 04: Stripe Billing Meters Integration Summary

**Daily batch job reports unreported usage events to Stripe with idempotent event creation and dual-path customer ID resolution**

## Performance

- **Duration:** 5 min
- **Started:** 2026-02-03T07:57:13Z
- **Completed:** 2026-02-03T08:02:23Z
- **Tasks:** 2
- **Files modified:** 8

## Accomplishments

- Created Stripe meter reporter service with lazy client initialization
- Implemented reportUsageToStripe() for single events with idempotency keys
- Implemented reportUnreportedUsageBatch() with dual-path customer lookup
- Added daily BullMQ job for automated usage reporting at 2 AM UTC
- Integrated usage reporter worker with exponential backoff retries
- Graceful handling of missing Stripe config and network failures

## Task Commits

Each task was committed atomically:

1. **Task 1: Create Stripe meter reporter service** - `ae392df` (feat)
2. **Task 2: Create daily usage reporting BullMQ job** - `8758463` (feat)

## Files Created/Modified

- `apps/slack-backend/src/services/stripe-meter-reporter.ts` - Stripe Billing Meters integration with dual-path customer lookup
- `apps/slack-backend/src/services/index.ts` - Exported stripe-meter-reporter functions
- `apps/slack-backend/src/jobs/types.ts` - Added UsageReporterJobData/Result types
- `apps/slack-backend/src/jobs/queues.ts` - Added usageReporterQueue with exponential backoff
- `apps/slack-backend/src/jobs/workers.ts` - Added usage-reporter worker implementation
- `apps/slack-backend/src/jobs/schedulers.ts` - Added setupUsageReporterScheduler() for daily cron
- `apps/slack-backend/src/jobs/index.ts` - Exported usage reporter scheduler
- `apps/slack-backend/src/index.ts` - Called setupUsageReporterScheduler() on startup

## Decisions Made

1. **Idempotency identifier format** - `${workspaceId}-${userId}-${eventId}` ensures unique identification across retries
2. **Dual-path customer lookup** - Check individual subscription first, then organization (mirrors access check pattern)
3. **Skip free tier users** - Events without Stripe customer ID are skipped (not errors)
4. **Idempotent success handling** - `resource_already_exists` error treated as success
5. **500 event batch limit** - Prevents long-running transactions and memory issues
6. **35-day lookback window** - Matches Stripe's maximum event age for billing meters
7. **2 AM UTC scheduling** - Runs during low-traffic hours to minimize impact
8. **Lazy Stripe client** - Returns null if STRIPE_SECRET_KEY not configured (non-fatal)

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

1. **Stripe API version mismatch** - Fixed by updating from `2024-11-20.acacia` to `2026-01-28.clover` to match web-portal
2. **TypeScript cache issue** - Resolved by rebuilding database package after schema changes

## User Setup Required

**Required after deployment:**

1. **Create Stripe Billing Meter:**
   - Dashboard -> More -> Billing -> Meters -> Create meter
   - Name: "AI Suggestions"
   - Event name: `ai_suggestion`
   - Aggregation: Sum
   - Payload key: `value`

2. **Link meter to plans:**
   - Dashboard -> Products -> Edit each plan -> Add metered price
   - Link to the "AI Suggestions" meter
   - Set overage rate (e.g., $0.35/suggestion for Starter)

3. **Environment variable:**
   - Set `STRIPE_METER_EVENT_NAME=ai_suggestion` (or leave default)
   - Ensure `STRIPE_SECRET_KEY` is configured

## Next Phase Readiness

**Ready for next plan:**
- Usage events automatically reported to Stripe daily
- Idempotency prevents duplicate charges
- Dual-path customer lookup handles both individual and team billing
- Worker integrates cleanly with existing BullMQ infrastructure
- Graceful degradation when Stripe not configured

**No blockers or concerns.**

---
*Phase: 11.1-usage-tracking*
*Completed: 2026-02-03*
