---
phase: 11.1-usage-tracking
plan: 01
subsystem: billing
tags: [stripe, usage-tracking, drizzle-orm, billing-meters, atomic-operations]

# Dependency graph
requires:
  - phase: 11-individual-billing
    provides: userSubscriptions table and individual billing flow
provides:
  - Stripe tracking columns (stripeReportedAt, stripeMeterId, planId)
  - Server-side usage query functions (getCurrentUsage, getUsageHistory, getOrgUsageSummary)
  - Atomic usage increment to prevent race conditions
  - Usage warning levels (WARNING: 0.8, CRITICAL: 0.95, HARD_CAP: 1.0)
  - FREE_PLAN canonical definition
affects: [11.1-usage-enforcement, 11.1-usage-dashboard, stripe-integration]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "Atomic SQL increments for concurrent usage updates"
    - "Server-only usage queries with explicit billing period calculation"
    - "Warning levels based on usage thresholds"

key-files:
  created:
    - apps/web-portal/lib/billing/usage-queries.ts
  modified:
    - packages/database/src/schema.ts
    - apps/slack-backend/src/services/usage-enforcement.ts
    - apps/web-portal/lib/billing/plans.config.ts

key-decisions:
  - "Use stripeReportedAt timestamp on usageEvents to track batch reporting status"
  - "Store planId and stripeMeterId on usageRecords for historical reference"
  - "Atomic SQL increment prevents race condition in concurrent usage recording"
  - "Warning levels computed at 80% (warning) and 95% (critical) of limit"
  - "FREE_PLAN defined in plans.config.ts as canonical source of truth"

patterns-established:
  - "Usage queries follow server-only pattern with explicit billing period calculation"
  - "PLAN_LIMITS kept in sync with plans.config.ts plan IDs"
  - "UsageCheckResult and getUsageStatus return warningLevel and overageRate"

# Metrics
duration: 3min
completed: 2026-02-03
---

# Phase 11.1 Plan 01: Usage Tracking Infrastructure Summary

**Stripe Billing Meters integration columns added, server-side usage queries created, atomic increment prevents race conditions, warning levels computed at 80%/95% thresholds**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-03T07:52:14Z
- **Completed:** 2026-02-03T07:55:02Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments
- Added Stripe tracking columns (stripeReportedAt, stripeMeterId, planId) for batch reporting integration
- Created server-side usage query functions (getCurrentUsage, getUsageHistory, getOrgUsageSummary)
- Fixed race condition in usage recording with atomic SQL increment
- Added usage warning levels (WARNING: 0.8, CRITICAL: 0.95, HARD_CAP: 1.0)
- Defined FREE_PLAN in canonical plans.config.ts

## Task Commits

Each task was committed atomically:

1. **Task 1: Add Stripe tracking columns and create usage queries** - `0d9c1c7` (feat)
2. **Task 2: Align plan limits and fix usage tracking race condition** - `940341e` (feat)

## Files Created/Modified
- `packages/database/src/schema.ts` - Added stripeReportedAt to usageEvents, stripeMeterId/planId to usageRecords, index on stripeReportedAt
- `apps/web-portal/lib/billing/usage-queries.ts` - Created server-side usage query functions with proper billing period calculation
- `apps/slack-backend/src/services/usage-enforcement.ts` - Aligned PLAN_LIMITS, added atomic increment, added USAGE_THRESHOLDS and warningLevel
- `apps/web-portal/lib/billing/plans.config.ts` - Added FREE_PLAN as canonical definition

## Decisions Made

1. **stripeReportedAt timestamp** - Tracks which usage events have been reported to Stripe Billing Meters (null = not yet reported)
2. **stripeMeterId and planId on usageRecords** - Historical tracking for which Stripe meter and plan were active during each billing period
3. **Atomic SQL increment** - Changed from `suggestionsUsed: record.suggestionsUsed + 1` to `sql\`${usageRecords.suggestionsUsed} + 1\`` to prevent race conditions when multiple suggestions are generated concurrently
4. **Warning level thresholds** - WARNING at 80%, CRITICAL at 95%, HARD_CAP at 100% for UI feedback
5. **FREE_PLAN in plans.config.ts** - Canonical definition ensures consistency between web-portal and slack-backend
6. **PLAN_LIMITS alignment** - Updated to match actual plan IDs (free, starter, pro, team, business) from plans.config.ts

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None - all tasks completed as specified.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

**Ready for next plan:**
- Usage tracking columns support Stripe Billing Meters batch reporting
- Server-side queries ready for dashboard display
- Atomic operations prevent concurrent usage recording bugs
- Warning levels ready for UI display
- Plan limits aligned across backend and web-portal

**No blockers or concerns.**

---
*Phase: 11.1-usage-tracking*
*Completed: 2026-02-03*
