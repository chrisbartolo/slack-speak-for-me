---
phase: 11.1-usage-tracking
plan: 03
type: execute
wave: 2
depends_on: ["11.1-01"]
files_modified:
  - apps/web-portal/app/dashboard/usage/page.tsx
  - apps/web-portal/components/usage/usage-meter.tsx
  - apps/web-portal/components/usage/usage-alert.tsx
  - apps/web-portal/components/dashboard/sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "User can navigate to /dashboard/usage from sidebar"
    - "Usage dashboard shows progress bar with current month consumption"
    - "Usage dashboard shows numeric count (X/Y suggestions used)"
    - "Warning alert appears when user exceeds 80% of monthly limit"
    - "Critical alert appears when user exceeds 95% of monthly limit"
    - "Upgrade CTA shown for free-tier users approaching limits"
    - "Billing period end date and days remaining displayed"
  artifacts:
    - path: "apps/web-portal/app/dashboard/usage/page.tsx"
      provides: "Usage dashboard page with server-side data fetching"
      contains: "getCurrentUsage"
    - path: "apps/web-portal/components/usage/usage-meter.tsx"
      provides: "Progress bar component with color-coded usage percentage"
      exports: ["UsageMeter"]
    - path: "apps/web-portal/components/usage/usage-alert.tsx"
      provides: "Warning and critical alert components for usage limits"
      exports: ["UsageAlert"]
  key_links:
    - from: "apps/web-portal/app/dashboard/usage/page.tsx"
      to: "apps/web-portal/lib/billing/usage-queries.ts"
      via: "getCurrentUsage() server-side call"
      pattern: "getCurrentUsage"
    - from: "apps/web-portal/app/dashboard/usage/page.tsx"
      to: "apps/web-portal/lib/billing/plans.config.ts"
      via: "getPlanById() for plan details"
      pattern: "getPlanById"
    - from: "apps/web-portal/components/dashboard/sidebar.tsx"
      to: "apps/web-portal/app/dashboard/usage/page.tsx"
      via: "NavItem link to /dashboard/usage"
      pattern: "/dashboard/usage"
---

<objective>
Create a user-facing usage dashboard page showing current month consumption, warnings, and upgrade options.

Purpose: Users currently have no visibility into how many AI suggestions they've used this month. This plan creates a `/dashboard/usage` page with a visual progress bar, usage stats, tiered warning alerts (80%/95%/100%), and an upgrade CTA for users approaching limits. This is the primary user-facing component of the usage tracking system.

Output: Usage dashboard page accessible from sidebar, with meter visualization and alert components.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/11.1-usage-tracking/11.1-RESEARCH.md
@.planning/phases/11.1-usage-tracking/11.1-01-SUMMARY.md
@apps/web-portal/lib/billing/plans.config.ts
@apps/web-portal/components/dashboard/sidebar.tsx
@apps/web-portal/app/dashboard/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create UsageMeter and UsageAlert components</name>
  <files>
    apps/web-portal/components/usage/usage-meter.tsx
    apps/web-portal/components/usage/usage-alert.tsx
  </files>
  <action>
    1. Create `apps/web-portal/components/usage/usage-meter.tsx`:
       - Client component ('use client')
       - Props interface:
         ```typescript
         interface UsageMeterProps {
           used: number;
           limit: number;
           planName: string;
           overageRate: number; // cents
           billingPeriodEnd: string; // ISO date string
         }
         ```
       - Renders:
         - Header row: Zap icon + "AI Suggestions" label on left, "X / Y used" on right
         - shadcn/ui Progress bar (import from @/components/ui/progress)
           - Color classes based on percentage: <80% default (indigo), 80-95% yellow, 95%+ red
           - Use `value={Math.min(percentUsed, 100)}` to cap at 100% visually
         - Stats row below progress bar: Plan name on left, days remaining on right
         - If in overage (used > limit): show overage count and estimated overage cost
           - `Overage: X extra suggestions (est. ${CURRENCY.symbol}${cost.toFixed(2)})`
         - Import CURRENCY and formatOverageRate from plans.config

    2. Create `apps/web-portal/components/usage/usage-alert.tsx`:
       - Client component ('use client')
       - Props interface:
         ```typescript
         interface UsageAlertProps {
           warningLevel: 'safe' | 'warning' | 'critical' | 'exceeded';
           used: number;
           limit: number;
           planId: string;
           daysRemaining: number;
         }
         ```
       - Renders based on warningLevel:
         - `safe`: no alert rendered (return null)
         - `warning`: Info-style Alert (blue) - "You've used {percentUsed}% of your monthly suggestions. Resets in {daysRemaining} days."
         - `critical`: Warning-style Alert (yellow/orange) - "Only {remaining} suggestions remaining this month!"
         - `exceeded`: Destructive-style Alert (red):
           - For free-tier (planId === 'free'): "You've reached your monthly limit. Upgrade for more suggestions." with upgrade Button linking to /pricing
           - For paid tiers: "You've exceeded your included suggestions. Additional usage will be billed at the overage rate."
       - Use shadcn/ui Alert, AlertTitle, AlertDescription components
       - Use lucide-react icons: AlertTriangle for warning/critical, XCircle for exceeded, TrendingUp for upgrade CTA
  </action>
  <verify>
    - Run `npx tsc --noEmit` in apps/web-portal to confirm compilation
    - Grep for `UsageMeter` in usage-meter.tsx to confirm export
    - Grep for `UsageAlert` in usage-alert.tsx to confirm export
    - Verify Progress import from @/components/ui/progress
  </verify>
  <done>
    UsageMeter renders a color-coded progress bar with usage stats. UsageAlert shows tiered warnings based on consumption level. Both components are client-side and reusable.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create usage dashboard page and add sidebar link</name>
  <files>
    apps/web-portal/app/dashboard/usage/page.tsx
    apps/web-portal/components/dashboard/sidebar.tsx
  </files>
  <action>
    1. Create `apps/web-portal/app/dashboard/usage/page.tsx` as a SERVER component:
       - Import `verifySession` from `@/lib/auth/dal`
       - Import `getCurrentUsage`, `getUsageHistory` from `@/lib/billing/usage-queries`
       - Import `getPlanById`, `USAGE_THRESHOLDS`, `CURRENCY`, `formatOverageRate` from `@/lib/billing/plans.config`
       - Import `checkUserAccess` from `@/lib/billing/access-check`
       - Import UsageMeter and UsageAlert components

       - Server-side data fetching:
         ```typescript
         const session = await verifySession();
         const access = await checkUserAccess(session.email, session.workspaceId);
         const usage = session.email ? await getCurrentUsage(session.email) : null;
         const history = session.email ? await getUsageHistory(session.email, 6) : [];
         ```

       - Determine plan info:
         ```typescript
         const planId = access.hasAccess ? (access.planId || 'free') : 'free';
         const plan = getPlanById(planId);
         ```

       - Compute usage values (default to 0/5 if no record):
         ```typescript
         const used = usage?.suggestionsUsed ?? 0;
         const limit = usage?.suggestionsIncluded ?? (plan?.includedSuggestions ?? 5);
         const percentUsed = limit > 0 ? (used / limit) * 100 : 0;
         const billingPeriodEnd = usage?.billingPeriodEnd ?? new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0);
         const daysRemaining = Math.max(0, Math.ceil((new Date(billingPeriodEnd).getTime() - Date.now()) / (1000 * 60 * 60 * 24)));
         ```

       - Compute warningLevel:
         ```typescript
         let warningLevel: 'safe' | 'warning' | 'critical' | 'exceeded' = 'safe';
         if (percentUsed >= 100) warningLevel = 'exceeded';
         else if (percentUsed >= 95) warningLevel = 'critical';
         else if (percentUsed >= 80) warningLevel = 'warning';
         ```

       - Page layout using Card components:
         - Page title "Usage" with description "Track your AI suggestion usage for the current billing period"
         - UsageAlert component (shows warning if applicable)
         - Card containing UsageMeter component
         - "Billing Period" card showing: start date, end date, days remaining, plan name
         - "Usage History" card showing last 6 months as a simple table:
           | Month | Used | Included | Overage |
           Each row from `history` array. Format month as `Month YYYY`.
         - If history is empty, show "No usage history yet" message

       - Add Next.js metadata export:
         ```typescript
         export const metadata = { title: 'Usage' };
         ```

    2. In `apps/web-portal/components/dashboard/sidebar.tsx`:
       - Add a NavItem for Usage between "AI Learning" and "Reports":
         ```tsx
         <NavItem href="/dashboard/usage" icon={BarChart3} label="Usage" />
         ```
       - Import `BarChart3` from lucide-react (add to existing import)
  </action>
  <verify>
    - Run `npx tsc --noEmit` in apps/web-portal to confirm compilation
    - Grep for `/dashboard/usage` in sidebar.tsx to confirm nav link
    - Grep for `getCurrentUsage` in page.tsx to confirm server-side data fetch
    - Grep for `UsageMeter` in page.tsx to confirm component usage
    - Grep for `UsageAlert` in page.tsx to confirm alert rendering
  </verify>
  <done>
    Usage dashboard page exists at /dashboard/usage. Shows progress bar, usage stats, tiered warnings, billing period info, and 6-month history table. Sidebar has "Usage" link with BarChart3 icon.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes in apps/web-portal
2. /dashboard/usage page renders with server-side usage data
3. UsageMeter shows color-coded progress bar
4. UsageAlert shows appropriate warning at 80%/95%/100% thresholds
5. Sidebar shows "Usage" link between "AI Learning" and "Reports"
6. Usage history table shows past billing periods
</verification>

<success_criteria>
- Users can navigate to /dashboard/usage from sidebar
- Page shows current month usage as progress bar with numeric count
- Tiered alerts appear at 80% (info), 95% (warning), 100% (critical/upgrade)
- Billing period dates and days remaining displayed
- Usage history table shows past 6 months
- Free-tier users see upgrade CTA when approaching limits
</success_criteria>

<output>
After completion, create `.planning/phases/11.1-usage-tracking/11.1-03-SUMMARY.md`
</output>
