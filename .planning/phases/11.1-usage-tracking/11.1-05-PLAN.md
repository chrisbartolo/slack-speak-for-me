---
phase: 11.1-usage-tracking
plan: 05
type: execute
wave: 3
depends_on: ["11.1-02", "11.1-03"]
files_modified:
  - apps/web-portal/app/admin/usage/page.tsx
  - apps/web-portal/components/admin/usage-analytics.tsx
  - apps/web-portal/components/dashboard/sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can navigate to /admin/usage from admin sidebar section"
    - "Admin usage page shows total org usage for current billing period"
    - "Admin can see per-user usage breakdown with suggestions count"
    - "Admin page shows top users by usage"
    - "Admin page shows average usage per user"
  artifacts:
    - path: "apps/web-portal/app/admin/usage/page.tsx"
      provides: "Admin usage analytics page with org-wide data"
      contains: "getOrgUsageSummary"
    - path: "apps/web-portal/components/admin/usage-analytics.tsx"
      provides: "Organization usage analytics table component"
      exports: ["UsageAnalyticsTable"]
  key_links:
    - from: "apps/web-portal/app/admin/usage/page.tsx"
      to: "apps/web-portal/lib/billing/usage-queries.ts"
      via: "getOrgUsageSummary() server-side call"
      pattern: "getOrgUsageSummary"
    - from: "apps/web-portal/components/dashboard/sidebar.tsx"
      to: "apps/web-portal/app/admin/usage/page.tsx"
      via: "NavGroup item linking to /admin/usage"
      pattern: "/admin/usage"
---

<objective>
Create admin usage analytics page and update pricing page to prominently display usage allowances.

Purpose: Admins need visibility into organization-wide usage to understand team adoption and predict costs. This plan creates an admin analytics page at `/admin/usage` showing total org usage, per-user breakdown, and top users. It also adds a "Usage" link to the admin sidebar section.

Output: Admin usage analytics page with org-wide usage data.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/phases/11.1-usage-tracking/11.1-RESEARCH.md
@.planning/phases/11.1-usage-tracking/11.1-01-SUMMARY.md
@.planning/phases/11.1-usage-tracking/11.1-03-SUMMARY.md
@apps/web-portal/app/admin/layout.tsx
@apps/web-portal/components/dashboard/sidebar.tsx
@apps/web-portal/lib/billing/usage-queries.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin usage analytics component and page</name>
  <files>
    apps/web-portal/components/admin/usage-analytics.tsx
    apps/web-portal/app/admin/usage/page.tsx
  </files>
  <action>
    1. Create `apps/web-portal/components/admin/usage-analytics.tsx`:
       - Client component ('use client')
       - Props interface:
         ```typescript
         interface UsageAnalyticsTableProps {
           totalUsers: number;
           totalSuggestions: number;
           averagePerUser: number;
           topUsers: Array<{
             email: string;
             suggestionsUsed: number;
             suggestionsIncluded: number;
           }>;
           billingPeriodLabel: string; // e.g., "February 2026"
         }
         ```
       - Renders:
         - Summary cards row (3 cards in grid):
           - "Total Users" card with Users icon and count
           - "Total Suggestions" card with Zap icon and count
           - "Average per User" card with TrendingUp icon and count
         - "Top Users by Usage" table:
           - Columns: Email, Suggestions Used, Included, % Used, Status
           - Status column shows badge: "Under Limit" (green), "Near Limit" (yellow), "Over Limit" (red)
           - Use shadcn/ui Table, TableHeader, TableBody, TableRow, TableHead, TableCell
           - Use Badge component for status
         - If no users, show "No usage data for this billing period" empty state

    2. Create `apps/web-portal/app/admin/usage/page.tsx` as a SERVER component:
       - Import `requireAdmin` from `@/lib/auth/admin` for auth gating
       - Import `getOrgUsageSummary` from `@/lib/billing/usage-queries`
       - Import UsageAnalyticsTable component

       - Server-side data fetching:
         ```typescript
         const admin = await requireAdmin(); // Redirects if not admin
         // Get org from admin context
         const { getOrganization } = await import('@/lib/auth/admin');
         const org = await getOrganization();
         ```

       - If no org found, show "No organization found" message.

       - Otherwise fetch usage data:
         ```typescript
         const summary = await getOrgUsageSummary(org.id);
         ```

       - Compute billing period label: format current month as "Month YYYY" using Intl.DateTimeFormat

       - Page layout:
         - Title: "Usage Analytics"
         - Description: "Organization-wide AI suggestion usage for the current billing period"
         - UsageAnalyticsTable with data

       - Add Next.js metadata: `export const metadata = { title: 'Usage Analytics' }`
  </action>
  <verify>
    - Run `npx tsc --noEmit` in apps/web-portal to confirm compilation
    - Grep for `getOrgUsageSummary` in admin/usage/page.tsx to confirm data fetch
    - Grep for `UsageAnalyticsTable` in admin/usage/page.tsx to confirm component usage
    - Grep for `requireAdmin` in admin/usage/page.tsx to confirm auth gating
  </verify>
  <done>
    Admin usage page at /admin/usage shows org-wide usage summary cards and per-user breakdown table. Auth-gated to admin-only. Uses server-side data fetching.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Usage link to admin sidebar section</name>
  <files>
    apps/web-portal/components/dashboard/sidebar.tsx
  </files>
  <action>
    1. In `apps/web-portal/components/dashboard/sidebar.tsx`, add "Usage" to the admin NavGroup items array:
       ```typescript
       items={[
         { href: '/admin/organizations', label: 'Organizations' },
         { href: '/admin/users', label: 'Users' },
         { href: '/admin/billing', label: 'Billing' },
         { href: '/admin/usage', label: 'Usage' },  // NEW
         ...(isSuperAdmin ? [{ href: '/admin/coupons', label: 'Coupons' }] : []),
       ]}
       ```
       Add "Usage" before the conditional coupons entry, after "Billing".
  </action>
  <verify>
    - Run `npx tsc --noEmit` in apps/web-portal to confirm compilation
    - Grep for `/admin/usage` in sidebar.tsx to confirm link exists
  </verify>
  <done>
    Admin sidebar section includes "Usage" link navigating to /admin/usage. Positioned after Billing and before Coupons.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes in apps/web-portal
2. Admin can navigate to /admin/usage from sidebar
3. Admin usage page shows total users, total suggestions, average per user
4. Per-user breakdown table shows usage with status badges
5. Page is auth-gated to admins only
6. Sidebar admin section includes "Usage" link
</verification>

<success_criteria>
- Admin usage page exists at /admin/usage with org-wide analytics
- Summary cards show total users, total suggestions, average per user
- Top users table shows per-user breakdown with usage status
- Admin sidebar has "Usage" link in admin section
- Page is protected by requireAdmin()
</success_criteria>

<output>
After completion, create `.planning/phases/11.1-usage-tracking/11.1-05-SUMMARY.md`
</output>
