---
phase: 03-ai-personalization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/src/schema.ts
  - packages/database/src/migrations/0003_personalization_tables.sql
autonomous: true

must_haves:
  truths:
    - "Database has pgvector extension enabled"
    - "User style preferences can be stored with tone, formality, and phrase lists"
    - "Message embeddings can store vector data for semantic search"
    - "Refinement feedback can be tracked per suggestion"
    - "GDPR consent status can be tracked per user"
  artifacts:
    - path: "packages/database/src/schema.ts"
      provides: "Drizzle schema definitions for personalization tables"
      contains: "userStylePreferences"
    - path: "packages/database/src/migrations/0003_personalization_tables.sql"
      provides: "Migration SQL for new tables and pgvector extension"
      contains: "CREATE EXTENSION"
  key_links:
    - from: "packages/database/src/schema.ts"
      to: "packages/database/src/index.ts"
      via: "export from schema"
      pattern: "export.*from.*schema"
---

<objective>
Add database schema for AI personalization features including user style preferences, message embeddings for semantic search, refinement feedback tracking, and GDPR consent tracking.

Purpose: Phase 3 requires persistent storage for style learning. The three-source architecture (explicit preferences + historical patterns + refinement feedback) needs dedicated tables. pgvector enables semantic similarity search across user message history.

Output: Migration file creating 4 new tables (userStylePreferences, messageEmbeddings, refinementFeedback, gdprConsent) and enabling pgvector extension.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ai-personalization/03-RESEARCH.md
@packages/database/src/schema.ts
@packages/database/src/migrations/0002_watched_conversations.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add personalization tables to Drizzle schema</name>
  <files>packages/database/src/schema.ts</files>
  <action>
Add four new table definitions to schema.ts:

1. **userStylePreferences** table:
   - id: uuid primary key with defaultRandom()
   - workspaceId: uuid references workspaces(id)
   - userId: text (Slack user ID), not null
   - tone: text nullable (e.g., "professional", "casual", "friendly")
   - formality: text nullable (e.g., "formal", "balanced", "informal")
   - preferredPhrases: jsonb array of strings, default []
   - avoidPhrases: jsonb array of strings, default []
   - customGuidance: text nullable (free-form user instructions)
   - updatedAt: timestamp with defaultNow()
   - Index on (workspaceId, userId) unique

2. **messageEmbeddings** table:
   - id: uuid primary key with defaultRandom()
   - workspaceId: uuid references workspaces(id)
   - userId: text (Slack user ID), not null
   - messageText: text, not null
   - threadContext: text nullable (what message was responding to)
   - embedding: text (store as serialized JSON array - pgvector handled in raw SQL)
   - createdAt: timestamp with defaultNow()
   - Index on (workspaceId, userId)
   - Index on createdAt for time-based filtering

3. **refinementFeedback** table:
   - id: uuid primary key with defaultRandom()
   - workspaceId: uuid references workspaces(id)
   - userId: text (Slack user ID), not null
   - suggestionId: text, not null (reference to original suggestion)
   - originalText: text, not null
   - modifiedText: text, not null
   - refinementType: text nullable ('tone' | 'length' | 'word_choice' | 'structure')
   - createdAt: timestamp with defaultNow()
   - Index on (workspaceId, userId)

4. **gdprConsent** table:
   - id: uuid primary key with defaultRandom()
   - workspaceId: uuid references workspaces(id)
   - userId: text (Slack user ID), not null
   - consentType: text, not null ('message_history_analysis')
   - consentedAt: timestamp nullable
   - revokedAt: timestamp nullable
   - createdAt: timestamp with defaultNow()
   - Unique index on (workspaceId, userId, consentType)

Use snake_case for all column names per project convention (see STATE.md decision from Phase 1).
  </action>
  <verify>
Run `npx tsc --noEmit -p packages/database/tsconfig.json` - should compile without errors.
  </verify>
  <done>
Schema file exports all 4 new tables with correct types and indexes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create migration SQL file</name>
  <files>packages/database/src/migrations/0003_personalization_tables.sql</files>
  <action>
Create SQL migration file with:

1. Enable pgvector extension (idempotent):
   ```sql
   CREATE EXTENSION IF NOT EXISTS vector;
   ```

2. Create user_style_preferences table matching Drizzle schema

3. Create message_embeddings table with vector column:
   - Use `embedding vector(1536)` for OpenAI-compatible dimension
   - Add HNSW index for fast similarity search:
     ```sql
     CREATE INDEX message_embeddings_embedding_idx ON message_embeddings
     USING hnsw (embedding vector_cosine_ops);
     ```

4. Create refinement_feedback table

5. Create gdpr_consent table

Follow naming convention from existing migrations (0001_, 0002_).

Note: The Drizzle schema stores embedding as text for ORM compatibility. The actual column type in PostgreSQL is vector(1536) via raw SQL. The service layer handles conversion.
  </action>
  <verify>
Check migration file syntax is valid SQL by reviewing structure.
  </verify>
  <done>
Migration file exists with all table CREATE statements, pgvector extension, and HNSW index for embeddings.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update database exports</name>
  <files>packages/database/src/index.ts</files>
  <action>
Ensure all new tables are exported from the package index file. The existing schema.ts export should pick them up automatically, but verify:

1. Read current index.ts
2. Confirm schema exports are present
3. Add explicit exports if needed for the new tables

Also run the migration against local database if DATABASE_URL is configured:
```bash
cd packages/database && npx drizzle-kit push
```

If drizzle-kit is not available, document that migration needs to be run manually.
  </action>
  <verify>
Run `npm run build -w packages/database` - should build successfully with new exports available.
  </verify>
  <done>
Database package builds and exports all personalization tables.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit -p packages/database/tsconfig.json` passes
2. `npm run build -w packages/database` succeeds
3. Schema file contains userStylePreferences, messageEmbeddings, refinementFeedback, gdprConsent exports
4. Migration file contains CREATE EXTENSION vector, all 4 CREATE TABLE statements
</verification>

<success_criteria>
- pgvector extension enabled in migration
- 4 new tables defined in Drizzle schema with correct column types
- HNSW index created for vector similarity search
- Migration file ready for deployment
- Database package builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/03-ai-personalization/03-01-SUMMARY.md`
</output>
