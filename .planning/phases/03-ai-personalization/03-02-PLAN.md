---
phase: 03-ai-personalization
plan: 02
type: execute
wave: 1
depends_on: ["03-01"]
files_modified:
  - apps/slack-backend/src/services/personalization/preferencesStore.ts
  - apps/slack-backend/src/services/personalization/index.ts
  - packages/validation/src/style-preferences.ts
  - packages/validation/src/index.ts
autonomous: true

must_haves:
  truths:
    - "User can save explicit style preferences (tone, formality, phrases)"
    - "User preferences are validated before storage"
    - "User preferences can be retrieved by userId and workspaceId"
    - "User preferences include injection protection on free-text fields"
  artifacts:
    - path: "apps/slack-backend/src/services/personalization/preferencesStore.ts"
      provides: "CRUD operations for user style preferences"
      exports: ["getStylePreferences", "upsertStylePreferences", "deleteStylePreferences"]
    - path: "packages/validation/src/style-preferences.ts"
      provides: "Zod schemas for validating preference input"
      exports: ["StylePreferencesSchema"]
  key_links:
    - from: "apps/slack-backend/src/services/personalization/preferencesStore.ts"
      to: "packages/database"
      via: "drizzle client import"
      pattern: "import.*from.*@slack-speak/database"
    - from: "apps/slack-backend/src/services/personalization/preferencesStore.ts"
      to: "packages/validation"
      via: "schema validation"
      pattern: "import.*StylePreferences.*from.*@slack-speak/validation"
---

<objective>
Create the style preferences service for storing and retrieving user's explicit style guidance including tone, formality level, and phrase preferences.

Purpose: AI-03 requires users to provide explicit style guidance. This service provides the CRUD operations for the userStylePreferences table created in Plan 01. Preferences are the highest-priority source in the three-source style architecture.

Output: preferencesStore.ts service with get/upsert/delete operations, plus Zod validation schemas to ensure data integrity and prevent prompt injection via preference fields.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-ai-personalization/03-RESEARCH.md
@packages/database/src/schema.ts
@packages/validation/src/sanitization.ts
@apps/slack-backend/src/services/watch.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Zod validation schemas for style preferences</name>
  <files>packages/validation/src/style-preferences.ts, packages/validation/src/index.ts</files>
  <action>
Create style-preferences.ts with Zod schemas:

```typescript
import { z } from 'zod';

// Tone options that make sense for professional communication
export const ToneSchema = z.enum([
  'professional',
  'casual',
  'friendly',
  'formal',
  'empathetic',
  'direct',
]).nullable();

// Formality level
export const FormalitySchema = z.enum([
  'formal',
  'balanced',
  'informal',
]).nullable();

// Individual phrase with length limits (prevent prompt stuffing)
const PhraseSchema = z.string()
  .min(1)
  .max(100) // Prevent overly long phrases
  .refine(
    (phrase) => !/<\|.*?\|>/.test(phrase), // Block data markers
    { message: 'Invalid characters in phrase' }
  );

// Custom guidance with length limits
const CustomGuidanceSchema = z.string()
  .max(500) // Reasonable limit for custom instructions
  .nullable();

// Full preferences object
export const StylePreferencesSchema = z.object({
  tone: ToneSchema,
  formality: FormalitySchema,
  preferredPhrases: z.array(PhraseSchema).max(20).default([]),
  avoidPhrases: z.array(PhraseSchema).max(20).default([]),
  customGuidance: CustomGuidanceSchema,
});

export type StylePreferences = z.infer<typeof StylePreferencesSchema>;

// Input schema for upsert (allows partial updates)
export const StylePreferencesInputSchema = StylePreferencesSchema.partial();
export type StylePreferencesInput = z.infer<typeof StylePreferencesInputSchema>;
```

Update packages/validation/src/index.ts to export the new schemas and types.
  </action>
  <verify>
Run `npm run build -w packages/validation` - should compile without errors.
  </verify>
  <done>
Validation package exports StylePreferencesSchema, StylePreferencesInputSchema, and related types.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create preferences store service</name>
  <files>apps/slack-backend/src/services/personalization/preferencesStore.ts, apps/slack-backend/src/services/personalization/index.ts</files>
  <action>
Create the personalization directory and preferencesStore.ts:

```typescript
import { eq, and } from 'drizzle-orm';
import { db } from '@slack-speak/database';
import { userStylePreferences } from '@slack-speak/database/schema';
import { StylePreferencesInputSchema, type StylePreferences } from '@slack-speak/validation';
import { logger } from '../../utils/logger.js';

interface PreferencesKey {
  workspaceId: string;
  userId: string;
}

/**
 * Get user's explicit style preferences
 * Returns null if no preferences set
 */
export async function getStylePreferences(
  key: PreferencesKey
): Promise<StylePreferences | null> {
  const result = await db
    .select()
    .from(userStylePreferences)
    .where(
      and(
        eq(userStylePreferences.workspaceId, key.workspaceId),
        eq(userStylePreferences.userId, key.userId)
      )
    )
    .limit(1);

  if (result.length === 0) {
    return null;
  }

  const row = result[0];
  return {
    tone: row.tone as StylePreferences['tone'],
    formality: row.formality as StylePreferences['formality'],
    preferredPhrases: (row.preferredPhrases as string[]) || [],
    avoidPhrases: (row.avoidPhrases as string[]) || [],
    customGuidance: row.customGuidance,
  };
}

/**
 * Create or update user's style preferences
 * Validates input before storing
 */
export async function upsertStylePreferences(
  key: PreferencesKey,
  input: unknown
): Promise<StylePreferences> {
  // Validate input (throws ZodError if invalid)
  const validated = StylePreferencesInputSchema.parse(input);

  // Check if exists
  const existing = await getStylePreferences(key);

  if (existing) {
    // Update
    await db
      .update(userStylePreferences)
      .set({
        ...validated,
        updatedAt: new Date(),
      })
      .where(
        and(
          eq(userStylePreferences.workspaceId, key.workspaceId),
          eq(userStylePreferences.userId, key.userId)
        )
      );

    logger.info({ ...key }, 'Updated user style preferences');
  } else {
    // Insert
    await db.insert(userStylePreferences).values({
      workspaceId: key.workspaceId,
      userId: key.userId,
      ...validated,
    });

    logger.info({ ...key }, 'Created user style preferences');
  }

  // Return the updated preferences
  const updated = await getStylePreferences(key);
  return updated!;
}

/**
 * Delete user's style preferences
 */
export async function deleteStylePreferences(
  key: PreferencesKey
): Promise<boolean> {
  const result = await db
    .delete(userStylePreferences)
    .where(
      and(
        eq(userStylePreferences.workspaceId, key.workspaceId),
        eq(userStylePreferences.userId, key.userId)
      )
    );

  const deleted = (result.rowCount ?? 0) > 0;
  if (deleted) {
    logger.info({ ...key }, 'Deleted user style preferences');
  }

  return deleted;
}
```

Create index.ts for the personalization directory:
```typescript
export * from './preferencesStore.js';
```

Note: The database client import path may need adjustment based on how @slack-speak/database exports. Check existing services like watch.ts for the correct import pattern.
  </action>
  <verify>
Run `npx tsc --noEmit -p apps/slack-backend/tsconfig.json` - should compile without errors.
  </verify>
  <done>
preferencesStore.ts exports getStylePreferences, upsertStylePreferences, deleteStylePreferences functions with proper validation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update main services index to export personalization</name>
  <files>apps/slack-backend/src/services/index.ts</files>
  <action>
Update the services index.ts to include exports from the new personalization module:

```typescript
export * from './personalization/index.js';
```

Verify the export is accessible by checking TypeScript compilation.
  </action>
  <verify>
Run full type check: `npm run typecheck` or `npx tsc --noEmit` from workspace root.
  </verify>
  <done>
Personalization services are exported and accessible from apps/slack-backend/src/services.
  </done>
</task>

</tasks>

<verification>
1. `npm run build -w packages/validation` succeeds
2. `npx tsc --noEmit -p apps/slack-backend/tsconfig.json` succeeds
3. StylePreferencesSchema validates correctly (rejects invalid tones, enforces phrase limits)
4. getStylePreferences returns null for non-existent user
5. upsertStylePreferences creates new record, then updates on second call
</verification>

<success_criteria>
- Zod schema enforces tone enum, formality enum, phrase length limits (100 chars), custom guidance limit (500 chars)
- Zod schema blocks data marker injection patterns in phrases
- preferencesStore.ts provides get/upsert/delete with proper database queries
- All exports compile and are accessible from service index
</success_criteria>

<output>
After completion, create `.planning/phases/03-ai-personalization/03-02-SUMMARY.md`
</output>
