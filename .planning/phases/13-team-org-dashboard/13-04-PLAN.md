---
phase: 13-team-org-dashboard
plan: 04
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - apps/web-portal/lib/admin/templates.ts
  - apps/web-portal/app/api/admin/templates/route.ts
  - apps/web-portal/app/api/admin/templates/[id]/route.ts
  - apps/web-portal/app/admin/templates/page.tsx
  - apps/web-portal/components/dashboard/sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Any team member can submit a response template for admin review"
    - "Admin can approve or reject pending templates"
    - "Approved templates are visible to all team members"
    - "Templates support three types: canned responses, response starters, situation playbooks"
    - "Template count respects plan limits"
  artifacts:
    - path: "apps/web-portal/lib/admin/templates.ts"
      provides: "Template CRUD and approval workflow service"
      exports: ["getTemplates", "createTemplate", "approveTemplate", "rejectTemplate"]
    - path: "apps/web-portal/app/admin/templates/page.tsx"
      provides: "Template management page with submission and approval UI"
      contains: "approveTemplate"
  key_links:
    - from: "apps/web-portal/app/admin/templates/page.tsx"
      to: "apps/web-portal/lib/admin/templates.ts"
      via: "server component + API calls"
      pattern: "getTemplates|approveTemplate"
    - from: "apps/web-portal/lib/admin/templates.ts"
      to: "apps/web-portal/lib/admin/plan-features.ts"
      via: "template limit enforcement"
      pattern: "maxTemplates"
---

<objective>
Build shared response template management with submission and approval workflow. Any team member can submit templates (canned responses, response starters, situation playbooks). Admin reviews and approves/rejects. Template count is plan-gated.

Purpose: Enables shared knowledge capture and consistent response patterns across team (TEAM-05, success criteria 5).
Output: Template service, API endpoints, admin management page with approval workflow.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-team-org-dashboard/13-CONTEXT.md
@.planning/phases/13-team-org-dashboard/13-01-SUMMARY.md
@packages/database/src/schema.ts
@apps/web-portal/lib/auth/admin.ts
@apps/web-portal/lib/admin/plan-features.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create template service and API endpoints</name>
  <files>
    apps/web-portal/lib/admin/templates.ts
    apps/web-portal/app/api/admin/templates/route.ts
    apps/web-portal/app/api/admin/templates/[id]/route.ts
  </files>
  <action>
    Create `apps/web-portal/lib/admin/templates.ts` with 'server-only':

    1. **getTemplates(organizationId, options?)**: List templates with optional filters:
       - status filter: 'all' | 'pending' | 'approved' | 'rejected' (default 'all')
       - templateType filter: 'canned' | 'starter' | 'playbook' | null
       - ORDER BY status='pending' first (admin needs to see pending first), then createdAt DESC

    2. **createTemplate(organizationId, data)**: Create new template:
       - Validate with Zod: name (3-100 chars), templateType (enum), content (10-5000 chars), description (optional, max 500 chars)
       - Check approved template count against plan limit (getPlanFeatures(planId).maxTemplates)
       - If at limit, return error "Template limit reached for your plan"
       - Set status='pending', submittedBy from session
       - Return created template

    3. **approveTemplate(templateId, adminUserId)**: Set status='approved', reviewedBy, reviewedAt
    4. **rejectTemplate(templateId, adminUserId, reason?)**: Set status='rejected', reviewedBy, reviewedAt, rejectionReason
    5. **deleteTemplate(templateId)**: Hard delete (admin only)
    6. **getApprovedTemplates(organizationId)**: Get only approved templates (for AI to use later)

    Create API routes:

    `apps/web-portal/app/api/admin/templates/route.ts`:
    - GET: List templates with query params (?status=pending&type=canned). requireAdmin for all, but allow non-admin to submit.
    - POST: Create new template (any authenticated user can submit). Validate body with Zod.

    `apps/web-portal/app/api/admin/templates/[id]/route.ts`:
    - PUT: Approve/reject template (requireAdmin). Body: { action: 'approve' | 'reject', reason?: string }
    - DELETE: Delete template (requireAdmin)

    All queries filter by organizationId for multi-tenant isolation.
  </action>
  <verify>TypeScript compiles. Grep for 'maxTemplates' in templates.ts (plan limit check). Grep for Zod validation.</verify>
  <done>Template CRUD with approval workflow, plan limit enforcement, and API endpoints.</done>
</task>

<task type="auto">
  <name>Task 2: Build template management admin page</name>
  <files>
    apps/web-portal/app/admin/templates/page.tsx
    apps/web-portal/components/dashboard/sidebar.tsx
  </files>
  <action>
    Create `apps/web-portal/app/admin/templates/page.tsx`:

    Page layout with:

    **Header area:**
    - Title: "Response Templates"
    - Subtitle: "Manage shared response templates for your team"
    - "New Template" button (opens creation dialog/sheet)
    - Template count badge: "X/Y templates" (used/limit from plan features)

    **Filter tabs:**
    - All | Pending (badge with count) | Approved | Rejected
    - Template type filter dropdown: All Types | Canned Response | Response Starter | Situation Playbook

    **Template list:**
    - Card-based layout for each template:
      - Name + type badge (color-coded: canned=blue, starter=green, playbook=purple)
      - Description (truncated to 2 lines)
      - Content preview (truncated, expandable on click)
      - Status badge: Pending (yellow), Approved (green), Rejected (red)
      - Submitted by + date
      - Reviewed by + date (if reviewed)
      - Rejection reason (if rejected, shown in red text)
    - For pending templates: Approve (green) + Reject (red) buttons
    - For all templates: Delete button (with confirmation dialog)

    **New Template dialog** (Sheet or Dialog component):
    - Name input
    - Type selector (3 radio cards with descriptions):
      - Canned Response: "Full pre-written response for common situations"
      - Response Starter: "Opening line/framework that AI personalizes"
      - Situation Playbook: "Scenario guide with key points to hit"
    - Description textarea (optional)
    - Content textarea (large, with character counter)
    - Submit button

    **Rejection dialog:**
    - Textarea for rejection reason (optional but encouraged)
    - Confirm reject button

    Add 'Templates' to admin NavGroup in sidebar after Analytics.

    Use existing shadcn/ui: Card, Button, Badge, Dialog, Textarea, Input, Tabs, Sheet.
  </action>
  <verify>Check page.tsx renders template cards with approve/reject actions. Verify sidebar has Templates link.</verify>
  <done>Template management page with submission form, approval/rejection workflow, filter tabs, and plan limit display.</done>
</task>

</tasks>

<verification>
- `ls apps/web-portal/app/admin/templates/page.tsx` exists
- `grep 'approve\|reject' apps/web-portal/app/admin/templates/page.tsx` shows approval actions
- `grep 'canned\|starter\|playbook' apps/web-portal/app/admin/templates/page.tsx` shows template types
- `grep 'Templates' apps/web-portal/components/dashboard/sidebar.tsx` shows nav link
- Template count respects plan limits
</verification>

<success_criteria>
- Admin sees list of templates with status badges
- Admin can approve/reject pending templates
- Any user can submit new templates
- Template types properly categorized and color-coded
- Plan limit enforced (shows count/limit)
- Templates link in admin sidebar
</success_criteria>

<output>
After completion, create `.planning/phases/13-team-org-dashboard/13-04-SUMMARY.md`
</output>
