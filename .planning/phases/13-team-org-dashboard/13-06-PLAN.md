---
phase: 13-team-org-dashboard
plan: 06
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - apps/web-portal/lib/admin/guardrails.ts
  - apps/web-portal/app/api/admin/guardrails/route.ts
  - apps/web-portal/app/api/admin/guardrails/violations/route.ts
  - apps/web-portal/app/admin/guardrails/page.tsx
  - apps/web-portal/components/dashboard/sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can toggle predefined guardrail categories on/off"
    - "Admin can add/remove custom blocked keywords"
    - "Admin can choose trigger behavior: hard block, regenerate, or soft warning"
    - "Guardrail violations are logged with type, rule, and action"
    - "Violations report shows frequency stats and patterns"
    - "Sensible defaults pre-configured for new orgs"
  artifacts:
    - path: "apps/web-portal/lib/admin/guardrails.ts"
      provides: "Guardrail config CRUD, violation logging, checking logic"
      exports: ["getGuardrailConfig", "upsertGuardrailConfig", "checkGuardrails", "logViolation", "getViolationStats"]
    - path: "apps/web-portal/app/admin/guardrails/page.tsx"
      provides: "Content guardrails admin page with category toggles and keyword management"
      contains: "enabledCategories"
  key_links:
    - from: "apps/web-portal/lib/admin/guardrails.ts"
      to: "apps/web-portal/lib/admin/plan-features.ts"
      via: "keyword limit and AI detection enforcement"
      pattern: "maxBlockedKeywords|aiCategoryDetection"
    - from: "apps/web-portal/app/admin/guardrails/page.tsx"
      to: "apps/web-portal/lib/admin/guardrails.ts"
      via: "config management and violation stats"
      pattern: "getGuardrailConfig|getViolationStats"
---

<objective>
Build content guardrails configuration with predefined topic categories, custom keyword blocklist, configurable trigger behavior, and violation reporting. Admin can toggle categories, manage keywords, set trigger mode, and view violation frequency stats.

Purpose: Enables admins to control what AI can/cannot suggest (TEAM-06, success criteria 7).
Output: Guardrails service with checking logic, violation logging, admin config page, violations report.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-team-org-dashboard/13-CONTEXT.md
@.planning/phases/13-team-org-dashboard/13-RESEARCH.md
@.planning/phases/13-team-org-dashboard/13-01-SUMMARY.md
@packages/database/src/schema.ts
@apps/web-portal/lib/auth/admin.ts
@apps/web-portal/lib/admin/plan-features.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create guardrails service with checking logic and APIs</name>
  <files>
    apps/web-portal/lib/admin/guardrails.ts
    apps/web-portal/app/api/admin/guardrails/route.ts
    apps/web-portal/app/api/admin/guardrails/violations/route.ts
  </files>
  <action>
    Create `apps/web-portal/lib/admin/guardrails.ts` with 'server-only':

    1. **PREDEFINED_CATEGORIES** constant array with objects:
       ```typescript
       export const PREDEFINED_CATEGORIES = [
         { id: 'legal_advice', name: 'Legal Advice', description: 'Prevents AI from giving legal opinions or recommendations', keywords: ['hereby', 'pursuant', 'legally binding', 'sue', 'litigation', 'statute', 'liability'] },
         { id: 'pricing_commitments', name: 'Pricing Commitments', description: 'Blocks specific pricing quotes or discount promises', keywords: ['guarantee price', 'lock in rate', 'special discount', 'custom pricing', 'waive fee'] },
         { id: 'competitor_bashing', name: 'Competitor Mentions', description: 'Avoids negative competitor references', keywords: ['better than [competitor]', 'unlike [competitor]', 'competitor fails'] },
         { id: 'medical_advice', name: 'Medical Advice', description: 'Prevents health or medical recommendations', keywords: ['diagnose', 'prescribe', 'treatment plan', 'medical advice'] },
         { id: 'financial_advice', name: 'Financial Advice', description: 'Blocks investment or financial guidance', keywords: ['invest in', 'financial advice', 'guaranteed returns', 'buy/sell recommendation'] },
         { id: 'hr_decisions', name: 'HR Decisions', description: 'Prevents employment-related commitments', keywords: ['you are fired', 'terminated', 'promote you', 'salary increase guaranteed'] },
         { id: 'nda_confidential', name: 'Confidential Information', description: 'Blocks sharing of marked confidential content', keywords: ['confidential', 'proprietary', 'trade secret', 'under NDA'] },
       ] as const;
       ```

    2. **getGuardrailConfig(organizationId)**: Fetch guardrailConfig, return defaults if none exists
    3. **upsertGuardrailConfig(organizationId, data)**: Upsert config:
       - Validate enabledCategories against PREDEFINED_CATEGORIES ids
       - Validate blockedKeywords: max count from getPlanFeatures(planId).maxBlockedKeywords, each max 100 chars
       - Validate triggerMode enum
    4. **checkGuardrails(text, config)**: Check AI output against guardrails:
       - Check custom keywords first (case-insensitive, word boundary matching using regex `\\b${keyword}\\b`)
       - Check enabled category keywords
       - Return: { violated: boolean, violations: Array<{ type, rule, matchedText }> }
       - Return ALL violations found (not just first)
    5. **logViolation(organizationId, workspaceId, userId, violation, suggestionText, action)**: Insert into guardrailViolations table
    6. **getViolationStats(organizationId, days?)**: Aggregate violations:
       - Total count in period
       - By violation type (category vs keyword)
       - By violated rule (which category/keyword triggered most)
       - By action (blocked/regenerated/warned)
       - Daily trend (for mini chart)

    Create API routes:

    `apps/web-portal/app/api/admin/guardrails/route.ts`:
    - GET: Return guardrail config + predefined categories list
    - PUT: Update guardrail config. requireAdmin.

    `apps/web-portal/app/api/admin/guardrails/violations/route.ts`:
    - GET: Return violation stats with query params (?days=30). requireAdmin.
  </action>
  <verify>TypeScript compiles. Grep for 'PREDEFINED_CATEGORIES' in guardrails.ts. Grep for 'checkGuardrails' function.</verify>
  <done>Guardrails service with category/keyword checking, violation logging, and stats aggregation.</done>
</task>

<task type="auto">
  <name>Task 2: Build guardrails admin page with categories and violations report</name>
  <files>
    apps/web-portal/app/admin/guardrails/page.tsx
    apps/web-portal/components/dashboard/sidebar.tsx
  </files>
  <action>
    Create `apps/web-portal/app/admin/guardrails/page.tsx`:

    Page with two tabs: Configuration | Violations Report

    **Configuration tab:**
    - Trigger Mode selector (3 radio cards):
      - Hard Block: "Suppress suggestion entirely, show warning to user" (strictest)
      - Warning + Regenerate: "AI regenerates without prohibited content, shows filter note" (balanced)
      - Soft Warning: "Deliver suggestion with visible warning flag" (least strict)
    - Predefined Categories section:
      - Grid of toggle cards (2 cols on lg, 1 on sm)
      - Each card: category name, description, toggle switch
      - Enabled categories highlighted with blue border
      - Show "(Default)" badge for categories enabled by default
    - Custom Keywords section:
      - Input field + "Add" button to add new keyword
      - List of keywords as removable tags/chips (X button to remove)
      - Counter: "X/Y keywords used" (from plan limits)
      - If at limit, show upgrade message
    - Save Configuration button

    **Violations Report tab:**
    - Summary stats cards: Total violations (period), Most triggered rule, Most common action
    - Violations by rule chart (bar chart or BarList from Tremor, showing top 10 triggered rules)
    - Violations by type pie/donut chart (category vs keyword)
    - Recent violations table:
      - Date, User, Violation Type, Rule, Action taken
      - Limited to last 50 entries
    - Period selector: Last 7 days | 30 days | 90 days

    Add 'Guardrails' to admin NavGroup in sidebar after Audit Trail.

    Use existing shadcn/ui: Card, Tabs, TabsList, TabsContent, Switch, Input, Button, Badge.
    Use Tremor for violation charts (BarList, DonutChart).
  </action>
  <verify>Check page.tsx has both Configuration and Violations tabs. Verify sidebar has Guardrails link. Check for PREDEFINED_CATEGORIES usage.</verify>
  <done>Guardrails page renders with category toggles, keyword management, trigger mode, and violations report with charts.</done>
</task>

</tasks>

<verification>
- `ls apps/web-portal/app/admin/guardrails/page.tsx` exists
- `grep 'enabledCategories\|PREDEFINED' apps/web-portal/app/admin/guardrails/page.tsx` shows category toggles
- `grep 'blockedKeywords' apps/web-portal/app/admin/guardrails/page.tsx` shows keyword management
- `grep 'Guardrails' apps/web-portal/components/dashboard/sidebar.tsx` shows nav link
- `grep 'checkGuardrails' apps/web-portal/lib/admin/guardrails.ts` shows checking logic
- Violations report shows stats and charts
</verification>

<success_criteria>
- Admin can toggle predefined categories on/off
- Admin can add/remove custom keywords (within plan limit)
- Admin can select trigger mode (hard block/regenerate/soft warning)
- Sensible defaults active for new orgs
- Violations report shows frequency, trends, top rules
- Configuration persists across page reloads
- Guardrails link in admin sidebar
</success_criteria>

<output>
After completion, create `.planning/phases/13-team-org-dashboard/13-06-SUMMARY.md`
</output>
