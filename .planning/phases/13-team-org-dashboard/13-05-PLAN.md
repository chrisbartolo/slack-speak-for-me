---
phase: 13-team-org-dashboard
plan: 05
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - apps/web-portal/lib/admin/audit-trail.ts
  - apps/web-portal/app/api/admin/audit-trail/route.ts
  - apps/web-portal/app/api/admin/audit-trail/export/route.ts
  - apps/web-portal/app/admin/audit-trail/page.tsx
  - apps/web-portal/components/admin/audit-trail-table.tsx
  - apps/web-portal/components/dashboard/sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can view compliance audit trail with who, when, what action, and channel"
    - "Suggestion text visibility is plan-gated (metadata only vs full text)"
    - "Audit trail supports filtering by action type, user, and date range"
    - "CSV export downloads filtered audit data"
    - "Data shown respects retention period based on plan tier"
  artifacts:
    - path: "apps/web-portal/lib/admin/audit-trail.ts"
      provides: "Audit trail queries with plan-gated field visibility"
      exports: ["getAuditTrail", "getAuditTrailStats"]
    - path: "apps/web-portal/components/admin/audit-trail-table.tsx"
      provides: "TanStack Table with sorting, filtering, pagination"
      contains: "useReactTable"
    - path: "apps/web-portal/app/admin/audit-trail/page.tsx"
      provides: "Compliance audit trail admin page"
      contains: "AuditTrailTable"
  key_links:
    - from: "apps/web-portal/components/admin/audit-trail-table.tsx"
      to: "@tanstack/react-table"
      via: "table state management"
      pattern: "useReactTable|getCoreRowModel"
    - from: "apps/web-portal/lib/admin/audit-trail.ts"
      to: "apps/web-portal/lib/admin/plan-features.ts"
      via: "plan-gated text visibility"
      pattern: "auditTrailTextVisible"
---

<objective>
Build the compliance audit trail page with TanStack Table showing all AI-assisted response activity. Combines data from suggestionFeedback and auditLogs tables. Plan-gated: lower tiers see metadata only (who/when/action), higher tiers see full suggestion text. Supports filtering, sorting, pagination, and CSV/PDF export.

Purpose: Gives admins compliance visibility into AI-assisted communication (TEAM-04, success criteria 4).
Output: Audit trail service, TanStack Table component, admin page, CSV/PDF export.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-team-org-dashboard/13-CONTEXT.md
@.planning/phases/13-team-org-dashboard/13-RESEARCH.md
@.planning/phases/13-team-org-dashboard/13-01-SUMMARY.md
@packages/database/src/schema.ts
@apps/web-portal/lib/auth/admin.ts
@apps/web-portal/lib/admin/plan-features.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create audit trail queries and export API</name>
  <files>
    apps/web-portal/lib/admin/audit-trail.ts
    apps/web-portal/app/api/admin/audit-trail/route.ts
    apps/web-portal/app/api/admin/audit-trail/export/route.ts
  </files>
  <action>
    Create `apps/web-portal/lib/admin/audit-trail.ts` with 'server-only':

    1. **getAuditTrail(organizationId, workspaceId, planId, options?)**: Combined query from suggestionFeedback:
       - Fetch from suggestionFeedback WHERE workspaceId matches
       - Apply date range filter (default: within retention period from getPlanFeatures)
       - Apply action filter (accepted/refined/dismissed)
       - Apply userId filter
       - Apply plan-gated visibility: if getPlanFeatures(planId).auditTrailTextVisible is false, exclude originalText and finalText from select
       - Order by createdAt DESC
       - Paginate: offset + limit (default 50 per page)
       - LEFT JOIN users for email/display info
       - Return { items, total, page, pageSize, hasMore }

    2. **getAuditTrailStats(organizationId, workspaceId)**: Summary for header cards:
       - Total entries count
       - Last 24h count
       - Unique users count
       - Most common action

    3. **getAdminAuditTrail(organizationId, options?)**: Separate query from auditLogs table:
       - Admin config changes (settings_changed, admin_action)
       - Filter by workspaceId
       - Return entries with details JSONB

    Create `apps/web-portal/app/api/admin/audit-trail/route.ts`:
    - GET: Return paginated audit trail with query params:
      - page, pageSize, action, userId, startDate, endDate
    - requireAdmin, filter by organization

    Create `apps/web-portal/app/api/admin/audit-trail/export/route.ts`:
    - GET: Export audit trail as CSV or PDF
    - Query params: format=csv|pdf, startDate, endDate, action, userId
    - CSV: Use papaparse.unparse() with appropriate columns
    - PDF: Use PDFKit to generate formatted report with header, date range, and data rows
    - Content-Disposition header for download
    - Plan-gated: exclude text columns for lower tier plans
  </action>
  <verify>TypeScript compiles. Grep for 'auditTrailTextVisible' in audit-trail.ts. Grep for 'papaparse\|PDFKit\|pdfkit' in export route.</verify>
  <done>Audit trail service returns plan-gated data with pagination. CSV/PDF export endpoints work.</done>
</task>

<task type="auto">
  <name>Task 2: Build audit trail page with TanStack Table</name>
  <files>
    apps/web-portal/components/admin/audit-trail-table.tsx
    apps/web-portal/app/admin/audit-trail/page.tsx
    apps/web-portal/components/dashboard/sidebar.tsx
  </files>
  <action>
    Create `apps/web-portal/components/admin/audit-trail-table.tsx` ('use client'):
    - Import from @tanstack/react-table: ColumnDef, flexRender, getCoreRowModel, useReactTable, getSortedRowModel, getFilteredRowModel, SortingState, ColumnFiltersState
    - Import shadcn/ui Table components
    - Define columns:
      - Date/Time (formatted with date-fns, sortable)
      - User (email or slack user ID)
      - Action (badge: accepted=green, refined=yellow, dismissed=red)
      - Channel (channel ID or name if available)
      - Suggestion Text (conditionally shown based on plan -- prop: showText boolean)
      - Final Text (conditionally shown)
    - Filter input for action column
    - Date range picker inputs (start date, end date)
    - Pagination controls: Previous / Next buttons, page indicator, page size selector (10/25/50)
    - Sorting on all columns (click header to sort)
    - Empty state: "No audit entries found for the selected filters"

    Create `apps/web-portal/app/admin/audit-trail/page.tsx` (server component):
    - Fetch initial audit trail data + stats
    - Header with:
      - Title: "Compliance Audit Trail"
      - Stats row: Total entries, Last 24h, Unique users
      - Export buttons: "Export CSV" + "Export PDF" (both link to export API)
        - CSV always available for starter+
        - PDF only for team+ plans (use getPlanFeatures to check)
      - Plan indicator: show "Metadata only" badge for lower plans, "Full text access" for higher plans
    - AuditTrailTable component with fetched data
    - Admin config changes section below (separate card): list of admin-level changes from auditLogs

    Add 'Audit Trail' to admin NavGroup in sidebar after Templates.
  </action>
  <verify>Check page.tsx imports AuditTrailTable. Verify TanStack Table imports in audit-trail-table.tsx. Verify sidebar has Audit Trail link.</verify>
  <done>Audit trail page renders with TanStack Table, plan-gated columns, filters, pagination, and export buttons.</done>
</task>

</tasks>

<verification>
- `ls apps/web-portal/app/admin/audit-trail/page.tsx` exists
- `grep 'useReactTable' apps/web-portal/components/admin/audit-trail-table.tsx` shows TanStack integration
- `grep 'auditTrailTextVisible' apps/web-portal/lib/admin/audit-trail.ts` shows plan gating
- `grep 'Audit Trail' apps/web-portal/components/dashboard/sidebar.tsx` shows nav link
- Export routes exist for CSV and PDF
</verification>

<success_criteria>
- Audit trail table renders with sortable columns
- Filtering by action, user, and date range works
- Plan-gated: lower plans see metadata only, higher plans see text
- Pagination works with 50 items per page default
- CSV export downloads correctly formatted file
- PDF export generates formatted compliance report (team+ plans)
- Audit Trail link in admin sidebar
</success_criteria>

<output>
After completion, create `.planning/phases/13-team-org-dashboard/13-05-SUMMARY.md`
</output>
