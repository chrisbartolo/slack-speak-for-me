---
phase: 13-team-org-dashboard
plan: 03
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - apps/web-portal/lib/admin/org-style.ts
  - apps/web-portal/app/api/admin/org-style/route.ts
  - apps/web-portal/app/api/admin/yolo-mode/route.ts
  - apps/web-portal/app/admin/settings/page.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can set org-wide style guidelines with tone, formality, phrases, and custom guidance"
    - "Admin can choose style mode: override, layer, or fallback"
    - "Admin can enable/disable YOLO mode globally and per-user"
    - "YOLO mode is off by default"
  artifacts:
    - path: "apps/web-portal/lib/admin/org-style.ts"
      provides: "CRUD service for org style settings and YOLO mode management"
      exports: ["getOrgStyleSettings", "updateOrgStyleSettings", "getYoloModeSettings", "updateYoloModeSettings"]
    - path: "apps/web-portal/app/admin/settings/page.tsx"
      provides: "Admin settings page with org style and YOLO mode sections"
      contains: "styleMode"
  key_links:
    - from: "apps/web-portal/app/admin/settings/page.tsx"
      to: "apps/web-portal/lib/admin/org-style.ts"
      via: "form submission -> API -> service"
      pattern: "getOrgStyleSettings|updateOrgStyleSettings"
    - from: "apps/web-portal/app/api/admin/org-style/route.ts"
      to: "packages/database/src/schema.ts"
      via: "orgStyleSettings table"
      pattern: "orgStyleSettings"
---

<objective>
Build org-wide style guidelines settings and YOLO mode admin controls. Admin can configure how org style interacts with user preferences (override/layer/fallback), set org-level tone and phrases, and manage YOLO mode (auto-send) permissions globally and per-user.

Purpose: Enables admins to standardize AI communication across team (TEAM-02) and control auto-send permissions (TEAM-03).
Output: Org style service, YOLO mode management, admin settings page with both sections.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-team-org-dashboard/13-CONTEXT.md
@.planning/phases/13-team-org-dashboard/13-01-SUMMARY.md
@packages/database/src/schema.ts
@apps/web-portal/lib/auth/admin.ts
@apps/web-portal/app/dashboard/style/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create org style and YOLO mode services and APIs</name>
  <files>
    apps/web-portal/lib/admin/org-style.ts
    apps/web-portal/app/api/admin/org-style/route.ts
    apps/web-portal/app/api/admin/yolo-mode/route.ts
  </files>
  <action>
    Create `apps/web-portal/lib/admin/org-style.ts` with 'server-only':

    1. **getOrgStyleSettings(organizationId)**: Fetch orgStyleSettings for org, return null if none
    2. **upsertOrgStyleSettings(organizationId, data)**: Upsert (onConflictDoUpdate on organizationId unique) with:
       - styleMode: 'override' | 'layer' | 'fallback'
       - tone, formality, preferredPhrases, avoidPhrases, customGuidance
       - Validate with Zod: tone max 50 chars, formality max 50, phrases arrays max 20 items each max 100 chars, customGuidance max 2000 chars
    3. **getYoloModeSettings(organizationId)**: Return { globalEnabled, userOverrides } from orgStyleSettings
    4. **updateYoloModeGlobal(organizationId, enabled)**: Update yoloModeGlobal field
    5. **updateYoloModeUser(organizationId, slackUserId, enabled)**: Update specific user in yoloModeUserOverrides JSONB
       - If enabled is null, remove the user from overrides (use org default)
    6. **isYoloEnabled(organizationId, slackUserId)**: Check if YOLO enabled for specific user:
       - If user has override, use that
       - Otherwise use global setting
       - Default false if no settings exist

    Create API routes:

    `apps/web-portal/app/api/admin/org-style/route.ts`:
    - GET: Return org style settings (requireAdmin)
    - PUT: Update org style settings with Zod validation

    `apps/web-portal/app/api/admin/yolo-mode/route.ts`:
    - GET: Return YOLO mode settings with user list
    - PUT: Update global toggle or per-user override
      - Body: { global?: boolean, userId?: string, enabled?: boolean | null }
  </action>
  <verify>TypeScript compiles. Grep for 'upsertOrgStyleSettings' in org-style.ts. Grep for Zod validation.</verify>
  <done>Org style and YOLO mode services with full CRUD, Zod validation, and API endpoints.</done>
</task>

<task type="auto">
  <name>Task 2: Build admin settings page with org style and YOLO mode sections</name>
  <files>apps/web-portal/app/admin/settings/page.tsx</files>
  <action>
    Create `apps/web-portal/app/admin/settings/page.tsx` (server component with client form sections):

    Page layout with two distinct sections:

    **Section 1: Org-Wide Style Guidelines**
    - Style Mode selector (3 radio cards with descriptions):
      - "Org overrides user" - Org style replaces user preferences entirely
      - "Org sets baseline" - Org provides defaults, user can customize within bounds
      - "User preferences first" - User preferences take priority, org fills gaps (DEFAULT)
    - Tone input (text, e.g., "Professional", "Friendly", "Direct")
    - Formality input (select: "Very Formal", "Formal", "Neutral", "Casual", "Very Casual")
    - Preferred phrases (tag input, add/remove individual phrases)
    - Avoid phrases (tag input, add/remove individual phrases)
    - Custom guidance textarea (max 2000 chars with counter)
    - Save button that calls PUT /api/admin/org-style

    **Section 2: YOLO Mode (Auto-Send) Controls**
    - Global toggle switch with warning text: "When enabled, AI suggestions are automatically sent as messages without user review"
    - Status indicator: "Currently: DISABLED globally" or "Currently: ENABLED globally"
    - Per-user overrides section (show when org has users):
      - List of workspace users with individual toggle switches
      - Each user shows: name/email, toggle, status (Using org default / Enabled / Disabled)
      - Toggle calls PUT /api/admin/yolo-mode with userId
    - Warning banner: "YOLO mode sends AI-generated messages without human review. Use with caution."

    Use existing shadcn/ui components: Card, Button, Input, Textarea, Switch, Label, RadioGroup.
    Add 'Settings' link to admin NavGroup in sidebar if not already present (check first).
    Use fetching pattern consistent with other admin pages.
  </action>
  <verify>Check page.tsx exists and contains styleMode, yoloModeGlobal, and user overrides UI. Verify it imports from org-style service.</verify>
  <done>Admin settings page renders with org style form and YOLO mode toggle controls.</done>
</task>

</tasks>

<verification>
- `ls apps/web-portal/app/admin/settings/page.tsx` exists
- `grep 'styleMode' apps/web-portal/app/admin/settings/page.tsx` shows style mode selector
- `grep 'yoloModeGlobal\|YOLO' apps/web-portal/app/admin/settings/page.tsx` shows YOLO controls
- `grep 'isYoloEnabled' apps/web-portal/lib/admin/org-style.ts` shows lookup function
- API routes exist and require admin auth
</verification>

<success_criteria>
- Admin can select style mode (override/layer/fallback)
- Admin can set org-wide tone, formality, phrases, guidance
- YOLO mode global toggle works
- Per-user YOLO overrides work
- Form validates input with Zod
- Settings persist across page reloads
</success_criteria>

<output>
After completion, create `.planning/phases/13-team-org-dashboard/13-03-SUMMARY.md`
</output>
