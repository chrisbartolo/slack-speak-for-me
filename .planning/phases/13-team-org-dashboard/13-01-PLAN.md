---
phase: 13-team-org-dashboard
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/src/schema.ts
  - apps/web-portal/lib/db/index.ts
  - apps/web-portal/lib/admin/plan-features.ts
  - apps/web-portal/package.json
autonomous: true

must_haves:
  truths:
    - "New database tables exist for response templates, guardrail config, guardrail violations, and org style settings"
    - "Plan-gated features config defines audit trail visibility, retention days, and template limits per plan tier"
    - "Tremor, papaparse, and TanStack Table are installed and available"
  artifacts:
    - path: "packages/database/src/schema.ts"
      provides: "responseTemplates, guardrailConfig, guardrailViolations, orgStyleSettings tables"
      contains: "responseTemplates"
    - path: "apps/web-portal/lib/admin/plan-features.ts"
      provides: "PLAN_FEATURES config with tier-based access control"
      exports: ["PLAN_FEATURES", "getPlanFeatures"]
    - path: "apps/web-portal/lib/db/index.ts"
      provides: "New tables exported to web-portal schema"
      contains: "responseTemplates"
  key_links:
    - from: "apps/web-portal/lib/admin/plan-features.ts"
      to: "apps/web-portal/lib/billing/plans.config.ts"
      via: "plan ID alignment"
      pattern: "starter.*pro.*business"
---

<objective>
Create database schema for Phase 13 features (response templates, guardrail config, guardrail violations, org style settings), install Tremor/papaparse/TanStack Table dependencies, and create plan-gated features configuration.

Purpose: Foundation layer that all other Phase 13 plans depend on -- schema, dependencies, and feature gating.
Output: New database tables, installed packages, plan features config file.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-team-org-dashboard/13-CONTEXT.md
@.planning/phases/13-team-org-dashboard/13-RESEARCH.md
@packages/database/src/schema.ts
@apps/web-portal/lib/db/index.ts
@apps/web-portal/lib/billing/plans.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Phase 13 database tables to schema</name>
  <files>packages/database/src/schema.ts</files>
  <action>
    Add 4 new tables to the schema file:

    1. **orgStyleSettings** - Org-wide style guidelines configuration:
       - id: uuid primary key
       - organizationId: uuid FK to organizations (unique index -- one config per org)
       - styleMode: text ('override' | 'layer' | 'fallback') default 'fallback'
       - tone: text (nullable)
       - formality: text (nullable)
       - preferredPhrases: jsonb string[] (nullable)
       - avoidPhrases: jsonb string[] (nullable)
       - customGuidance: text (nullable)
       - yoloModeGlobal: boolean default false -- global YOLO mode toggle
       - yoloModeUserOverrides: jsonb Record<string, boolean> (nullable) -- per-user overrides keyed by slackUserId
       - updatedAt: timestamp defaultNow

    2. **responseTemplates** - Shared response templates with approval workflow:
       - id: uuid primary key
       - organizationId: uuid FK to organizations
       - name: text notNull
       - description: text (nullable)
       - templateType: text notNull ('canned' | 'starter' | 'playbook')
       - content: text notNull
       - submittedBy: text notNull (Slack user ID)
       - status: text default 'pending' ('pending' | 'approved' | 'rejected')
       - reviewedBy: text (nullable)
       - reviewedAt: timestamp (nullable)
       - rejectionReason: text (nullable)
       - createdAt: timestamp defaultNow
       - updatedAt: timestamp defaultNow
       - Indexes: orgIdx on organizationId, statusIdx on status

    3. **guardrailConfig** - Content guardrail configuration per org:
       - id: uuid primary key
       - organizationId: uuid FK to organizations (unique index -- one config per org)
       - enabledCategories: jsonb string[] default ['legal_advice', 'pricing_commitments', 'competitor_bashing']
       - blockedKeywords: jsonb string[] default []
       - triggerMode: text default 'hard_block' ('hard_block' | 'regenerate' | 'soft_warning')
       - updatedAt: timestamp defaultNow

    4. **guardrailViolations** - Log of guardrail triggers:
       - id: uuid primary key
       - organizationId: uuid FK to organizations
       - userId: text notNull (Slack user ID)
       - workspaceId: uuid FK to workspaces
       - violationType: text notNull ('category' | 'keyword')
       - violatedRule: text notNull
       - suggestionText: text (nullable -- plan-gated visibility)
       - action: text notNull ('blocked' | 'regenerated' | 'warned')
       - channelId: text (nullable)
       - createdAt: timestamp defaultNow
       - Indexes: orgIdx on organizationId, createdAtIdx on createdAt

    Add type exports for all 4 tables (both select and insert types).

    Follow the exact patterns from existing schema tables (e.g., clientProfiles, brandVoiceTemplates).
  </action>
  <verify>Run `npx tsc --noEmit` in packages/database to verify types compile. Grep schema.ts for all 4 table names.</verify>
  <done>All 4 tables defined with correct columns, indexes, and type exports.</done>
</task>

<task type="auto">
  <name>Task 2: Export new tables and install dependencies</name>
  <files>
    apps/web-portal/lib/db/index.ts
    apps/web-portal/package.json
  </files>
  <action>
    1. Update `apps/web-portal/lib/db/index.ts`:
       - Import all 4 new tables: orgStyleSettings, responseTemplates, guardrailConfig, guardrailViolations
       - Add them to the schema object
       - Re-export their types (OrgStyleSettings, ResponseTemplate, GuardrailConfig, GuardrailViolation + New* variants)

    2. Install new dependencies in web-portal workspace:
       ```bash
       cd apps/web-portal
       npm install @tremor/react papaparse @tanstack/react-table
       npm install --save-dev @types/papaparse
       ```

    Note: @tanstack/react-table works with the existing shadcn/ui Table component. Tremor is built on Recharts + Radix (already in codebase). papaparse handles CSV export with proper escaping.
  </action>
  <verify>Run `npm ls @tremor/react papaparse @tanstack/react-table --workspace=apps/web-portal` to confirm packages installed. Check lib/db/index.ts imports compile with `npx tsc --noEmit`.</verify>
  <done>New tables exported in web-portal schema, Tremor + papaparse + TanStack Table installed.</done>
</task>

<task type="auto">
  <name>Task 3: Create plan-gated features configuration</name>
  <files>apps/web-portal/lib/admin/plan-features.ts</files>
  <action>
    Create `apps/web-portal/lib/admin/plan-features.ts` with plan-gated feature access:

    ```typescript
    /**
     * Plan-gated feature access for admin dashboard.
     * Controls what admin features are available per plan tier.
     * Aligns plan IDs with plans.config.ts (free, starter, pro, team, business).
     */

    export interface PlanFeatures {
      // Audit trail
      auditTrailTextVisible: boolean;  // Can admin see actual suggestion text?
      dataRetentionDays: number;       // How long to keep audit data

      // Templates
      maxTemplates: number;            // Max shared templates allowed

      // Analytics
      analyticsHistoryMonths: number;  // How many months of analytics data
      csvExportEnabled: boolean;       // Can export to CSV
      pdfExportEnabled: boolean;       // Can export to PDF

      // Guardrails
      maxBlockedKeywords: number;      // Custom keyword limit
      aiCategoryDetection: boolean;    // AI-powered category detection (vs keyword only)
    }

    export const PLAN_FEATURES: Record<string, PlanFeatures> = {
      free: {
        auditTrailTextVisible: false,
        dataRetentionDays: 7,
        maxTemplates: 0,
        analyticsHistoryMonths: 1,
        csvExportEnabled: false,
        pdfExportEnabled: false,
        maxBlockedKeywords: 0,
        aiCategoryDetection: false,
      },
      starter: {
        auditTrailTextVisible: false,
        dataRetentionDays: 30,
        maxTemplates: 5,
        analyticsHistoryMonths: 3,
        csvExportEnabled: true,
        pdfExportEnabled: false,
        maxBlockedKeywords: 10,
        aiCategoryDetection: false,
      },
      pro: {
        auditTrailTextVisible: false,
        dataRetentionDays: 90,
        maxTemplates: 25,
        analyticsHistoryMonths: 6,
        csvExportEnabled: true,
        pdfExportEnabled: false,
        maxBlockedKeywords: 50,
        aiCategoryDetection: true,
      },
      team: {
        auditTrailTextVisible: true,
        dataRetentionDays: 90,
        maxTemplates: 50,
        analyticsHistoryMonths: 6,
        csvExportEnabled: true,
        pdfExportEnabled: true,
        maxBlockedKeywords: 100,
        aiCategoryDetection: true,
      },
      business: {
        auditTrailTextVisible: true,
        dataRetentionDays: 90,
        maxTemplates: 100,
        analyticsHistoryMonths: 6,
        csvExportEnabled: true,
        pdfExportEnabled: true,
        maxBlockedKeywords: 500,
        aiCategoryDetection: true,
      },
    };

    export function getPlanFeatures(planId: string | null | undefined): PlanFeatures {
      return PLAN_FEATURES[planId || 'free'] || PLAN_FEATURES.free;
    }
    ```

    This file does NOT have 'server-only' import since it's a pure config object that may be needed on client too.
  </action>
  <verify>Run `npx tsc --noEmit` in apps/web-portal to confirm types compile.</verify>
  <done>Plan features config exists with correct tier definitions aligned to plans.config.ts IDs.</done>
</task>

</tasks>

<verification>
- `grep -c 'responseTemplates\|guardrailConfig\|guardrailViolations\|orgStyleSettings' packages/database/src/schema.ts` returns 4+ matches
- `grep -c 'responseTemplates\|guardrailConfig\|guardrailViolations\|orgStyleSettings' apps/web-portal/lib/db/index.ts` returns 4+ matches
- `npm ls @tremor/react --workspace=apps/web-portal` shows installed
- `cat apps/web-portal/lib/admin/plan-features.ts` shows PLAN_FEATURES with 5 tiers
- TypeScript compiles without errors
</verification>

<success_criteria>
- 4 new database tables defined in schema.ts with proper indexes and FK constraints
- All tables exported in web-portal db/index.ts
- Tremor, papaparse, and TanStack Table installed
- Plan features config with 5 tiers (free, starter, pro, team, business)
- All TypeScript compiles clean
</success_criteria>

<output>
After completion, create `.planning/phases/13-team-org-dashboard/13-01-SUMMARY.md`
</output>
