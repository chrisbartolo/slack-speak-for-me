---
phase: 13-team-org-dashboard
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - apps/web-portal/lib/admin/analytics.ts
  - apps/web-portal/app/api/admin/analytics/route.ts
  - apps/web-portal/app/admin/analytics/page.tsx
  - apps/web-portal/components/admin/analytics-charts.tsx
  - apps/web-portal/components/dashboard/sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Org admin can view team adoption rate, acceptance ratio, and estimated time saved"
    - "Dashboard shows 6-month trend charts with Tremor LineChart and DonutChart"
    - "Admin can drill down to per-user metrics"
    - "CSV export button downloads analytics data"
    - "Dashboard shows team adoption metrics and usage statistics"
  artifacts:
    - path: "apps/web-portal/lib/admin/analytics.ts"
      provides: "Server-side aggregation queries for team metrics"
      exports: ["getTeamMetrics", "getUserMetrics", "getAdoptionTrend"]
    - path: "apps/web-portal/app/admin/analytics/page.tsx"
      provides: "Team analytics admin page with summary cards and charts"
      contains: "AnalyticsCharts"
    - path: "apps/web-portal/components/admin/analytics-charts.tsx"
      provides: "Tremor chart components for analytics visualization"
      contains: "LineChart"
  key_links:
    - from: "apps/web-portal/app/admin/analytics/page.tsx"
      to: "apps/web-portal/lib/admin/analytics.ts"
      via: "server component data fetching"
      pattern: "getTeamMetrics|getAdoptionTrend"
    - from: "apps/web-portal/components/admin/analytics-charts.tsx"
      to: "@tremor/react"
      via: "chart components"
      pattern: "LineChart|DonutChart"
---

<objective>
Build the team analytics dashboard with Tremor charts showing adoption rate, acceptance vs refinement ratio, and estimated time saved. Includes summary cards, 6-month trend charts, per-user drill-down, and CSV export.

Purpose: Gives org admins visibility into how their team uses AI suggestions (TEAM-01, success criteria 1 and 6).
Output: Analytics page, chart components, server-side aggregation queries, CSV export API.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-team-org-dashboard/13-CONTEXT.md
@.planning/phases/13-team-org-dashboard/13-RESEARCH.md
@.planning/phases/13-team-org-dashboard/13-01-SUMMARY.md
@packages/database/src/schema.ts
@apps/web-portal/lib/auth/admin.ts
@apps/web-portal/lib/db/admin-queries.ts
@apps/web-portal/lib/admin/plan-features.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analytics aggregation queries and API</name>
  <files>
    apps/web-portal/lib/admin/analytics.ts
    apps/web-portal/app/api/admin/analytics/route.ts
  </files>
  <action>
    Create `apps/web-portal/lib/admin/analytics.ts` with 'server-only' import:

    1. **getTeamMetrics(organizationId, workspaceId)** - Single aggregation query using JOIN:
       - Total suggestions generated (count from suggestionFeedback where workspaceId matches)
       - Acceptance rate (accepted / total * 100)
       - Refinement rate (refined / total * 100)
       - Dismissal rate (dismissed / total * 100)
       - Active users count (COUNT DISTINCT userId from suggestionFeedback in last 30 days)
       - Total users (COUNT from users where workspaceId matches)
       - Adoption rate (active / total * 100)
       - Estimated time saved: character count of accepted+refined suggestions / 200 chars per min (40 WPM * 5 chars per word)

    2. **getAdoptionTrend(organizationId, workspaceId, months)** - Monthly time-series:
       - Use raw SQL with date_trunc('month', created_at)
       - Return: month, active_users, total_suggestions, acceptance_rate
       - Filter by workspace, last N months (default 6)
       - Downsample if needed (max 100 data points, but monthly data is fine)

    3. **getUserMetrics(organizationId, workspaceId)** - Per-user breakdown:
       - Single GROUP BY query on userId
       - LEFT JOIN users table for email
       - Return: userId, email, suggestionCount, acceptedCount, refinedCount, dismissedCount, lastActive

    4. **getActionBreakdown(organizationId, workspaceId)** - For donut chart:
       - GROUP BY action, return action + count

    ALL queries MUST filter by workspaceId (multi-tenant isolation). Use `requireAdmin()` pattern from existing admin-queries.ts.

    Create `apps/web-portal/app/api/admin/analytics/route.ts`:
    - GET endpoint that returns team metrics
    - Support `?format=csv` query param for CSV export using papaparse
    - Support `?view=users` for per-user data export
    - Require admin auth, filter by organization
    - CSV response uses Content-Type: text/csv and Content-Disposition header
  </action>
  <verify>TypeScript compiles. Grep for `date_trunc` in analytics.ts. Grep for `papaparse` in route.ts.</verify>
  <done>Analytics queries return team metrics, adoption trend, user breakdown. CSV export works via API.</done>
</task>

<task type="auto">
  <name>Task 2: Build analytics dashboard page with Tremor charts</name>
  <files>
    apps/web-portal/components/admin/analytics-charts.tsx
    apps/web-portal/app/admin/analytics/page.tsx
    apps/web-portal/components/dashboard/sidebar.tsx
  </files>
  <action>
    Create `apps/web-portal/components/admin/analytics-charts.tsx` ('use client'):
    - Import from @tremor/react: Card, Title, LineChart, DonutChart, BarList
    - **AdoptionTrendChart**: LineChart showing monthly adoption rate and total suggestions over time
    - **ActionBreakdownChart**: DonutChart showing accepted/refined/dismissed breakdown with green/yellow/red colors
    - **UserMetricsTable**: Simple table (not TanStack yet) showing per-user stats with sortable columns
    - All charts use showAnimation for nice load effect
    - valueFormatter for percentages and counts

    Create `apps/web-portal/app/admin/analytics/page.tsx` (server component):
    - Call getTeamMetrics, getAdoptionTrend, getUserMetrics, getActionBreakdown from analytics.ts
    - Summary cards row (4 cols on lg, 2 on md, 1 on sm):
      - Total Suggestions (count with trend arrow vs last month)
      - Adoption Rate (% with color coding: green >70%, yellow >40%, red <40%)
      - AI Accuracy (acceptance rate %)
      - Time Saved (formatted as "X hours Y min")
    - Charts section:
      - AdoptionTrendChart (full width)
      - ActionBreakdownChart (half width) + UserMetricsTable (half width)
    - CSV Export button in top-right corner using `<a href="/api/admin/analytics?format=csv" download>` pattern
    - Use existing Card component from shadcn/ui for summary cards, Tremor Card for charts

    Update sidebar.tsx:
    - Add 'Analytics' item to the admin NavGroup items array, positioned first:
      `{ href: '/admin/analytics', label: 'Analytics' }`
  </action>
  <verify>Check that page.tsx imports from analytics.ts and analytics-charts.tsx. Verify sidebar has Analytics link.</verify>
  <done>Analytics dashboard renders with 4 summary cards, adoption trend line chart, action donut chart, user table, and CSV export button.</done>
</task>

</tasks>

<verification>
- `ls apps/web-portal/app/admin/analytics/page.tsx` exists
- `grep 'LineChart\|DonutChart' apps/web-portal/components/admin/analytics-charts.tsx` shows Tremor imports
- `grep 'Analytics' apps/web-portal/components/dashboard/sidebar.tsx` shows nav link
- `grep 'papaparse' apps/web-portal/app/api/admin/analytics/route.ts` shows CSV export
- TypeScript compiles clean
</verification>

<success_criteria>
- Admin analytics page shows 4 summary metric cards
- 6-month adoption trend chart renders with Tremor LineChart
- Action breakdown donut chart shows accepted/refined/dismissed
- Per-user metrics table with drill-down
- CSV export downloads analytics data
- Analytics link appears in admin sidebar navigation
</success_criteria>

<output>
After completion, create `.planning/phases/13-team-org-dashboard/13-02-SUMMARY.md`
</output>
