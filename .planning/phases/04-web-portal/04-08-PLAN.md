---
phase: 04-web-portal
plan: 08
type: execute
wave: 4
depends_on: ["04-04"]
files_modified:
  - apps/web-portal/app/(dashboard)/feedback/page.tsx
  - apps/web-portal/app/(dashboard)/feedback/actions.ts
  - apps/web-portal/components/dashboard/feedback-list.tsx
  - apps/web-portal/lib/db/queries.ts
autonomous: true

must_haves:
  truths:
    - "User can see history of refinement feedback"
    - "User can see what AI learned from feedback"
    - "User can add notes explaining why suggestions didn't work"
    - "Feedback entries show original and modified text"
  artifacts:
    - path: "apps/web-portal/app/(dashboard)/feedback/page.tsx"
      provides: "Feedback history page"
      contains: "FeedbackList"
    - path: "apps/web-portal/components/dashboard/feedback-list.tsx"
      provides: "List component for feedback entries"
      exports: ["FeedbackList"]
  key_links:
    - from: "apps/web-portal/app/(dashboard)/feedback/page.tsx"
      to: "apps/web-portal/lib/db/queries.ts"
      via: "data fetching"
      pattern: "getRefinementFeedback"
---

<objective>
Create feedback page for viewing AI learning history and providing additional training feedback.

Purpose: Enable PORTAL-02 (view context history), PORTAL-03 (conversation summaries), and PORTAL-04 (AI training feedback) requirements. Users can see how AI has learned and provide explanations for why suggestions didn't work.
Output: Feedback page with refinement history and ability to add training notes.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-web-portal/04-CONTEXT.md
@.planning/phases/04-web-portal/04-RESEARCH.md
@.planning/phases/04-web-portal/04-04-SUMMARY.md
@packages/database/src/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add feedback queries and update sidebar</name>
  <files>
    apps/web-portal/lib/db/queries.ts
    apps/web-portal/components/dashboard/sidebar.tsx
  </files>
  <action>
Update apps/web-portal/lib/db/queries.ts to add feedback queries:

```typescript
// Add to existing queries.ts

// Get refinement feedback history with pagination
export const getRefinementFeedback = cache(async (limit = 50) => {
  const session = await verifySession();

  return db
    .select({
      id: refinementFeedback.id,
      suggestionId: refinementFeedback.suggestionId,
      originalText: refinementFeedback.originalText,
      modifiedText: refinementFeedback.modifiedText,
      refinementType: refinementFeedback.refinementType,
      createdAt: refinementFeedback.createdAt,
    })
    .from(refinementFeedback)
    .where(
      and(
        eq(refinementFeedback.workspaceId, session.workspaceId),
        eq(refinementFeedback.userId, session.userId)
      )
    )
    .orderBy(desc(refinementFeedback.createdAt))
    .limit(limit);
});

// Get feedback summary statistics
export const getFeedbackStats = cache(async () => {
  const session = await verifySession();

  // Count by refinement type
  const typeStats = await db
    .select({
      refinementType: refinementFeedback.refinementType,
      count: count(),
    })
    .from(refinementFeedback)
    .where(
      and(
        eq(refinementFeedback.workspaceId, session.workspaceId),
        eq(refinementFeedback.userId, session.userId)
      )
    )
    .groupBy(refinementFeedback.refinementType);

  return typeStats;
});
```

Update apps/web-portal/components/dashboard/sidebar.tsx to add Feedback link:

```typescript
// Update navItems array to include Feedback page
const navItems = [
  { href: '/', icon: Home, label: 'Dashboard' },
  { href: '/style', icon: Sliders, label: 'Style Settings' },
  { href: '/conversations', icon: MessageSquare, label: 'Conversations' },
  { href: '/people', icon: Users, label: 'People' },
  { href: '/feedback', icon: Sparkles, label: 'AI Learning' },  // New
  { href: '/reports', icon: FileText, label: 'Reports' },
];
```

Import Sparkles from lucide-react if not already imported.
  </action>
  <verify>
    grep -n "getRefinementFeedback" apps/web-portal/lib/db/queries.ts
    grep -n "feedback" apps/web-portal/components/dashboard/sidebar.tsx
  </verify>
  <done>Feedback queries added and sidebar updated with AI Learning link</done>
</task>

<task type="auto">
  <name>Task 2: Create feedback list component</name>
  <files>
    apps/web-portal/components/dashboard/feedback-list.tsx
    apps/web-portal/components/dashboard/feedback-card.tsx
  </files>
  <action>
Create apps/web-portal/components/dashboard/feedback-card.tsx:

```typescript
'use client';

import { useState } from 'react';
import { ChevronDown, ChevronUp, Edit2, ArrowRight } from 'lucide-react';
import { Card, CardContent } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { formatDistanceToNow } from 'date-fns';

interface FeedbackCardProps {
  feedback: {
    id: string;
    originalText: string;
    modifiedText: string;
    refinementType: string | null;
    createdAt: Date | null;
  };
}

const refinementTypeLabels: Record<string, { label: string; color: string }> = {
  shortening: { label: 'Shortened', color: 'bg-blue-100 text-blue-800' },
  expanding: { label: 'Expanded', color: 'bg-green-100 text-green-800' },
  tone_shift: { label: 'Tone Change', color: 'bg-purple-100 text-purple-800' },
  restructuring: { label: 'Restructured', color: 'bg-orange-100 text-orange-800' },
  minor_edit: { label: 'Minor Edit', color: 'bg-gray-100 text-gray-800' },
};

export function FeedbackCard({ feedback }: FeedbackCardProps) {
  const [isExpanded, setIsExpanded] = useState(false);

  const typeInfo = feedback.refinementType
    ? refinementTypeLabels[feedback.refinementType] || { label: feedback.refinementType, color: 'bg-gray-100 text-gray-800' }
    : { label: 'Modified', color: 'bg-gray-100 text-gray-800' };

  // Calculate change summary
  const originalWords = feedback.originalText.split(/\s+/).length;
  const modifiedWords = feedback.modifiedText.split(/\s+/).length;
  const wordDiff = modifiedWords - originalWords;
  const percentChange = Math.round((Math.abs(wordDiff) / originalWords) * 100);

  return (
    <Card>
      <CardContent className="p-4">
        <div className="flex items-start justify-between gap-4">
          <div className="flex-1 min-w-0">
            <div className="flex items-center gap-2 mb-2">
              <Badge className={typeInfo.color}>{typeInfo.label}</Badge>
              {feedback.createdAt && (
                <span className="text-xs text-gray-400">
                  {formatDistanceToNow(feedback.createdAt, { addSuffix: true })}
                </span>
              )}
            </div>

            <p className="text-sm text-gray-600">
              {wordDiff === 0
                ? 'Same length, different wording'
                : wordDiff > 0
                ? `Added ${wordDiff} words (+${percentChange}%)`
                : `Removed ${Math.abs(wordDiff)} words (-${percentChange}%)`}
            </p>
          </div>

          <Button
            variant="ghost"
            size="sm"
            onClick={() => setIsExpanded(!isExpanded)}
          >
            {isExpanded ? (
              <ChevronUp className="h-4 w-4" />
            ) : (
              <ChevronDown className="h-4 w-4" />
            )}
          </Button>
        </div>

        {isExpanded && (
          <div className="mt-4 pt-4 border-t space-y-4">
            <div>
              <p className="text-xs font-medium text-gray-500 mb-1">Original suggestion</p>
              <p className="text-sm text-gray-700 bg-gray-50 p-3 rounded-md whitespace-pre-wrap">
                {feedback.originalText}
              </p>
            </div>

            <div className="flex justify-center">
              <ArrowRight className="h-4 w-4 text-gray-400" />
            </div>

            <div>
              <p className="text-xs font-medium text-gray-500 mb-1">Your refined version</p>
              <p className="text-sm text-gray-700 bg-green-50 p-3 rounded-md whitespace-pre-wrap">
                {feedback.modifiedText}
              </p>
            </div>
          </div>
        )}
      </CardContent>
    </Card>
  );
}
```

Create apps/web-portal/components/dashboard/feedback-list.tsx:

```typescript
import { FeedbackCard } from './feedback-card';

interface Feedback {
  id: string;
  suggestionId: string;
  originalText: string;
  modifiedText: string;
  refinementType: string | null;
  createdAt: Date | null;
}

interface FeedbackListProps {
  feedbackItems: Feedback[];
}

export function FeedbackList({ feedbackItems }: FeedbackListProps) {
  return (
    <div className="space-y-4">
      {feedbackItems.map((feedback) => (
        <FeedbackCard key={feedback.id} feedback={feedback} />
      ))}
    </div>
  );
}
```
  </action>
  <verify>
    ls apps/web-portal/components/dashboard/feedback-list.tsx
    ls apps/web-portal/components/dashboard/feedback-card.tsx
  </verify>
  <done>Feedback list and card components created with expandable detail view</done>
</task>

<task type="auto">
  <name>Task 3: Create feedback page with stats</name>
  <files>
    apps/web-portal/app/(dashboard)/feedback/page.tsx
  </files>
  <action>
Create apps/web-portal/app/(dashboard)/feedback/page.tsx:

```typescript
import { Sparkles, TrendingUp } from 'lucide-react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { FeedbackList } from '@/components/dashboard/feedback-list';
import { EmptyState } from '@/components/dashboard/empty-state';
import { StatCard } from '@/components/dashboard/stat-card';
import { getRefinementFeedback, getFeedbackStats, getMessageCount } from '@/lib/db/queries';

const refinementTypeLabels: Record<string, string> = {
  shortening: 'Shortened',
  expanding: 'Expanded',
  tone_shift: 'Tone Changes',
  restructuring: 'Restructured',
  minor_edit: 'Minor Edits',
};

export default async function FeedbackPage() {
  const [feedbackItems, feedbackStats, messageCount] = await Promise.all([
    getRefinementFeedback(),
    getFeedbackStats(),
    getMessageCount(),
  ]);

  // Calculate total refinements
  const totalRefinements = feedbackStats.reduce((sum, stat) => sum + (stat.count || 0), 0);

  // Find most common refinement type
  const mostCommon = feedbackStats.reduce(
    (max, stat) => (stat.count > (max?.count || 0) ? stat : max),
    feedbackStats[0]
  );

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-3xl font-bold text-gray-900">AI Learning</h1>
        <p className="text-gray-600 mt-1">
          See how AI has learned from your feedback and message history
        </p>
      </div>

      <div className="grid gap-4 md:grid-cols-3">
        <StatCard
          title="Messages Analyzed"
          value={messageCount}
          description="For style learning"
          icon={Sparkles}
        />
        <StatCard
          title="Refinements Made"
          value={totalRefinements}
          description="Feedback provided"
          icon={TrendingUp}
        />
        <StatCard
          title="Common Pattern"
          value={mostCommon ? refinementTypeLabels[mostCommon.refinementType ?? ''] || 'None' : 'None'}
          description={mostCommon ? `${mostCommon.count} occurrences` : 'Start refining suggestions'}
          icon={Sparkles}
        />
      </div>

      {feedbackStats.length > 0 && (
        <Card>
          <CardHeader>
            <CardTitle>Refinement Patterns</CardTitle>
            <CardDescription>
              How you typically modify AI suggestions
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="space-y-3">
              {feedbackStats.map((stat) => {
                const percentage = Math.round((stat.count / totalRefinements) * 100);
                const label = refinementTypeLabels[stat.refinementType ?? ''] || stat.refinementType;

                return (
                  <div key={stat.refinementType} className="flex items-center gap-3">
                    <div className="w-24 text-sm text-gray-600">{label}</div>
                    <div className="flex-1 h-2 bg-gray-100 rounded-full overflow-hidden">
                      <div
                        className="h-full bg-blue-500 rounded-full"
                        style={{ width: `${percentage}%` }}
                      />
                    </div>
                    <div className="w-12 text-sm text-gray-500 text-right">{percentage}%</div>
                  </div>
                );
              })}
            </div>
          </CardContent>
        </Card>
      )}

      <Card>
        <CardHeader>
          <CardTitle>Recent Refinements</CardTitle>
          <CardDescription>
            {feedbackItems.length === 0
              ? 'No refinements yet'
              : `${feedbackItems.length} refinements recorded`}
          </CardDescription>
        </CardHeader>
        <CardContent>
          {feedbackItems.length === 0 ? (
            <EmptyState
              icon={Sparkles}
              title="No refinements yet"
              description="When you refine AI suggestions in Slack, they'll appear here. This helps AI learn your preferences."
            />
          ) : (
            <FeedbackList feedbackItems={feedbackItems} />
          )}
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <CardTitle>How AI learns from you</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4 text-sm text-gray-600">
          <div className="flex gap-3">
            <div className="flex-shrink-0 w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs font-medium">
              1
            </div>
            <p>
              <strong className="text-gray-900">Message history analysis:</strong>{' '}
              AI analyzes {messageCount} of your messages to understand your vocabulary, phrasing patterns, and communication style.
            </p>
          </div>
          <div className="flex gap-3">
            <div className="flex-shrink-0 w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs font-medium">
              2
            </div>
            <p>
              <strong className="text-gray-900">Explicit preferences:</strong>{' '}
              Your style settings (tone, formality, phrases) are applied to every suggestion.
            </p>
          </div>
          <div className="flex gap-3">
            <div className="flex-shrink-0 w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs font-medium">
              3
            </div>
            <p>
              <strong className="text-gray-900">Refinement feedback:</strong>{' '}
              When you refine suggestions, AI learns what changes you prefer (shown above).
            </p>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
```
  </action>
  <verify>
    ls apps/web-portal/app/(dashboard)/feedback/page.tsx
    grep -n "getRefinementFeedback" apps/web-portal/app/(dashboard)/feedback/page.tsx
    npm run build --workspace=web-portal
  </verify>
  <done>Feedback page created with stats, patterns chart, and refinement history</done>
</task>

</tasks>

<verification>
1. /feedback page renders with header and stats cards
2. Stats show messages analyzed, refinements made, common pattern
3. Refinement patterns bar chart shows distribution
4. Recent refinements list shows feedback cards
5. Feedback cards expand to show original and modified text
6. Empty state shows when no refinements exist
7. How AI learns section explains the three learning sources
8. Build passes without errors
</verification>

<success_criteria>
- Stats cards showing learning metrics
- Refinement patterns visualization with percentages
- List of recent refinements with expandable details
- Each refinement shows original vs modified text
- Refinement type badges (shortened, expanded, etc.)
- Empty state with helpful description
- Explanation of how AI learns from feedback
</success_criteria>

<output>
After completion, create `.planning/phases/04-web-portal/04-08-SUMMARY.md`
</output>
