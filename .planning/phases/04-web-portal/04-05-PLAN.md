---
phase: 04-web-portal
plan: 05
type: execute
wave: 4
depends_on: ["04-04"]
files_modified:
  - apps/web-portal/app/(dashboard)/style/page.tsx
  - apps/web-portal/app/(dashboard)/style/actions.ts
  - apps/web-portal/components/forms/style-preferences-form.tsx
  - apps/web-portal/components/forms/tag-input.tsx
autonomous: true

must_haves:
  truths:
    - "User can configure tone setting"
    - "User can configure formality setting"
    - "User can add phrases to use"
    - "User can add phrases to avoid"
    - "User can add custom guidance"
    - "Settings persist after save"
  artifacts:
    - path: "apps/web-portal/app/(dashboard)/style/page.tsx"
      provides: "Style settings page"
      contains: "StylePreferencesForm"
    - path: "apps/web-portal/app/(dashboard)/style/actions.ts"
      provides: "Server action for saving preferences"
      exports: ["updateStylePreferences"]
    - path: "apps/web-portal/components/forms/style-preferences-form.tsx"
      provides: "Form component for style settings"
      exports: ["StylePreferencesForm"]
  key_links:
    - from: "apps/web-portal/components/forms/style-preferences-form.tsx"
      to: "apps/web-portal/app/(dashboard)/style/actions.ts"
      via: "form action"
      pattern: "updateStylePreferences"
    - from: "apps/web-portal/app/(dashboard)/style/actions.ts"
      to: "@slack-speak-for-me/database"
      via: "database update"
      pattern: "userStylePreferences"
---

<objective>
Create style settings page with form for configuring personality and tone preferences.

Purpose: Enable PORTAL-06 (personality/tone settings) and PORTAL-07 (default response style preferences) requirements. Users can explicitly guide how AI generates suggestions.
Output: Style settings page with validated form for tone, formality, phrases, and custom guidance.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-web-portal/04-CONTEXT.md
@.planning/phases/04-web-portal/04-RESEARCH.md
@.planning/phases/04-web-portal/04-04-SUMMARY.md
@packages/database/src/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tag input component for phrases</name>
  <files>
    apps/web-portal/components/forms/tag-input.tsx
  </files>
  <action>
Create apps/web-portal/components/forms/tag-input.tsx for managing phrase lists:

```typescript
'use client';

import { useState, KeyboardEvent } from 'react';
import { X } from 'lucide-react';
import { Input } from '@/components/ui/input';
import { Badge } from '@/components/ui/badge';
import { cn } from '@/lib/utils';

interface TagInputProps {
  value: string[];
  onChange: (tags: string[]) => void;
  placeholder?: string;
  maxTags?: number;
  maxLength?: number;
  className?: string;
}

export function TagInput({
  value,
  onChange,
  placeholder = 'Type and press Enter',
  maxTags = 10,
  maxLength = 100,
  className,
}: TagInputProps) {
  const [inputValue, setInputValue] = useState('');

  const handleKeyDown = (e: KeyboardEvent<HTMLInputElement>) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      addTag();
    }
    if (e.key === 'Backspace' && !inputValue && value.length > 0) {
      removeTag(value.length - 1);
    }
  };

  const addTag = () => {
    const trimmed = inputValue.trim().slice(0, maxLength);
    if (trimmed && !value.includes(trimmed) && value.length < maxTags) {
      onChange([...value, trimmed]);
      setInputValue('');
    }
  };

  const removeTag = (index: number) => {
    onChange(value.filter((_, i) => i !== index));
  };

  return (
    <div className={cn('space-y-2', className)}>
      <div className="flex flex-wrap gap-2">
        {value.map((tag, index) => (
          <Badge key={index} variant="secondary" className="gap-1 pr-1">
            {tag}
            <button
              type="button"
              onClick={() => removeTag(index)}
              className="ml-1 rounded-full hover:bg-gray-300 p-0.5"
            >
              <X className="h-3 w-3" />
            </button>
          </Badge>
        ))}
      </div>
      <Input
        value={inputValue}
        onChange={(e) => setInputValue(e.target.value)}
        onKeyDown={handleKeyDown}
        onBlur={addTag}
        placeholder={value.length >= maxTags ? `Maximum ${maxTags} items` : placeholder}
        disabled={value.length >= maxTags}
      />
      <p className="text-xs text-gray-500">
        {value.length}/{maxTags} items. Press Enter to add.
      </p>
    </div>
  );
}
```

Add the Badge component from shadcn/ui:
```bash
cd apps/web-portal && npx shadcn@latest add badge
```
  </action>
  <verify>
    ls apps/web-portal/components/forms/tag-input.tsx
    ls apps/web-portal/components/ui/badge.tsx
  </verify>
  <done>Tag input component created for managing phrase lists</done>
</task>

<task type="auto">
  <name>Task 2: Create server action for updating style preferences</name>
  <files>
    apps/web-portal/app/(dashboard)/style/actions.ts
    apps/web-portal/lib/validations/style.ts
  </files>
  <action>
Create apps/web-portal/lib/validations/style.ts with Zod schema:

```typescript
import { z } from 'zod';

// Injection protection - block spotlighting markers per Phase 3 decisions
const safeTextSchema = z.string().refine(
  (val) => !val.includes('<|user_input_start|>') && !val.includes('<|user_input_end|>'),
  { message: 'Invalid characters detected' }
);

export const stylePreferencesSchema = z.object({
  tone: z.enum(['Professional', 'Friendly', 'Direct', 'Empathetic']).nullable(),
  formality: z.enum(['Casual', 'Neutral', 'Formal']).nullable(),
  preferredPhrases: z
    .array(safeTextSchema.max(100, 'Phrase too long'))
    .max(20, 'Maximum 20 phrases'),
  avoidPhrases: z
    .array(safeTextSchema.max(100, 'Phrase too long'))
    .max(20, 'Maximum 20 phrases'),
  customGuidance: safeTextSchema.max(500, 'Maximum 500 characters').nullable(),
});

export type StylePreferences = z.infer<typeof stylePreferencesSchema>;
```

Create apps/web-portal/app/(dashboard)/style/actions.ts:

```typescript
'use server';

import { revalidatePath } from 'next/cache';
import { db, userStylePreferences } from '@slack-speak-for-me/database';
import { eq, and } from 'drizzle-orm';
import { verifySession } from '@/lib/auth/dal';
import { stylePreferencesSchema } from '@/lib/validations/style';

export type ActionResult = {
  success?: boolean;
  errors?: Record<string, string[]>;
};

export async function updateStylePreferences(formData: FormData): Promise<ActionResult> {
  const session = await verifySession();

  // Parse form data
  const rawData = {
    tone: formData.get('tone') as string | null,
    formality: formData.get('formality') as string | null,
    preferredPhrases: JSON.parse((formData.get('preferredPhrases') as string) || '[]'),
    avoidPhrases: JSON.parse((formData.get('avoidPhrases') as string) || '[]'),
    customGuidance: formData.get('customGuidance') as string | null,
  };

  // Validate
  const result = stylePreferencesSchema.safeParse(rawData);

  if (!result.success) {
    return {
      errors: result.error.flatten().fieldErrors as Record<string, string[]>,
    };
  }

  const { tone, formality, preferredPhrases, avoidPhrases, customGuidance } = result.data;

  // Upsert preferences
  await db
    .insert(userStylePreferences)
    .values({
      workspaceId: session.workspaceId,
      userId: session.userId,
      tone,
      formality,
      preferredPhrases,
      avoidPhrases,
      customGuidance,
      updatedAt: new Date(),
    })
    .onConflictDoUpdate({
      target: [userStylePreferences.workspaceId, userStylePreferences.userId],
      set: {
        tone,
        formality,
        preferredPhrases,
        avoidPhrases,
        customGuidance,
        updatedAt: new Date(),
      },
    });

  revalidatePath('/style');
  revalidatePath('/');

  return { success: true };
}
```
  </action>
  <verify>
    ls apps/web-portal/app/(dashboard)/style/actions.ts
    ls apps/web-portal/lib/validations/style.ts
    grep -n "updateStylePreferences" apps/web-portal/app/(dashboard)/style/actions.ts
  </verify>
  <done>Server action created with Zod validation and injection protection</done>
</task>

<task type="auto">
  <name>Task 3: Create style preferences form and page</name>
  <files>
    apps/web-portal/components/forms/style-preferences-form.tsx
    apps/web-portal/app/(dashboard)/style/page.tsx
  </files>
  <action>
Create apps/web-portal/components/forms/style-preferences-form.tsx:

```typescript
'use client';

import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { useState, useTransition } from 'react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Textarea } from '@/components/ui/textarea';
import { TagInput } from './tag-input';
import { stylePreferencesSchema, StylePreferences } from '@/lib/validations/style';
import { updateStylePreferences, ActionResult } from '@/app/(dashboard)/style/actions';
import { useToast } from '@/hooks/use-toast';

interface StylePreferencesFormProps {
  defaultValues?: Partial<StylePreferences>;
}

export function StylePreferencesForm({ defaultValues }: StylePreferencesFormProps) {
  const [isPending, startTransition] = useTransition();
  const { toast } = useToast();

  const form = useForm<StylePreferences>({
    resolver: zodResolver(stylePreferencesSchema),
    defaultValues: {
      tone: defaultValues?.tone ?? null,
      formality: defaultValues?.formality ?? null,
      preferredPhrases: defaultValues?.preferredPhrases ?? [],
      avoidPhrases: defaultValues?.avoidPhrases ?? [],
      customGuidance: defaultValues?.customGuidance ?? null,
    },
  });

  async function onSubmit(data: StylePreferences) {
    startTransition(async () => {
      const formData = new FormData();
      formData.set('tone', data.tone ?? '');
      formData.set('formality', data.formality ?? '');
      formData.set('preferredPhrases', JSON.stringify(data.preferredPhrases));
      formData.set('avoidPhrases', JSON.stringify(data.avoidPhrases));
      formData.set('customGuidance', data.customGuidance ?? '');

      const result = await updateStylePreferences(formData);

      if (result.success) {
        toast({
          title: 'Settings saved',
          description: 'Your style preferences have been updated.',
        });
      } else if (result.errors) {
        toast({
          title: 'Error',
          description: 'Please check the form for errors.',
          variant: 'destructive',
        });
        // Set form errors
        Object.entries(result.errors).forEach(([field, messages]) => {
          form.setError(field as keyof StylePreferences, {
            message: messages?.[0],
          });
        });
      }
    });
  }

  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
        <Card>
          <CardHeader>
            <CardTitle>Tone & Formality</CardTitle>
            <CardDescription>
              Set your default communication style for AI suggestions
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <FormField
              control={form.control}
              name="tone"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Tone</FormLabel>
                  <Select
                    onValueChange={field.onChange}
                    defaultValue={field.value ?? undefined}
                  >
                    <FormControl>
                      <SelectTrigger>
                        <SelectValue placeholder="Select a tone" />
                      </SelectTrigger>
                    </FormControl>
                    <SelectContent>
                      <SelectItem value="Professional">Professional</SelectItem>
                      <SelectItem value="Friendly">Friendly</SelectItem>
                      <SelectItem value="Direct">Direct</SelectItem>
                      <SelectItem value="Empathetic">Empathetic</SelectItem>
                    </SelectContent>
                  </Select>
                  <FormDescription>
                    The overall emotional quality of your messages
                  </FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="formality"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Formality</FormLabel>
                  <Select
                    onValueChange={field.onChange}
                    defaultValue={field.value ?? undefined}
                  >
                    <FormControl>
                      <SelectTrigger>
                        <SelectValue placeholder="Select formality level" />
                      </SelectTrigger>
                    </FormControl>
                    <SelectContent>
                      <SelectItem value="Casual">Casual</SelectItem>
                      <SelectItem value="Neutral">Neutral</SelectItem>
                      <SelectItem value="Formal">Formal</SelectItem>
                    </SelectContent>
                  </Select>
                  <FormDescription>
                    How formal or casual your messages should be
                  </FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>Phrases</CardTitle>
            <CardDescription>
              Phrases you like to use or want to avoid
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-6">
            <FormField
              control={form.control}
              name="preferredPhrases"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Phrases to use</FormLabel>
                  <FormControl>
                    <TagInput
                      value={field.value}
                      onChange={field.onChange}
                      placeholder="e.g., 'Thanks for reaching out'"
                      maxTags={20}
                      maxLength={100}
                    />
                  </FormControl>
                  <FormDescription>
                    Phrases AI should try to incorporate in suggestions
                  </FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="avoidPhrases"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Phrases to avoid</FormLabel>
                  <FormControl>
                    <TagInput
                      value={field.value}
                      onChange={field.onChange}
                      placeholder="e.g., 'No worries'"
                      maxTags={20}
                      maxLength={100}
                    />
                  </FormControl>
                  <FormDescription>
                    Phrases AI should never use in suggestions
                  </FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>Custom Guidance</CardTitle>
            <CardDescription>
              Any additional instructions for the AI
            </CardDescription>
          </CardHeader>
          <CardContent>
            <FormField
              control={form.control}
              name="customGuidance"
              render={({ field }) => (
                <FormItem>
                  <FormControl>
                    <Textarea
                      placeholder="e.g., 'Always acknowledge the other person's point before disagreeing'"
                      className="min-h-[100px]"
                      {...field}
                      value={field.value ?? ''}
                    />
                  </FormControl>
                  <FormDescription>
                    {(field.value?.length ?? 0)}/500 characters
                  </FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />
          </CardContent>
        </Card>

        <div className="flex justify-end">
          <Button type="submit" disabled={isPending}>
            {isPending ? 'Saving...' : 'Save Settings'}
          </Button>
        </div>
      </form>
    </Form>
  );
}
```

Create apps/web-portal/app/(dashboard)/style/page.tsx:

```typescript
import { StylePreferencesForm } from '@/components/forms/style-preferences-form';
import { getStylePreferences } from '@/lib/db/queries';

export default async function StylePage() {
  const prefs = await getStylePreferences();

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-3xl font-bold text-gray-900">Style Settings</h1>
        <p className="text-gray-600 mt-1">
          Configure how AI generates response suggestions for you
        </p>
      </div>

      <StylePreferencesForm
        defaultValues={prefs ? {
          tone: prefs.tone as 'Professional' | 'Friendly' | 'Direct' | 'Empathetic' | null,
          formality: prefs.formality as 'Casual' | 'Neutral' | 'Formal' | null,
          preferredPhrases: prefs.preferredPhrases ?? [],
          avoidPhrases: prefs.avoidPhrases ?? [],
          customGuidance: prefs.customGuidance,
        } : undefined}
      />
    </div>
  );
}
```

Create apps/web-portal/hooks/use-toast.ts (if not created by shadcn):
```bash
cd apps/web-portal && npx shadcn@latest add toast
```

This will add the toast hook and Toaster component. Make sure to add Toaster to app/layout.tsx if not already there.
  </action>
  <verify>
    ls apps/web-portal/components/forms/style-preferences-form.tsx
    ls apps/web-portal/app/(dashboard)/style/page.tsx
    npm run build --workspace=web-portal
  </verify>
  <done>Style preferences form and page created with all PORTAL-06 and PORTAL-07 fields</done>
</task>

</tasks>

<verification>
1. /style page renders with tone, formality, phrases, and guidance sections
2. Dropdown selects work for tone and formality
3. Tag input allows adding and removing phrases
4. Custom guidance textarea with character counter
5. Form submits and shows success toast
6. Settings persist after page refresh
7. Validation errors display correctly
8. Build passes without errors
</verification>

<success_criteria>
- Tone dropdown with Professional, Friendly, Direct, Empathetic options
- Formality dropdown with Casual, Neutral, Formal options
- Tag input for phrases to use (max 20 items, 100 chars each)
- Tag input for phrases to avoid (same limits)
- Custom guidance textarea (max 500 chars)
- Form validation with Zod schema
- Injection protection for spotlighting markers
- Success/error toast notifications
- Settings saved to database and persist
</success_criteria>

<output>
After completion, create `.planning/phases/04-web-portal/04-05-SUMMARY.md`
</output>
