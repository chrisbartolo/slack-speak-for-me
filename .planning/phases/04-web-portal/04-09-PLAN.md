---
phase: 04-web-portal
plan: 09
type: execute
wave: 4
depends_on: ["04-02", "04-04"]
files_modified:
  - apps/web-portal/app/(dashboard)/reports/page.tsx
  - apps/web-portal/app/(dashboard)/reports/actions.ts
  - apps/web-portal/components/forms/report-settings-form.tsx
  - packages/database/src/schema.ts
  - apps/web-portal/lib/db/queries.ts
autonomous: true

must_haves:
  truths:
    - "User can configure weekly report schedule"
    - "User can select day and time for reports"
    - "User can choose report recipients"
    - "Settings persist after save"
  artifacts:
    - path: "apps/web-portal/app/(dashboard)/reports/page.tsx"
      provides: "Reports settings page"
      contains: "ReportSettingsForm"
    - path: "apps/web-portal/app/(dashboard)/reports/actions.ts"
      provides: "Server actions for report settings"
      exports: ["saveReportSettings"]
    - path: "packages/database/src/schema.ts"
      provides: "reportSettings table"
      contains: "reportSettings"
  key_links:
    - from: "apps/web-portal/components/forms/report-settings-form.tsx"
      to: "apps/web-portal/app/(dashboard)/reports/actions.ts"
      via: "form action"
      pattern: "saveReportSettings"
---

<objective>
Create reports settings page for configuring weekly report generation preferences.

Purpose: Enable PORTAL-10 requirement - users can configure weekly report settings including schedule, format, and recipients. This prepares for Phase 5 which implements actual report generation.
Output: Reports settings page with schedule picker, format options, and recipient configuration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-web-portal/04-CONTEXT.md
@.planning/phases/04-web-portal/04-RESEARCH.md
@.planning/phases/04-web-portal/04-02-SUMMARY.md
@.planning/phases/04-web-portal/04-04-SUMMARY.md
@packages/database/src/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add reportSettings table to database schema</name>
  <files>
    packages/database/src/schema.ts
  </files>
  <action>
Add the reportSettings table to packages/database/src/schema.ts:

```typescript
export const reportSettings = pgTable('report_settings', {
  id: uuid('id').primaryKey().defaultRandom(),
  workspaceId: uuid('workspace_id').notNull().references(() => workspaces.id),
  userId: text('user_id').notNull(),

  // Schedule settings
  enabled: boolean('enabled').default(false),
  dayOfWeek: integer('day_of_week').default(1), // 0=Sunday, 1=Monday, etc.
  timeOfDay: text('time_of_day').default('09:00'), // HH:mm format
  timezone: text('timezone').default('UTC'),

  // Format settings
  format: text('format').default('detailed'), // 'concise' | 'detailed'
  sections: jsonb('sections').$type<string[]>().default(['achievements', 'focus', 'blockers', 'shoutouts']),

  // Delivery settings
  autoSend: boolean('auto_send').default(false), // false = draft for review, true = auto-send
  recipientChannelId: text('recipient_channel_id'), // DM or channel to send to

  createdAt: timestamp('created_at').defaultNow(),
  updatedAt: timestamp('updated_at').defaultNow(),
}, (table) => ({
  uniqueSettings: uniqueIndex('report_settings_unique_idx').on(table.workspaceId, table.userId),
}));
```

Import boolean and integer from drizzle-orm/pg-core if not already imported:

```typescript
import { pgTable, uuid, text, timestamp, index, uniqueIndex, jsonb, boolean, integer } from 'drizzle-orm/pg-core';
```

Run db:push to apply the schema change:

```bash
npm run db:push --workspace=@slack-speak-for-me/database
```

Export reportSettings from index.ts if not using wildcard export.
  </action>
  <verify>
    grep -n "reportSettings" packages/database/src/schema.ts
    npm run db:push --workspace=@slack-speak-for-me/database
  </verify>
  <done>reportSettings table added to database schema</done>
</task>

<task type="auto">
  <name>Task 2: Create server actions and queries for report settings</name>
  <files>
    apps/web-portal/app/(dashboard)/reports/actions.ts
    apps/web-portal/lib/validations/report-settings.ts
    apps/web-portal/lib/db/queries.ts
  </files>
  <action>
Create apps/web-portal/lib/validations/report-settings.ts:

```typescript
import { z } from 'zod';

export const reportSettingsSchema = z.object({
  enabled: z.boolean(),
  dayOfWeek: z.number().min(0).max(6),
  timeOfDay: z.string().regex(/^([01]\d|2[0-3]):([0-5]\d)$/, 'Invalid time format'),
  timezone: z.string().min(1),
  format: z.enum(['concise', 'detailed']),
  sections: z.array(z.enum(['achievements', 'focus', 'blockers', 'shoutouts'])).min(1),
  autoSend: z.boolean(),
});

export type ReportSettings = z.infer<typeof reportSettingsSchema>;
```

Update apps/web-portal/lib/db/queries.ts to add getReportSettings:

```typescript
// Add to existing queries.ts

import { reportSettings } from '@slack-speak-for-me/database';

export const getReportSettings = cache(async () => {
  const session = await verifySession();

  const [settings] = await db
    .select()
    .from(reportSettings)
    .where(
      and(
        eq(reportSettings.workspaceId, session.workspaceId),
        eq(reportSettings.userId, session.userId)
      )
    )
    .limit(1);

  return settings ?? null;
});
```

Create apps/web-portal/app/(dashboard)/reports/actions.ts:

```typescript
'use server';

import { revalidatePath } from 'next/cache';
import { db, reportSettings } from '@slack-speak-for-me/database';
import { eq, and } from 'drizzle-orm';
import { verifySession } from '@/lib/auth/dal';
import { reportSettingsSchema } from '@/lib/validations/report-settings';

export type ActionResult = {
  success?: boolean;
  error?: string;
  errors?: Record<string, string[]>;
};

export async function saveReportSettings(formData: FormData): Promise<ActionResult> {
  const session = await verifySession();

  const rawData = {
    enabled: formData.get('enabled') === 'true',
    dayOfWeek: parseInt(formData.get('dayOfWeek') as string, 10),
    timeOfDay: formData.get('timeOfDay') as string,
    timezone: formData.get('timezone') as string,
    format: formData.get('format') as string,
    sections: JSON.parse((formData.get('sections') as string) || '[]'),
    autoSend: formData.get('autoSend') === 'true',
  };

  const result = reportSettingsSchema.safeParse(rawData);

  if (!result.success) {
    return {
      errors: result.error.flatten().fieldErrors as Record<string, string[]>,
    };
  }

  const data = result.data;

  try {
    await db
      .insert(reportSettings)
      .values({
        workspaceId: session.workspaceId,
        userId: session.userId,
        enabled: data.enabled,
        dayOfWeek: data.dayOfWeek,
        timeOfDay: data.timeOfDay,
        timezone: data.timezone,
        format: data.format,
        sections: data.sections,
        autoSend: data.autoSend,
        updatedAt: new Date(),
      })
      .onConflictDoUpdate({
        target: [reportSettings.workspaceId, reportSettings.userId],
        set: {
          enabled: data.enabled,
          dayOfWeek: data.dayOfWeek,
          timeOfDay: data.timeOfDay,
          timezone: data.timezone,
          format: data.format,
          sections: data.sections,
          autoSend: data.autoSend,
          updatedAt: new Date(),
        },
      });

    revalidatePath('/reports');
    return { success: true };
  } catch (error) {
    console.error('Error saving report settings:', error);
    return { error: 'Failed to save settings' };
  }
}
```
  </action>
  <verify>
    ls apps/web-portal/app/(dashboard)/reports/actions.ts
    ls apps/web-portal/lib/validations/report-settings.ts
    grep -n "getReportSettings" apps/web-portal/lib/db/queries.ts
  </verify>
  <done>Server actions and queries for report settings created</done>
</task>

<task type="auto">
  <name>Task 3: Create report settings form and page</name>
  <files>
    apps/web-portal/components/forms/report-settings-form.tsx
    apps/web-portal/app/(dashboard)/reports/page.tsx
  </files>
  <action>
Create apps/web-portal/components/forms/report-settings-form.tsx:

```typescript
'use client';

import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { useTransition } from 'react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Input } from '@/components/ui/input';
import { Switch } from '@/components/ui/switch';
import { Checkbox } from '@/components/ui/checkbox';
import { reportSettingsSchema, ReportSettings } from '@/lib/validations/report-settings';
import { saveReportSettings, ActionResult } from '@/app/(dashboard)/reports/actions';
import { useToast } from '@/hooks/use-toast';

const daysOfWeek = [
  { value: '0', label: 'Sunday' },
  { value: '1', label: 'Monday' },
  { value: '2', label: 'Tuesday' },
  { value: '3', label: 'Wednesday' },
  { value: '4', label: 'Thursday' },
  { value: '5', label: 'Friday' },
  { value: '6', label: 'Saturday' },
];

const sections = [
  { id: 'achievements', label: 'Achievements' },
  { id: 'focus', label: 'Current Focus' },
  { id: 'blockers', label: 'Blockers' },
  { id: 'shoutouts', label: 'Shoutouts' },
];

const timezones = [
  'America/New_York',
  'America/Chicago',
  'America/Denver',
  'America/Los_Angeles',
  'Europe/London',
  'Europe/Paris',
  'Asia/Tokyo',
  'Australia/Sydney',
  'UTC',
];

interface ReportSettingsFormProps {
  defaultValues?: Partial<ReportSettings>;
}

export function ReportSettingsForm({ defaultValues }: ReportSettingsFormProps) {
  const [isPending, startTransition] = useTransition();
  const { toast } = useToast();

  const form = useForm<ReportSettings>({
    resolver: zodResolver(reportSettingsSchema),
    defaultValues: {
      enabled: defaultValues?.enabled ?? false,
      dayOfWeek: defaultValues?.dayOfWeek ?? 1,
      timeOfDay: defaultValues?.timeOfDay ?? '09:00',
      timezone: defaultValues?.timezone ?? 'America/New_York',
      format: defaultValues?.format ?? 'detailed',
      sections: defaultValues?.sections ?? ['achievements', 'focus', 'blockers', 'shoutouts'],
      autoSend: defaultValues?.autoSend ?? false,
    },
  });

  const enabled = form.watch('enabled');

  async function onSubmit(data: ReportSettings) {
    startTransition(async () => {
      const formData = new FormData();
      formData.set('enabled', String(data.enabled));
      formData.set('dayOfWeek', String(data.dayOfWeek));
      formData.set('timeOfDay', data.timeOfDay);
      formData.set('timezone', data.timezone);
      formData.set('format', data.format);
      formData.set('sections', JSON.stringify(data.sections));
      formData.set('autoSend', String(data.autoSend));

      const result = await saveReportSettings(formData);

      if (result.success) {
        toast({
          title: 'Settings saved',
          description: 'Your report settings have been updated.',
        });
      } else if (result.errors) {
        Object.entries(result.errors).forEach(([field, messages]) => {
          form.setError(field as keyof ReportSettings, {
            message: messages?.[0],
          });
        });
      } else if (result.error) {
        toast({
          title: 'Error',
          description: result.error,
          variant: 'destructive',
        });
      }
    });
  }

  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-6">
        <Card>
          <CardHeader>
            <CardTitle>Report Schedule</CardTitle>
            <CardDescription>
              Configure when weekly reports should be generated
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-4">
            <FormField
              control={form.control}
              name="enabled"
              render={({ field }) => (
                <FormItem className="flex flex-row items-center justify-between rounded-lg border p-4">
                  <div className="space-y-0.5">
                    <FormLabel className="text-base">Enable scheduled reports</FormLabel>
                    <FormDescription>
                      Automatically generate reports on schedule
                    </FormDescription>
                  </div>
                  <FormControl>
                    <Switch checked={field.value} onCheckedChange={field.onChange} />
                  </FormControl>
                </FormItem>
              )}
            />

            <div className={!enabled ? 'opacity-50 pointer-events-none' : ''}>
              <div className="grid gap-4 md:grid-cols-3">
                <FormField
                  control={form.control}
                  name="dayOfWeek"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Day</FormLabel>
                      <Select
                        onValueChange={(v) => field.onChange(parseInt(v, 10))}
                        value={String(field.value)}
                      >
                        <FormControl>
                          <SelectTrigger>
                            <SelectValue placeholder="Select day" />
                          </SelectTrigger>
                        </FormControl>
                        <SelectContent>
                          {daysOfWeek.map((day) => (
                            <SelectItem key={day.value} value={day.value}>
                              {day.label}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                <FormField
                  control={form.control}
                  name="timeOfDay"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Time</FormLabel>
                      <FormControl>
                        <Input type="time" {...field} />
                      </FormControl>
                      <FormMessage />
                    </FormItem>
                  )}
                />

                <FormField
                  control={form.control}
                  name="timezone"
                  render={({ field }) => (
                    <FormItem>
                      <FormLabel>Timezone</FormLabel>
                      <Select onValueChange={field.onChange} value={field.value}>
                        <FormControl>
                          <SelectTrigger>
                            <SelectValue placeholder="Select timezone" />
                          </SelectTrigger>
                        </FormControl>
                        <SelectContent>
                          {timezones.map((tz) => (
                            <SelectItem key={tz} value={tz}>
                              {tz.replace('_', ' ')}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                      <FormMessage />
                    </FormItem>
                  )}
                />
              </div>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>Report Format</CardTitle>
            <CardDescription>
              Choose how your reports should be formatted
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-6">
            <FormField
              control={form.control}
              name="format"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Length</FormLabel>
                  <Select onValueChange={field.onChange} value={field.value}>
                    <FormControl>
                      <SelectTrigger>
                        <SelectValue placeholder="Select format" />
                      </SelectTrigger>
                    </FormControl>
                    <SelectContent>
                      <SelectItem value="concise">Concise (bullet points)</SelectItem>
                      <SelectItem value="detailed">Detailed (full summaries)</SelectItem>
                    </SelectContent>
                  </Select>
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="sections"
              render={() => (
                <FormItem>
                  <div className="mb-4">
                    <FormLabel>Include sections</FormLabel>
                    <FormDescription>
                      Select which sections to include in reports
                    </FormDescription>
                  </div>
                  <div className="space-y-2">
                    {sections.map((section) => (
                      <FormField
                        key={section.id}
                        control={form.control}
                        name="sections"
                        render={({ field }) => (
                          <FormItem className="flex flex-row items-center space-x-3 space-y-0">
                            <FormControl>
                              <Checkbox
                                checked={field.value?.includes(section.id as any)}
                                onCheckedChange={(checked) => {
                                  const current = field.value || [];
                                  if (checked) {
                                    field.onChange([...current, section.id]);
                                  } else {
                                    field.onChange(current.filter((v) => v !== section.id));
                                  }
                                }}
                              />
                            </FormControl>
                            <FormLabel className="font-normal">{section.label}</FormLabel>
                          </FormItem>
                        )}
                      />
                    ))}
                  </div>
                  <FormMessage />
                </FormItem>
              )}
            />
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>Delivery</CardTitle>
            <CardDescription>
              Control how reports are delivered to you
            </CardDescription>
          </CardHeader>
          <CardContent>
            <FormField
              control={form.control}
              name="autoSend"
              render={({ field }) => (
                <FormItem className="flex flex-row items-center justify-between rounded-lg border p-4">
                  <div className="space-y-0.5">
                    <FormLabel className="text-base">Auto-send reports</FormLabel>
                    <FormDescription>
                      When disabled, reports are sent as drafts for your review before sharing
                    </FormDescription>
                  </div>
                  <FormControl>
                    <Switch checked={field.value} onCheckedChange={field.onChange} />
                  </FormControl>
                </FormItem>
              )}
            />
          </CardContent>
        </Card>

        <div className="flex justify-end">
          <Button type="submit" disabled={isPending}>
            {isPending ? 'Saving...' : 'Save Settings'}
          </Button>
        </div>
      </form>
    </Form>
  );
}
```

Add switch and checkbox components:
```bash
cd apps/web-portal && npx shadcn@latest add switch checkbox
```

Create apps/web-portal/app/(dashboard)/reports/page.tsx:

```typescript
import { FileText } from 'lucide-react';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { ReportSettingsForm } from '@/components/forms/report-settings-form';
import { getReportSettings } from '@/lib/db/queries';

export default async function ReportsPage() {
  const settings = await getReportSettings();

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-3xl font-bold text-gray-900">Weekly Reports</h1>
        <p className="text-gray-600 mt-1">
          Configure automatic weekly report generation
        </p>
      </div>

      <ReportSettingsForm
        defaultValues={settings ? {
          enabled: settings.enabled ?? false,
          dayOfWeek: settings.dayOfWeek ?? 1,
          timeOfDay: settings.timeOfDay ?? '09:00',
          timezone: settings.timezone ?? 'America/New_York',
          format: (settings.format as 'concise' | 'detailed') ?? 'detailed',
          sections: (settings.sections as string[]) ?? ['achievements', 'focus', 'blockers', 'shoutouts'],
          autoSend: settings.autoSend ?? false,
        } : undefined}
      />

      <Card>
        <CardHeader>
          <CardTitle>How reports work</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4 text-sm text-gray-600">
          <div className="flex gap-3">
            <div className="flex-shrink-0 w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs font-medium">
              1
            </div>
            <p>
              <strong className="text-gray-900">Team submits updates:</strong>{' '}
              Your direct reports submit weekly updates via Slack workflow form
            </p>
          </div>
          <div className="flex gap-3">
            <div className="flex-shrink-0 w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs font-medium">
              2
            </div>
            <p>
              <strong className="text-gray-900">AI aggregates:</strong>{' '}
              Submissions are automatically collected and summarized
            </p>
          </div>
          <div className="flex gap-3">
            <div className="flex-shrink-0 w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs font-medium">
              3
            </div>
            <p>
              <strong className="text-gray-900">Report generated:</strong>{' '}
              AI creates a board-ready summary with achievements, focus areas, blockers, and shoutouts
            </p>
          </div>
          <div className="flex gap-3">
            <div className="flex-shrink-0 w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs font-medium">
              4
            </div>
            <p>
              <strong className="text-gray-900">Review and share:</strong>{' '}
              Report is sent to you for review. You can refine and copy to share.
            </p>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
```
  </action>
  <verify>
    ls apps/web-portal/components/forms/report-settings-form.tsx
    ls apps/web-portal/app/(dashboard)/reports/page.tsx
    npm run build --workspace=web-portal
  </verify>
  <done>Report settings form and page created with schedule, format, and delivery options</done>
</task>

</tasks>

<verification>
1. /reports page renders with settings form
2. Enable/disable toggle for scheduled reports
3. Day, time, and timezone selectors work
4. Format dropdown (concise/detailed) works
5. Section checkboxes (achievements, focus, blockers, shoutouts) work
6. Auto-send toggle works
7. Form submits and shows success toast
8. Settings persist after page refresh
9. How reports work section explains the workflow
10. Build passes without errors
</verification>

<success_criteria>
- Schedule configuration (day, time, timezone)
- Enable/disable toggle for automatic generation
- Format selection (concise vs detailed)
- Section selection via checkboxes
- Auto-send toggle for draft vs automatic delivery
- Settings saved to database and persist
- Form validation with Zod schema
- Toast notifications for save success/error
</success_criteria>

<output>
After completion, create `.planning/phases/04-web-portal/04-09-SUMMARY.md`
</output>
