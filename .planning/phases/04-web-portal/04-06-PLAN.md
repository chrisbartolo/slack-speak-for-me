---
phase: 04-web-portal
plan: 06
type: execute
wave: 4
depends_on: ["04-04"]
files_modified:
  - apps/web-portal/app/(dashboard)/conversations/page.tsx
  - apps/web-portal/app/(dashboard)/conversations/actions.ts
  - apps/web-portal/components/dashboard/conversation-list.tsx
  - apps/web-portal/lib/db/queries.ts
autonomous: true

must_haves:
  truths:
    - "User can see list of watched conversations"
    - "User can toggle watch status for channels"
    - "User can remove channels from monitoring"
    - "Changes persist after page refresh"
  artifacts:
    - path: "apps/web-portal/app/(dashboard)/conversations/page.tsx"
      provides: "Conversations management page"
      contains: "ConversationList"
    - path: "apps/web-portal/app/(dashboard)/conversations/actions.ts"
      provides: "Server actions for watch management"
      exports: ["unwatchConversation"]
    - path: "apps/web-portal/components/dashboard/conversation-list.tsx"
      provides: "List component for conversations"
      exports: ["ConversationList"]
  key_links:
    - from: "apps/web-portal/components/dashboard/conversation-list.tsx"
      to: "apps/web-portal/app/(dashboard)/conversations/actions.ts"
      via: "form action"
      pattern: "unwatchConversation"
---

<objective>
Create conversations management page for viewing and managing watched channels.

Purpose: Enable PORTAL-08 (view/manage monitored channels) and PORTAL-09 (view/manage watched conversations) requirements. Users can see what channels are being monitored and remove them.
Output: Conversations page with list of watched channels and unwatch functionality.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-web-portal/04-CONTEXT.md
@.planning/phases/04-web-portal/04-RESEARCH.md
@.planning/phases/04-web-portal/04-04-SUMMARY.md
@packages/database/src/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create server actions for conversation management</name>
  <files>
    apps/web-portal/app/(dashboard)/conversations/actions.ts
  </files>
  <action>
Create apps/web-portal/app/(dashboard)/conversations/actions.ts:

```typescript
'use server';

import { revalidatePath } from 'next/cache';
import { db, watchedConversations } from '@slack-speak-for-me/database';
import { eq, and } from 'drizzle-orm';
import { verifySession } from '@/lib/auth/dal';

export type ActionResult = {
  success?: boolean;
  error?: string;
};

export async function unwatchConversation(conversationId: string): Promise<ActionResult> {
  const session = await verifySession();

  try {
    // Verify ownership and delete
    const deleted = await db
      .delete(watchedConversations)
      .where(
        and(
          eq(watchedConversations.id, conversationId),
          eq(watchedConversations.workspaceId, session.workspaceId),
          eq(watchedConversations.userId, session.userId)
        )
      )
      .returning();

    if (deleted.length === 0) {
      return { error: 'Conversation not found or already removed' };
    }

    revalidatePath('/conversations');
    revalidatePath('/');

    return { success: true };
  } catch (error) {
    console.error('Error unwatching conversation:', error);
    return { error: 'Failed to remove conversation' };
  }
}

// Note: Adding new channels to watch is done via Slack slash commands (/watch)
// The web portal only shows existing watches and allows removing them
```
  </action>
  <verify>
    ls apps/web-portal/app/(dashboard)/conversations/actions.ts
    grep -n "unwatchConversation" apps/web-portal/app/(dashboard)/conversations/actions.ts
  </verify>
  <done>Server action for unwatching conversations created</done>
</task>

<task type="auto">
  <name>Task 2: Create conversation list component</name>
  <files>
    apps/web-portal/components/dashboard/conversation-list.tsx
    apps/web-portal/components/dashboard/empty-state.tsx
  </files>
  <action>
Create apps/web-portal/components/dashboard/empty-state.tsx:

```typescript
import { LucideIcon } from 'lucide-react';

interface EmptyStateProps {
  icon: LucideIcon;
  title: string;
  description: string;
  action?: React.ReactNode;
}

export function EmptyState({ icon: Icon, title, description, action }: EmptyStateProps) {
  return (
    <div className="text-center py-12">
      <Icon className="mx-auto h-12 w-12 text-gray-400" />
      <h3 className="mt-4 text-lg font-medium text-gray-900">{title}</h3>
      <p className="mt-2 text-sm text-gray-500 max-w-sm mx-auto">{description}</p>
      {action && <div className="mt-6">{action}</div>}
    </div>
  );
}
```

Create apps/web-portal/components/dashboard/conversation-list.tsx:

```typescript
'use client';

import { useState, useTransition } from 'react';
import { Trash2, MessageSquare, Hash } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from '@/components/ui/alert-dialog';
import { unwatchConversation } from '@/app/(dashboard)/conversations/actions';
import { useToast } from '@/hooks/use-toast';
import { formatDistanceToNow } from 'date-fns';

interface Conversation {
  id: string;
  channelId: string;
  watchedAt: Date | null;
}

interface ConversationListProps {
  conversations: Conversation[];
}

export function ConversationList({ conversations }: ConversationListProps) {
  const [isPending, startTransition] = useTransition();
  const [removingId, setRemovingId] = useState<string | null>(null);
  const { toast } = useToast();

  const handleRemove = async (id: string) => {
    setRemovingId(id);
    startTransition(async () => {
      const result = await unwatchConversation(id);

      if (result.success) {
        toast({
          title: 'Channel removed',
          description: 'You will no longer receive suggestions for this channel.',
        });
      } else {
        toast({
          title: 'Error',
          description: result.error || 'Failed to remove channel',
          variant: 'destructive',
        });
      }
      setRemovingId(null);
    });
  };

  return (
    <div className="space-y-4">
      {conversations.map((conversation) => (
        <Card key={conversation.id}>
          <CardContent className="flex items-center justify-between p-4">
            <div className="flex items-center gap-3">
              <div className="p-2 bg-gray-100 rounded-lg">
                <Hash className="h-5 w-5 text-gray-600" />
              </div>
              <div>
                <p className="font-medium text-gray-900">{conversation.channelId}</p>
                <p className="text-sm text-gray-500">
                  {conversation.watchedAt
                    ? `Added ${formatDistanceToNow(conversation.watchedAt, { addSuffix: true })}`
                    : 'Recently added'}
                </p>
              </div>
            </div>

            <AlertDialog>
              <AlertDialogTrigger asChild>
                <Button
                  variant="ghost"
                  size="sm"
                  disabled={isPending && removingId === conversation.id}
                >
                  <Trash2 className="h-4 w-4 text-gray-400 hover:text-red-500" />
                </Button>
              </AlertDialogTrigger>
              <AlertDialogContent>
                <AlertDialogHeader>
                  <AlertDialogTitle>Remove channel?</AlertDialogTitle>
                  <AlertDialogDescription>
                    You will no longer receive AI suggestions for messages in this channel.
                    You can add it back anytime using /watch in Slack.
                  </AlertDialogDescription>
                </AlertDialogHeader>
                <AlertDialogFooter>
                  <AlertDialogCancel>Cancel</AlertDialogCancel>
                  <AlertDialogAction
                    onClick={() => handleRemove(conversation.id)}
                    className="bg-red-600 hover:bg-red-700"
                  >
                    Remove
                  </AlertDialogAction>
                </AlertDialogFooter>
              </AlertDialogContent>
            </AlertDialog>
          </CardContent>
        </Card>
      ))}
    </div>
  );
}
```

Add required shadcn components:
```bash
cd apps/web-portal && npx shadcn@latest add alert-dialog
```

Install date-fns:
```bash
npm install date-fns --workspace=web-portal
```
  </action>
  <verify>
    ls apps/web-portal/components/dashboard/conversation-list.tsx
    ls apps/web-portal/components/dashboard/empty-state.tsx
    ls apps/web-portal/components/ui/alert-dialog.tsx
  </verify>
  <done>Conversation list component created with remove functionality and confirmation dialog</done>
</task>

<task type="auto">
  <name>Task 3: Create conversations page</name>
  <files>
    apps/web-portal/app/(dashboard)/conversations/page.tsx
  </files>
  <action>
Create apps/web-portal/app/(dashboard)/conversations/page.tsx:

```typescript
import { MessageSquare } from 'lucide-react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { ConversationList } from '@/components/dashboard/conversation-list';
import { EmptyState } from '@/components/dashboard/empty-state';
import { getWatchedConversations } from '@/lib/db/queries';

export default async function ConversationsPage() {
  const conversations = await getWatchedConversations();

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-3xl font-bold text-gray-900">Conversations</h1>
        <p className="text-gray-600 mt-1">
          Channels where you receive AI response suggestions
        </p>
      </div>

      <Card>
        <CardHeader>
          <CardTitle>Watched Channels</CardTitle>
          <CardDescription>
            {conversations.length === 0
              ? 'No channels are being monitored'
              : `${conversations.length} channel${conversations.length === 1 ? '' : 's'} being monitored`}
          </CardDescription>
        </CardHeader>
        <CardContent>
          {conversations.length === 0 ? (
            <EmptyState
              icon={MessageSquare}
              title="No watched channels"
              description="Use /watch in any Slack channel to start receiving AI suggestions when you're mentioned or replied to."
            />
          ) : (
            <ConversationList conversations={conversations} />
          )}
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <CardTitle>How it works</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4 text-sm text-gray-600">
          <div className="flex gap-3">
            <div className="flex-shrink-0 w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs font-medium">
              1
            </div>
            <p>
              Use <code className="px-1 py-0.5 bg-gray-100 rounded">/watch</code> in a Slack channel to start monitoring
            </p>
          </div>
          <div className="flex gap-3">
            <div className="flex-shrink-0 w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs font-medium">
              2
            </div>
            <p>
              When someone mentions you or replies to your message, you'll receive an AI-generated response suggestion
            </p>
          </div>
          <div className="flex gap-3">
            <div className="flex-shrink-0 w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs font-medium">
              3
            </div>
            <p>
              The suggestion appears as a private message only you can see
            </p>
          </div>
          <div className="flex gap-3">
            <div className="flex-shrink-0 w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center text-xs font-medium">
              4
            </div>
            <p>
              Copy, refine, or dismiss the suggestion as needed
            </p>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
```
  </action>
  <verify>
    ls apps/web-portal/app/(dashboard)/conversations/page.tsx
    grep -n "getWatchedConversations" apps/web-portal/app/(dashboard)/conversations/page.tsx
    npm run build --workspace=web-portal
  </verify>
  <done>Conversations page created with list, empty state, and help section</done>
</task>

</tasks>

<verification>
1. /conversations page renders with header and description
2. Empty state shows when no channels are watched
3. Channel list shows channel IDs and watch dates
4. Remove button shows confirmation dialog
5. Removing channel updates list and shows toast
6. Changes persist after page refresh
7. Help section explains the workflow
8. Build passes without errors
</verification>

<success_criteria>
- Page shows list of all watched conversations
- Each conversation shows channel ID and when it was added
- Remove button with confirmation dialog
- Empty state with instructions when no channels
- Help section explaining /watch workflow
- Toast notifications for actions
- Changes persist in database
</success_criteria>

<output>
After completion, create `.planning/phases/04-web-portal/04-06-SUMMARY.md`
</output>
