---
phase: 04-web-portal
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/src/schema.ts
  - packages/database/src/migrations/0004_person_context.sql
autonomous: true

must_haves:
  truths:
    - "personContext table exists for storing notes about people"
    - "Database schema supports PORTAL-05 requirement"
    - "Schema migration runs without errors"
  artifacts:
    - path: "packages/database/src/schema.ts"
      provides: "personContext table definition"
      contains: "personContext"
    - path: "packages/database/src/migrations/0004_person_context.sql"
      provides: "Migration for new table"
      contains: "CREATE TABLE"
  key_links:
    - from: "packages/database/src/schema.ts"
      to: "workspaces table"
      via: "foreign key reference"
      pattern: "references.*workspaces"
---

<objective>
Add personContext table to database schema for storing user notes about people they communicate with.

Purpose: Enable PORTAL-05 requirement where users can add context/background information for specific people (relationship notes, communication preferences).
Output: Updated database schema with personContext table and migration file.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-web-portal/04-CONTEXT.md
@.planning/phases/04-web-portal/04-RESEARCH.md
@packages/database/src/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add personContext table to schema</name>
  <files>
    packages/database/src/schema.ts
  </files>
  <action>
Add the personContext table to packages/database/src/schema.ts:

```typescript
export const personContext = pgTable('person_context', {
  id: uuid('id').primaryKey().defaultRandom(),
  workspaceId: uuid('workspace_id').notNull().references(() => workspaces.id),
  userId: text('user_id').notNull(), // The user who owns this context
  targetSlackUserId: text('target_slack_user_id').notNull(), // The person they're adding context about
  contextText: text('context_text').notNull(), // Free-form notes (max 1000 chars enforced at app level)
  createdAt: timestamp('created_at').defaultNow(),
  updatedAt: timestamp('updated_at').defaultNow(),
}, (table) => ({
  workspaceUserIdx: index('person_context_workspace_user_idx').on(table.workspaceId, table.userId),
  uniquePersonContext: uniqueIndex('person_context_unique_idx').on(table.workspaceId, table.userId, table.targetSlackUserId),
}));
```

This table allows:
- Each user to store context about people they communicate with
- Unique constraint prevents duplicate entries for the same person
- Workspace isolation through workspaceId foreign key

The contextText field is free-form text. Per CONTEXT.md, this is per Slack user ID globally (not per-channel). 1000 char limit will be enforced at the service layer with Zod validation.
  </action>
  <verify>
    grep -n "personContext" packages/database/src/schema.ts
    TypeScript compilation passes: npm run build --workspace=@slack-speak-for-me/database
  </verify>
  <done>personContext table defined in schema with proper indexes and constraints</done>
</task>

<task type="auto">
  <name>Task 2: Generate and apply migration</name>
  <files>
    packages/database/src/migrations/0004_person_context.sql
  </files>
  <action>
Generate the migration for the new table:

```bash
npm run db:generate --workspace=@slack-speak-for-me/database
```

If using Drizzle's push approach (based on existing patterns), run:

```bash
npm run db:push --workspace=@slack-speak-for-me/database
```

Verify the migration file is created or the schema is pushed to the database.

If the project uses migration files, create packages/database/src/migrations/0004_person_context.sql with:

```sql
CREATE TABLE IF NOT EXISTS person_context (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  workspace_id UUID NOT NULL REFERENCES workspaces(id),
  user_id TEXT NOT NULL,
  target_slack_user_id TEXT NOT NULL,
  context_text TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS person_context_workspace_user_idx ON person_context(workspace_id, user_id);
CREATE UNIQUE INDEX IF NOT EXISTS person_context_unique_idx ON person_context(workspace_id, user_id, target_slack_user_id);
```

Check existing migration patterns in packages/database/src/migrations/ and follow the same approach.
  </action>
  <verify>
    Database schema includes person_context table
    npm run db:push --workspace=@slack-speak-for-me/database succeeds (or equivalent migration command)
  </verify>
  <done>Migration created and applied, person_context table exists in database</done>
</task>

<task type="auto">
  <name>Task 3: Export personContext from database package</name>
  <files>
    packages/database/src/index.ts
  </files>
  <action>
Ensure personContext is exported from the database package's index.ts:

Check packages/database/src/index.ts and add export if not automatically included:

```typescript
export { personContext } from './schema.js';
```

Or if using re-export pattern:
```typescript
export * from './schema.js';
```

Verify the export by building the database package:

```bash
npm run build --workspace=@slack-speak-for-me/database
```

Then test the import works in a quick check (can use node REPL or a test file).
  </action>
  <verify>
    npm run build --workspace=@slack-speak-for-me/database succeeds
    grep -n "personContext" packages/database/src/index.ts (or export * pattern)
  </verify>
  <done>personContext table exported from database package for use by web-portal</done>
</task>

</tasks>

<verification>
1. packages/database/src/schema.ts contains personContext table definition
2. Table has proper foreign key to workspaces, indexes, and unique constraint
3. Database migration applied successfully
4. Export available from @slack-speak-for-me/database package
</verification>

<success_criteria>
- personContext table exists in schema with id, workspaceId, userId, targetSlackUserId, contextText, timestamps
- Unique constraint on (workspaceId, userId, targetSlackUserId) prevents duplicates
- Index on (workspaceId, userId) for efficient queries
- Table can be imported from @slack-speak-for-me/database
</success_criteria>

<output>
After completion, create `.planning/phases/04-web-portal/04-02-SUMMARY.md`
</output>
