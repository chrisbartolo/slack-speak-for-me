---
phase: 04-web-portal
plan: 07
type: execute
wave: 4
depends_on: ["04-02", "04-04"]
files_modified:
  - apps/web-portal/app/(dashboard)/people/page.tsx
  - apps/web-portal/app/(dashboard)/people/actions.ts
  - apps/web-portal/components/dashboard/person-context-list.tsx
  - apps/web-portal/components/forms/person-context-form.tsx
  - apps/web-portal/lib/db/queries.ts
autonomous: true

must_haves:
  truths:
    - "User can see list of people with context added"
    - "User can add context for a new person"
    - "User can edit context for existing person"
    - "User can remove person context"
    - "Context persists after save"
  artifacts:
    - path: "apps/web-portal/app/(dashboard)/people/page.tsx"
      provides: "People context management page"
      contains: "PersonContextList"
    - path: "apps/web-portal/app/(dashboard)/people/actions.ts"
      provides: "Server actions for person context"
      exports: ["savePersonContext", "deletePersonContext"]
    - path: "apps/web-portal/components/dashboard/person-context-list.tsx"
      provides: "List component for person contexts"
      exports: ["PersonContextList"]
  key_links:
    - from: "apps/web-portal/components/forms/person-context-form.tsx"
      to: "apps/web-portal/app/(dashboard)/people/actions.ts"
      via: "form action"
      pattern: "savePersonContext"
    - from: "apps/web-portal/app/(dashboard)/people/actions.ts"
      to: "@slack-speak-for-me/database"
      via: "database query"
      pattern: "personContext"
---

<objective>
Create people management page for adding context about people the user communicates with.

Purpose: Enable PORTAL-05 requirement - users can add context/background information for specific people (relationship notes, communication preferences). This context helps AI generate more appropriate suggestions.
Output: People page with list of person contexts and add/edit/remove functionality.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-web-portal/04-CONTEXT.md
@.planning/phases/04-web-portal/04-RESEARCH.md
@.planning/phases/04-web-portal/04-02-SUMMARY.md
@.planning/phases/04-web-portal/04-04-SUMMARY.md
@packages/database/src/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create server actions for person context management</name>
  <files>
    apps/web-portal/app/(dashboard)/people/actions.ts
    apps/web-portal/lib/validations/person-context.ts
  </files>
  <action>
Create apps/web-portal/lib/validations/person-context.ts:

```typescript
import { z } from 'zod';

// Injection protection - block spotlighting markers
const safeTextSchema = z.string().refine(
  (val) => !val.includes('<|user_input_start|>') && !val.includes('<|user_input_end|>'),
  { message: 'Invalid characters detected' }
);

export const personContextSchema = z.object({
  targetSlackUserId: z
    .string()
    .min(1, 'Slack user ID is required')
    .regex(/^[UW][A-Z0-9]+$/, 'Invalid Slack user ID format'),
  contextText: safeTextSchema
    .min(1, 'Context is required')
    .max(1000, 'Maximum 1000 characters'),
});

export type PersonContextInput = z.infer<typeof personContextSchema>;
```

Create apps/web-portal/app/(dashboard)/people/actions.ts:

```typescript
'use server';

import { revalidatePath } from 'next/cache';
import { db, personContext } from '@slack-speak-for-me/database';
import { eq, and } from 'drizzle-orm';
import { verifySession } from '@/lib/auth/dal';
import { personContextSchema } from '@/lib/validations/person-context';

export type ActionResult = {
  success?: boolean;
  error?: string;
  errors?: Record<string, string[]>;
};

export async function savePersonContext(formData: FormData): Promise<ActionResult> {
  const session = await verifySession();

  const rawData = {
    targetSlackUserId: formData.get('targetSlackUserId') as string,
    contextText: formData.get('contextText') as string,
  };

  const result = personContextSchema.safeParse(rawData);

  if (!result.success) {
    return {
      errors: result.error.flatten().fieldErrors as Record<string, string[]>,
    };
  }

  const { targetSlackUserId, contextText } = result.data;

  try {
    // Upsert - create or update
    await db
      .insert(personContext)
      .values({
        workspaceId: session.workspaceId,
        userId: session.userId,
        targetSlackUserId,
        contextText,
        updatedAt: new Date(),
      })
      .onConflictDoUpdate({
        target: [personContext.workspaceId, personContext.userId, personContext.targetSlackUserId],
        set: {
          contextText,
          updatedAt: new Date(),
        },
      });

    revalidatePath('/people');
    return { success: true };
  } catch (error) {
    console.error('Error saving person context:', error);
    return { error: 'Failed to save context' };
  }
}

export async function deletePersonContext(id: string): Promise<ActionResult> {
  const session = await verifySession();

  try {
    const deleted = await db
      .delete(personContext)
      .where(
        and(
          eq(personContext.id, id),
          eq(personContext.workspaceId, session.workspaceId),
          eq(personContext.userId, session.userId)
        )
      )
      .returning();

    if (deleted.length === 0) {
      return { error: 'Context not found or already deleted' };
    }

    revalidatePath('/people');
    return { success: true };
  } catch (error) {
    console.error('Error deleting person context:', error);
    return { error: 'Failed to delete context' };
  }
}
```
  </action>
  <verify>
    ls apps/web-portal/app/(dashboard)/people/actions.ts
    ls apps/web-portal/lib/validations/person-context.ts
    grep -n "savePersonContext" apps/web-portal/app/(dashboard)/people/actions.ts
  </verify>
  <done>Server actions for person context CRUD operations created</done>
</task>

<task type="auto">
  <name>Task 2: Create person context form and list components</name>
  <files>
    apps/web-portal/components/forms/person-context-form.tsx
    apps/web-portal/components/dashboard/person-context-list.tsx
  </files>
  <action>
Create apps/web-portal/components/forms/person-context-form.tsx:

```typescript
'use client';

import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { useTransition } from 'react';
import { Button } from '@/components/ui/button';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from '@/components/ui/dialog';
import {
  Form,
  FormControl,
  FormDescription,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form';
import { Input } from '@/components/ui/input';
import { Textarea } from '@/components/ui/textarea';
import { Plus } from 'lucide-react';
import { personContextSchema, PersonContextInput } from '@/lib/validations/person-context';
import { savePersonContext } from '@/app/(dashboard)/people/actions';
import { useToast } from '@/hooks/use-toast';

interface PersonContextFormProps {
  defaultValues?: {
    targetSlackUserId: string;
    contextText: string;
  };
  trigger?: React.ReactNode;
  onSuccess?: () => void;
}

export function PersonContextForm({ defaultValues, trigger, onSuccess }: PersonContextFormProps) {
  const [isPending, startTransition] = useTransition();
  const [open, setOpen] = useState(false);
  const { toast } = useToast();

  const form = useForm<PersonContextInput>({
    resolver: zodResolver(personContextSchema),
    defaultValues: defaultValues ?? {
      targetSlackUserId: '',
      contextText: '',
    },
  });

  async function onSubmit(data: PersonContextInput) {
    startTransition(async () => {
      const formData = new FormData();
      formData.set('targetSlackUserId', data.targetSlackUserId);
      formData.set('contextText', data.contextText);

      const result = await savePersonContext(formData);

      if (result.success) {
        toast({
          title: defaultValues ? 'Context updated' : 'Context added',
          description: 'The person context has been saved.',
        });
        setOpen(false);
        form.reset();
        onSuccess?.();
      } else if (result.errors) {
        Object.entries(result.errors).forEach(([field, messages]) => {
          form.setError(field as keyof PersonContextInput, {
            message: messages?.[0],
          });
        });
      } else if (result.error) {
        toast({
          title: 'Error',
          description: result.error,
          variant: 'destructive',
        });
      }
    });
  }

  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogTrigger asChild>
        {trigger ?? (
          <Button>
            <Plus className="h-4 w-4 mr-2" />
            Add Person
          </Button>
        )}
      </DialogTrigger>
      <DialogContent className="sm:max-w-[500px]">
        <DialogHeader>
          <DialogTitle>{defaultValues ? 'Edit Context' : 'Add Person Context'}</DialogTitle>
          <DialogDescription>
            Add notes about this person to help AI generate better suggestions.
          </DialogDescription>
        </DialogHeader>

        <Form {...form}>
          <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
            <FormField
              control={form.control}
              name="targetSlackUserId"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Slack User ID</FormLabel>
                  <FormControl>
                    <Input
                      placeholder="e.g., U01ABC123"
                      {...field}
                      disabled={!!defaultValues}
                    />
                  </FormControl>
                  <FormDescription>
                    Find this by clicking on a user's profile in Slack and copying their member ID
                  </FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />

            <FormField
              control={form.control}
              name="contextText"
              render={({ field }) => (
                <FormItem>
                  <FormLabel>Context</FormLabel>
                  <FormControl>
                    <Textarea
                      placeholder="e.g., 'CMO, tends to bypass processes. CEO has asked me to push back diplomatically when they try to skip the roadmap.'"
                      className="min-h-[150px]"
                      {...field}
                    />
                  </FormControl>
                  <FormDescription>
                    {field.value.length}/1000 characters. Include relationship context, communication preferences, or background info.
                  </FormDescription>
                  <FormMessage />
                </FormItem>
              )}
            />

            <div className="flex justify-end gap-2">
              <Button type="button" variant="outline" onClick={() => setOpen(false)}>
                Cancel
              </Button>
              <Button type="submit" disabled={isPending}>
                {isPending ? 'Saving...' : 'Save Context'}
              </Button>
            </div>
          </form>
        </Form>
      </DialogContent>
    </Dialog>
  );
}

// Need to import useState
import { useState } from 'react';
```

Add dialog component:
```bash
cd apps/web-portal && npx shadcn@latest add dialog
```

Create apps/web-portal/components/dashboard/person-context-list.tsx:

```typescript
'use client';

import { useState, useTransition } from 'react';
import { Edit2, Trash2, User } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Card, CardContent } from '@/components/ui/card';
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from '@/components/ui/alert-dialog';
import { PersonContextForm } from '@/components/forms/person-context-form';
import { deletePersonContext } from '@/app/(dashboard)/people/actions';
import { useToast } from '@/hooks/use-toast';
import { formatDistanceToNow } from 'date-fns';

interface PersonContext {
  id: string;
  targetSlackUserId: string;
  contextText: string;
  updatedAt: Date | null;
}

interface PersonContextListProps {
  contexts: PersonContext[];
}

export function PersonContextList({ contexts }: PersonContextListProps) {
  const [isPending, startTransition] = useTransition();
  const [deletingId, setDeletingId] = useState<string | null>(null);
  const { toast } = useToast();

  const handleDelete = async (id: string) => {
    setDeletingId(id);
    startTransition(async () => {
      const result = await deletePersonContext(id);

      if (result.success) {
        toast({
          title: 'Context removed',
          description: 'The person context has been deleted.',
        });
      } else {
        toast({
          title: 'Error',
          description: result.error || 'Failed to delete context',
          variant: 'destructive',
        });
      }
      setDeletingId(null);
    });
  };

  return (
    <div className="space-y-4">
      {contexts.map((context) => (
        <Card key={context.id}>
          <CardContent className="p-4">
            <div className="flex items-start justify-between gap-4">
              <div className="flex items-start gap-3 flex-1 min-w-0">
                <div className="p-2 bg-gray-100 rounded-lg flex-shrink-0">
                  <User className="h-5 w-5 text-gray-600" />
                </div>
                <div className="flex-1 min-w-0">
                  <div className="flex items-center gap-2">
                    <p className="font-medium text-gray-900">{context.targetSlackUserId}</p>
                    {context.updatedAt && (
                      <span className="text-xs text-gray-400">
                        Updated {formatDistanceToNow(context.updatedAt, { addSuffix: true })}
                      </span>
                    )}
                  </div>
                  <p className="text-sm text-gray-600 mt-1 whitespace-pre-wrap">
                    {context.contextText}
                  </p>
                </div>
              </div>

              <div className="flex items-center gap-1 flex-shrink-0">
                <PersonContextForm
                  defaultValues={{
                    targetSlackUserId: context.targetSlackUserId,
                    contextText: context.contextText,
                  }}
                  trigger={
                    <Button variant="ghost" size="sm">
                      <Edit2 className="h-4 w-4 text-gray-400 hover:text-gray-600" />
                    </Button>
                  }
                />

                <AlertDialog>
                  <AlertDialogTrigger asChild>
                    <Button
                      variant="ghost"
                      size="sm"
                      disabled={isPending && deletingId === context.id}
                    >
                      <Trash2 className="h-4 w-4 text-gray-400 hover:text-red-500" />
                    </Button>
                  </AlertDialogTrigger>
                  <AlertDialogContent>
                    <AlertDialogHeader>
                      <AlertDialogTitle>Delete context?</AlertDialogTitle>
                      <AlertDialogDescription>
                        This will remove all context for this person. AI will no longer use this
                        information when generating suggestions.
                      </AlertDialogDescription>
                    </AlertDialogHeader>
                    <AlertDialogFooter>
                      <AlertDialogCancel>Cancel</AlertDialogCancel>
                      <AlertDialogAction
                        onClick={() => handleDelete(context.id)}
                        className="bg-red-600 hover:bg-red-700"
                      >
                        Delete
                      </AlertDialogAction>
                    </AlertDialogFooter>
                  </AlertDialogContent>
                </AlertDialog>
              </div>
            </div>
          </CardContent>
        </Card>
      ))}
    </div>
  );
}
```
  </action>
  <verify>
    ls apps/web-portal/components/forms/person-context-form.tsx
    ls apps/web-portal/components/dashboard/person-context-list.tsx
    ls apps/web-portal/components/ui/dialog.tsx
  </verify>
  <done>Person context form and list components created</done>
</task>

<task type="auto">
  <name>Task 3: Create people page</name>
  <files>
    apps/web-portal/app/(dashboard)/people/page.tsx
  </files>
  <action>
Create apps/web-portal/app/(dashboard)/people/page.tsx:

```typescript
import { Users } from 'lucide-react';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { PersonContextList } from '@/components/dashboard/person-context-list';
import { PersonContextForm } from '@/components/forms/person-context-form';
import { EmptyState } from '@/components/dashboard/empty-state';
import { getPersonContexts } from '@/lib/db/queries';

export default async function PeoplePage() {
  const contexts = await getPersonContexts();

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">People</h1>
          <p className="text-gray-600 mt-1">
            Add context about people to help AI generate better suggestions
          </p>
        </div>
        <PersonContextForm />
      </div>

      <Card>
        <CardHeader>
          <CardTitle>Person Contexts</CardTitle>
          <CardDescription>
            {contexts.length === 0
              ? 'No person contexts added yet'
              : `${contexts.length} ${contexts.length === 1 ? 'person' : 'people'} with context`}
          </CardDescription>
        </CardHeader>
        <CardContent>
          {contexts.length === 0 ? (
            <EmptyState
              icon={Users}
              title="No person contexts"
              description="Add context about people you communicate with to help AI understand your relationships and generate more appropriate suggestions."
              action={<PersonContextForm />}
            />
          ) : (
            <PersonContextList contexts={contexts} />
          )}
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <CardTitle>Tips for good context</CardTitle>
        </CardHeader>
        <CardContent className="space-y-3 text-sm text-gray-600">
          <p>
            <strong className="text-gray-900">Include relationship context:</strong>{' '}
            "My direct manager", "Senior VP I report to quarterly", "Cross-functional partner"
          </p>
          <p>
            <strong className="text-gray-900">Note communication preferences:</strong>{' '}
            "Prefers bullet points", "Appreciates detailed explanations", "Values brevity"
          </p>
          <p>
            <strong className="text-gray-900">Add relevant background:</strong>{' '}
            "Often pushes back on timelines", "Champion of our project", "New to the team"
          </p>
          <p>
            <strong className="text-gray-900">Share guidance you've received:</strong>{' '}
            "CEO asked me to push back diplomatically on scope creep requests"
          </p>
        </CardContent>
      </Card>
    </div>
  );
}
```
  </action>
  <verify>
    ls apps/web-portal/app/(dashboard)/people/page.tsx
    grep -n "getPersonContexts" apps/web-portal/app/(dashboard)/people/page.tsx
    npm run build --workspace=web-portal
  </verify>
  <done>People page created with list, add form, and tips section</done>
</task>

</tasks>

<verification>
1. /people page renders with header and Add Person button
2. Empty state shows when no contexts exist
3. Add Person dialog opens with form
4. Form validates Slack user ID format
5. Form validates context length (max 1000 chars)
6. Saving context updates list and shows toast
7. Edit button opens pre-filled form
8. Delete button shows confirmation dialog
9. Changes persist after page refresh
10. Build passes without errors
</verification>

<success_criteria>
- Page shows list of all person contexts
- Add Person button opens dialog with form
- Form validates Slack user ID format (U or W + alphanumeric)
- Context textarea with 1000 char limit
- Edit functionality for existing contexts
- Delete with confirmation dialog
- Injection protection for spotlighting markers
- Tips section for writing good context
- Toast notifications for all actions
</success_criteria>

<output>
After completion, create `.planning/phases/04-web-portal/04-07-SUMMARY.md`
</output>
