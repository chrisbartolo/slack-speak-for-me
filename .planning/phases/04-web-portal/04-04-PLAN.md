---
phase: 04-web-portal
plan: 04
type: execute
wave: 3
depends_on: ["04-01", "04-03"]
files_modified:
  - apps/web-portal/app/(dashboard)/layout.tsx
  - apps/web-portal/app/(dashboard)/page.tsx
  - apps/web-portal/components/dashboard/sidebar.tsx
  - apps/web-portal/components/dashboard/nav-item.tsx
  - apps/web-portal/lib/db/queries.ts
autonomous: true

must_haves:
  truths:
    - "Dashboard has sidebar navigation"
    - "Sidebar shows Dashboard, Style, Conversations, People, Reports links"
    - "Dashboard home shows learning summary"
    - "User sees personalization status"
  artifacts:
    - path: "apps/web-portal/app/(dashboard)/layout.tsx"
      provides: "Dashboard layout with sidebar"
      contains: "Sidebar"
    - path: "apps/web-portal/components/dashboard/sidebar.tsx"
      provides: "Sidebar navigation component"
      exports: ["Sidebar"]
    - path: "apps/web-portal/app/(dashboard)/page.tsx"
      provides: "Dashboard home page"
      contains: "personalization"
    - path: "apps/web-portal/lib/db/queries.ts"
      provides: "Database query functions"
      exports: ["getStylePreferences", "getMessageCount"]
  key_links:
    - from: "apps/web-portal/app/(dashboard)/layout.tsx"
      to: "apps/web-portal/lib/auth/dal.ts"
      via: "verifySession call"
      pattern: "verifySession"
    - from: "apps/web-portal/app/(dashboard)/page.tsx"
      to: "apps/web-portal/lib/db/queries.ts"
      via: "data fetching"
      pattern: "getStylePreferences|getMessageCount"
---

<objective>
Create dashboard shell with sidebar navigation and home page showing AI learning summary.

Purpose: Establish the main authenticated layout with navigation to all dashboard sections. Dashboard home fulfills PORTAL-02 by showing what AI has learned.
Output: Dashboard layout with sidebar, navigation items, and home page with personalization status.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-web-portal/04-CONTEXT.md
@.planning/phases/04-web-portal/04-RESEARCH.md
@.planning/phases/04-web-portal/04-01-SUMMARY.md
@.planning/phases/04-web-portal/04-03-SUMMARY.md
@packages/database/src/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database query functions</name>
  <files>
    apps/web-portal/lib/db/queries.ts
    apps/web-portal/lib/db/index.ts
  </files>
  <action>
Create apps/web-portal/lib/db/queries.ts with cached database queries:

```typescript
import 'server-only';
import { cache } from 'react';
import {
  db,
  userStylePreferences,
  messageEmbeddings,
  watchedConversations,
  refinementFeedback,
  personContext,
} from '@slack-speak-for-me/database';
import { eq, and, count, desc, sql } from 'drizzle-orm';
import { verifySession } from '@/lib/auth/dal';

// Style preferences for current user
export const getStylePreferences = cache(async () => {
  const session = await verifySession();

  const [prefs] = await db
    .select()
    .from(userStylePreferences)
    .where(
      and(
        eq(userStylePreferences.workspaceId, session.workspaceId),
        eq(userStylePreferences.userId, session.userId)
      )
    )
    .limit(1);

  return prefs ?? null;
});

// Count of messages analyzed for learning
export const getMessageCount = cache(async () => {
  const session = await verifySession();

  const [result] = await db
    .select({ count: count() })
    .from(messageEmbeddings)
    .where(
      and(
        eq(messageEmbeddings.workspaceId, session.workspaceId),
        eq(messageEmbeddings.userId, session.userId)
      )
    );

  return result?.count ?? 0;
});

// Count of watched conversations
export const getWatchedConversationCount = cache(async () => {
  const session = await verifySession();

  const [result] = await db
    .select({ count: count() })
    .from(watchedConversations)
    .where(
      and(
        eq(watchedConversations.workspaceId, session.workspaceId),
        eq(watchedConversations.userId, session.userId)
      )
    );

  return result?.count ?? 0;
});

// Count of refinement feedback entries
export const getRefinementCount = cache(async () => {
  const session = await verifySession();

  const [result] = await db
    .select({ count: count() })
    .from(refinementFeedback)
    .where(
      and(
        eq(refinementFeedback.workspaceId, session.workspaceId),
        eq(refinementFeedback.userId, session.userId)
      )
    );

  return result?.count ?? 0;
});

// Get all watched conversations
export const getWatchedConversations = cache(async () => {
  const session = await verifySession();

  return db
    .select()
    .from(watchedConversations)
    .where(
      and(
        eq(watchedConversations.workspaceId, session.workspaceId),
        eq(watchedConversations.userId, session.userId)
      )
    )
    .orderBy(desc(watchedConversations.watchedAt));
});

// Get all person context entries
export const getPersonContexts = cache(async () => {
  const session = await verifySession();

  return db
    .select()
    .from(personContext)
    .where(
      and(
        eq(personContext.workspaceId, session.workspaceId),
        eq(personContext.userId, session.userId)
      )
    )
    .orderBy(desc(personContext.updatedAt));
});
```

Create apps/web-portal/lib/db/index.ts:
```typescript
export * from './queries';
```
  </action>
  <verify>
    ls apps/web-portal/lib/db/queries.ts
    grep -n "getStylePreferences" apps/web-portal/lib/db/queries.ts
    npm run build --workspace=web-portal
  </verify>
  <done>Database query functions created with cache() for request deduplication</done>
</task>

<task type="auto">
  <name>Task 2: Create sidebar navigation component</name>
  <files>
    apps/web-portal/components/dashboard/sidebar.tsx
    apps/web-portal/components/dashboard/nav-item.tsx
    apps/web-portal/components/dashboard/user-menu.tsx
  </files>
  <action>
Create apps/web-portal/components/dashboard/nav-item.tsx:

```typescript
'use client';

import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { cn } from '@/lib/utils';
import { LucideIcon } from 'lucide-react';

interface NavItemProps {
  href: string;
  icon: LucideIcon;
  label: string;
}

export function NavItem({ href, icon: Icon, label }: NavItemProps) {
  const pathname = usePathname();
  const isActive = pathname === href || (href !== '/' && pathname.startsWith(href));

  return (
    <Link
      href={href}
      className={cn(
        'flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium transition-colors',
        isActive
          ? 'bg-gray-100 text-gray-900'
          : 'text-gray-600 hover:bg-gray-50 hover:text-gray-900'
      )}
    >
      <Icon className="h-5 w-5" />
      {label}
    </Link>
  );
}
```

Create apps/web-portal/components/dashboard/user-menu.tsx:

```typescript
import { Button } from '@/components/ui/button';
import { LogOut } from 'lucide-react';
import { deleteSession } from '@/lib/auth/session';
import { redirect } from 'next/navigation';

async function handleLogout() {
  'use server';
  await deleteSession();
  redirect('/login');
}

export function UserMenu() {
  return (
    <form action={handleLogout}>
      <Button variant="ghost" size="sm" className="w-full justify-start text-gray-600">
        <LogOut className="h-4 w-4 mr-2" />
        Sign out
      </Button>
    </form>
  );
}
```

Create apps/web-portal/components/dashboard/sidebar.tsx:

```typescript
import { Home, Sliders, MessageSquare, Users, FileText } from 'lucide-react';
import { NavItem } from './nav-item';
import { UserMenu } from './user-menu';

const navItems = [
  { href: '/', icon: Home, label: 'Dashboard' },
  { href: '/style', icon: Sliders, label: 'Style Settings' },
  { href: '/conversations', icon: MessageSquare, label: 'Conversations' },
  { href: '/people', icon: Users, label: 'People' },
  { href: '/reports', icon: FileText, label: 'Reports' },
];

export function Sidebar() {
  return (
    <aside className="w-64 border-r bg-white flex flex-col">
      <div className="p-6">
        <h1 className="text-xl font-bold text-gray-900">Speak For Me</h1>
      </div>

      <nav className="flex-1 px-4 space-y-1">
        {navItems.map((item) => (
          <NavItem key={item.href} {...item} />
        ))}
      </nav>

      <div className="p-4 border-t">
        <UserMenu />
      </div>
    </aside>
  );
}
```

Install lucide-react icons:
```bash
npm install lucide-react --workspace=web-portal
```
  </action>
  <verify>
    ls apps/web-portal/components/dashboard/sidebar.tsx
    ls apps/web-portal/components/dashboard/nav-item.tsx
    grep -n "NavItem" apps/web-portal/components/dashboard/sidebar.tsx
  </verify>
  <done>Sidebar navigation component created with nav items for all dashboard sections</done>
</task>

<task type="auto">
  <name>Task 3: Create dashboard layout and home page</name>
  <files>
    apps/web-portal/app/(dashboard)/layout.tsx
    apps/web-portal/app/(dashboard)/page.tsx
    apps/web-portal/components/dashboard/learning-summary.tsx
    apps/web-portal/components/dashboard/stat-card.tsx
  </files>
  <action>
Create apps/web-portal/components/dashboard/stat-card.tsx:

```typescript
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { LucideIcon } from 'lucide-react';

interface StatCardProps {
  title: string;
  value: string | number;
  description?: string;
  icon: LucideIcon;
}

export function StatCard({ title, value, description, icon: Icon }: StatCardProps) {
  return (
    <Card>
      <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
        <CardTitle className="text-sm font-medium text-gray-600">{title}</CardTitle>
        <Icon className="h-4 w-4 text-gray-400" />
      </CardHeader>
      <CardContent>
        <div className="text-2xl font-bold">{value}</div>
        {description && (
          <p className="text-xs text-gray-500 mt-1">{description}</p>
        )}
      </CardContent>
    </Card>
  );
}
```

Create apps/web-portal/components/dashboard/learning-summary.tsx:

```typescript
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';

interface LearningSummaryProps {
  messageCount: number;
  refinementCount: number;
  tone?: string | null;
  formality?: string | null;
}

function getLearningPhase(messageCount: number): { label: string; description: string } {
  if (messageCount < 15) {
    return {
      label: 'Early learning',
      description: `${messageCount} messages analyzed. AI is still learning your style.`,
    };
  }
  if (messageCount < 50) {
    return {
      label: 'Building profile',
      description: `${messageCount} messages analyzed. AI is recognizing patterns.`,
    };
  }
  if (messageCount < 150) {
    return {
      label: 'Personalized',
      description: `${messageCount} messages analyzed. AI understands your style.`,
    };
  }
  return {
    label: 'Highly personalized',
    description: `${messageCount}+ messages analyzed. AI has deep understanding of your style.`,
  };
}

export function LearningSummary({ messageCount, refinementCount, tone, formality }: LearningSummaryProps) {
  const phase = getLearningPhase(messageCount);

  return (
    <Card>
      <CardHeader>
        <CardTitle>What AI Has Learned</CardTitle>
        <CardDescription>Your personalization status</CardDescription>
      </CardHeader>
      <CardContent className="space-y-4">
        <div>
          <div className="flex items-center gap-2 mb-2">
            <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
              {phase.label}
            </span>
          </div>
          <p className="text-sm text-gray-600">{phase.description}</p>
        </div>

        {(tone || formality) && (
          <div className="pt-4 border-t">
            <p className="text-sm text-gray-700">
              You tend to be{' '}
              <span className="font-medium">{tone?.toLowerCase() || 'adaptable'}</span>
              {formality && (
                <>
                  {' '}and{' '}
                  <span className="font-medium">{formality.toLowerCase()}</span>
                </>
              )}
              .
            </p>
          </div>
        )}

        {refinementCount > 0 && (
          <div className="pt-4 border-t">
            <p className="text-sm text-gray-600">
              AI has learned from <span className="font-medium">{refinementCount}</span> refinements you've made.
            </p>
          </div>
        )}
      </CardContent>
    </Card>
  );
}
```

Create apps/web-portal/app/(dashboard)/layout.tsx:

```typescript
import { Sidebar } from '@/components/dashboard/sidebar';
import { verifySession } from '@/lib/auth/dal';

export default async function DashboardLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  // Verify authentication at layout level
  await verifySession();

  return (
    <div className="flex min-h-screen bg-gray-50">
      <Sidebar />
      <main className="flex-1 p-8">
        {children}
      </main>
    </div>
  );
}
```

Create apps/web-portal/app/(dashboard)/page.tsx:

```typescript
import { MessageSquare, Sparkles, Users, FileEdit } from 'lucide-react';
import { StatCard } from '@/components/dashboard/stat-card';
import { LearningSummary } from '@/components/dashboard/learning-summary';
import {
  getStylePreferences,
  getMessageCount,
  getWatchedConversationCount,
  getRefinementCount,
} from '@/lib/db/queries';

export default async function DashboardPage() {
  // Fetch all data in parallel
  const [stylePrefs, messageCount, conversationCount, refinementCount] = await Promise.all([
    getStylePreferences(),
    getMessageCount(),
    getWatchedConversationCount(),
    getRefinementCount(),
  ]);

  return (
    <div className="space-y-8">
      <div>
        <h1 className="text-3xl font-bold text-gray-900">Dashboard</h1>
        <p className="text-gray-600 mt-1">
          Overview of your AI response assistant
        </p>
      </div>

      <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
        <StatCard
          title="Messages Analyzed"
          value={messageCount}
          description="For style learning"
          icon={MessageSquare}
        />
        <StatCard
          title="Conversations"
          value={conversationCount}
          description="Being monitored"
          icon={Sparkles}
        />
        <StatCard
          title="Refinements"
          value={refinementCount}
          description="Feedback provided"
          icon={FileEdit}
        />
        <StatCard
          title="Style Settings"
          value={stylePrefs ? 'Configured' : 'Not set'}
          description={stylePrefs?.tone || 'Set your preferences'}
          icon={Users}
        />
      </div>

      <div className="grid gap-6 md:grid-cols-2">
        <LearningSummary
          messageCount={messageCount}
          refinementCount={refinementCount}
          tone={stylePrefs?.tone}
          formality={stylePrefs?.formality}
        />
      </div>
    </div>
  );
}
```
  </action>
  <verify>
    ls apps/web-portal/app/(dashboard)/layout.tsx
    ls apps/web-portal/app/(dashboard)/page.tsx
    grep -n "verifySession" apps/web-portal/app/(dashboard)/layout.tsx
    npm run build --workspace=web-portal
  </verify>
  <done>Dashboard layout and home page created with learning summary and stats</done>
</task>

</tasks>

<verification>
1. Dashboard layout renders sidebar on the left
2. Sidebar shows all 5 navigation items with icons
3. Navigation items highlight correctly when active
4. Dashboard home shows stat cards (messages, conversations, refinements, style)
5. Learning summary shows personalization phase based on message count
6. Sign out button works from sidebar
7. Build passes without errors
</verification>

<success_criteria>
- Sidebar navigation with Dashboard, Style Settings, Conversations, People, Reports
- Active route highlighting in sidebar
- Dashboard home with 4 stat cards showing learning metrics
- Learning summary component showing personalization status
- Sign out functionality working
- All database queries use verifySession() for security
</success_criteria>

<output>
After completion, create `.planning/phases/04-web-portal/04-04-SUMMARY.md`
</output>
