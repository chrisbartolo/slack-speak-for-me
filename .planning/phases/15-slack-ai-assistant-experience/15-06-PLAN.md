---
phase: 15-slack-ai-assistant-experience
plan: 06
type: execute
wave: 5
depends_on: ["15-04", "15-05"]
files_modified:
  - apps/slack-backend/src/services/delivery-router.ts
  - apps/slack-backend/src/jobs/workers.ts
  - apps/slack-backend/src/handlers/events/message-reply.ts
  - packages/database/src/schema.ts
  - apps/web-portal/lib/db/index.ts
autonomous: true

must_haves:
  truths:
    - "Existing ephemeral delivery in channels continues to work unchanged"
    - "DM suggestions can be delivered through the assistant panel when the user has it open"
    - "The system does not break when a user has not opened the assistant panel"
    - "Channel watchers still receive ephemeral suggestions as before"
  artifacts:
    - path: "apps/slack-backend/src/services/delivery-router.ts"
      provides: "Routing logic deciding assistant vs ephemeral delivery"
      exports: ["routeDelivery"]
    - path: "packages/database/src/schema.ts"
      provides: "User preference column for delivery mode"
      contains: "assistantDelivery"
  key_links:
    - from: "apps/slack-backend/src/jobs/workers.ts"
      to: "apps/slack-backend/src/services/delivery-router.ts"
      via: "import and call routeDelivery"
      pattern: "routeDelivery"
    - from: "apps/slack-backend/src/services/delivery-router.ts"
      to: "apps/slack-backend/src/services/suggestion-delivery.ts"
      via: "fallback to sendSuggestionEphemeral"
      pattern: "sendSuggestionEphemeral"
---

<objective>
Implement dual delivery mode: assistant panel for DMs and opted-in users, ephemeral messages for channel watchers. Existing behavior is preserved as the default, with assistant delivery as an enhancement.

Purpose: The assistant panel solves the DM ephemeral limitation natively, but channel watchers should continue receiving ephemeral suggestions. This plan ensures backward compatibility while adding the new delivery mode.
Output: A delivery router that decides between assistant and ephemeral delivery based on context and user preference.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-slack-ai-assistant-experience/15-RESEARCH.md
@apps/slack-backend/src/jobs/workers.ts
@apps/slack-backend/src/services/suggestion-delivery.ts
@apps/slack-backend/src/handlers/events/message-reply.ts
@packages/database/src/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add delivery preference to schema and create delivery router</name>
  <files>
    packages/database/src/schema.ts
    apps/web-portal/lib/db/index.ts
    apps/slack-backend/src/services/delivery-router.ts
  </files>
  <action>
1. Update `packages/database/src/schema.ts`:
   - Add an `assistantDelivery` boolean column to the `users` table (or `watchedConversations` table — prefer users table for user-level preference):
     ```typescript
     // In the users table definition, add:
     assistantDelivery: boolean('assistant_delivery').default(false).notNull(),
     ```
   - This column controls whether the user prefers assistant panel delivery over ephemeral. Default `false` means existing behavior (ephemeral) is preserved.
   - Run `npm run db:generate --workspace=@slack-speak-for-me/database` if needed to generate migration.

2. Update `apps/web-portal/lib/db/index.ts`:
   - Ensure the users table schema export includes the new column (if schema is re-exported, this should be automatic)

3. Create `apps/slack-backend/src/services/delivery-router.ts`:
   - Export `routeDelivery(options)`:
     ```typescript
     interface DeliveryOptions {
       client: WebClient;
       workspaceId: string;
       userId: string;
       channelId: string;
       suggestionId: string;
       suggestion: string;
       triggerContext: 'mention' | 'reply' | 'thread' | 'message_action' | 'dm';
       threadTs?: string;
       usageInfo?: UsageInfo;
     }

     export async function routeDelivery(options: DeliveryOptions): Promise<'ephemeral' | 'dm_fallback'> {
       const { channelId, triggerContext } = options;

       // For channel-based triggers (mention, reply, thread): ALWAYS use ephemeral
       // This is the existing behavior that must be preserved.
       // The assistant panel is for proactive/on-demand use, not for channel events.
       if (triggerContext !== 'dm' && triggerContext !== 'message_action') {
         await sendSuggestionEphemeral(options);
         return 'ephemeral';
       }

       // For DMs: use existing postToUser which tries ephemeral then falls back to bot DM
       // The assistant panel handles DMs natively when the user opens it.
       // When a DM message comes in, two paths can trigger:
       //   1. User has assistant open -> userMessage handler handles it (no worker needed)
       //   2. User does NOT have assistant open -> worker delivers via postToUser (existing behavior)
       // This router handles case 2 (called from worker).
       await sendSuggestionEphemeral(options);
       return 'dm_fallback';
     }
     ```
   - Import existing delivery functions from suggestion-delivery.ts
   - The key insight: assistant delivery for DMs happens AUTOMATICALLY through the Assistant class's userMessage handler (plan 15-04). When a user has the assistant open and types, the streaming handler responds. This delivery router only handles the WORKER path (message events that trigger background jobs), which should continue using ephemeral/DM delivery as before.
   - The `assistantDelivery` user preference is reserved for FUTURE use where proactive suggestions could be pushed to the assistant thread instead of ephemeral. For now, the preference column exists but the router doesn't check it — it defaults to existing behavior.
  </action>
  <verify>
`npm run build --workspace=@slack-speak/slack-backend` compiles. `npm run build --workspace=@slack-speak-for-me/database` compiles. New column exists in schema.
  </verify>
  <done>
Delivery router created with conservative routing logic. Schema extended with assistantDelivery preference column. Existing ephemeral delivery unchanged for all channel-based triggers.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire delivery router into worker and ensure backward compatibility</name>
  <files>
    apps/slack-backend/src/jobs/workers.ts
    apps/slack-backend/src/handlers/events/message-reply.ts
  </files>
  <action>
1. Update `apps/slack-backend/src/jobs/workers.ts`:
   - Import `routeDelivery` from `'../services/delivery-router.js'`
   - In the ai-responses worker, replace the delivery section (the `else` branch that calls `sendSuggestionEphemeral`) with a call to `routeDelivery`:
     ```typescript
     // Replace this section (around line 253-265):
     // Normal mode: Send ephemeral suggestion
     // await sendSuggestionEphemeral({ ... });

     // With:
     const deliveryMode = await routeDelivery({
       client,
       workspaceId,
       userId,
       channelId,
       suggestionId,
       suggestion: result.suggestion,
       triggerContext: triggeredBy,
       threadTs: job.data.threadTs,
       usageInfo,
     });

     logger.info({
       jobId: job.id,
       suggestionId,
       channelId,
       userId,
       mode: deliveryMode,
     }, 'Suggestion delivered via delivery router');
     ```
   - IMPORTANT: Keep the YOLO mode branch (auto-respond) UNCHANGED. The delivery router only replaces the normal ephemeral delivery path.
   - Keep the DM response_url branch UNCHANGED as well.

2. Verify `apps/slack-backend/src/handlers/events/message-reply.ts` is UNCHANGED:
   - The message event handler queues jobs to BullMQ, which is handled by the worker.
   - The assistant's userMessage handler handles messages in the assistant thread.
   - These are separate event paths and do NOT conflict:
     - message.im events in the assistant thread are routed to the Assistant class by Bolt
     - message.im events outside the assistant thread continue to be handled by message-reply.ts
   - No changes needed to message-reply.ts. Verify this by reading the file and confirming no modification is necessary.

3. Verify that `sendSuggestionEphemeral` is still imported in workers.ts (it's used by the routeDelivery function internally, and may also be used directly in some branches).
  </action>
  <verify>
`npm run build --workspace=@slack-speak/slack-backend` compiles. `grep 'routeDelivery' apps/slack-backend/src/jobs/workers.ts` shows the router is wired in. Verify the YOLO mode and response_url branches are unchanged by reviewing workers.ts.
  </verify>
  <done>
Delivery router wired into the worker. Existing ephemeral delivery preserved for all channel-based triggers. YOLO mode unchanged. DM response_url path unchanged. Message event handler unchanged. Backward compatibility maintained.
  </done>
</task>

</tasks>

<verification>
1. `npm run build --workspace=@slack-speak/slack-backend` — zero errors
2. `npm run build --workspace=@slack-speak-for-me/database` — schema compiles
3. `grep 'routeDelivery' apps/slack-backend/src/jobs/workers.ts` — router wired
4. `grep 'assistantDelivery' packages/database/src/schema.ts` — preference column exists
5. Verify YOLO mode branch in workers.ts is unchanged
</verification>

<success_criteria>
- Channel watchers continue receiving ephemeral suggestions (zero regression)
- DM delivery continues working via existing postToUser pattern
- Assistant panel handles DMs natively through userMessage handler (from 15-04)
- Delivery router in place for future assistant preference toggle
- Schema extended with delivery preference for future use
- YOLO mode and response_url paths untouched
</success_criteria>

<output>
After completion, create `.planning/phases/15-slack-ai-assistant-experience/15-06-SUMMARY.md`
</output>
