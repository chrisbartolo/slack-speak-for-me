---
phase: 15-slack-ai-assistant-experience
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/slack-backend/package.json
  - apps/slack-backend/src/app.ts
  - apps/slack-backend/src/handlers/events/message-reply.ts
  - apps/slack-backend/src/handlers/events/app-mention.ts
  - apps/slack-backend/src/services/suggestion-delivery.ts
  - apps/slack-backend/src/handlers/actions/send-suggestion.ts
autonomous: true

must_haves:
  truths:
    - "Bolt 4.x is installed and the app compiles without TypeScript errors"
    - "All existing handlers (events, commands, actions, shortcuts, views) work without regression"
    - "Custom health and test routes still respond correctly"
  artifacts:
    - path: "apps/slack-backend/package.json"
      provides: "@slack/bolt ^4.6.0 dependency"
      contains: '"@slack/bolt": "^4'
    - path: "apps/slack-backend/src/app.ts"
      provides: "Bolt 4.x App constructor with ESM import"
      contains: "import { App"
  key_links:
    - from: "apps/slack-backend/src/app.ts"
      to: "@slack/bolt"
      via: "ESM named import"
      pattern: "import \\{ App"
---

<objective>
Upgrade @slack/bolt from 3.22 to 4.x, fix all breaking changes, and verify zero regression in existing functionality.

Purpose: Bolt 4.x is required for the Assistant class, chatStream() utility, and feedback_buttons element that power the AI assistant experience.
Output: A compiling, working Bolt 4.x app with all existing handlers intact.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-slack-ai-assistant-experience/15-RESEARCH.md
@apps/slack-backend/package.json
@apps/slack-backend/src/app.ts
@apps/slack-backend/src/handlers/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Upgrade @slack/bolt to 4.x and fix imports</name>
  <files>
    apps/slack-backend/package.json
    apps/slack-backend/src/app.ts
  </files>
  <action>
1. Run `npm install @slack/bolt@^4.6.0 --workspace=@slack-speak/slack-backend` to upgrade Bolt.
   - Bolt 4.x bundles @slack/web-api v7 and express v5 automatically.
   - Do NOT separately install express or @slack/web-api.

2. In `apps/slack-backend/src/app.ts`, change the CJS-compatible import pattern:
   FROM:
   ```typescript
   import pkg from '@slack/bolt';
   const { App } = pkg;
   ```
   TO (Bolt v4 supports ESM named exports natively):
   ```typescript
   import { App } from '@slack/bolt';
   ```

3. Verify no `ignoreSelf()` or `directMention()` calls exist in the codebase (grep for them). If found, remove parentheses per Bolt v4 migration guide. Based on research, the project does NOT use these, but verify.

4. Search all files under `apps/slack-backend/src/` for imports from `@slack/bolt` or `@slack/types` or `@slack/web-api` and update any that break:
   - `import type { App } from '@slack/bolt'` — should still work
   - `import { WebClient } from '@slack/web-api'` — should still work (v7 is compatible)
   - `import type { Block, KnownBlock } from '@slack/types'` — verify still works; if not, use `import { type types } from '@slack/bolt'` and access as `types.Block`

5. Do NOT change the App constructor options, scopes, or installerOptions — those remain unchanged in this plan. The `assistant:write` scope is added in plan 15-02.
  </action>
  <verify>
Run `npm run build --workspace=@slack-speak/slack-backend` — must compile with zero TypeScript errors.
  </verify>
  <done>
Bolt 4.x installed, all imports updated, TypeScript compilation succeeds with zero errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix web-api v7 type changes and verify all handlers</name>
  <files>
    apps/slack-backend/src/handlers/events/message-reply.ts
    apps/slack-backend/src/handlers/events/app-mention.ts
    apps/slack-backend/src/services/suggestion-delivery.ts
    apps/slack-backend/src/handlers/actions/send-suggestion.ts
  </files>
  <action>
1. After the Bolt upgrade in Task 1, run `npm run build --workspace=@slack-speak/slack-backend` and collect ALL TypeScript errors.

2. For each error, fix the type issue following web-api v7 migration patterns:
   - Method arguments may have stricter types (e.g., `channel` must be `string`, not `string | undefined`)
   - Some response types may have changed (e.g., `chat.postEphemeral` result type)
   - The `message` event type in `app.message()` handler may have changed — update type guards in `message-reply.ts` if needed
   - `app.action()` body types may be stricter in v4

3. Common fixes to expect:
   - In `message-reply.ts`: The `message` parameter type may need updated type narrowing. The existing type guard pattern (`'user' in message && 'text' in message`) should still work, but verify.
   - In `suggestion-delivery.ts`: `client.chat.postEphemeral()` and `client.chat.postMessage()` argument types may be stricter. Ensure `channel`, `user`, `text` are typed as `string` (not optional).
   - In `send-suggestion.ts`: The `body` type assertion pattern may need adjustment for Bolt v4's stricter action body types.
   - In `app-mention.ts`: The event handler signature may have changed.

4. For customRoutes in app.ts: Express v5 is bundled with Bolt v4. Check that the healthRoutes and testRoutes still work — Express v5's main breaking changes are:
   - `req.params` returns undefined instead of empty string for missing params
   - `res.json()` behavior is slightly different
   - Route paths are slightly stricter
   The health routes are simple GET handlers, so they should work without changes.

5. Run the full build again to confirm zero errors.

6. If there are test files, run `npm test --workspace=@slack-speak/slack-backend` to verify tests still pass. If tests fail due to Bolt version mocking, update the test mocks but do NOT spend time fixing unrelated test issues.
  </action>
  <verify>
`npm run build --workspace=@slack-speak/slack-backend` succeeds with zero errors. If tests exist, `npm test --workspace=@slack-speak/slack-backend` passes.
  </verify>
  <done>
All existing handlers compile and work correctly with Bolt 4.x. Zero TypeScript errors, zero regressions in event handling, commands, actions, shortcuts, and views.
  </done>
</task>

</tasks>

<verification>
1. `npm run build --workspace=@slack-speak/slack-backend` — zero TypeScript errors
2. `grep -r "from '@slack/bolt'" apps/slack-backend/src/` — verify ESM imports (no CJS default import pattern)
3. Package.json shows `@slack/bolt` at `^4.6.0`
</verification>

<success_criteria>
- @slack/bolt upgraded to ^4.6.0 in package.json
- App compiles with zero TypeScript errors
- All handler registrations in app.ts unchanged and functional
- Import pattern changed from CJS default to ESM named export
- No regression in existing functionality
</success_criteria>

<output>
After completion, create `.planning/phases/15-slack-ai-assistant-experience/15-01-SUMMARY.md`
</output>
