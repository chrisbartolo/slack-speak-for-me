---
phase: 15-slack-ai-assistant-experience
plan: 05
type: execute
wave: 4
depends_on: ["15-04"]
files_modified:
  - apps/slack-backend/src/assistant/actions/send-from-assistant.ts
  - apps/slack-backend/src/assistant/actions/refine-from-assistant.ts
  - apps/slack-backend/src/assistant/actions/dismiss-from-assistant.ts
  - apps/slack-backend/src/assistant/actions/feedback-handler.ts
  - apps/slack-backend/src/assistant/actions/index.ts
  - apps/slack-backend/src/app.ts
  - apps/slack-backend/src/handlers/index.ts
autonomous: true

must_haves:
  truths:
    - "User can click thumbs up or thumbs down on a suggestion and feedback is stored"
    - "User can click Send as Me to post the suggestion in the conversation they were viewing"
    - "User can click Refine to request a modified version of the suggestion"
    - "User can dismiss a suggestion"
  artifacts:
    - path: "apps/slack-backend/src/assistant/actions/feedback-handler.ts"
      provides: "ai_feedback action handler storing thumbs up/down"
      exports: ["registerFeedbackAction"]
    - path: "apps/slack-backend/src/assistant/actions/send-from-assistant.ts"
      provides: "Send as Me action for assistant panel suggestions"
      exports: ["registerAssistantSendAction"]
    - path: "apps/slack-backend/src/assistant/actions/refine-from-assistant.ts"
      provides: "Refine action for assistant panel suggestions"
      exports: ["registerAssistantRefineAction"]
    - path: "apps/slack-backend/src/assistant/actions/dismiss-from-assistant.ts"
      provides: "Dismiss action for assistant panel suggestions"
      exports: ["registerAssistantDismissAction"]
    - path: "apps/slack-backend/src/assistant/actions/index.ts"
      provides: "Barrel export for all assistant action handlers"
      exports: ["registerAssistantActions"]
  key_links:
    - from: "apps/slack-backend/src/app.ts"
      to: "apps/slack-backend/src/assistant/actions/index.ts"
      via: "registerAssistantActions(app)"
      pattern: "registerAssistantActions"
    - from: "apps/slack-backend/src/assistant/actions/feedback-handler.ts"
      to: "apps/slack-backend/src/services/feedback-tracker.ts"
      via: "trackFeedback call"
      pattern: "trackFeedback"
---

<objective>
Add action buttons (Send as Me, Refine, Dismiss) to assistant panel suggestions and implement the ai_feedback handler for thumbs up/down quality tracking.

Purpose: The assistant panel needs interactive actions so users can act on suggestions directly. Feedback buttons enable quality tracking for AI improvement.
Output: Working action handlers for Send as Me, Refine, Dismiss, and feedback buttons in the assistant panel.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-slack-ai-assistant-experience/15-RESEARCH.md
@apps/slack-backend/src/handlers/actions/send-suggestion.ts
@apps/slack-backend/src/handlers/actions/refine-suggestion.ts
@apps/slack-backend/src/handlers/actions/dismiss-suggestion.ts
@apps/slack-backend/src/services/feedback-tracker.ts
@apps/slack-backend/src/assistant/streaming.ts
@apps/slack-backend/src/assistant/feedback.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create feedback handler and assistant action buttons</name>
  <files>
    apps/slack-backend/src/assistant/actions/feedback-handler.ts
    apps/slack-backend/src/assistant/actions/send-from-assistant.ts
    apps/slack-backend/src/assistant/actions/refine-from-assistant.ts
    apps/slack-backend/src/assistant/actions/dismiss-from-assistant.ts
  </files>
  <action>
1. Create `apps/slack-backend/src/assistant/actions/feedback-handler.ts`:
   - Export `registerFeedbackAction(app: App)` function
   - Register `app.action('ai_feedback', async ({ ack, body }) => { ... })`
   - Parse `body.actions[0].value` as JSON to get `{ suggestionId, feedback }` where feedback is 'positive' or 'negative'
   - Extract userId from `body.user.id`
   - Call the existing `trackFeedback` service from `../../services/feedback-tracker.js` to store the feedback:
     ```typescript
     await trackFeedback({
       suggestionId,
       action: feedback === 'positive' ? 'accepted' : 'dismissed',
       userId,
     });
     ```
   - Log the feedback event. Do NOT send a response message (the feedback buttons handle their own UI state in Slack).
   - Wrap in try/catch — feedback tracking should not throw.

2. Create `apps/slack-backend/src/assistant/actions/send-from-assistant.ts`:
   - Export `registerAssistantSendAction(app: App)` function
   - Register `app.action('assistant_send_suggestion', async ({ ack, body, client, say }) => { ... })`
   - This action ID is DIFFERENT from the existing `send_suggestion` to avoid conflicts with the ephemeral flow.
   - Parse `body.actions[0].value` as JSON to get `{ suggestionId, suggestion, channelId, threadTs }`
   - The `channelId` is the VIEWING channel (where to post), NOT the assistant thread channel
   - Use the same user-token-based posting pattern from the existing `send-suggestion.ts`:
     a. Get teamId from body
     b. Look up workspaceId via getWorkspaceId
     c. Get user token from installations table
     d. Decrypt user token
     e. Create WebClient with user token
     f. Post message to channelId (with threadTs if present)
   - After sending, respond in the assistant thread confirming: `await say({ text: 'Message sent!' })`
   - If no user token available, respond with error message explaining they need to reinstall.

3. Create `apps/slack-backend/src/assistant/actions/refine-from-assistant.ts`:
   - Export `registerAssistantRefineAction(app: App)` function
   - Register `app.action('assistant_refine_suggestion', async ({ ack, body, say }) => { ... })`
   - Parse `body.actions[0].value` as JSON to get `{ suggestionId, suggestion }`
   - Respond in the assistant thread prompting the user: `await say({ text: "What would you like me to change about this suggestion? Reply with your refinement request." })`
   - Note: The actual refinement happens when the user sends their next message in the thread. The userMessage handler in 15-04 already handles all messages. For refinement to work, we need to store that the user is in "refinement mode." The simplest approach: include a hint in the say() message that tells the user to just describe what they want changed, and the assistant will generate a new response. The userMessage handler treats every message as a new request, which effectively works as refinement (the conversation context in the thread provides the history).

4. Create `apps/slack-backend/src/assistant/actions/dismiss-from-assistant.ts`:
   - Export `registerAssistantDismissAction(app: App)` function
   - Register `app.action('assistant_dismiss_suggestion', async ({ ack, body, say }) => { ... })`
   - Parse `body.actions[0].value` as JSON to get `{ suggestionId }`
   - Track dismissal via existing feedback tracker
   - Respond: `await say({ text: "Suggestion dismissed. Send me another message if you need help." })`
  </action>
  <verify>
All four files exist and export their register functions. `npm run build --workspace=@slack-speak/slack-backend` compiles without errors.
  </verify>
  <done>
Four action handlers created: ai_feedback (thumbs up/down), assistant_send_suggestion (Send as Me from panel), assistant_refine_suggestion (prompts for refinement), assistant_dismiss_suggestion (dismisses with tracking).
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire action buttons into streaming output and register handlers</name>
  <files>
    apps/slack-backend/src/assistant/actions/index.ts
    apps/slack-backend/src/assistant/streaming.ts
    apps/slack-backend/src/app.ts
    apps/slack-backend/src/handlers/index.ts
  </files>
  <action>
1. Create `apps/slack-backend/src/assistant/actions/index.ts`:
   - Barrel export that registers all assistant actions:
     ```typescript
     import type { App } from '@slack/bolt';
     import { registerFeedbackAction } from './feedback-handler.js';
     import { registerAssistantSendAction } from './send-from-assistant.js';
     import { registerAssistantRefineAction } from './refine-from-assistant.js';
     import { registerAssistantDismissAction } from './dismiss-from-assistant.js';

     export function registerAssistantActions(app: App) {
       registerFeedbackAction(app);
       registerAssistantSendAction(app);
       registerAssistantRefineAction(app);
       registerAssistantDismissAction(app);
     }
     ```

2. Update `apps/slack-backend/src/assistant/streaming.ts`:
   - After the `streamer.stop({ blocks: [createFeedbackBlock(suggestionId)] })` call, add action buttons block BEFORE stopping the stream.
   - Actually, the action buttons should be sent as a SEPARATE message after the stream stops (the stream contains the suggestion text; actions go below it). After `streamer.stop()`, post a follow-up message in the thread with action buttons:
     ```typescript
     // Post action buttons as a follow-up message
     await client.chat.postMessage({
       channel: channelId,
       thread_ts: threadTs,
       text: 'What would you like to do with this suggestion?',
       blocks: [
         {
           type: 'actions',
           elements: [
             {
               type: 'button',
               text: { type: 'plain_text', text: 'Send as Me', emoji: true },
               action_id: 'assistant_send_suggestion',
               value: JSON.stringify({ suggestionId, suggestion: fullText, channelId: viewingChannelId, threadTs: viewingThreadTs }),
               style: 'primary',
             },
             {
               type: 'button',
               text: { type: 'plain_text', text: 'Refine', emoji: true },
               action_id: 'assistant_refine_suggestion',
               value: JSON.stringify({ suggestionId, suggestion: fullText }),
             },
             {
               type: 'button',
               text: { type: 'plain_text', text: 'Dismiss', emoji: true },
               action_id: 'assistant_dismiss_suggestion',
               value: JSON.stringify({ suggestionId }),
             },
           ],
         },
       ],
     });
     ```
   - To capture `fullText`, accumulate the streamed text chunks in a variable alongside the streamer:
     ```typescript
     let fullText = '';
     for await (const event of stream) {
       if (event.type === 'content_block_delta' && event.delta.type === 'text_delta') {
         fullText += event.delta.text;
         await streamer.append({ markdown_text: event.delta.text });
       }
     }
     ```
   - Pass `viewingChannelId` and any `viewingThreadTs` (if the user was viewing a specific thread) through the StreamOptions interface so the Send as Me button knows where to post.

3. Update `apps/slack-backend/src/app.ts`:
   - Add import: `import { registerAssistantActions } from './assistant/actions/index.js';`
   - Add after the assistant registration: `registerAssistantActions(app);`
   - Also add to `apps/slack-backend/src/handlers/index.ts` if it's needed for export consistency, or keep the import directly in app.ts.

4. Export `registerAssistantActions` from the handlers index if needed for consistency, OR import it directly in app.ts (prefer direct import in app.ts since it's assistant-specific and the handlers/index.ts is for the existing handler tree).
  </action>
  <verify>
`npm run build --workspace=@slack-speak/slack-backend` compiles. `grep 'registerAssistantActions' apps/slack-backend/src/app.ts` returns a match. `grep 'assistant_send_suggestion' apps/slack-backend/src/assistant/streaming.ts` shows action buttons are included in streaming output.
  </verify>
  <done>
Action buttons (Send as Me, Refine, Dismiss) appear after every streamed suggestion in the assistant panel. Feedback buttons (thumbs up/down) appear at the end of the streamed text. All action handlers registered with the app. Users can interact with suggestions directly from the assistant panel.
  </done>
</task>

</tasks>

<verification>
1. `npm run build --workspace=@slack-speak/slack-backend` — zero errors
2. `grep -r 'ai_feedback' apps/slack-backend/src/assistant/` — feedback handler registered
3. `grep -r 'assistant_send_suggestion' apps/slack-backend/src/assistant/` — send action registered
4. `grep 'registerAssistantActions' apps/slack-backend/src/app.ts` — handlers wired to app
</verification>

<success_criteria>
- Feedback buttons (thumbs up/down) track quality via existing feedback tracker
- Send as Me posts suggestion in the viewing channel using user's token
- Refine prompts user for modification request
- Dismiss tracks dismissal and clears suggestion
- Action buttons appear after every streamed suggestion
- All handlers registered with the Bolt app
</success_criteria>

<output>
After completion, create `.planning/phases/15-slack-ai-assistant-experience/15-05-SUMMARY.md`
</output>
