---
phase: 18-auto-learning-knowledge-base
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - apps/slack-backend/src/services/kb-learner.ts
  - apps/slack-backend/src/services/index.ts
  - apps/slack-backend/src/services/feedback-tracker.ts
  - apps/slack-backend/src/jobs/types.ts
  - apps/slack-backend/src/jobs/queues.ts
  - apps/slack-backend/src/jobs/workers.ts
autonomous: true

must_haves:
  truths:
    - "When a suggestion is accepted, a background job evaluates it for reusable knowledge"
    - "Claude API extracts knowledge patterns and determines if candidate should be created"
    - "Near-duplicate candidates are merged (incremented) instead of creating new entries"
    - "Quality score is computed using composite formula (acceptance 40%, similarity 30%, diversity 20%, recency 10%)"
  artifacts:
    - path: "apps/slack-backend/src/services/kb-learner.ts"
      provides: "evaluateForKnowledge, createOrUpdateCandidate, calculateQualityScore functions"
      exports: ["evaluateForKnowledge", "createOrUpdateCandidate", "calculateQualityScore"]
    - path: "apps/slack-backend/src/jobs/types.ts"
      provides: "KBLearningJobData and KBLearningJobResult types"
      contains: "KBLearningJobData"
    - path: "apps/slack-backend/src/jobs/queues.ts"
      provides: "kbLearningQueue and queueKBLearning function"
      contains: "kbLearningQueue"
    - path: "apps/slack-backend/src/jobs/workers.ts"
      provides: "KB learning worker processing"
      contains: "kb-learning"
  key_links:
    - from: "apps/slack-backend/src/services/feedback-tracker.ts"
      to: "apps/slack-backend/src/jobs/queues.ts"
      via: "queueKBLearning call in trackAcceptance"
      pattern: "queueKBLearning"
    - from: "apps/slack-backend/src/jobs/workers.ts"
      to: "apps/slack-backend/src/services/kb-learner.ts"
      via: "evaluateForKnowledge call in worker"
      pattern: "evaluateForKnowledge"
    - from: "apps/slack-backend/src/services/kb-learner.ts"
      to: "packages/database/src/schema.ts"
      via: "kbCandidates table insert/update"
      pattern: "kbCandidates"
---

<objective>
Build the KB auto-learner service and background job that mines accepted suggestions for reusable knowledge patterns.

Purpose: This is the core learning engine. When a user accepts a suggestion (copies it), a fire-and-forget background job evaluates whether the suggestion contains reusable knowledge (de-escalation techniques, phrasing patterns, domain knowledge). If yes, it creates or merges a KB candidate for admin review.
Output: kb-learner.ts service, BullMQ job infrastructure, and integration into feedback-tracker.ts.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/18-auto-learning-knowledge-base/18-RESEARCH.md
@.planning/phases/18-auto-learning-knowledge-base/18-01-SUMMARY.md
@packages/database/src/schema.ts
@apps/slack-backend/src/services/feedback-tracker.ts
@apps/slack-backend/src/services/knowledge-base.ts
@apps/slack-backend/src/jobs/types.ts
@apps/slack-backend/src/jobs/queues.ts
@apps/slack-backend/src/jobs/workers.ts
@apps/slack-backend/src/services/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create kb-learner service</name>
  <files>apps/slack-backend/src/services/kb-learner.ts</files>
  <action>
Create `kb-learner.ts` following patterns from existing services (topic-classifier.ts, sentiment-detector.ts).

**Export 1: `evaluateForKnowledge`**
- Takes: `{ suggestionText: string, triggerContext: string, organizationId: string }`
- Uses Claude API (same client import as ai.ts) with a structured prompt that evaluates whether the suggestion contains reusable knowledge
- Prompt should ask Claude to determine:
  1. Does this contain a reusable pattern (de-escalation technique, phrasing approach, domain knowledge)?
  2. Would storing this help generate better suggestions in similar future situations?
  3. Is it specific enough to be useful but general enough to apply beyond this exact message?
- Returns: `{ shouldCreate: boolean, title?: string, category?: string, excerpt?: string, reasoning: string }`
- Use `claude-sonnet-4-20250514` model (same as topic-classifier), max_tokens 500, timeout 5000ms
- Parse JSON response, wrap in try/catch, return `{ shouldCreate: false, reasoning: 'evaluation failed' }` on error

**Export 2: `createOrUpdateCandidate`**
- Takes: `{ organizationId: string, title: string, content: string, category: string, reasoning: string, sourceSuggestionId?: string }`
- Generate embedding using the same `embedText` function from knowledge-base.ts (import it, or copy the function -- prefer importing if it's exported)
- Check for near-duplicates: query kbCandidates where organizationId matches AND status='pending' AND vector cosine similarity > 0.9 (use the `1 - (embedding::vector <=> ...)` pattern from knowledge-base.ts)
- If duplicate found: UPDATE the existing candidate -- increment acceptance_count, increment unique_users_count, update last_seen_at, recalculate quality_score
- If no duplicate: INSERT new candidate with status='pending', acceptance_count=1, unique_users_count=1
- Returns: the candidate ID (string)

**Export 3: `calculateQualityScore`**
- Takes: `{ acceptanceCount: number, avgSimilarity: number, uniqueUsersCount: number, daysSinceCreation: number }`
- Implements composite formula from research:
  - acceptanceWeight = 0.4, score = min(acceptanceCount / 10, 1)
  - similarityWeight = 0.3, score = avgSimilarity / 100 (since stored as 0-100)
  - diversityWeight = 0.2, score = min(uniqueUsersCount / 5, 1)
  - recencyWeight = 0.1, score = max(0, 1 - daysSinceCreation / 30)
- Returns: integer 0-100

Import logger from '../utils/logger.js'. All functions should log on error but not throw (fire-and-forget pattern). Import db and kbCandidates from '@slack-speak/database'.
  </action>
  <verify>Run `npx tsc --noEmit --project /Users/christopherbartolo/Documents/GitHub/slack-speak-for-me/apps/slack-backend/tsconfig.json` to confirm no type errors.</verify>
  <done>kb-learner.ts exports evaluateForKnowledge, createOrUpdateCandidate, and calculateQualityScore. All functions handle errors gracefully without throwing.</done>
</task>

<task type="auto">
  <name>Task 2: Add BullMQ job and wire into feedback tracker</name>
  <files>
    apps/slack-backend/src/jobs/types.ts
    apps/slack-backend/src/jobs/queues.ts
    apps/slack-backend/src/jobs/workers.ts
    apps/slack-backend/src/services/feedback-tracker.ts
    apps/slack-backend/src/services/index.ts
  </files>
  <action>
**types.ts** -- Add job types following existing patterns:
```typescript
export interface KBLearningJobData {
  organizationId: string;
  suggestionId: string;
  suggestionText: string;
  triggerContext: string;
}

export interface KBLearningJobResult {
  candidateId?: string;
  action: 'created' | 'merged' | 'skipped';
}
```

**queues.ts** -- Add queue and helper:
- Import KBLearningJobData type
- Create `kbLearningQueue` with same config as kbIndexQueue (3 attempts, exponential backoff 2s, keep 100 complete / 500 failed)
- Export `queueKBLearning(data: KBLearningJobData)` function that adds 'evaluate-suggestion' job

**workers.ts** -- Add worker processing:
- Import kbLearningQueue, evaluateForKnowledge, createOrUpdateCandidate from services
- Add a new Worker for 'kb-learning' queue
- Worker logic:
  1. Call `evaluateForKnowledge({ suggestionText, triggerContext, organizationId })`
  2. If `shouldCreate` is false, return `{ action: 'skipped' }`
  3. Call `createOrUpdateCandidate({ organizationId, title, content: excerpt, category, reasoning, sourceSuggestionId: suggestionId })`
  4. Return `{ candidateId, action: 'created' or 'merged' }`
- Wrap in try/catch, log errors with logger.warn (not error -- this is non-critical)

**feedback-tracker.ts** -- Wire fire-and-forget:
- Import `queueKBLearning` from jobs/queues.ts
- In `trackAcceptance` function, after the existing `trackFeedback` call, add:
  ```typescript
  // Fire-and-forget KB learning job
  // Need organizationId from workspace -- resolve via existing pattern
  queueKBLearning({
    organizationId: '', // Will need workspace->org resolution
    suggestionId,
    suggestionText,
    triggerContext: '', // Not available in trackAcceptance currently
  }).catch(() => {}); // Don't block on job queueing failure
  ```
  Note: trackAcceptance doesn't currently have organizationId or triggerContext. The simplest approach is to add them as optional parameters to trackAcceptance. Update the function signature to:
  `trackAcceptance(workspaceId, userId, suggestionId, suggestionText, channelId?, organizationId?, triggerContext?)`
  Only queue the KB learning job if organizationId is provided (callers will be updated in a gap closure plan if needed -- for now, make it opt-in).

**index.ts** -- Add exports:
```typescript
export { evaluateForKnowledge, createOrUpdateCandidate, calculateQualityScore } from './kb-learner.js';
```
  </action>
  <verify>Run `npx tsc --noEmit --project /Users/christopherbartolo/Documents/GitHub/slack-speak-for-me/apps/slack-backend/tsconfig.json` to confirm no type errors. Verify the kbLearningQueue is exported from queues.ts.</verify>
  <done>BullMQ kb-learning queue and worker process accepted suggestions. feedback-tracker.ts fires KB learning job on acceptance. All TypeScript compiles clean.</done>
</task>

</tasks>

<verification>
- TypeScript compiles: `npx tsc --noEmit` in apps/slack-backend passes
- kb-learner.ts exports three functions
- Job types, queue, and worker follow existing patterns
- feedback-tracker.ts queues KB learning on acceptance (fire-and-forget)
- No existing tests broken
</verification>

<success_criteria>
- Accepted suggestions trigger async KB learning evaluation via BullMQ
- Claude evaluates whether suggestion contains reusable knowledge
- Near-duplicate candidates are merged (not duplicated)
- Quality score uses composite formula (acceptance 40%, similarity 30%, diversity 20%, recency 10%)
- Fire-and-forget pattern ensures zero latency impact on user flow
</success_criteria>

<output>
After completion, create `.planning/phases/18-auto-learning-knowledge-base/18-02-SUMMARY.md`
</output>
