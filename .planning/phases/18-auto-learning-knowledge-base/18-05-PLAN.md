---
phase: 18-auto-learning-knowledge-base
plan: 05
type: execute
wave: 3
depends_on: ["18-04"]
files_modified:
  - apps/web-portal/app/admin/learning-loop/page.tsx
  - apps/web-portal/components/admin/learning-loop-charts.tsx
autonomous: false

must_haves:
  truths:
    - "Admin can see list of pending KB candidates sorted by quality score"
    - "Admin can approve, reject, or merge candidates from the dashboard"
    - "Dashboard shows KB effectiveness metrics per document"
    - "Dashboard shows KB growth trend chart (candidates created vs approved over time)"
    - "Candidate status summary cards show pending/approved/rejected/merged counts"
  artifacts:
    - path: "apps/web-portal/app/admin/learning-loop/page.tsx"
      provides: "Admin learning loop dashboard page with data fetching"
      min_lines: 80
    - path: "apps/web-portal/components/admin/learning-loop-charts.tsx"
      provides: "Chart and table components for learning loop visualization"
      min_lines: 100
  key_links:
    - from: "apps/web-portal/app/admin/learning-loop/page.tsx"
      to: "/api/admin/kb-candidates"
      via: "fetch for candidate list"
      pattern: "api/admin/kb-candidates"
    - from: "apps/web-portal/app/admin/learning-loop/page.tsx"
      to: "/api/admin/kb-effectiveness"
      via: "fetch for effectiveness data"
      pattern: "api/admin/kb-effectiveness"
    - from: "apps/web-portal/components/admin/learning-loop-charts.tsx"
      to: "tremor"
      via: "BarChart, AreaChart imports"
      pattern: "tremor"
---

<objective>
Build the admin Learning Loop dashboard with candidate review table, effectiveness metrics, and growth trend charts.

Purpose: Admin-facing UI that surfaces KB candidates for review (approve/reject/merge), shows which KB documents are most effective (impact on acceptance rates), and visualizes KB growth trends over time. This closes the human-in-the-loop for the auto-learning system.
Output: Admin dashboard page and chart components using Tremor and existing UI patterns.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/18-auto-learning-knowledge-base/18-RESEARCH.md
@.planning/phases/18-auto-learning-knowledge-base/18-04-SUMMARY.md
@apps/web-portal/app/admin/communication-insights/page.tsx
@apps/web-portal/components/admin/communication-insights-charts.tsx
@apps/web-portal/app/admin/knowledge-base/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create learning loop chart components</name>
  <files>apps/web-portal/components/admin/learning-loop-charts.tsx</files>
  <action>
Create chart components following the same pattern as `communication-insights-charts.tsx` (which uses Tremor BarChart, AreaChart, and custom tables).

**Component 1: `CandidateStatusCards`**
- Props: `{ stats: { pending: number, approved: number, rejected: number, merged: number } }`
- Four summary cards in a grid (2x2 on mobile, 4 cols on lg)
- Each card shows count with label and appropriate color:
  - Pending: amber/yellow
  - Approved: green
  - Rejected: red
  - Merged: blue
- Use the same Card component from shadcn/ui used elsewhere

**Component 2: `KBGrowthChart`**
- Props: `{ data: Array<{ week: string, created: number, approved: number, rejected: number }> }`
- Tremor `AreaChart` showing candidates created vs approved vs rejected per week
- Categories: ['created', 'approved', 'rejected']
- Colors: ['blue', 'green', 'red']
- Index: 'week' (format as readable date)
- Title: "KB Growth Trend"

**Component 3: `EffectivenessTable`**
- Props: `{ data: Array<{ documentId: string, title: string, category: string, timesUsed: number, acceptedCount: number, dismissedCount: number, acceptanceRate: number, avgSimilarity: number }> }`
- HTML table (same styling as other admin tables, or use TanStack Table if already imported)
- Columns: Title, Category, Times Used, Accepted, Dismissed, Acceptance Rate (color-coded: green >70%, yellow 30-70%, red <30%), Avg Similarity
- Sort by timesUsed descending

**Component 4: `CandidateReviewTable`**
- Props: `{ candidates: Array<{ id: string, title: string, content: string, category: string, qualityScore: number, acceptanceCount: number, uniqueUsersCount: number, status: string, createdAt: string }>, onAction: (id: string, action: 'approve' | 'reject' | 'merge', data?: { rejectionReason?: string, mergeWithId?: string }) => void }`
- Table rows with expandable content preview
- Columns: Title, Category, Quality Score (as progress bar or badge), Accepted Count, Users, Created
- Action buttons per row:
  - Approve (green button) -- calls onAction(id, 'approve')
  - Reject (red button) -- opens small inline input for rejection reason, then calls onAction(id, 'reject', { rejectionReason })
  - Mark as "Merge" if admin sees duplicates (optional, simpler to leave for v2)
- Filter tabs above table: All | Pending | Approved | Rejected
- Use 'use client' directive at top

Import Tremor components from '@tremor/react'. Import Card, Badge, Button from shadcn/ui. Follow the exact import patterns from communication-insights-charts.tsx.
  </action>
  <verify>Run `npx tsc --noEmit --project /Users/christopherbartolo/Documents/GitHub/slack-speak-for-me/apps/web-portal/tsconfig.json` to confirm no type errors.</verify>
  <done>Four chart/table components created: CandidateStatusCards, KBGrowthChart, EffectivenessTable, CandidateReviewTable. All use Tremor and shadcn/ui patterns from existing dashboard.</done>
</task>

<task type="auto">
  <name>Task 2: Create admin learning loop page</name>
  <files>apps/web-portal/app/admin/learning-loop/page.tsx</files>
  <action>
Create the admin learning loop dashboard page following the pattern from `communication-insights/page.tsx` (server component with parallel data fetching and client chart components).

**Page structure (server component):**
1. Fetch data from both APIs in parallel using Promise.all:
   - `GET /api/admin/kb-candidates?status=pending&limit=20`
   - `GET /api/admin/kb-effectiveness?days=30`
2. Pass data to client components

**Layout sections (top to bottom):**

Section 1: Page header
- Title: "Learning Loop"
- Subtitle: "Auto-learned knowledge from accepted suggestions"

Section 2: Status summary cards
- `<CandidateStatusCards stats={effectivenessData.candidateStats} />`

Section 3: KB Growth Trend
- `<KBGrowthChart data={effectivenessData.growthTrend} />`

Section 4: KB Effectiveness
- `<EffectivenessTable data={effectivenessData.documentEffectiveness} />`
- Title: "Document Effectiveness"
- Subtitle: "How KB documents impact suggestion acceptance rates"

Section 5: Pending Candidates for Review
- `<CandidateReviewTable candidates={candidatesData.candidates} onAction={handleAction} />`
- Title: "Candidates Pending Review"
- The onAction handler needs to be in a client component wrapper since this is a server component. Create a small client wrapper component (either inline with 'use client' or within the charts file) that:
  - Holds candidates in state
  - Calls `PATCH /api/admin/kb-candidates/{id}` on action
  - Removes the candidate from state on successful action (optimistic update)
  - Shows toast notification on success/error (use sonner if available, or simple alert)

**Important patterns to follow:**
- Use `cookies()` from 'next/headers' to forward auth cookies in fetch calls (same pattern as communication-insights/page.tsx)
- Use absolute URL construction with `process.env.NEXTAUTH_URL || 'http://localhost:3000'` or the pattern used by other admin pages
- Handle fetch errors gracefully -- show empty state if APIs fail
- Use the same page layout wrapper (padding, max-width) as other admin pages

**Add navigation link:**
- Check the admin layout or sidebar component and add a "Learning Loop" link pointing to `/admin/learning-loop`. Follow the same pattern used for other admin nav items (e.g., "Communication Insights", "Response Times").
  </action>
  <verify>Run `npx tsc --noEmit --project /Users/christopherbartolo/Documents/GitHub/slack-speak-for-me/apps/web-portal/tsconfig.json` to confirm no type errors. Verify the page file exists at the expected path.</verify>
  <done>Admin learning loop page displays candidate status summary, KB growth trend chart, document effectiveness table, and pending candidates for review. Navigation link added to admin sidebar.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete auto-learning knowledge base system: schema, learner service, effectiveness tracking, API routes, and admin learning loop dashboard</what-built>
  <how-to-verify>
    1. Start the dev server: `npm run dev` in the web-portal workspace
    2. Navigate to the admin dashboard and look for "Learning Loop" in the sidebar
    3. Click "Learning Loop" -- the dashboard should load with:
       - Status summary cards (all zeros initially)
       - Empty KB growth trend chart
       - Empty document effectiveness table
       - Empty pending candidates table
    4. Verify the page renders without errors (check browser console)
    5. Verify the approve/reject buttons are visible on the candidates table (will be empty but buttons should be wired)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
- TypeScript compiles for web-portal
- Learning loop page renders at /admin/learning-loop
- Navigation link appears in admin sidebar
- Charts use Tremor components (same as other dashboards)
- Candidate review table has approve/reject action buttons
- Effectiveness table shows acceptance rate with color coding
</verification>

<success_criteria>
- Admin can see pending KB candidates sorted by quality score
- Admin can approve candidates (publishes to KB) or reject with reason
- Dashboard shows per-document effectiveness metrics (acceptance rates)
- Growth trend chart visualizes KB candidate creation and approval over time
- Status summary cards show counts for pending/approved/rejected/merged
- Page follows existing admin dashboard visual patterns
</success_criteria>

<output>
After completion, create `.planning/phases/18-auto-learning-knowledge-base/18-05-SUMMARY.md`
</output>
