---
phase: 18-auto-learning-knowledge-base
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/src/schema.ts
autonomous: true

must_haves:
  truths:
    - "kb_candidates table exists with status workflow (pending/approved/rejected/merged)"
    - "kb_effectiveness table exists linking KB document usage to suggestion outcomes"
    - "Schema supports quality scoring with acceptance_count, unique_users, avg_similarity"
  artifacts:
    - path: "packages/database/src/schema.ts"
      provides: "kbCandidates and kbEffectiveness table definitions with type exports"
      contains: "kbCandidates"
    - path: "packages/database/src/schema.ts"
      provides: "kbEffectiveness table for tracking KB doc usage per suggestion"
      contains: "kbEffectiveness"
  key_links:
    - from: "packages/database/src/schema.ts"
      to: "organizations table"
      via: "organizationId foreign key on kbCandidates"
      pattern: "references.*organizations"
    - from: "packages/database/src/schema.ts"
      to: "knowledge_base_documents table"
      via: "kbDocumentId reference on kbEffectiveness"
      pattern: "knowledgeBaseDocuments"
---

<objective>
Add database schema for KB candidates (auto-learned knowledge) and KB effectiveness tracking tables.

Purpose: Foundation tables that all other Phase 18 plans depend on. KB candidates store auto-extracted knowledge patterns pending admin review. KB effectiveness links KB document usage to suggestion outcomes for impact measurement.
Output: Two new tables in schema.ts with indexes, type exports, and drizzle push applied.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/18-auto-learning-knowledge-base/18-RESEARCH.md
@packages/database/src/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add kbCandidates table to schema</name>
  <files>packages/database/src/schema.ts</files>
  <action>
Add the `kbCandidates` table after the existing `knowledgeBaseDocuments` table definition. Follow the exact same patterns used by existing tables (uuid primary key, references to organizations, timestamp defaults, index naming conventions).

Table: `kb_candidates`
Columns:
- `id`: uuid, primaryKey, defaultRandom
- `organization_id`: uuid, notNull, references organizations.id
- `title`: text, notNull -- descriptive title for the candidate
- `content`: text, notNull -- the reusable knowledge content
- `category`: text -- nullable, e.g. 'de_escalation', 'phrasing_patterns', 'domain_knowledge', 'best_practices'
- `tags`: jsonb, typed as string[] -- nullable
- `embedding`: text, notNull -- vector string for similarity search (same pattern as knowledgeBaseDocuments)
- `reasoning`: text -- nullable, Claude's explanation for why this is reusable
- `source_suggestion_id`: text -- nullable, first suggestion that triggered this candidate
- `acceptance_count`: integer, default 1 -- how many times similar patterns were accepted
- `unique_users_count`: integer, default 1 -- how many distinct users accepted similar patterns
- `avg_similarity`: integer, default 0 -- average similarity score 0-100 with existing KB docs
- `quality_score`: integer, default 0 -- composite score 0-100 for admin prioritization
- `status`: text, default 'pending' -- 'pending' | 'approved' | 'rejected' | 'merged'
- `reviewed_by`: text -- nullable, admin user ID who reviewed
- `reviewed_at`: timestamp -- nullable
- `rejection_reason`: text -- nullable
- `published_document_id`: uuid -- nullable, references knowledgeBaseDocuments.id when approved
- `merged_into_id`: uuid -- nullable, self-reference for merge tracking
- `last_seen_at`: timestamp, defaultNow -- last time a similar suggestion was accepted
- `created_at`: timestamp, defaultNow, notNull
- `updated_at`: timestamp, defaultNow

Indexes:
- `kb_candidates_org_idx` on organizationId
- `kb_candidates_status_idx` on (organizationId, status)
- `kb_candidates_quality_idx` on (organizationId, qualityScore) -- for sorting admin review list

Add type exports: `KbCandidate` and `NewKbCandidate` using `$inferSelect` and `$inferInsert`.
  </action>
  <verify>Run `npx tsc --noEmit --project /Users/christopherbartolo/Documents/GitHub/slack-speak-for-me/packages/database/tsconfig.json` to confirm no type errors.</verify>
  <done>kbCandidates table defined in schema.ts with all columns, indexes, and type exports. TypeScript compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Add kbEffectiveness table and push schema</name>
  <files>packages/database/src/schema.ts</files>
  <action>
Add the `kbEffectiveness` table after kbCandidates. This table tracks which KB documents were used when generating a suggestion, enabling effectiveness measurement by joining with suggestionFeedback.

Table: `kb_effectiveness`
Columns:
- `id`: uuid, primaryKey, defaultRandom
- `suggestion_id`: text, notNull -- links to the suggestion (NOT a foreign key, same pattern as suggestionMetrics and topicClassifications)
- `kb_document_id`: uuid, notNull, references knowledgeBaseDocuments.id
- `organization_id`: uuid, notNull -- denormalized for fast org-wide queries (same pattern as suggestionMetrics)
- `similarity`: integer -- 0-100, how similar the KB doc was to the query
- `created_at`: timestamp, defaultNow, notNull

Indexes:
- `kb_effectiveness_suggestion_idx` on suggestionId
- `kb_effectiveness_doc_idx` on (kbDocumentId, createdAt) -- for per-doc effectiveness queries
- `kb_effectiveness_org_idx` on (organizationId, createdAt) -- for org-wide effectiveness queries

Add type exports: `KbEffectiveness` and `NewKbEffectiveness`.

After adding both tables, run `npm run db:push --workspace=@slack-speak-for-me/database` to apply the schema to the database. If docker database is not running, that is acceptable -- the schema definition is what matters for downstream plans.
  </action>
  <verify>Run `npx tsc --noEmit --project /Users/christopherbartolo/Documents/GitHub/slack-speak-for-me/packages/database/tsconfig.json` to confirm no type errors. Verify both table exports exist: `kbCandidates` and `kbEffectiveness`.</verify>
  <done>Both kbCandidates and kbEffectiveness tables defined with proper indexes and type exports. Schema compiles without TypeScript errors.</done>
</task>

</tasks>

<verification>
- TypeScript compiles: `npx tsc --noEmit` in packages/database passes
- Both tables exported from schema.ts
- Type exports available: KbCandidate, NewKbCandidate, KbEffectiveness, NewKbEffectiveness
- Indexes follow naming conventions from existing tables
</verification>

<success_criteria>
- kbCandidates table has all columns for candidate lifecycle (pending -> approved/rejected/merged)
- kbEffectiveness table links KB documents to suggestion outcomes
- Both tables have proper foreign keys and indexes
- Schema pushes successfully (or compiles if DB not running)
</success_criteria>

<output>
After completion, create `.planning/phases/18-auto-learning-knowledge-base/18-01-SUMMARY.md`
</output>
