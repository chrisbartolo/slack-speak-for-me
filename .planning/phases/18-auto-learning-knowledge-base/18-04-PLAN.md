---
phase: 18-auto-learning-knowledge-base
plan: 04
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - apps/web-portal/app/api/admin/kb-candidates/route.ts
  - apps/web-portal/app/api/admin/kb-candidates/[id]/route.ts
  - apps/web-portal/app/api/admin/kb-effectiveness/route.ts
autonomous: true

must_haves:
  truths:
    - "API returns paginated list of KB candidates with status filtering"
    - "API supports approve, reject, and merge actions on individual candidates"
    - "API returns KB effectiveness metrics per document"
    - "Approve action publishes candidate to knowledge_base_documents table"
  artifacts:
    - path: "apps/web-portal/app/api/admin/kb-candidates/route.ts"
      provides: "GET endpoint for listing candidates with status/category filters"
      exports: ["GET"]
    - path: "apps/web-portal/app/api/admin/kb-candidates/[id]/route.ts"
      provides: "GET for single candidate, PATCH for approve/reject/merge actions"
      exports: ["GET", "PATCH"]
    - path: "apps/web-portal/app/api/admin/kb-effectiveness/route.ts"
      provides: "GET endpoint for KB effectiveness metrics and learning loop stats"
      exports: ["GET"]
  key_links:
    - from: "apps/web-portal/app/api/admin/kb-candidates/[id]/route.ts"
      to: "packages/database/src/schema.ts"
      via: "kbCandidates update and knowledgeBaseDocuments insert on approve"
      pattern: "kbCandidates|knowledgeBaseDocuments"
    - from: "apps/web-portal/app/api/admin/kb-effectiveness/route.ts"
      to: "packages/database/src/schema.ts"
      via: "kbEffectiveness join queries"
      pattern: "kb_effectiveness"
---

<objective>
Create API routes for KB candidate management (list, approve, reject, merge) and effectiveness metrics.

Purpose: The web portal dashboard needs API endpoints to display KB candidates for admin review, perform review actions, and show effectiveness metrics. These APIs serve the dashboard UI in Plan 05.
Output: Three API route files providing candidate CRUD, review actions, and effectiveness data.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/18-auto-learning-knowledge-base/18-RESEARCH.md
@.planning/phases/18-auto-learning-knowledge-base/18-01-SUMMARY.md
@packages/database/src/schema.ts
@apps/web-portal/app/api/admin/knowledge-base/route.ts
@apps/web-portal/app/api/admin/knowledge-base/[id]/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create KB candidates API routes</name>
  <files>
    apps/web-portal/app/api/admin/kb-candidates/route.ts
    apps/web-portal/app/api/admin/kb-candidates/[id]/route.ts
  </files>
  <action>
Follow the existing admin API patterns from `apps/web-portal/app/api/admin/knowledge-base/route.ts` for auth, error handling, and response format.

**route.ts (list endpoint):**
- GET handler with admin session check (same auth pattern as other admin routes)
- Query params: `status` (filter by pending/approved/rejected/merged, default 'pending'), `category` (optional filter), `limit` (default 20), `offset` (default 0), `sort` ('quality_score' desc by default)
- Query kbCandidates table: filter by organizationId from session, apply status/category filters, order by qualityScore DESC, apply limit/offset
- Also return total count for pagination: separate COUNT(*) query with same filters
- Response: `{ candidates: KbCandidate[], total: number, limit: number, offset: number }`

**[id]/route.ts (single candidate + actions):**

GET handler:
- Return single candidate by ID, verify organizationId matches session
- 404 if not found

PATCH handler (review actions):
- Parse body: `{ action: 'approve' | 'reject' | 'merge', rejectionReason?: string, mergeWithId?: string }`
- Verify candidate belongs to session's organizationId

**Approve action:**
1. Read the candidate record
2. Use the existing `indexDocument` function from knowledge-base.ts service (import from '@slack-speak/database' or from the service) to publish the candidate content to the knowledge_base_documents table. Pass: organizationId, title, content, category, tags from the candidate.
3. Update the candidate: set status='approved', reviewedAt=new Date(), reviewedBy=session.userId, publishedDocumentId=new document ID
4. Return `{ success: true, documentId }`

Note: The `indexDocument` function in `apps/slack-backend/src/services/knowledge-base.ts` is in the slack-backend app, not accessible from web-portal. Instead, perform a direct database insert:
- Import db, knowledgeBaseDocuments, kbCandidates from '@slack-speak/database'
- Insert into knowledgeBaseDocuments: organizationId, title, content, category, tags, embedding (copy from candidate), isActive=true
- Then update kbCandidates with status='approved' and publishedDocumentId

**Reject action:**
1. Update candidate: status='rejected', reviewedAt, reviewedBy, rejectionReason
2. Return `{ success: true }`

**Merge action:**
1. Validate mergeWithId is provided and exists in same organization
2. Add this candidate's acceptance_count to the target candidate's acceptance_count
3. Update this candidate: status='merged', mergedIntoId=mergeWithId
4. Return `{ success: true }`

Use `eq` and `and` from drizzle-orm for queries. Return 400 for invalid actions, 404 for not found, 403 for wrong organization.
  </action>
  <verify>Run `npx tsc --noEmit --project /Users/christopherbartolo/Documents/GitHub/slack-speak-for-me/apps/web-portal/tsconfig.json` to confirm no type errors. Verify both route files exist.</verify>
  <done>KB candidates API supports listing with filters, individual retrieval, and approve/reject/merge actions. Approve publishes to knowledge_base_documents table.</done>
</task>

<task type="auto">
  <name>Task 2: Create KB effectiveness API route</name>
  <files>apps/web-portal/app/api/admin/kb-effectiveness/route.ts</files>
  <action>
Create effectiveness metrics API following existing admin API patterns.

**GET handler:**
- Admin session check (same auth pattern as other admin routes)
- Query params: `days` (default 30, max 90)
- Run three queries against the database:

**Query 1: Per-document effectiveness** (similar to getKBEffectiveness in Plan 03 but running from web-portal directly against DB):
```sql
SELECT
  ke.kb_document_id as "documentId",
  kbd.title,
  kbd.category,
  COUNT(ke.id)::int as "timesUsed",
  COUNT(DISTINCT ke.suggestion_id)::int as "uniqueSuggestions",
  SUM(CASE WHEN sf.action = 'accepted' THEN 1 ELSE 0 END)::int as "acceptedCount",
  SUM(CASE WHEN sf.action = 'dismissed' THEN 1 ELSE 0 END)::int as "dismissedCount",
  ROUND(
    SUM(CASE WHEN sf.action = 'accepted' THEN 1 ELSE 0 END)::numeric /
    NULLIF(COUNT(ke.id), 0) * 100
  )::int as "acceptanceRate",
  ROUND(AVG(ke.similarity))::int as "avgSimilarity"
FROM kb_effectiveness ke
JOIN knowledge_base_documents kbd ON ke.kb_document_id = kbd.id
LEFT JOIN suggestion_feedback sf ON ke.suggestion_id = sf.suggestion_id
WHERE ke.organization_id = $orgId
  AND ke.created_at > NOW() - INTERVAL '...'
GROUP BY ke.kb_document_id, kbd.title, kbd.category
ORDER BY "timesUsed" DESC
LIMIT 50
```

**Query 2: Learning loop stats** (summary counts):
```sql
-- Total candidates by status
SELECT
  status,
  COUNT(*)::int as count
FROM kb_candidates
WHERE organization_id = $orgId
GROUP BY status
```

**Query 3: KB growth over time** (for trend chart):
```sql
-- Candidates created per week (last 12 weeks)
SELECT
  DATE_TRUNC('week', created_at) as week,
  COUNT(*)::int as created,
  SUM(CASE WHEN status = 'approved' THEN 1 ELSE 0 END)::int as approved,
  SUM(CASE WHEN status = 'rejected' THEN 1 ELSE 0 END)::int as rejected
FROM kb_candidates
WHERE organization_id = $orgId
  AND created_at > NOW() - INTERVAL '12 weeks'
GROUP BY DATE_TRUNC('week', created_at)
ORDER BY week ASC
```

Response shape:
```json
{
  "documentEffectiveness": [...],
  "candidateStats": { "pending": N, "approved": N, "rejected": N, "merged": N },
  "growthTrend": [{ "week": "2026-01-27", "created": 5, "approved": 3, "rejected": 1 }, ...]
}
```

Use `db.execute(sql`...`)` for raw SQL queries with parameterized organizationId. Use the `sql` tagged template from drizzle-orm.
  </action>
  <verify>Run `npx tsc --noEmit --project /Users/christopherbartolo/Documents/GitHub/slack-speak-for-me/apps/web-portal/tsconfig.json` to confirm no type errors. Verify route file exists at the expected path.</verify>
  <done>KB effectiveness API returns per-document metrics, candidate status counts, and growth trend data. All queries parameterized and org-scoped.</done>
</task>

</tasks>

<verification>
- TypeScript compiles: `npx tsc --noEmit` in apps/web-portal passes
- Three API route files created under apps/web-portal/app/api/admin/
- All routes require admin session authentication
- Approve action publishes candidate to knowledge_base_documents
- Effectiveness query joins kb_effectiveness with suggestion_feedback
</verification>

<success_criteria>
- Admin can list candidates filtered by status and category
- Admin can approve (publishes to KB), reject (with reason), or merge candidates
- Effectiveness API shows per-document acceptance rates
- Growth trend data shows KB candidate creation and approval over time
- All queries scoped to admin's organization
</success_criteria>

<output>
After completion, create `.planning/phases/18-auto-learning-knowledge-base/18-04-SUMMARY.md`
</output>
