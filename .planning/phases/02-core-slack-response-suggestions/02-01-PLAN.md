---
phase: 02-core-slack-response-suggestions
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/src/schema.ts
  - packages/database/src/migrations/0001_watched_conversations.sql
  - apps/slack-backend/src/services/watch.ts
  - apps/slack-backend/src/services/index.ts
autonomous: true

must_haves:
  truths:
    - "User's watched conversations are persisted to database"
    - "System can query which conversations a user is watching"
    - "System can track thread participation for a user"
  artifacts:
    - path: "packages/database/src/schema.ts"
      provides: "watched_conversations table definition"
      contains: "watchedConversations"
    - path: "apps/slack-backend/src/services/watch.ts"
      provides: "Watch/unwatch service functions"
      exports: ["watchConversation", "unwatchConversation", "isWatching", "getWatchedConversations"]
  key_links:
    - from: "apps/slack-backend/src/services/watch.ts"
      to: "packages/database/src/schema.ts"
      via: "drizzle query"
      pattern: "db\\.insert.*watchedConversations|db\\.delete.*watchedConversations"
---

<objective>
Add database schema and service layer for tracking watched conversations and thread participation.

Purpose: Enable users to control which conversations trigger AI suggestions, and allow the system to detect when users are participating in threads.

Output: Database table for watched_conversations, service functions for watch/unwatch operations, and thread participation tracking.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-slack-response-suggestions/02-RESEARCH.md

@packages/database/src/schema.ts
@packages/database/src/client.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add watched_conversations and thread_participants tables to database schema</name>
  <files>
    packages/database/src/schema.ts
    packages/database/src/migrations/0001_watched_conversations.sql
  </files>
  <action>
Add two new tables to packages/database/src/schema.ts:

1. `watchedConversations` table:
   - id: uuid primary key (defaultRandom)
   - workspace_id: uuid (references workspaces.id)
   - user_id: text (Slack user ID, e.g., "U12345")
   - channel_id: text (Slack channel/conversation ID, e.g., "C12345")
   - watched_at: timestamp (defaultNow)
   - Add unique constraint on (workspace_id, user_id, channel_id)
   - Add index on (workspace_id, user_id)

2. `threadParticipants` table (for tracking active thread participation):
   - id: uuid primary key (defaultRandom)
   - workspace_id: uuid (references workspaces.id)
   - user_id: text (Slack user ID)
   - channel_id: text (Slack channel ID)
   - thread_ts: text (thread parent timestamp)
   - last_message_at: timestamp (when user last posted in thread)
   - Add unique constraint on (workspace_id, user_id, channel_id, thread_ts)
   - Add index on (workspace_id, channel_id, thread_ts)

Create migration file 0001_watched_conversations.sql with:
- CREATE TABLE statements
- CREATE INDEX statements
- Enable RLS on both tables
- Add tenant_isolation policies using workspace_id

Use snake_case for all column names (consistent with Phase 1 convention).
  </action>
  <verify>
Run `npm run build --workspaces --if-present` - TypeScript compiles without errors.
Verify schema.ts exports watchedConversations and threadParticipants.
  </verify>
  <done>
Both tables defined in schema.ts with proper types, constraints, and indexes.
Migration file exists with RLS policies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create watch service for conversation tracking operations</name>
  <files>
    apps/slack-backend/src/services/watch.ts
    apps/slack-backend/src/services/index.ts
  </files>
  <action>
Create apps/slack-backend/src/services/watch.ts with these functions:

```typescript
import { db, watchedConversations, threadParticipants } from '@slack-speak/database';
import { eq, and } from 'drizzle-orm';

// Watch a conversation for a user
export async function watchConversation(
  workspaceId: string,
  userId: string,
  channelId: string
): Promise<void>

// Unwatch a conversation for a user
export async function unwatchConversation(
  workspaceId: string,
  userId: string,
  channelId: string
): Promise<void>

// Check if user is watching a specific conversation
export async function isWatching(
  workspaceId: string,
  userId: string,
  channelId: string
): Promise<boolean>

// Get all watched conversations for a user
export async function getWatchedConversations(
  workspaceId: string,
  userId: string
): Promise<string[]> // Returns array of channel IDs

// Record thread participation (for trigger detection)
export async function recordThreadParticipation(
  workspaceId: string,
  userId: string,
  channelId: string,
  threadTs: string
): Promise<void>

// Check if user is participating in a thread (posted within last 7 days)
export async function isParticipatingInThread(
  workspaceId: string,
  userId: string,
  channelId: string,
  threadTs: string
): Promise<boolean>
```

Implementation notes:
- Use upsert pattern for watchConversation (ON CONFLICT DO NOTHING)
- Use upsert pattern for recordThreadParticipation (ON CONFLICT UPDATE last_message_at)
- isParticipatingInThread should check last_message_at is within 7 days
- All functions should use db from @slack-speak/database

Create apps/slack-backend/src/services/index.ts as barrel file exporting all service functions.
  </action>
  <verify>
Run `npm run build --workspaces --if-present` - TypeScript compiles without errors.
Grep for function exports: `grep -E "export.*function" apps/slack-backend/src/services/watch.ts`
  </verify>
  <done>
watch.ts exports watchConversation, unwatchConversation, isWatching, getWatchedConversations, recordThreadParticipation, isParticipatingInThread.
index.ts re-exports all functions.
TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. Run `npm run build --workspaces --if-present` - all packages compile
2. Verify schema exports: `grep "watchedConversations\|threadParticipants" packages/database/src/schema.ts`
3. Verify service exports: `grep "export" apps/slack-backend/src/services/index.ts`
4. Verify RLS in migration: `grep "ROW LEVEL SECURITY\|CREATE POLICY" packages/database/src/migrations/0001_*.sql`
</verification>

<success_criteria>
- watchedConversations and threadParticipants tables defined in schema.ts
- Migration file includes RLS policies for both tables
- Watch service provides CRUD operations for watched conversations
- Thread participation tracking with 7-day window
- All code compiles without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-slack-response-suggestions/02-01-SUMMARY.md`
</output>
