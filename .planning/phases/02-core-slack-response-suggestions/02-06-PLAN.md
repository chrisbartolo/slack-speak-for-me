---
phase: 02-core-slack-response-suggestions
plan: 06
type: execute
wave: 2
depends_on: ["02-02"]
files_modified:
  - apps/slack-backend/src/services/suggestion-delivery.ts
  - apps/slack-backend/src/services/index.ts
  - apps/slack-backend/src/jobs/workers.ts
autonomous: true

must_haves:
  truths:
    - "AI suggestion is delivered via ephemeral message"
    - "Ephemeral message includes Copy and Refine buttons"
    - "Message is only visible to the target user"
  artifacts:
    - path: "apps/slack-backend/src/services/suggestion-delivery.ts"
      provides: "Ephemeral message delivery with Block Kit"
      exports: ["sendSuggestionEphemeral"]
  key_links:
    - from: "apps/slack-backend/src/jobs/workers.ts"
      to: "apps/slack-backend/src/services/suggestion-delivery.ts"
      via: "sendSuggestionEphemeral call"
      pattern: "sendSuggestionEphemeral"
    - from: "apps/slack-backend/src/services/suggestion-delivery.ts"
      to: "@slack/web-api"
      via: "chat.postEphemeral"
      pattern: "chat\\.postEphemeral"
---

<objective>
Create the ephemeral message delivery service that sends AI suggestions to users with Copy and Refine action buttons.

Purpose: After the AI generates a suggestion, it needs to be delivered privately to the user with interactive buttons for copying or refining the response.

Output: Suggestion delivery service with Block Kit message formatting, integrated into the job worker.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-slack-response-suggestions/02-RESEARCH.md

@apps/slack-backend/src/jobs/workers.ts
@apps/slack-backend/src/jobs/types.ts
@apps/slack-backend/src/oauth/installation-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create suggestion delivery service with Block Kit formatting</name>
  <files>
    apps/slack-backend/src/services/suggestion-delivery.ts
    apps/slack-backend/src/services/index.ts
  </files>
  <action>
Create apps/slack-backend/src/services/suggestion-delivery.ts:

```typescript
import { WebClient } from '@slack/web-api';
import type { Block, KnownBlock } from '@slack/types';
import { logger } from '../utils/logger.js';

interface SuggestionDeliveryOptions {
  client: WebClient;
  userId: string;
  channelId: string;
  suggestion: string;
  suggestionId: string;
  triggeredBy: 'mention' | 'reply' | 'thread' | 'message_action';
  originalMessageTs: string;
}

/**
 * Build Block Kit blocks for the suggestion ephemeral message.
 * Includes:
 * - Header with trigger context
 * - Suggestion text in a section
 * - Action buttons: Copy and Refine
 */
function buildSuggestionBlocks(
  suggestion: string,
  suggestionId: string,
  triggeredBy: string,
  originalMessageTs: string
): (Block | KnownBlock)[] {
  const triggerLabel = {
    mention: 'you were mentioned',
    reply: 'someone replied to your message',
    thread: 'new message in a thread you participate in',
    message_action: 'you requested help',
  }[triggeredBy] || 'a message was received';

  return [
    {
      type: 'header',
      text: {
        type: 'plain_text',
        text: 'Suggested Response',
        emoji: true,
      },
    },
    {
      type: 'context',
      elements: [
        {
          type: 'mrkdwn',
          text: `Triggered because ${triggerLabel}`,
        },
      ],
    },
    {
      type: 'divider',
    },
    {
      type: 'section',
      text: {
        type: 'mrkdwn',
        text: suggestion,
      },
    },
    {
      type: 'divider',
    },
    {
      type: 'actions',
      block_id: `suggestion_actions_${suggestionId}`,
      elements: [
        {
          type: 'button',
          text: {
            type: 'plain_text',
            text: 'Copy to Clipboard',
            emoji: true,
          },
          action_id: 'copy_suggestion',
          value: JSON.stringify({
            suggestionId,
            suggestion,
          }),
          style: 'primary',
        },
        {
          type: 'button',
          text: {
            type: 'plain_text',
            text: 'Refine',
            emoji: true,
          },
          action_id: 'refine_suggestion',
          value: JSON.stringify({
            suggestionId,
            suggestion,
            originalMessageTs,
          }),
        },
        {
          type: 'button',
          text: {
            type: 'plain_text',
            text: 'Dismiss',
            emoji: true,
          },
          action_id: 'dismiss_suggestion',
          value: suggestionId,
        },
      ],
    },
    {
      type: 'context',
      elements: [
        {
          type: 'mrkdwn',
          text: '_This message is only visible to you. Copy the suggestion and paste it into your message._',
        },
      ],
    },
  ];
}

/**
 * Send an ephemeral message with the AI-generated suggestion.
 * Ephemeral messages are only visible to the specified user.
 */
export async function sendSuggestionEphemeral(
  options: SuggestionDeliveryOptions
): Promise<{ ok: boolean; messageTs?: string }> {
  const { client, userId, channelId, suggestion, suggestionId, triggeredBy, originalMessageTs } = options;

  const blocks = buildSuggestionBlocks(suggestion, suggestionId, triggeredBy, originalMessageTs);

  try {
    const result = await client.chat.postEphemeral({
      channel: channelId,
      user: userId,
      text: `Suggested response: ${suggestion.substring(0, 100)}...`, // Fallback text
      blocks,
    });

    if (!result.ok) {
      logger.warn({
        userId,
        channelId,
        error: result.error,
      }, 'Failed to send ephemeral suggestion');
      return { ok: false };
    }

    logger.info({
      userId,
      channelId,
      suggestionId,
      messageTs: result.message_ts,
    }, 'Ephemeral suggestion sent');

    return { ok: true, messageTs: result.message_ts };
  } catch (error) {
    logger.error({ error, userId, channelId }, 'Error sending ephemeral suggestion');
    throw error;
  }
}

/**
 * Build fallback text for suggestion (used when blocks aren't supported).
 */
export function buildSuggestionFallbackText(suggestion: string): string {
  const maxLength = 200;
  const truncated = suggestion.length > maxLength
    ? `${suggestion.substring(0, maxLength)}...`
    : suggestion;
  return `Suggested response: ${truncated}`;
}
```

Update apps/slack-backend/src/services/index.ts:
```typescript
export { generateSuggestion } from './ai.js';
export { watchConversation, unwatchConversation, isWatching, getWatchedConversations, recordThreadParticipation, isParticipatingInThread } from './watch.js';
export { getConversationContext, getThreadContext, getContextForMessage, type ContextMessage } from './context.js';
export { sendSuggestionEphemeral, buildSuggestionFallbackText } from './suggestion-delivery.js';
```

Implementation notes:
- Use Block Kit for rich message formatting
- Include trigger context (why was this triggered)
- Copy button stores suggestion in value for action handler
- Refine button stores suggestionId and original context
- Dismiss button allows user to close without action
- Context block explains this is ephemeral and copy/paste workflow
- Fallback text for clients that don't support blocks
  </action>
  <verify>
Run `npm run build --workspaces --if-present` - TypeScript compiles without errors.
Verify export: `grep "sendSuggestionEphemeral" apps/slack-backend/src/services/suggestion-delivery.ts`
Verify blocks include buttons: `grep "copy_suggestion\|refine_suggestion" apps/slack-backend/src/services/suggestion-delivery.ts`
  </verify>
  <done>
suggestion-delivery.ts exports sendSuggestionEphemeral.
Block Kit message includes Copy, Refine, and Dismiss buttons.
Trigger context displayed to user.
TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire suggestion delivery into BullMQ worker</name>
  <files>
    apps/slack-backend/src/jobs/workers.ts
  </files>
  <action>
Update apps/slack-backend/src/jobs/workers.ts to send ephemeral message after generating suggestion:

```typescript
import { Worker } from 'bullmq';
import { WebClient } from '@slack/web-api';
import { redis } from './connection.js';
import { logger } from '../utils/logger.js';
import { generateSuggestion, sendSuggestionEphemeral } from '../services/index.js';
import { installationStore } from '../oauth/installation-store.js';
import type { AIResponseJobData, AIResponseJobResult } from './types.js';

export const aiResponseWorker = new Worker<AIResponseJobData, AIResponseJobResult>(
  'ai-responses',
  async (job) => {
    const {
      workspaceId,
      userId,
      channelId,
      messageTs,
      triggerMessageText,
      contextMessages,
      triggeredBy,
    } = job.data;

    logger.info({
      jobId: job.id,
      workspaceId,
      userId,
      triggeredBy,
    }, 'Processing AI response job');

    // Generate AI suggestion
    const result = await generateSuggestion({
      triggerMessage: triggerMessageText,
      contextMessages,
      triggeredBy,
    });

    // Generate a unique suggestion ID for tracking
    const suggestionId = `sug_${Date.now()}_${Math.random().toString(36).slice(2, 9)}`;

    logger.info({
      jobId: job.id,
      suggestionId,
      processingTimeMs: result.processingTimeMs,
    }, 'AI suggestion generated successfully');

    // Fetch installation to get bot token
    const installation = await installationStore.fetchInstallation({
      teamId: workspaceId,
      isEnterpriseInstall: false,
    });

    if (!installation || !installation.bot?.token) {
      logger.error({ workspaceId }, 'No bot token available for workspace');
      throw new Error('No bot token available');
    }

    // Create Web client with bot token
    const client = new WebClient(installation.bot.token);

    // Send ephemeral message with suggestion
    const deliveryResult = await sendSuggestionEphemeral({
      client,
      userId,
      channelId,
      suggestion: result.suggestion,
      suggestionId,
      triggeredBy,
      originalMessageTs: messageTs,
    });

    if (!deliveryResult.ok) {
      logger.warn({
        jobId: job.id,
        suggestionId,
        userId,
        channelId,
      }, 'Failed to deliver ephemeral suggestion');
      // Don't throw - suggestion was generated, delivery failed
      // This could happen if user left channel, etc.
    }

    return {
      suggestionId,
      suggestion: result.suggestion,
      processingTimeMs: result.processingTimeMs,
    };
  },
  {
    connection: redis,
    concurrency: 5,
    limiter: {
      max: 10,
      duration: 1000, // 10 jobs per second
    },
  }
);

// Event handlers
aiResponseWorker.on('error', (err) => {
  logger.error({ error: err }, 'Worker error');
});

aiResponseWorker.on('failed', (job, err) => {
  logger.error({
    jobId: job?.id,
    error: err.message,
    attempts: job?.attemptsMade,
  }, 'Job failed');
});

aiResponseWorker.on('completed', (job, result) => {
  logger.info({
    jobId: job.id,
    suggestionId: result.suggestionId,
    processingTimeMs: result.processingTimeMs,
  }, 'Job completed');
});

aiResponseWorker.on('stalled', (jobId) => {
  logger.warn({ jobId }, 'Job stalled');
});
```

Implementation notes:
- Fetch installation to get bot token for API calls
- Create WebClient with bot token
- Call sendSuggestionEphemeral after generating suggestion
- Don't throw on delivery failure (suggestion was generated)
- Log delivery status for monitoring
- Return result regardless of delivery success
  </action>
  <verify>
Run `npm run build --workspaces --if-present` - TypeScript compiles without errors.
Verify delivery integration: `grep "sendSuggestionEphemeral" apps/slack-backend/src/jobs/workers.ts`
Verify WebClient: `grep "new WebClient" apps/slack-backend/src/jobs/workers.ts`
  </verify>
  <done>
Worker generates suggestion and sends ephemeral message.
Bot token retrieved from installation store.
Delivery failure doesn't fail the job (suggestion was generated).
TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. Run `npm run build --workspaces --if-present` - all packages compile
2. Verify delivery service: `grep "export.*sendSuggestionEphemeral" apps/slack-backend/src/services/suggestion-delivery.ts`
3. Verify Block Kit buttons: `grep "copy_suggestion\|refine_suggestion" apps/slack-backend/src/services/suggestion-delivery.ts`
4. Verify worker integration: `grep "sendSuggestionEphemeral" apps/slack-backend/src/jobs/workers.ts`
5. Verify WebClient usage: `grep "WebClient" apps/slack-backend/src/jobs/workers.ts`
</verification>

<success_criteria>
- Ephemeral messages sent with Block Kit formatting
- Copy, Refine, and Dismiss buttons included
- Trigger context displayed in message
- Worker fetches bot token and sends suggestion after generation
- Delivery failure doesn't fail the job
- All code compiles without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-slack-response-suggestions/02-06-SUMMARY.md`
</output>
