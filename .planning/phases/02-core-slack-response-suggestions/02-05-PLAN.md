---
phase: 02-core-slack-response-suggestions
plan: 05
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - apps/slack-backend/src/handlers/commands/watch.ts
  - apps/slack-backend/src/handlers/commands/index.ts
  - apps/slack-backend/src/handlers/index.ts
  - apps/slack-backend/src/app.ts
autonomous: true

must_haves:
  truths:
    - "User can toggle watch on specific conversations via /watch command"
    - "User can toggle unwatch via /unwatch command"
    - "Watch status is confirmed via ephemeral message"
  artifacts:
    - path: "apps/slack-backend/src/handlers/commands/watch.ts"
      provides: "Slash command handlers for /watch and /unwatch"
      exports: ["registerWatchCommands"]
  key_links:
    - from: "apps/slack-backend/src/handlers/commands/watch.ts"
      to: "apps/slack-backend/src/services/watch.ts"
      via: "watchConversation and unwatchConversation"
      pattern: "watchConversation|unwatchConversation"
---

<objective>
Implement /watch and /unwatch slash commands for users to control which conversations trigger AI suggestions.

Purpose: Users need explicit control over when they receive suggestions. Watch commands let them opt-in to specific channels/conversations.

Output: Slash command handlers that toggle watch status and confirm via ephemeral message.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-slack-response-suggestions/02-RESEARCH.md

@apps/slack-backend/src/app.ts
@.planning/phases/02-core-slack-response-suggestions/02-01-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create /watch and /unwatch slash command handlers</name>
  <files>
    apps/slack-backend/src/handlers/commands/watch.ts
    apps/slack-backend/src/handlers/commands/index.ts
  </files>
  <action>
Create apps/slack-backend/src/handlers/commands/ directory and watch.ts:

```typescript
import type { App } from '@slack/bolt';
import { watchConversation, unwatchConversation, isWatching, getWatchedConversations } from '../../services/watch.js';
import { logger } from '../../utils/logger.js';

/**
 * Register /watch and /unwatch slash commands.
 *
 * /watch - Start receiving AI suggestions in this conversation
 * /unwatch - Stop receiving AI suggestions in this conversation
 *
 * Both commands respond with ephemeral messages to confirm the action.
 */
export function registerWatchCommands(app: App): void {
  // /watch command
  app.command('/watch', async ({ command, ack, respond, context }) => {
    await ack();

    const userId = command.user_id;
    const channelId = command.channel_id;
    const teamId = context.teamId;

    if (!teamId) {
      await respond({
        response_type: 'ephemeral',
        text: 'Unable to process command: workspace not identified.',
      });
      return;
    }

    try {
      // Check if already watching
      const alreadyWatching = await isWatching(teamId, userId, channelId);

      if (alreadyWatching) {
        await respond({
          response_type: 'ephemeral',
          text: `You're already watching this conversation. You'll receive AI-powered response suggestions when mentioned or replied to here.`,
        });
        return;
      }

      // Add watch
      await watchConversation(teamId, userId, channelId);

      logger.info({
        teamId,
        userId,
        channelId,
        action: 'watch',
      }, 'User watching conversation');

      await respond({
        response_type: 'ephemeral',
        text: `You're now watching this conversation. You'll receive AI-powered response suggestions when:\n- Someone mentions you\n- Someone replies to your messages\n- New messages appear in threads you participate in\n\nUse \`/unwatch\` to stop receiving suggestions here.`,
      });
    } catch (error) {
      logger.error({ error, userId, channelId }, 'Failed to watch conversation');
      await respond({
        response_type: 'ephemeral',
        text: 'Something went wrong. Please try again.',
      });
    }
  });

  // /unwatch command
  app.command('/unwatch', async ({ command, ack, respond, context }) => {
    await ack();

    const userId = command.user_id;
    const channelId = command.channel_id;
    const teamId = context.teamId;

    if (!teamId) {
      await respond({
        response_type: 'ephemeral',
        text: 'Unable to process command: workspace not identified.',
      });
      return;
    }

    try {
      // Check if currently watching
      const currentlyWatching = await isWatching(teamId, userId, channelId);

      if (!currentlyWatching) {
        await respond({
          response_type: 'ephemeral',
          text: `You're not currently watching this conversation. Use \`/watch\` to start receiving AI-powered response suggestions here.`,
        });
        return;
      }

      // Remove watch
      await unwatchConversation(teamId, userId, channelId);

      logger.info({
        teamId,
        userId,
        channelId,
        action: 'unwatch',
      }, 'User unwatched conversation');

      await respond({
        response_type: 'ephemeral',
        text: `You've unwatched this conversation. You won't receive automatic AI suggestions here anymore.\n\nYou can still use the "Help me respond" message action on any message, or use \`/watch\` to start watching again.`,
      });
    } catch (error) {
      logger.error({ error, userId, channelId }, 'Failed to unwatch conversation');
      await respond({
        response_type: 'ephemeral',
        text: 'Something went wrong. Please try again.',
      });
    }
  });
}
```

Create apps/slack-backend/src/handlers/commands/index.ts:

```typescript
export { registerWatchCommands } from './watch.js';
```

Implementation notes:
- Call ack() immediately to meet 3-second requirement
- Use respond() with ephemeral messages (only visible to user)
- Check current watch status before toggling
- Provide clear feedback on what watching means
- Mention the "Help me respond" alternative for unwatched conversations
- Log all watch/unwatch actions for debugging
  </action>
  <verify>
Run `npm run build --workspaces --if-present` - TypeScript compiles without errors.
Verify commands: `grep "app.command" apps/slack-backend/src/handlers/commands/watch.ts`
  </verify>
  <done>
watch.ts implements /watch and /unwatch commands.
Both commands check current status before toggling.
Ephemeral responses confirm actions to user.
TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register slash commands with Bolt app</name>
  <files>
    apps/slack-backend/src/handlers/index.ts
    apps/slack-backend/src/app.ts
  </files>
  <action>
Update apps/slack-backend/src/handlers/index.ts:
```typescript
export { healthRoutes, logHealthEndpointsRegistered } from './health.js';
export { registerAppMentionHandler, registerMessageReplyHandler } from './events/index.js';
export { registerWatchCommands } from './commands/index.js';
```

Update apps/slack-backend/src/app.ts to register slash commands:

```typescript
import { App } from '@slack/bolt';
import { env } from './env.js';
import { installationStore } from './oauth/installation-store.js';
import { errorHandler } from './middleware/error-handler.js';
import {
  healthRoutes,
  logHealthEndpointsRegistered,
  registerAppMentionHandler,
  registerMessageReplyHandler,
  registerWatchCommands,
} from './handlers/index.js';

/**
 * Slack Bolt app with OAuth configuration and health endpoints.
 */
export const app = new App({
  signingSecret: env.SLACK_SIGNING_SECRET,
  clientId: env.SLACK_CLIENT_ID,
  clientSecret: env.SLACK_CLIENT_SECRET,
  stateSecret: env.SLACK_STATE_SECRET,
  installationStore,
  scopes: [
    'channels:history',
    'channels:read',
    'chat:write',
    'users:read',
    'app_mentions:read',
    'commands', // Add commands scope for slash commands
  ],
  installerOptions: {
    directInstall: true,
  },
  customRoutes: healthRoutes,
});

// Register global error handler
app.error(errorHandler);

// Register event handlers
registerAppMentionHandler(app);
registerMessageReplyHandler(app);

// Register slash commands
registerWatchCommands(app);

// Log health endpoints registration
logHealthEndpointsRegistered();
```

Implementation notes:
- Add 'commands' scope for slash command support
- Register slash commands after event handlers
- The /watch and /unwatch commands must be configured in Slack App settings:
  - Command: /watch
  - Request URL: https://your-app.com/slack/events
  - Description: Start receiving AI response suggestions in this conversation

  - Command: /unwatch
  - Request URL: https://your-app.com/slack/events
  - Description: Stop receiving AI response suggestions in this conversation
  </action>
  <verify>
Run `npm run build --workspaces --if-present` - TypeScript compiles without errors.
Verify commands registered: `grep "registerWatchCommands" apps/slack-backend/src/app.ts`
Verify commands scope: `grep "commands" apps/slack-backend/src/app.ts`
  </verify>
  <done>
commands/index.ts exports registerWatchCommands.
handlers/index.ts re-exports slash command registration.
app.ts imports and calls registerWatchCommands.
'commands' scope added to OAuth scopes.
TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. Run `npm run build --workspaces --if-present` - all packages compile
2. Verify command handlers: `grep "app.command" apps/slack-backend/src/handlers/commands/watch.ts`
3. Verify registration: `grep "registerWatchCommands" apps/slack-backend/src/app.ts`
4. Verify commands scope: `grep "commands" apps/slack-backend/src/app.ts`
5. Verify service integration: `grep "watchConversation\|unwatchConversation" apps/slack-backend/src/handlers/commands/watch.ts`
</verification>

<success_criteria>
- /watch command enables AI suggestions for the conversation
- /unwatch command disables AI suggestions for the conversation
- Both commands respond with clear ephemeral feedback
- Current watch status checked before toggling
- 'commands' scope added to OAuth configuration
- All code compiles without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-slack-response-suggestions/02-05-SUMMARY.md`
</output>
