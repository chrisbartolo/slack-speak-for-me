---
phase: 02-core-slack-response-suggestions
plan: 07
type: execute
wave: 3
depends_on: ["02-06"]
files_modified:
  - apps/slack-backend/src/handlers/shortcuts/help-me-respond.ts
  - apps/slack-backend/src/handlers/shortcuts/index.ts
  - apps/slack-backend/src/handlers/actions/copy-suggestion.ts
  - apps/slack-backend/src/handlers/actions/dismiss-suggestion.ts
  - apps/slack-backend/src/handlers/actions/index.ts
  - apps/slack-backend/src/handlers/index.ts
  - apps/slack-backend/src/app.ts
autonomous: true

must_haves:
  truths:
    - "User can right-click any message and select 'Help me respond'"
    - "Message shortcut triggers AI suggestion in queue"
    - "Copy button provides instructions for copying text"
    - "Dismiss button removes the ephemeral message"
  artifacts:
    - path: "apps/slack-backend/src/handlers/shortcuts/help-me-respond.ts"
      provides: "Message shortcut handler"
      contains: "app.shortcut"
    - path: "apps/slack-backend/src/handlers/actions/copy-suggestion.ts"
      provides: "Copy button action handler"
      contains: "app.action"
  key_links:
    - from: "apps/slack-backend/src/handlers/shortcuts/help-me-respond.ts"
      to: "apps/slack-backend/src/jobs/queues.ts"
      via: "queueAIResponse"
      pattern: "queueAIResponse"
---

<objective>
Implement the "Help me respond" message shortcut and action button handlers for Copy and Dismiss.

Purpose: Users need manual control to request help on any message (including DMs where watching isn't practical). The message shortcut provides this. Button handlers complete the interaction flow.

Output: Message shortcut handler, Copy button handler (with copy instructions), Dismiss button handler.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-slack-response-suggestions/02-RESEARCH.md

@apps/slack-backend/src/app.ts
@apps/slack-backend/src/jobs/queues.ts
@.planning/phases/02-core-slack-response-suggestions/02-06-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create "Help me respond" message shortcut handler</name>
  <files>
    apps/slack-backend/src/handlers/shortcuts/help-me-respond.ts
    apps/slack-backend/src/handlers/shortcuts/index.ts
  </files>
  <action>
Create apps/slack-backend/src/handlers/shortcuts/ directory and help-me-respond.ts:

```typescript
import type { App, MessageShortcut } from '@slack/bolt';
import { queueAIResponse } from '../../jobs/queues.js';
import { getContextForMessage } from '../../services/context.js';
import { logger } from '../../utils/logger.js';
import { installationStore } from '../../oauth/installation-store.js';
import { WebClient } from '@slack/web-api';

/**
 * Register "Help me respond" message shortcut.
 *
 * This shortcut appears when users right-click on any message.
 * It triggers AI suggestion generation for any message, regardless of watch status.
 *
 * The shortcut callback_id must match the one configured in the Slack App settings.
 */
export function registerHelpMeRespondShortcut(app: App): void {
  app.shortcut('help_me_respond', async ({ shortcut, ack, client, context }) => {
    await ack();

    const messageShortcut = shortcut as MessageShortcut;

    logger.info({
      user: messageShortcut.user.id,
      channel: messageShortcut.channel.id,
      messageTs: messageShortcut.message.ts,
    }, 'Help me respond shortcut triggered');

    const teamId = context.teamId;
    if (!teamId) {
      logger.warn({ shortcut }, 'No team ID in context');
      // Can't respond without team context
      return;
    }

    // Get message text from the shortcut payload
    const messageText = messageShortcut.message.text || '';
    const channelId = messageShortcut.channel.id;
    const messageTs = messageShortcut.message.ts;
    const userId = messageShortcut.user.id;

    // Determine thread context
    const threadTs = 'thread_ts' in messageShortcut.message
      ? (messageShortcut.message as { thread_ts?: string }).thread_ts
      : undefined;

    try {
      // Fetch conversation context
      const contextMessages = await getContextForMessage(
        client,
        channelId,
        messageTs,
        threadTs
      );

      // Queue AI response job
      await queueAIResponse({
        workspaceId: teamId,
        userId,
        channelId,
        messageTs,
        triggerMessageText: messageText,
        contextMessages,
        triggeredBy: 'message_action',
      });

      logger.info({
        channel: channelId,
        user: userId,
        messageTs,
        jobQueued: true,
      }, 'AI response job queued for message shortcut');

      // Send immediate acknowledgment to user
      await client.chat.postEphemeral({
        channel: channelId,
        user: userId,
        text: 'Got it! Generating a suggested response for you...',
      });
    } catch (error) {
      logger.error({ error, userId, channelId }, 'Error processing help me respond shortcut');

      // Send error message to user
      try {
        await client.chat.postEphemeral({
          channel: channelId,
          user: userId,
          text: 'Sorry, something went wrong. Please try again.',
        });
      } catch {
        // Ignore ephemeral send failure
      }
    }
  });
}
```

Create apps/slack-backend/src/handlers/shortcuts/index.ts:

```typescript
export { registerHelpMeRespondShortcut } from './help-me-respond.js';
```

Implementation notes:
- Message shortcuts use callback_id to identify which shortcut was triggered
- Shortcut payload includes message content and channel info
- Send immediate "working on it" acknowledgment
- Fetch context using getContextForMessage (handles threads)
- Queue job with triggeredBy: 'message_action' to distinguish from auto-triggers
- Handle errors gracefully with user-facing message
  </action>
  <verify>
Run `npm run build --workspaces --if-present` - TypeScript compiles without errors.
Verify shortcut handler: `grep "app.shortcut.*help_me_respond" apps/slack-backend/src/handlers/shortcuts/help-me-respond.ts`
  </verify>
  <done>
help-me-respond.ts implements message shortcut handler.
Fetches context and queues AI job.
Sends acknowledgment ephemeral message.
TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Copy and Dismiss button action handlers</name>
  <files>
    apps/slack-backend/src/handlers/actions/copy-suggestion.ts
    apps/slack-backend/src/handlers/actions/dismiss-suggestion.ts
    apps/slack-backend/src/handlers/actions/index.ts
    apps/slack-backend/src/handlers/index.ts
    apps/slack-backend/src/app.ts
  </files>
  <action>
Create apps/slack-backend/src/handlers/actions/ directory.

Create copy-suggestion.ts:

```typescript
import type { App } from '@slack/bolt';
import { logger } from '../../utils/logger.js';

/**
 * Handle "Copy to Clipboard" button click.
 *
 * Since Slack doesn't support programmatic clipboard access,
 * we provide instructions for manual copying and show the text prominently.
 */
export function registerCopySuggestionAction(app: App): void {
  app.action('copy_suggestion', async ({ ack, body, respond }) => {
    await ack();

    // Extract suggestion from button value
    const actionBody = body as { actions: Array<{ value?: string }> };
    const value = actionBody.actions[0]?.value;

    if (!value) {
      logger.warn({ body }, 'Copy action missing value');
      return;
    }

    try {
      const { suggestionId, suggestion } = JSON.parse(value);

      logger.info({
        suggestionId,
        userId: 'user' in body ? body.user.id : 'unknown',
      }, 'Copy button clicked');

      // Respond with instructions and prominent text for copying
      await respond({
        response_type: 'ephemeral',
        replace_original: true,
        text: 'Copy the response below:',
        blocks: [
          {
            type: 'header',
            text: {
              type: 'plain_text',
              text: 'Copy This Response',
              emoji: true,
            },
          },
          {
            type: 'section',
            text: {
              type: 'mrkdwn',
              text: '*Select and copy the text below:*',
            },
          },
          {
            type: 'divider',
          },
          {
            type: 'section',
            text: {
              type: 'mrkdwn',
              text: `\`\`\`${suggestion}\`\`\``,
            },
          },
          {
            type: 'context',
            elements: [
              {
                type: 'mrkdwn',
                text: '_Triple-click to select all, then Cmd+C (Mac) or Ctrl+C (Windows) to copy._',
              },
            ],
          },
          {
            type: 'actions',
            elements: [
              {
                type: 'button',
                text: {
                  type: 'plain_text',
                  text: 'Done',
                  emoji: true,
                },
                action_id: 'dismiss_suggestion',
                value: suggestionId,
              },
            ],
          },
        ],
      });
    } catch (error) {
      logger.error({ error }, 'Error handling copy action');
    }
  });
}
```

Create dismiss-suggestion.ts:

```typescript
import type { App } from '@slack/bolt';
import { logger } from '../../utils/logger.js';

/**
 * Handle "Dismiss" button click.
 *
 * Simply removes the ephemeral message by replacing with minimal content.
 */
export function registerDismissSuggestionAction(app: App): void {
  app.action('dismiss_suggestion', async ({ ack, body, respond }) => {
    await ack();

    // Extract suggestion ID from button value
    const actionBody = body as { actions: Array<{ value?: string }> };
    const suggestionId = actionBody.actions[0]?.value;

    logger.info({
      suggestionId,
      userId: 'user' in body ? body.user.id : 'unknown',
    }, 'Suggestion dismissed');

    // Replace with minimal message that confirms dismissal
    await respond({
      response_type: 'ephemeral',
      replace_original: true,
      delete_original: true,
      text: 'Suggestion dismissed.',
    });
  });
}
```

Create apps/slack-backend/src/handlers/actions/index.ts:

```typescript
export { registerCopySuggestionAction } from './copy-suggestion.js';
export { registerDismissSuggestionAction } from './dismiss-suggestion.js';
```

Update apps/slack-backend/src/handlers/index.ts:

```typescript
export { healthRoutes, logHealthEndpointsRegistered } from './health.js';
export { registerAppMentionHandler, registerMessageReplyHandler } from './events/index.js';
export { registerWatchCommands } from './commands/index.js';
export { registerHelpMeRespondShortcut } from './shortcuts/index.js';
export { registerCopySuggestionAction, registerDismissSuggestionAction } from './actions/index.js';
```

Update apps/slack-backend/src/app.ts:

```typescript
import { App } from '@slack/bolt';
import { env } from './env.js';
import { installationStore } from './oauth/installation-store.js';
import { errorHandler } from './middleware/error-handler.js';
import {
  healthRoutes,
  logHealthEndpointsRegistered,
  registerAppMentionHandler,
  registerMessageReplyHandler,
  registerWatchCommands,
  registerHelpMeRespondShortcut,
  registerCopySuggestionAction,
  registerDismissSuggestionAction,
} from './handlers/index.js';

/**
 * Slack Bolt app with OAuth configuration and health endpoints.
 */
export const app = new App({
  signingSecret: env.SLACK_SIGNING_SECRET,
  clientId: env.SLACK_CLIENT_ID,
  clientSecret: env.SLACK_CLIENT_SECRET,
  stateSecret: env.SLACK_STATE_SECRET,
  installationStore,
  scopes: [
    'channels:history',
    'channels:read',
    'chat:write',
    'users:read',
    'app_mentions:read',
    'commands',
  ],
  installerOptions: {
    directInstall: true,
  },
  customRoutes: healthRoutes,
});

// Register global error handler
app.error(errorHandler);

// Register event handlers
registerAppMentionHandler(app);
registerMessageReplyHandler(app);

// Register slash commands
registerWatchCommands(app);

// Register message shortcuts
registerHelpMeRespondShortcut(app);

// Register action handlers
registerCopySuggestionAction(app);
registerDismissSuggestionAction(app);

// Log health endpoints registration
logHealthEndpointsRegistered();
```

Implementation notes:
- Copy button shows suggestion in code block for easy selection
- Triple-click to select all text in code block
- Dismiss button removes ephemeral message
- Use respond() with replace_original to update ephemeral messages
- delete_original: true removes the message entirely
  </action>
  <verify>
Run `npm run build --workspaces --if-present` - TypeScript compiles without errors.
Verify action handlers: `grep "app.action" apps/slack-backend/src/handlers/actions/*.ts`
Verify registration: `grep "registerCopySuggestionAction\|registerDismissSuggestionAction\|registerHelpMeRespondShortcut" apps/slack-backend/src/app.ts`
  </verify>
  <done>
copy-suggestion.ts shows text in copyable format with instructions.
dismiss-suggestion.ts removes the ephemeral message.
help-me-respond.ts triggers AI suggestion from message context menu.
All handlers registered in app.ts.
TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. Run `npm run build --workspaces --if-present` - all packages compile
2. Verify shortcut handler: `grep "app.shortcut" apps/slack-backend/src/handlers/shortcuts/help-me-respond.ts`
3. Verify action handlers: `grep "app.action" apps/slack-backend/src/handlers/actions/*.ts`
4. Verify all registrations in app.ts: `grep "register.*Shortcut\|register.*Action" apps/slack-backend/src/app.ts`
</verification>

<success_criteria>
- "Help me respond" shortcut queues AI suggestion job
- Immediate acknowledgment sent to user
- Copy button displays suggestion in copyable format
- Dismiss button removes ephemeral message
- All handlers registered with Bolt app
- All code compiles without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-slack-response-suggestions/02-07-SUMMARY.md`
</output>
