---
phase: 02-core-slack-response-suggestions
plan: 08
type: execute
wave: 3
depends_on: ["02-06"]
files_modified:
  - apps/slack-backend/src/handlers/actions/refine-suggestion.ts
  - apps/slack-backend/src/handlers/views/refinement-modal.ts
  - apps/slack-backend/src/handlers/views/index.ts
  - apps/slack-backend/src/handlers/actions/index.ts
  - apps/slack-backend/src/handlers/index.ts
  - apps/slack-backend/src/app.ts
autonomous: true

must_haves:
  truths:
    - "User can click 'Refine' to open modal with current suggestion"
    - "Modal allows user to request refinements"
    - "AI generates updated suggestion based on feedback"
    - "Modal shows updated suggestion after refinement"
  artifacts:
    - path: "apps/slack-backend/src/handlers/actions/refine-suggestion.ts"
      provides: "Refine button handler that opens modal"
      contains: "views.open"
    - path: "apps/slack-backend/src/handlers/views/refinement-modal.ts"
      provides: "Modal submission and refinement logic"
      contains: "app.view"
  key_links:
    - from: "apps/slack-backend/src/handlers/actions/refine-suggestion.ts"
      to: "@slack/web-api"
      via: "views.open"
      pattern: "views\\.open"
    - from: "apps/slack-backend/src/handlers/views/refinement-modal.ts"
      to: "apps/slack-backend/src/services/ai.ts"
      via: "AI refinement call"
      pattern: "generateSuggestion|refine"
---

<objective>
Implement the refinement modal for multi-turn conversation with AI to adjust suggestions.

Purpose: Users often need to tweak suggestions - make them more direct, softer, shorter, etc. The modal provides a structured interface for back-and-forth refinement.

Output: Refine button handler that opens modal, modal view with suggestion and input, submission handler that generates refined suggestion and updates modal.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-slack-response-suggestions/02-RESEARCH.md

@apps/slack-backend/src/app.ts
@apps/slack-backend/src/services/ai.ts
@.planning/phases/02-core-slack-response-suggestions/02-06-PLAN.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AI refinement service function</name>
  <files>
    apps/slack-backend/src/services/ai.ts
  </files>
  <action>
Add refinement function to apps/slack-backend/src/services/ai.ts:

```typescript
// Add this interface for refinement context
interface RefinementContext {
  originalSuggestion: string;
  refinementHistory: Array<{
    request: string;
    suggestion: string;
  }>;
  newRequest: string;
}

/**
 * Refine an existing suggestion based on user feedback.
 * Maintains conversation history for multi-turn refinement.
 */
export async function refineSuggestion(
  context: RefinementContext
): Promise<SuggestionResult> {
  const startTime = Date.now();

  // Build conversation history for AI
  const historyMessages = context.refinementHistory.flatMap((turn) => [
    {
      role: 'user' as const,
      content: `Original suggestion: "${turn.suggestion}"\n\nRefinement request: ${turn.request}`,
    },
    {
      role: 'assistant' as const,
      content: turn.suggestion,
    },
  ]);

  const systemPrompt = `You are helping refine a workplace response suggestion. The user has received an initial suggestion and wants to adjust it.

Your job is to:
1. Take the current suggestion and the user's refinement request
2. Generate an updated suggestion that addresses their feedback
3. Maintain the professional tone while incorporating their requested changes

Only output the refined suggestion text, no commentary or explanations.`;

  const userPrompt = `Current suggestion:
"${context.originalSuggestion}"

User's refinement request:
${prepareForAI(context.newRequest)}

Please provide a refined version of the suggestion that addresses the user's feedback.`;

  try {
    const response = await anthropic.messages.create({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 1024,
      system: systemPrompt,
      messages: [
        ...historyMessages,
        {
          role: 'user',
          content: userPrompt,
        },
      ],
    });

    const rawSuggestion = response.content[0].type === 'text'
      ? response.content[0].text
      : '';

    const suggestion = sanitizeAIOutput(rawSuggestion);
    const processingTimeMs = Date.now() - startTime;

    logger.info({
      processingTimeMs,
      inputTokens: response.usage.input_tokens,
      outputTokens: response.usage.output_tokens,
      refinementRound: context.refinementHistory.length + 1,
    }, 'AI suggestion refined');

    return {
      suggestion,
      processingTimeMs,
    };
  } catch (error) {
    logger.error({ error }, 'Failed to refine AI suggestion');
    throw error;
  }
}
```

Update the exports in apps/slack-backend/src/services/index.ts to include refineSuggestion:

```typescript
export { generateSuggestion, refineSuggestion } from './ai.js';
```

Implementation notes:
- Takes original suggestion and refinement request
- Supports multi-turn history for progressive refinement
- Uses same model as initial generation
- Sanitizes input/output as usual
- Logs refinement round number for analytics
  </action>
  <verify>
Run `npm run build --workspaces --if-present` - TypeScript compiles without errors.
Verify export: `grep "refineSuggestion" apps/slack-backend/src/services/ai.ts`
  </verify>
  <done>
refineSuggestion function added to ai.ts.
Supports multi-turn refinement history.
TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Refine button handler and refinement modal</name>
  <files>
    apps/slack-backend/src/handlers/actions/refine-suggestion.ts
    apps/slack-backend/src/handlers/views/refinement-modal.ts
    apps/slack-backend/src/handlers/views/index.ts
    apps/slack-backend/src/handlers/actions/index.ts
    apps/slack-backend/src/handlers/index.ts
    apps/slack-backend/src/app.ts
  </files>
  <action>
Create apps/slack-backend/src/handlers/actions/refine-suggestion.ts:

```typescript
import type { App, BlockAction } from '@slack/bolt';
import { logger } from '../../utils/logger.js';

interface RefineButtonValue {
  suggestionId: string;
  suggestion: string;
  originalMessageTs: string;
}

/**
 * Handle "Refine" button click.
 * Opens a modal for the user to request refinements.
 */
export function registerRefineSuggestionAction(app: App): void {
  app.action('refine_suggestion', async ({ ack, body, client }) => {
    await ack();

    const actionBody = body as BlockAction;

    // Get trigger_id for opening modal (required)
    const triggerId = actionBody.trigger_id;
    if (!triggerId) {
      logger.warn({ body }, 'No trigger_id available for modal');
      return;
    }

    // Extract data from button value
    const value = actionBody.actions[0]?.type === 'button'
      ? (actionBody.actions[0] as { value?: string }).value
      : undefined;

    if (!value) {
      logger.warn({ body }, 'Refine action missing value');
      return;
    }

    try {
      const { suggestionId, suggestion, originalMessageTs }: RefineButtonValue = JSON.parse(value);

      logger.info({
        suggestionId,
        userId: actionBody.user.id,
      }, 'Opening refinement modal');

      // Store state in private_metadata (3000 char limit)
      const privateMetadata = JSON.stringify({
        suggestionId,
        originalSuggestion: suggestion,
        originalMessageTs,
        refinementHistory: [] as Array<{ request: string; suggestion: string }>,
      });

      await client.views.open({
        trigger_id: triggerId,
        view: {
          type: 'modal',
          callback_id: 'refinement_modal',
          private_metadata: privateMetadata,
          title: {
            type: 'plain_text',
            text: 'Refine Suggestion',
          },
          submit: {
            type: 'plain_text',
            text: 'Refine',
          },
          close: {
            type: 'plain_text',
            text: 'Done',
          },
          blocks: [
            {
              type: 'section',
              text: {
                type: 'mrkdwn',
                text: '*Current suggestion:*',
              },
            },
            {
              type: 'section',
              block_id: 'current_suggestion',
              text: {
                type: 'mrkdwn',
                text: `>${suggestion.split('\n').join('\n>')}`,
              },
            },
            {
              type: 'divider',
            },
            {
              type: 'input',
              block_id: 'refinement_input',
              element: {
                type: 'plain_text_input',
                action_id: 'refinement_text',
                multiline: true,
                placeholder: {
                  type: 'plain_text',
                  text: 'How should I adjust this? e.g., "Make it shorter", "More direct", "Add acknowledgment of their concerns"',
                },
              },
              label: {
                type: 'plain_text',
                text: 'What would you like to change?',
              },
            },
            {
              type: 'context',
              elements: [
                {
                  type: 'mrkdwn',
                  text: '_Tip: Be specific about what you want changed. You can refine multiple times._',
                },
              ],
            },
          ],
        },
      });
    } catch (error) {
      logger.error({ error }, 'Error opening refinement modal');
    }
  });
}
```

Create apps/slack-backend/src/handlers/views/ directory.

Create apps/slack-backend/src/handlers/views/refinement-modal.ts:

```typescript
import type { App, ViewSubmitAction, ViewStateValue } from '@slack/bolt';
import { refineSuggestion } from '../../services/index.js';
import { logger } from '../../utils/logger.js';

interface RefinementMetadata {
  suggestionId: string;
  originalSuggestion: string;
  originalMessageTs: string;
  refinementHistory: Array<{ request: string; suggestion: string }>;
}

/**
 * Handle refinement modal submission.
 * Generates refined suggestion and updates the modal with the result.
 */
export function registerRefinementModalHandler(app: App): void {
  app.view('refinement_modal', async ({ ack, body, view, client }) => {
    // Parse metadata
    const metadata: RefinementMetadata = JSON.parse(view.private_metadata);
    const userId = body.user.id;

    // Get refinement request from input
    const refinementText = view.state.values.refinement_input?.refinement_text?.value;

    if (!refinementText) {
      await ack({
        response_action: 'errors',
        errors: {
          refinement_input: 'Please enter what you would like to change.',
        },
      });
      return;
    }

    logger.info({
      suggestionId: metadata.suggestionId,
      userId,
      refinementRound: metadata.refinementHistory.length + 1,
    }, 'Processing refinement request');

    // Acknowledge with update response action
    await ack({
      response_action: 'update',
      view: {
        type: 'modal',
        callback_id: 'refinement_modal',
        private_metadata: view.private_metadata, // Keep same metadata for now
        title: {
          type: 'plain_text',
          text: 'Refining...',
        },
        close: {
          type: 'plain_text',
          text: 'Cancel',
        },
        blocks: [
          {
            type: 'section',
            text: {
              type: 'mrkdwn',
              text: '_Generating refined suggestion..._',
            },
          },
        ],
      },
    });

    try {
      // Get the most recent suggestion (either original or last refinement)
      const currentSuggestion = metadata.refinementHistory.length > 0
        ? metadata.refinementHistory[metadata.refinementHistory.length - 1].suggestion
        : metadata.originalSuggestion;

      // Generate refined suggestion
      const result = await refineSuggestion({
        originalSuggestion: currentSuggestion,
        refinementHistory: metadata.refinementHistory,
        newRequest: refinementText,
      });

      // Update history
      const newHistory = [
        ...metadata.refinementHistory,
        { request: refinementText, suggestion: result.suggestion },
      ];

      // Build new metadata
      const newMetadata: RefinementMetadata = {
        ...metadata,
        refinementHistory: newHistory,
      };

      // Truncate history if private_metadata is getting too long (3000 char limit)
      let metadataString = JSON.stringify(newMetadata);
      if (metadataString.length > 2800) {
        // Keep only last 2 refinements
        newMetadata.refinementHistory = newHistory.slice(-2);
        metadataString = JSON.stringify(newMetadata);
      }

      // Update modal with refined suggestion
      await client.views.update({
        view_id: view.id,
        view: {
          type: 'modal',
          callback_id: 'refinement_modal',
          private_metadata: metadataString,
          title: {
            type: 'plain_text',
            text: 'Refine Suggestion',
          },
          submit: {
            type: 'plain_text',
            text: 'Refine More',
          },
          close: {
            type: 'plain_text',
            text: 'Done',
          },
          blocks: [
            {
              type: 'section',
              text: {
                type: 'mrkdwn',
                text: '*Refined suggestion:*',
              },
            },
            {
              type: 'section',
              block_id: 'current_suggestion',
              text: {
                type: 'mrkdwn',
                text: `>${result.suggestion.split('\n').join('\n>')}`,
              },
            },
            {
              type: 'divider',
            },
            {
              type: 'actions',
              block_id: 'suggestion_actions',
              elements: [
                {
                  type: 'button',
                  text: {
                    type: 'plain_text',
                    text: 'Copy Final',
                    emoji: true,
                  },
                  action_id: 'copy_final_suggestion',
                  value: JSON.stringify({
                    suggestionId: metadata.suggestionId,
                    suggestion: result.suggestion,
                  }),
                  style: 'primary',
                },
              ],
            },
            {
              type: 'divider',
            },
            {
              type: 'input',
              block_id: 'refinement_input',
              element: {
                type: 'plain_text_input',
                action_id: 'refinement_text',
                multiline: true,
                placeholder: {
                  type: 'plain_text',
                  text: 'Need more changes? Describe what to adjust.',
                },
              },
              label: {
                type: 'plain_text',
                text: 'Continue refining (optional)',
              },
              optional: true,
            },
            {
              type: 'context',
              elements: [
                {
                  type: 'mrkdwn',
                  text: `_Refinements: ${newMetadata.refinementHistory.length} | Click "Copy Final" when satisfied, or refine more._`,
                },
              ],
            },
          ],
        },
      });

      logger.info({
        suggestionId: metadata.suggestionId,
        refinements: newMetadata.refinementHistory.length,
        processingTimeMs: result.processingTimeMs,
      }, 'Refinement modal updated');
    } catch (error) {
      logger.error({ error, suggestionId: metadata.suggestionId }, 'Error refining suggestion');

      // Update modal with error
      await client.views.update({
        view_id: view.id,
        view: {
          type: 'modal',
          callback_id: 'refinement_modal',
          private_metadata: view.private_metadata,
          title: {
            type: 'plain_text',
            text: 'Error',
          },
          close: {
            type: 'plain_text',
            text: 'Close',
          },
          blocks: [
            {
              type: 'section',
              text: {
                type: 'mrkdwn',
                text: 'Sorry, something went wrong while refining. Please close and try again.',
              },
            },
          ],
        },
      });
    }
  });
}
```

Create apps/slack-backend/src/handlers/views/index.ts:

```typescript
export { registerRefinementModalHandler } from './refinement-modal.js';
```

Add copy_final_suggestion handler to copy-suggestion.ts (append to existing file):

```typescript
// Add this to the end of copy-suggestion.ts

/**
 * Handle "Copy Final" button click in refinement modal.
 * Shows the final suggestion in copyable format and closes modal.
 */
export function registerCopyFinalSuggestionAction(app: App): void {
  app.action('copy_final_suggestion', async ({ ack, body, respond, client }) => {
    await ack();

    const actionBody = body as { actions: Array<{ value?: string }>; trigger_id?: string; view?: { id: string } };
    const value = actionBody.actions[0]?.value;

    if (!value) {
      logger.warn({ body }, 'Copy final action missing value');
      return;
    }

    try {
      const { suggestionId, suggestion } = JSON.parse(value);

      logger.info({
        suggestionId,
        userId: 'user' in body ? body.user.id : 'unknown',
      }, 'Copy final button clicked');

      // Close the modal and show copy view
      if (actionBody.view?.id) {
        await client.views.update({
          view_id: actionBody.view.id,
          view: {
            type: 'modal',
            callback_id: 'copy_view',
            title: {
              type: 'plain_text',
              text: 'Copy Response',
            },
            close: {
              type: 'plain_text',
              text: 'Done',
            },
            blocks: [
              {
                type: 'header',
                text: {
                  type: 'plain_text',
                  text: 'Copy This Response',
                  emoji: true,
                },
              },
              {
                type: 'section',
                text: {
                  type: 'mrkdwn',
                  text: '*Select and copy the text below:*',
                },
              },
              {
                type: 'divider',
              },
              {
                type: 'section',
                text: {
                  type: 'mrkdwn',
                  text: `\`\`\`${suggestion}\`\`\``,
                },
              },
              {
                type: 'context',
                elements: [
                  {
                    type: 'mrkdwn',
                    text: '_Triple-click to select all, then Cmd+C (Mac) or Ctrl+C (Windows) to copy._',
                  },
                ],
              },
            ],
          },
        });
      }
    } catch (error) {
      logger.error({ error }, 'Error handling copy final action');
    }
  });
}
```

Update apps/slack-backend/src/handlers/actions/index.ts:

```typescript
export { registerCopySuggestionAction, registerCopyFinalSuggestionAction } from './copy-suggestion.js';
export { registerDismissSuggestionAction } from './dismiss-suggestion.js';
export { registerRefineSuggestionAction } from './refine-suggestion.js';
```

Update apps/slack-backend/src/handlers/index.ts:

```typescript
export { healthRoutes, logHealthEndpointsRegistered } from './health.js';
export { registerAppMentionHandler, registerMessageReplyHandler } from './events/index.js';
export { registerWatchCommands } from './commands/index.js';
export { registerHelpMeRespondShortcut } from './shortcuts/index.js';
export {
  registerCopySuggestionAction,
  registerCopyFinalSuggestionAction,
  registerDismissSuggestionAction,
  registerRefineSuggestionAction,
} from './actions/index.js';
export { registerRefinementModalHandler } from './views/index.js';
```

Update apps/slack-backend/src/app.ts:

```typescript
import { App } from '@slack/bolt';
import { env } from './env.js';
import { installationStore } from './oauth/installation-store.js';
import { errorHandler } from './middleware/error-handler.js';
import {
  healthRoutes,
  logHealthEndpointsRegistered,
  registerAppMentionHandler,
  registerMessageReplyHandler,
  registerWatchCommands,
  registerHelpMeRespondShortcut,
  registerCopySuggestionAction,
  registerCopyFinalSuggestionAction,
  registerDismissSuggestionAction,
  registerRefineSuggestionAction,
  registerRefinementModalHandler,
} from './handlers/index.js';

/**
 * Slack Bolt app with OAuth configuration and health endpoints.
 */
export const app = new App({
  signingSecret: env.SLACK_SIGNING_SECRET,
  clientId: env.SLACK_CLIENT_ID,
  clientSecret: env.SLACK_CLIENT_SECRET,
  stateSecret: env.SLACK_STATE_SECRET,
  installationStore,
  scopes: [
    'channels:history',
    'channels:read',
    'chat:write',
    'users:read',
    'app_mentions:read',
    'commands',
  ],
  installerOptions: {
    directInstall: true,
  },
  customRoutes: healthRoutes,
});

// Register global error handler
app.error(errorHandler);

// Register event handlers
registerAppMentionHandler(app);
registerMessageReplyHandler(app);

// Register slash commands
registerWatchCommands(app);

// Register message shortcuts
registerHelpMeRespondShortcut(app);

// Register action handlers
registerCopySuggestionAction(app);
registerCopyFinalSuggestionAction(app);
registerDismissSuggestionAction(app);
registerRefineSuggestionAction(app);

// Register view handlers
registerRefinementModalHandler(app);

// Log health endpoints registration
logHealthEndpointsRegistered();
```

Implementation notes:
- Modal stores state in private_metadata (up to 3000 chars)
- Refinement history maintained for context
- History truncated if approaching limit
- "Refine More" allows multiple rounds
- "Copy Final" presents text in copyable format
- Loading state shown during AI processing
  </action>
  <verify>
Run `npm run build --workspaces --if-present` - TypeScript compiles without errors.
Verify refine action: `grep "app.action.*refine_suggestion" apps/slack-backend/src/handlers/actions/refine-suggestion.ts`
Verify modal handler: `grep "app.view.*refinement_modal" apps/slack-backend/src/handlers/views/refinement-modal.ts`
Verify registration: `grep "registerRefineSuggestionAction\|registerRefinementModalHandler" apps/slack-backend/src/app.ts`
  </verify>
  <done>
refine-suggestion.ts opens modal with current suggestion.
refinement-modal.ts handles submission and calls AI for refinement.
Modal updates with refined suggestion.
Multi-turn refinement supported with history.
Copy Final button shows copyable text.
All handlers registered in app.ts.
TypeScript compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. Run `npm run build --workspaces --if-present` - all packages compile
2. Verify AI refinement: `grep "refineSuggestion" apps/slack-backend/src/services/ai.ts`
3. Verify refine action: `grep "app.action" apps/slack-backend/src/handlers/actions/refine-suggestion.ts`
4. Verify modal handler: `grep "app.view" apps/slack-backend/src/handlers/views/refinement-modal.ts`
5. Verify all registrations: `grep "register.*Action\|register.*Modal" apps/slack-backend/src/app.ts`
</verification>

<success_criteria>
- Refine button opens modal with current suggestion
- Modal has input for refinement request
- AI generates refined suggestion
- Modal updates with new suggestion
- Multi-turn refinement supported
- "Copy Final" presents text for copying
- History truncated to fit private_metadata limit
- All code compiles without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-slack-response-suggestions/02-08-SUMMARY.md`
</output>
