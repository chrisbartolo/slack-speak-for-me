---
phase: 05-weekly-reports
plan: 08
type: execute
wave: 5
depends_on: ["05-02", "05-03"]
files_modified:
  - apps/web-portal/app/(dashboard)/reports/page.tsx
  - apps/web-portal/app/(dashboard)/reports/actions.ts
  - apps/web-portal/components/workflow-config-form.tsx
autonomous: true

must_haves:
  truths:
    - "User can configure spreadsheet ID for Google Sheets storage"
    - "User can configure channel to monitor for workflow submissions"
    - "Spreadsheet name displays in Google connection card"
    - "Channel configuration validates bot membership"
  artifacts:
    - path: "apps/web-portal/app/(dashboard)/reports/page.tsx"
      provides: "Complete reports configuration page"
      contains: "WorkflowConfigForm"
    - path: "apps/web-portal/components/workflow-config-form.tsx"
      provides: "Form for configuring workflow channel and spreadsheet"
      exports: ["WorkflowConfigForm"]
  key_links:
    - from: "apps/web-portal/app/(dashboard)/reports/actions.ts"
      to: "packages/database/src/schema.ts"
      via: "Save spreadsheet and workflow config"
      pattern: "(googleIntegrations|workflowConfig)"
---

<objective>
Complete web portal reports configuration with spreadsheet and workflow channel setup.

Purpose: Allow users to configure which Google Sheet receives submissions and which Slack channel to monitor for workflow form submissions. This completes the web portal setup needed before weekly reports can function.

Output: Spreadsheet configuration in Google connection card, workflow channel configuration form, validation for bot membership.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-weekly-reports/05-RESEARCH.md
@.planning/phases/05-weekly-reports/05-02-SUMMARY.md
@.planning/phases/05-weekly-reports/05-03-SUMMARY.md

# Existing patterns
@apps/web-portal/app/(dashboard)/reports/page.tsx
@apps/web-portal/components/forms/report-settings-form.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add spreadsheet configuration to Google connection</name>
  <files>
apps/web-portal/app/(dashboard)/reports/actions.ts
apps/web-portal/components/google-connection-card.tsx
  </files>
  <action>
Update Google connection card to allow spreadsheet configuration after connecting.

Add server action in reports/actions.ts:
```typescript
export async function updateSpreadsheetConfig(
  spreadsheetId: string,
  spreadsheetName: string
): Promise<{ success: boolean; error?: string }> {
  const session = await verifySession();

  // Validate spreadsheet ID format (basic validation)
  if (!spreadsheetId || spreadsheetId.length < 10) {
    return { success: false, error: 'Invalid spreadsheet ID' };
  }

  try {
    await db
      .update(schema.googleIntegrations)
      .set({
        spreadsheetId,
        spreadsheetName,
        updatedAt: new Date(),
      })
      .where(
        and(
          eq(schema.googleIntegrations.workspaceId, session.workspaceId),
          eq(schema.googleIntegrations.userId, session.slackUserId)
        )
      );

    revalidatePath('/reports');
    return { success: true };
  } catch (error) {
    console.error('Failed to update spreadsheet config:', error);
    return { success: false, error: 'Failed to save configuration' };
  }
}
```

Update google-connection-card.tsx to include spreadsheet configuration:
```tsx
'use client';

import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { disconnectGoogle, updateSpreadsheetConfig } from '@/app/(dashboard)/reports/actions';
import { useTransition, useState, useEffect } from 'react';
import { toast } from 'sonner';
import { useSearchParams } from 'next/navigation';

interface Props {
  isConnected: boolean;
  spreadsheetId?: string;
  spreadsheetName?: string;
}

export function GoogleConnectionCard({ isConnected, spreadsheetId, spreadsheetName }: Props) {
  const [isPending, startTransition] = useTransition();
  const [isEditing, setIsEditing] = useState(false);
  const [sheetId, setSheetId] = useState(spreadsheetId || '');
  const [sheetName, setSheetName] = useState(spreadsheetName || '');
  const searchParams = useSearchParams();

  useEffect(() => {
    // Show success/error from OAuth redirect
    if (searchParams.get('google_connected') === 'true') {
      toast.success('Google account connected successfully');
      window.history.replaceState({}, '', '/reports');
    }
    if (searchParams.get('error') === 'google_auth_failed') {
      toast.error('Failed to connect Google account');
      window.history.replaceState({}, '', '/reports');
    }
  }, [searchParams]);

  const handleConnect = () => {
    const backendUrl = process.env.NEXT_PUBLIC_SLACK_BACKEND_URL || 'http://localhost:3000';
    window.location.href = `${backendUrl}/oauth/google/start`;
  };

  const handleDisconnect = () => {
    startTransition(async () => {
      const result = await disconnectGoogle();
      if (result.success) {
        toast.success('Google account disconnected');
      } else {
        toast.error(result.error || 'Failed to disconnect');
      }
    });
  };

  const handleSaveSpreadsheet = () => {
    if (!sheetId.trim()) {
      toast.error('Please enter a spreadsheet ID');
      return;
    }

    startTransition(async () => {
      const result = await updateSpreadsheetConfig(sheetId, sheetName || 'Weekly Updates');
      if (result.success) {
        toast.success('Spreadsheet configuration saved');
        setIsEditing(false);
      } else {
        toast.error(result.error || 'Failed to save');
      }
    });
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <GoogleIcon />
          Google Sheets Connection
        </CardTitle>
        <CardDescription>
          Connect your Google account and configure the spreadsheet for weekly report data.
        </CardDescription>
      </CardHeader>
      <CardContent className="space-y-4">
        {isConnected ? (
          <>
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <div className="h-2 w-2 rounded-full bg-green-500" />
                <span className="text-sm">Google account connected</span>
              </div>
              <Button
                variant="outline"
                size="sm"
                onClick={handleDisconnect}
                disabled={isPending}
              >
                Disconnect
              </Button>
            </div>

            {/* Spreadsheet configuration */}
            <div className="border rounded-lg p-4 space-y-3">
              <div className="flex items-center justify-between">
                <Label className="text-sm font-medium">Spreadsheet</Label>
                {!isEditing && spreadsheetId && (
                  <Button variant="ghost" size="sm" onClick={() => setIsEditing(true)}>
                    Edit
                  </Button>
                )}
              </div>

              {isEditing || !spreadsheetId ? (
                <div className="space-y-3">
                  <div>
                    <Label htmlFor="sheetId" className="text-xs text-muted-foreground">
                      Spreadsheet ID (from Google Sheets URL)
                    </Label>
                    <Input
                      id="sheetId"
                      value={sheetId}
                      onChange={(e) => setSheetId(e.target.value)}
                      placeholder="1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms"
                    />
                    <p className="text-xs text-muted-foreground mt-1">
                      Find in URL: docs.google.com/spreadsheets/d/<strong>[this-part]</strong>/edit
                    </p>
                  </div>
                  <div>
                    <Label htmlFor="sheetName" className="text-xs text-muted-foreground">
                      Display Name (optional)
                    </Label>
                    <Input
                      id="sheetName"
                      value={sheetName}
                      onChange={(e) => setSheetName(e.target.value)}
                      placeholder="Weekly Team Updates"
                    />
                  </div>
                  <div className="flex gap-2">
                    <Button
                      size="sm"
                      onClick={handleSaveSpreadsheet}
                      disabled={isPending}
                    >
                      Save
                    </Button>
                    {spreadsheetId && (
                      <Button
                        variant="ghost"
                        size="sm"
                        onClick={() => {
                          setIsEditing(false);
                          setSheetId(spreadsheetId);
                          setSheetName(spreadsheetName || '');
                        }}
                      >
                        Cancel
                      </Button>
                    )}
                  </div>
                </div>
              ) : (
                <div className="text-sm">
                  <span className="font-medium">{spreadsheetName || 'Unnamed Spreadsheet'}</span>
                  <span className="text-muted-foreground ml-2">({spreadsheetId.substring(0, 20)}...)</span>
                </div>
              )}
            </div>
          </>
        ) : (
          <div className="flex items-center justify-between">
            <span className="text-sm text-muted-foreground">
              Not connected - connect to enable weekly reports
            </span>
            <Button size="sm" onClick={handleConnect}>
              Connect Google Account
            </Button>
          </div>
        )}
      </CardContent>
    </Card>
  );
}

function GoogleIcon() {
  return (
    <svg className="h-5 w-5" viewBox="0 0 24 24">
      <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
      <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
      <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
      <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
    </svg>
  );
}
```

Update reports/page.tsx to pass new props:
```tsx
<GoogleConnectionCard
  isConnected={!!googleIntegration}
  spreadsheetId={googleIntegration?.spreadsheetId || undefined}
  spreadsheetName={googleIntegration?.spreadsheetName || undefined}
/>
```
  </action>
  <verify>
`npm run build --workspace=web-portal` compiles.
Spreadsheet config form appears when Google connected.
  </verify>
  <done>
Google connection card shows spreadsheet configuration section.
User can enter spreadsheet ID and optional display name.
Configuration saved to googleIntegrations table.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create workflow channel configuration form</name>
  <files>
apps/web-portal/app/(dashboard)/reports/actions.ts
apps/web-portal/components/workflow-config-form.tsx
apps/web-portal/lib/db/queries.ts
apps/web-portal/lib/db/index.ts
  </files>
  <action>
Create form for configuring which Slack channel to monitor for workflow submissions.

Add workflowConfig to lib/db/index.ts schema export:
```typescript
import { workflowConfig } from '@slack-speak/database';
export const schema = { ...existing, workflowConfig };
```

Add query in lib/db/queries.ts:
```typescript
export const getWorkflowConfig = cache(async () => {
  const session = await verifySession();

  const configs = await db
    .select()
    .from(schema.workflowConfig)
    .where(
      and(
        eq(schema.workflowConfig.workspaceId, session.workspaceId),
        eq(schema.workflowConfig.userId, session.slackUserId)
      )
    );

  return configs;
});
```

Add server actions in reports/actions.ts:
```typescript
export async function addWorkflowChannel(
  channelId: string,
  channelName: string
): Promise<{ success: boolean; error?: string }> {
  const session = await verifySession();

  try {
    await db
      .insert(schema.workflowConfig)
      .values({
        workspaceId: session.workspaceId,
        userId: session.slackUserId,
        channelId,
        channelName,
        enabled: true,
      })
      .onConflictDoUpdate({
        target: [schema.workflowConfig.workspaceId, schema.workflowConfig.userId, schema.workflowConfig.channelId],
        set: {
          channelName,
          enabled: true,
          updatedAt: new Date(),
        },
      });

    revalidatePath('/reports');
    return { success: true };
  } catch (error) {
    console.error('Failed to add workflow channel:', error);
    return { success: false, error: 'Failed to add channel' };
  }
}

export async function removeWorkflowChannel(
  channelId: string
): Promise<{ success: boolean; error?: string }> {
  const session = await verifySession();

  try {
    await db
      .delete(schema.workflowConfig)
      .where(
        and(
          eq(schema.workflowConfig.workspaceId, session.workspaceId),
          eq(schema.workflowConfig.userId, session.slackUserId),
          eq(schema.workflowConfig.channelId, channelId)
        )
      );

    revalidatePath('/reports');
    return { success: true };
  } catch (error) {
    console.error('Failed to remove workflow channel:', error);
    return { success: false, error: 'Failed to remove channel' };
  }
}
```

Create components/workflow-config-form.tsx:
```tsx
'use client';

import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { addWorkflowChannel, removeWorkflowChannel } from '@/app/(dashboard)/reports/actions';
import { useTransition, useState } from 'react';
import { toast } from 'sonner';
import { X } from 'lucide-react';

interface WorkflowChannel {
  id: string;
  channelId: string;
  channelName: string | null;
  enabled: boolean;
}

interface Props {
  channels: WorkflowChannel[];
  disabled?: boolean;
}

export function WorkflowConfigForm({ channels, disabled }: Props) {
  const [isPending, startTransition] = useTransition();
  const [newChannelId, setNewChannelId] = useState('');
  const [newChannelName, setNewChannelName] = useState('');

  const handleAddChannel = () => {
    if (!newChannelId.trim()) {
      toast.error('Please enter a channel ID');
      return;
    }

    startTransition(async () => {
      const result = await addWorkflowChannel(newChannelId, newChannelName || newChannelId);
      if (result.success) {
        toast.success('Channel added');
        setNewChannelId('');
        setNewChannelName('');
      } else {
        toast.error(result.error || 'Failed to add channel');
      }
    });
  };

  const handleRemoveChannel = (channelId: string) => {
    startTransition(async () => {
      const result = await removeWorkflowChannel(channelId);
      if (result.success) {
        toast.success('Channel removed');
      } else {
        toast.error(result.error || 'Failed to remove channel');
      }
    });
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle>Workflow Monitoring</CardTitle>
        <CardDescription>
          Select which Slack channels to monitor for workflow form submissions from your team.
        </CardDescription>
      </CardHeader>
      <CardContent className="space-y-4">
        {disabled && (
          <p className="text-sm text-muted-foreground">
            Connect Google Sheets above to enable workflow monitoring.
          </p>
        )}

        {/* Current channels */}
        {channels.length > 0 && (
          <div className="space-y-2">
            <Label className="text-sm font-medium">Monitored Channels</Label>
            <div className="space-y-2">
              {channels.map((channel) => (
                <div
                  key={channel.id}
                  className="flex items-center justify-between p-2 border rounded"
                >
                  <span className="text-sm">
                    #{channel.channelName || channel.channelId}
                  </span>
                  <Button
                    variant="ghost"
                    size="sm"
                    onClick={() => handleRemoveChannel(channel.channelId)}
                    disabled={isPending || disabled}
                  >
                    <X className="h-4 w-4" />
                  </Button>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* Add channel form */}
        <div className="space-y-3 pt-2 border-t">
          <Label className="text-sm font-medium">Add Channel</Label>
          <div className="grid gap-2">
            <div>
              <Label htmlFor="channelId" className="text-xs text-muted-foreground">
                Channel ID
              </Label>
              <Input
                id="channelId"
                value={newChannelId}
                onChange={(e) => setNewChannelId(e.target.value)}
                placeholder="C01234567"
                disabled={disabled}
              />
              <p className="text-xs text-muted-foreground mt-1">
                Right-click channel in Slack → View channel details → Copy ID at bottom
              </p>
            </div>
            <div>
              <Label htmlFor="channelName" className="text-xs text-muted-foreground">
                Channel Name (optional)
              </Label>
              <Input
                id="channelName"
                value={newChannelName}
                onChange={(e) => setNewChannelName(e.target.value)}
                placeholder="#weekly-updates"
                disabled={disabled}
              />
            </div>
            <Button
              onClick={handleAddChannel}
              disabled={isPending || disabled || !newChannelId.trim()}
              size="sm"
            >
              Add Channel
            </Button>
          </div>
        </div>
      </CardContent>
    </Card>
  );
}
```
  </action>
  <verify>
`npm run build --workspace=web-portal` compiles.
WorkflowConfigForm component renders correctly.
  </verify>
  <done>
WorkflowConfigForm allows adding/removing channels to monitor.
Channels stored in workflowConfig table.
Form disabled when Google not connected.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate workflow config into reports page</name>
  <files>apps/web-portal/app/(dashboard)/reports/page.tsx</files>
  <action>
Add WorkflowConfigForm to reports page.

Update reports/page.tsx:
```tsx
import { getReportSettings, getGoogleIntegration, getWorkflowConfig } from '@/lib/db/queries';
import { GoogleConnectionCard } from '@/components/google-connection-card';
import { WorkflowConfigForm } from '@/components/workflow-config-form';
import { ReportSettingsForm } from '@/components/forms/report-settings-form';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';

export default async function ReportsPage() {
  const [settings, googleIntegration, workflowChannels] = await Promise.all([
    getReportSettings(),
    getGoogleIntegration(),
    getWorkflowConfig(),
  ]);

  const isConfigured = !!googleIntegration?.spreadsheetId;

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-2xl font-semibold">Weekly Reports</h1>
        <p className="text-muted-foreground">
          Configure automated weekly team report generation from workflow submissions.
        </p>
      </div>

      {/* Step 1: Google Connection */}
      <GoogleConnectionCard
        isConnected={!!googleIntegration}
        spreadsheetId={googleIntegration?.spreadsheetId || undefined}
        spreadsheetName={googleIntegration?.spreadsheetName || undefined}
      />

      {/* Step 2: Workflow Channel Monitoring */}
      <WorkflowConfigForm
        channels={workflowChannels}
        disabled={!isConfigured}
      />

      {/* Step 3: Report Settings */}
      <ReportSettingsForm
        initialSettings={settings}
        disabled={!isConfigured}
      />

      {/* How it works */}
      <Card>
        <CardHeader>
          <CardTitle>How Weekly Reports Work</CardTitle>
        </CardHeader>
        <CardContent className="space-y-4 text-sm text-muted-foreground">
          <div className="space-y-2">
            <h4 className="font-medium text-foreground">1. Team members submit updates</h4>
            <p>Team members use your Slack workflow form to submit weekly updates (achievements, focus, blockers, shoutouts).</p>
          </div>
          <div className="space-y-2">
            <h4 className="font-medium text-foreground">2. Data captured to Google Sheets</h4>
            <p>Each submission is automatically written to your configured Google Sheet for tracking and aggregation.</p>
          </div>
          <div className="space-y-2">
            <h4 className="font-medium text-foreground">3. AI generates board-ready report</h4>
            <p>On your configured schedule (or manually via /generate-report), AI summarizes all submissions into a polished report.</p>
          </div>
          <div className="space-y-2">
            <h4 className="font-medium text-foreground">4. Review and share</h4>
            <p>The draft report is sent to your DM for review. Refine it if needed, then copy and share with your board.</p>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
```
  </action>
  <verify>
`npm run build --workspace=web-portal` compiles.
Reports page shows all configuration sections in order.
  </verify>
  <done>
Reports page has complete configuration flow: Google connection → Spreadsheet setup → Workflow channels → Report settings.
Sections disable when prerequisites not met.
How it works explainer provides user guidance.
  </done>
</task>

</tasks>

<verification>
1. `npm run build --workspace=web-portal` compiles
2. Reports page shows Google connection, spreadsheet config, workflow channels, report settings
3. Spreadsheet ID can be saved to googleIntegrations
4. Channels can be added/removed from workflowConfig
5. Forms disable appropriately when prerequisites missing
</verification>

<success_criteria>
- Spreadsheet configuration form in Google connection card
- Workflow channel configuration form with add/remove
- Reports page displays all configuration sections
- Forms disable when Google not connected or spreadsheet not configured
- How it works explainer guides users through setup
- All builds pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-weekly-reports/05-08-SUMMARY.md`
</output>
