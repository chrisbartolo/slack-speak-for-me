---
phase: 05-weekly-reports
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/src/schema.ts
  - apps/slack-backend/src/oauth/google-oauth.ts
  - apps/slack-backend/src/env.ts
autonomous: true
user_setup:
  - service: google-cloud
    why: "Google Sheets API access for reading/writing team report data"
    env_vars:
      - name: GOOGLE_CLIENT_ID
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client IDs"
      - name: GOOGLE_CLIENT_SECRET
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client IDs"
    dashboard_config:
      - task: "Create OAuth 2.0 Client ID (Web application type)"
        location: "Google Cloud Console -> APIs & Services -> Credentials -> Create Credentials"
      - task: "Add authorized redirect URI: http://localhost:3000/oauth/google/callback"
        location: "Google Cloud Console -> APIs & Services -> Credentials -> Edit OAuth Client"
      - task: "Enable Google Sheets API"
        location: "Google Cloud Console -> APIs & Services -> Library -> Search 'Google Sheets API' -> Enable"

must_haves:
  truths:
    - "Google OAuth tokens can be encrypted and stored in database"
    - "Google tokens can be retrieved and decrypted for API calls"
    - "Token refresh is handled automatically by oauth2Client"
  artifacts:
    - path: "packages/database/src/schema.ts"
      provides: "googleIntegrations table schema"
      contains: "googleIntegrations"
    - path: "apps/slack-backend/src/oauth/google-oauth.ts"
      provides: "Google OAuth service with token management"
      exports: ["getGoogleAuthUrl", "handleGoogleCallback", "getGoogleClient", "refreshGoogleTokens"]
    - path: "apps/slack-backend/src/env.ts"
      provides: "Google OAuth environment variables"
      contains: "GOOGLE_CLIENT_ID"
  key_links:
    - from: "apps/slack-backend/src/oauth/google-oauth.ts"
      to: "packages/database/src/schema.ts"
      via: "database insert/query for googleIntegrations"
      pattern: "db\\.(insert|select).*googleIntegrations"
    - from: "apps/slack-backend/src/oauth/google-oauth.ts"
      to: "@slack-speak/database encrypt/decrypt"
      via: "token encryption before storage"
      pattern: "encrypt\\(.*token"
---

<objective>
Create database schema for Google OAuth tokens and implement Google OAuth service for Sheets access.

Purpose: Enable users to connect their Google account for Google Sheets read/write access. This is the foundation for all weekly report features - monitoring submissions, writing to sheets, and reading aggregated data.

Output: googleIntegrations table in database, Google OAuth service with auth URL generation, callback handling, token refresh, and client retrieval.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-weekly-reports/05-RESEARCH.md

# Key existing patterns
@packages/database/src/schema.ts
@apps/slack-backend/src/oauth/installation-store.ts
@apps/slack-backend/src/env.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add googleIntegrations table to database schema</name>
  <files>packages/database/src/schema.ts</files>
  <action>
Add googleIntegrations table to store encrypted Google OAuth tokens. Follow the same patterns used in existing tables (uuid primary key, workspaceId reference, timestamp fields).

Table definition:
```typescript
export const googleIntegrations = pgTable('google_integrations', {
  id: uuid('id').primaryKey().defaultRandom(),
  workspaceId: uuid('workspace_id').notNull().references(() => workspaces.id),
  userId: text('user_id').notNull(), // Slack user ID
  accessToken: text('access_token').notNull(), // Encrypted
  refreshToken: text('refresh_token'), // Encrypted, nullable (may not always be returned)
  expiresAt: timestamp('expires_at'), // When access token expires
  scope: text('scope'), // Granted scopes
  spreadsheetId: text('spreadsheet_id'), // User's configured spreadsheet
  spreadsheetName: text('spreadsheet_name'), // Display name for UI
  createdAt: timestamp('created_at').defaultNow(),
  updatedAt: timestamp('updated_at').defaultNow(),
}, (table) => ({
  uniqueIntegration: uniqueIndex('google_integrations_unique_idx').on(table.workspaceId, table.userId),
}));
```

Run `npm run db:push --workspace=@slack-speak/database` to apply schema.
  </action>
  <verify>
Run `npm run db:push --workspace=@slack-speak/database` succeeds.
Run `npm run build --workspace=@slack-speak/database` succeeds.
Table can be imported: `import { googleIntegrations } from '@slack-speak/database'`
  </verify>
  <done>
googleIntegrations table exists in schema with encrypted token columns, workspace/user foreign key, spreadsheet config, and unique constraint on (workspaceId, userId).
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Google OAuth environment variables</name>
  <files>apps/slack-backend/src/env.ts</files>
  <action>
Add Google OAuth configuration to the environment validation. Follow the existing Zod schema pattern.

Add to envSchema:
```typescript
GOOGLE_CLIENT_ID: z.string().min(1, 'GOOGLE_CLIENT_ID is required'),
GOOGLE_CLIENT_SECRET: z.string().min(1, 'GOOGLE_CLIENT_SECRET is required'),
GOOGLE_REDIRECT_URI: z.string().url().default('http://localhost:3000/oauth/google/callback'),
```

Add getter functions following existing patterns:
```typescript
export function getGoogleClientId(): string {
  return env.GOOGLE_CLIENT_ID;
}

export function getGoogleClientSecret(): string {
  return env.GOOGLE_CLIENT_SECRET;
}

export function getGoogleRedirectUri(): string {
  return env.GOOGLE_REDIRECT_URI;
}
```

Update .env.example if it exists to include placeholder values.
  </action>
  <verify>
`npm run build --workspace=slack-backend` compiles without errors.
Environment variables are exported and accessible.
  </verify>
  <done>
Google OAuth environment variables (GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET, GOOGLE_REDIRECT_URI) are validated via Zod and have getter functions.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Google OAuth service</name>
  <files>apps/slack-backend/src/oauth/google-oauth.ts</files>
  <action>
Create Google OAuth service following patterns from installation-store.ts. Use googleapis library (install: `npm install googleapis --workspace=slack-backend`).

Service should export:
1. `getGoogleAuthUrl(workspaceId: string, userId: string)` - Generate OAuth consent URL with state parameter
2. `handleGoogleCallback(code: string, state: string)` - Exchange code for tokens, encrypt, store in DB
3. `getGoogleClient(workspaceId: string, userId: string)` - Get authenticated OAuth2Client for API calls
4. `refreshGoogleTokens(workspaceId: string, userId: string)` - Force token refresh and update DB
5. `revokeGoogleAccess(workspaceId: string, userId: string)` - Remove stored tokens

Key implementation details:
- Use `google.auth.OAuth2` from googleapis
- Scope: `https://www.googleapis.com/auth/spreadsheets` (read/write)
- State parameter: JSON.stringify({ workspaceId, userId }) encoded as base64
- Token encryption: Use existing `encrypt`/`decrypt` from @slack-speak/database
- Access type: 'offline' to get refresh token
- Prompt: 'consent' to force consent screen and ensure refresh token

Token refresh handling:
```typescript
oauth2Client.on('tokens', async (tokens) => {
  // Update stored tokens when auto-refreshed
  if (tokens.access_token) {
    await updateStoredTokens(workspaceId, userId, tokens);
  }
});
```

Error handling: Throw typed errors for missing integration, expired tokens, revoked access.
  </action>
  <verify>
`npm run build --workspace=slack-backend` compiles without errors.
Service exports all 5 functions.
Auth URL includes correct scope and redirect URI.
  </verify>
  <done>
Google OAuth service handles full OAuth flow: URL generation, callback processing, token encryption/storage, client retrieval with auto-refresh, and access revocation.
  </done>
</task>

</tasks>

<verification>
1. Database schema compiles and can be pushed: `npm run db:push --workspace=@slack-speak/database`
2. Slack-backend builds: `npm run build --workspace=slack-backend`
3. Google OAuth service exports correct functions
4. Token encryption uses existing AES-256-GCM pattern from installation-store.ts
</verification>

<success_criteria>
- googleIntegrations table in schema with encrypted token storage
- Environment validation for GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET, GOOGLE_REDIRECT_URI
- Google OAuth service with auth URL, callback, client retrieval, refresh, and revocation
- Follows existing patterns from installation-store.ts for encryption
- All packages build without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-weekly-reports/05-01-SUMMARY.md`
</output>
