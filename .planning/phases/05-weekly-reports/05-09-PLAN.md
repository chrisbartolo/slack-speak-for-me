---
phase: 05-weekly-reports
plan: 09
type: execute
wave: 6
depends_on: ["05-06", "05-07", "05-08"]
files_modified:
  - apps/slack-backend/src/handlers/index.ts
  - apps/web-portal/app/(dashboard)/reports/actions.ts
autonomous: false

must_haves:
  truths:
    - "All handlers registered and builds pass"
    - "Report scheduler syncs on startup"
    - "Web portal configuration flow is complete"
    - "End-to-end flow verified by human"
  artifacts:
    - path: "apps/slack-backend/src/handlers/index.ts"
      provides: "All report handlers registered"
      contains: "registerReportActionHandlers"
  key_links:
    - from: "apps/web-portal/app/(dashboard)/reports/actions.ts"
      to: "apps/slack-backend/src/jobs/schedulers.ts"
      via: "Scheduler upsert when settings saved"
      pattern: "upsertReportScheduler"
---

<objective>
Final integration and human verification of the complete Weekly Reports feature.

Purpose: Ensure all components are properly wired together, handlers are registered, and the end-to-end flow works correctly. Human verification confirms the feature is production-ready.

Output: All integrations complete, builds pass, human-verified end-to-end functionality.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-weekly-reports/05-RESEARCH.md
@.planning/phases/05-weekly-reports/05-06-SUMMARY.md
@.planning/phases/05-weekly-reports/05-07-SUMMARY.md
@.planning/phases/05-weekly-reports/05-08-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify all handler registrations and exports</name>
  <files>
apps/slack-backend/src/handlers/index.ts
apps/slack-backend/src/services/index.ts
apps/slack-backend/src/jobs/index.ts
  </files>
  <action>
Ensure all new handlers, services, and job exports are properly registered.

Verify handlers/index.ts includes:
```typescript
import { registerWorkflowSubmissionHandler } from './events/workflow-submission.js';
import { registerGenerateReportCommand } from './commands/generate-report.js';
import { registerReportActionHandlers } from './actions/report-actions.js';
import { registerReportRefinementViewHandler } from './views/report-refinement-modal.js';

export function registerHandlers(app: App): void {
  // Events
  registerWorkflowSubmissionHandler(app);
  // ... existing

  // Commands
  registerGenerateReportCommand(app);
  // ... existing

  // Actions
  registerReportActionHandlers(app);
  // ... existing

  // Views
  registerReportRefinementViewHandler(app);
  // ... existing
}
```

Verify services/index.ts exports:
```typescript
export * from './google-sheets.js';
export * from './report-generator.js';
```

Verify jobs/index.ts exports:
```typescript
export * from './schedulers.js';
```

Run full build to verify all imports resolve correctly.
  </action>
  <verify>
`npm run build --workspaces --if-present` completes without errors.
All new handlers are registered.
  </verify>
  <done>
All handlers, services, and job exports properly wired.
Full build passes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire scheduler upsert to settings save</name>
  <files>apps/web-portal/app/(dashboard)/reports/actions.ts</files>
  <action>
Update saveReportSettings action to trigger scheduler upsert after saving settings.

Since web-portal and slack-backend are separate apps, we need to call the scheduler sync via API or let the slack-backend handle it on startup.

For simplicity, add a note that schedulers sync on server restart. For immediate updates, add an internal API endpoint.

Option 1 (simple - use this): Document that scheduler updates take effect after slack-backend restart, or user can trigger manually.

Option 2 (if needed later): Add internal API endpoint in slack-backend for scheduler sync.

Update saveReportSettings to include comment:
```typescript
export async function saveReportSettings(data: ReportSettingsFormData): Promise<{ success: boolean; error?: string }> {
  const session = await verifySession();

  try {
    await db
      .insert(schema.reportSettings)
      .values({
        workspaceId: session.workspaceId,
        userId: session.slackUserId,
        enabled: data.enabled,
        dayOfWeek: data.dayOfWeek,
        timeOfDay: data.timeOfDay,
        timezone: data.timezone,
        format: data.format,
        sections: data.sections,
        autoSend: data.autoSend,
      })
      .onConflictDoUpdate({
        target: [schema.reportSettings.workspaceId, schema.reportSettings.userId],
        set: {
          enabled: data.enabled,
          dayOfWeek: data.dayOfWeek,
          timeOfDay: data.timeOfDay,
          timezone: data.timezone,
          format: data.format,
          sections: data.sections,
          autoSend: data.autoSend,
          updatedAt: new Date(),
        },
      });

    // Note: Scheduler will sync on slack-backend restart or next scheduled job check
    // For immediate scheduler update, restart slack-backend or wait for sync interval

    revalidatePath('/reports');
    return { success: true };
  } catch (error) {
    console.error('Failed to save report settings:', error);
    return { success: false, error: 'Failed to save settings' };
  }
}
```

Add a UI note in the form that schedule changes take effect after a short delay.
  </action>
  <verify>
`npm run build --workspace=web-portal` compiles.
Settings save works correctly.
  </verify>
  <done>
Report settings save action works correctly.
Documentation notes scheduler sync behavior.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Weekly Reports feature including:
- Google OAuth flow for Sheets access
- Spreadsheet configuration in web portal
- Workflow channel monitoring configuration
- Workflow submission detection and Sheets writing
- AI-powered report generation
- /generate-report slash command
- Scheduled report generation (BullMQ Job Schedulers)
- Report delivery via Slack DM
- Report refinement modal with multi-turn AI
  </what-built>
  <how-to-verify>
**Prerequisites:**
1. Set GOOGLE_CLIENT_ID and GOOGLE_CLIENT_SECRET in apps/slack-backend/.env
2. Create Google Cloud project with Sheets API enabled
3. Configure OAuth consent screen and create OAuth 2.0 Client ID

**Test Google OAuth Flow:**
1. Start slack-backend: `npm run dev --workspace=slack-backend`
2. Start web-portal: `npm run dev --workspace=web-portal`
3. Visit http://localhost:3001/reports
4. Click "Connect Google Account"
5. Complete Google OAuth consent
6. Verify redirected back to /reports with "connected" status
7. Enter a Google Sheets spreadsheet ID
8. Click Save

**Test Workflow Monitoring Setup:**
1. Add a channel ID to monitor in "Workflow Monitoring" section
2. Verify channel appears in list

**Test Report Generation (Manual):**
1. In Slack, run `/generate-report`
2. Verify acknowledgment message appears
3. Verify report delivered via DM (may take 30-60 seconds)
4. Click "Copy Report" - verify modal with copyable text
5. Click "Refine Report" - enter feedback and verify refined report

**Test Report Settings:**
1. Enable scheduled reports
2. Configure day, time, and timezone
3. Save settings
4. Verify settings persist after page reload

**Expected Behavior:**
- Google OAuth redirects correctly
- Spreadsheet ID saves to database
- Slash command acknowledges and delivers report
- Report shows in DM with Copy/Refine buttons
- Refinement modal allows multi-turn conversation
  </how-to-verify>
  <resume-signal>Type "approved" to complete phase, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build --workspaces --if-present` passes
2. All handlers registered correctly
3. Google OAuth flow works end-to-end
4. Report generation and delivery works
5. Human verification confirms functionality
</verification>

<success_criteria>
- All builds pass without errors
- All handlers properly registered
- Google OAuth flow works
- Report generation delivers to DM
- Refinement modal functions correctly
- Human verification approved
</success_criteria>

<output>
After completion, create `.planning/phases/05-weekly-reports/05-09-SUMMARY.md`
</output>
