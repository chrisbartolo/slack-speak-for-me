---
phase: 05-weekly-reports
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - apps/slack-backend/src/handlers/health.ts
  - apps/slack-backend/src/handlers/index.ts
  - apps/web-portal/app/(dashboard)/reports/page.tsx
  - apps/web-portal/app/(dashboard)/reports/actions.ts
  - apps/web-portal/lib/db/queries.ts
  - apps/web-portal/lib/db/index.ts
autonomous: true

must_haves:
  truths:
    - "User can initiate Google OAuth from reports settings page"
    - "OAuth callback stores encrypted tokens and returns success"
    - "Reports page shows Google connection status"
    - "User can disconnect Google account"
  artifacts:
    - path: "apps/slack-backend/src/handlers/health.ts"
      provides: "Google OAuth callback route"
      contains: "/oauth/google/callback"
    - path: "apps/web-portal/app/(dashboard)/reports/page.tsx"
      provides: "Google connection status display"
      contains: "GoogleConnectionCard"
    - path: "apps/web-portal/app/(dashboard)/reports/actions.ts"
      provides: "Server actions for Google connection"
      exports: ["disconnectGoogle"]
  key_links:
    - from: "apps/web-portal/app/(dashboard)/reports/page.tsx"
      to: "apps/slack-backend/src/oauth/google-oauth.ts"
      via: "OAuth initiation redirect"
      pattern: "getGoogleAuthUrl"
    - from: "apps/slack-backend/src/handlers/health.ts"
      to: "apps/slack-backend/src/oauth/google-oauth.ts"
      via: "OAuth callback handler"
      pattern: "handleGoogleCallback"
---

<objective>
Wire Google OAuth flow from web portal reports page through slack-backend callback endpoint.

Purpose: Allow users to connect their Google account from the reports settings page. The OAuth flow initiates from web-portal, redirects to Google, then returns to slack-backend callback which stores tokens and redirects back to web-portal.

Output: Complete OAuth flow with UI for initiating connection, showing connection status, and disconnecting.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-weekly-reports/05-RESEARCH.md
@.planning/phases/05-weekly-reports/05-01-SUMMARY.md

# Existing patterns
@apps/slack-backend/src/handlers/health.ts
@apps/web-portal/app/(dashboard)/reports/page.tsx
@apps/web-portal/app/(dashboard)/reports/actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Google OAuth callback route to slack-backend</name>
  <files>apps/slack-backend/src/handlers/health.ts</files>
  <action>
Add Google OAuth callback route to the customRoutes in health.ts. This follows the existing pattern of using Bolt's customRoutes for non-Slack endpoints.

Add route handler:
```typescript
{
  path: '/oauth/google/callback',
  method: ['GET'],
  handler: async (req, res) => {
    try {
      const url = new URL(req.url || '', `http://${req.headers.host}`);
      const code = url.searchParams.get('code');
      const state = url.searchParams.get('state');
      const error = url.searchParams.get('error');

      if (error) {
        logger.error({ error }, 'Google OAuth error');
        res.writeHead(302, {
          Location: `${process.env.WEB_PORTAL_URL || 'http://localhost:3001'}/reports?error=google_auth_failed`
        });
        res.end();
        return;
      }

      if (!code || !state) {
        res.writeHead(400, { 'Content-Type': 'application/json' });
        res.end(JSON.stringify({ error: 'Missing code or state parameter' }));
        return;
      }

      // Import and call handleGoogleCallback from google-oauth service
      const { handleGoogleCallback } = await import('../oauth/google-oauth.js');
      await handleGoogleCallback(code, state);

      // Redirect back to web portal reports page with success
      res.writeHead(302, {
        Location: `${process.env.WEB_PORTAL_URL || 'http://localhost:3001'}/reports?google_connected=true`
      });
      res.end();
    } catch (err) {
      logger.error({ err }, 'Google OAuth callback failed');
      res.writeHead(302, {
        Location: `${process.env.WEB_PORTAL_URL || 'http://localhost:3001'}/reports?error=google_auth_failed`
      });
      res.end();
    }
  },
}
```

Add WEB_PORTAL_URL to env.ts if not present (optional, defaults to localhost:3001).
  </action>
  <verify>
`npm run build --workspace=slack-backend` compiles.
Route is registered in customRoutes array.
  </verify>
  <done>
Google OAuth callback route exists at /oauth/google/callback, handles code exchange, and redirects to web portal.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Google connection query and actions to web-portal</name>
  <files>
apps/web-portal/lib/db/queries.ts
apps/web-portal/lib/db/index.ts
apps/web-portal/app/(dashboard)/reports/actions.ts
  </files>
  <action>
Add database query and server actions for Google connection status.

In lib/db/index.ts, add googleIntegrations to schema export:
```typescript
import { googleIntegrations } from '@slack-speak/database';
// Add to schema object
export const schema = { ...existing, googleIntegrations };
```

In lib/db/queries.ts, add cached query:
```typescript
export const getGoogleIntegration = cache(async () => {
  const session = await verifySession();

  const [integration] = await db
    .select()
    .from(schema.googleIntegrations)
    .where(
      and(
        eq(schema.googleIntegrations.workspaceId, session.workspaceId),
        eq(schema.googleIntegrations.userId, session.slackUserId)
      )
    )
    .limit(1);

  return integration || null;
});
```

In reports/actions.ts, add disconnect action:
```typescript
export async function disconnectGoogle(): Promise<{ success: boolean; error?: string }> {
  const session = await verifySession();

  try {
    await db
      .delete(schema.googleIntegrations)
      .where(
        and(
          eq(schema.googleIntegrations.workspaceId, session.workspaceId),
          eq(schema.googleIntegrations.userId, session.slackUserId)
        )
      );

    revalidatePath('/reports');
    return { success: true };
  } catch (error) {
    console.error('Failed to disconnect Google:', error);
    return { success: false, error: 'Failed to disconnect Google account' };
  }
}

export async function getGoogleAuthUrl(): Promise<string> {
  const session = await verifySession();
  // Construct URL to slack-backend Google OAuth initiation
  const backendUrl = process.env.SLACK_BACKEND_URL || 'http://localhost:3000';
  const params = new URLSearchParams({
    workspaceId: session.workspaceId,
    userId: session.slackUserId,
  });
  return `${backendUrl}/oauth/google/start?${params}`;
}
```

Note: We'll need to add a /oauth/google/start route to slack-backend that generates the auth URL.
  </action>
  <verify>
`npm run build --workspace=web-portal` compiles.
Query and actions are exported correctly.
  </verify>
  <done>
getGoogleIntegration query returns user's Google connection status.
disconnectGoogle action removes stored tokens.
getGoogleAuthUrl returns URL to initiate OAuth.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Google connection UI to reports page</name>
  <files>
apps/web-portal/app/(dashboard)/reports/page.tsx
apps/slack-backend/src/handlers/health.ts
  </files>
  <action>
Update reports page to show Google connection status and add OAuth start route.

First, add /oauth/google/start route to slack-backend health.ts:
```typescript
{
  path: '/oauth/google/start',
  method: ['GET'],
  handler: async (req, res) => {
    try {
      const url = new URL(req.url || '', `http://${req.headers.host}`);
      const workspaceId = url.searchParams.get('workspaceId');
      const userId = url.searchParams.get('userId');

      if (!workspaceId || !userId) {
        res.writeHead(400, { 'Content-Type': 'application/json' });
        res.end(JSON.stringify({ error: 'Missing workspaceId or userId' }));
        return;
      }

      const { getGoogleAuthUrl } = await import('../oauth/google-oauth.js');
      const authUrl = getGoogleAuthUrl(workspaceId, userId);

      res.writeHead(302, { Location: authUrl });
      res.end();
    } catch (err) {
      logger.error({ err }, 'Failed to generate Google auth URL');
      res.writeHead(500, { 'Content-Type': 'application/json' });
      res.end(JSON.stringify({ error: 'Failed to start Google OAuth' }));
    }
  },
}
```

In reports/page.tsx, add GoogleConnectionCard component above the settings form:
```tsx
import { getGoogleIntegration } from '@/lib/db/queries';
import { GoogleConnectionCard } from '@/components/google-connection-card';

export default async function ReportsPage() {
  const [settings, googleIntegration] = await Promise.all([
    getReportSettings(),
    getGoogleIntegration(),
  ]);

  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-2xl font-semibold">Weekly Reports</h1>
        <p className="text-muted-foreground">
          Configure automated weekly team report generation.
        </p>
      </div>

      <GoogleConnectionCard
        isConnected={!!googleIntegration}
        spreadsheetName={googleIntegration?.spreadsheetName || undefined}
      />

      {/* Existing ReportSettingsForm */}
      <ReportSettingsForm initialSettings={settings} disabled={!googleIntegration} />

      {/* Existing explainer card */}
    </div>
  );
}
```

Create components/google-connection-card.tsx:
```tsx
'use client';

import { Button } from '@/components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { disconnectGoogle } from '@/app/(dashboard)/reports/actions';
import { useTransition } from 'react';
import { toast } from 'sonner';
import { useSearchParams } from 'next/navigation';
import { useEffect } from 'react';

interface Props {
  isConnected: boolean;
  spreadsheetName?: string;
}

export function GoogleConnectionCard({ isConnected, spreadsheetName }: Props) {
  const [isPending, startTransition] = useTransition();
  const searchParams = useSearchParams();

  useEffect(() => {
    if (searchParams.get('google_connected') === 'true') {
      toast.success('Google account connected successfully');
      // Clean up URL
      window.history.replaceState({}, '', '/reports');
    }
    if (searchParams.get('error') === 'google_auth_failed') {
      toast.error('Failed to connect Google account');
      window.history.replaceState({}, '', '/reports');
    }
  }, [searchParams]);

  const handleConnect = async () => {
    // Use server action to get auth URL with session data included
    const { getGoogleAuthUrl } = await import('@/app/(dashboard)/reports/actions');
    const authUrl = await getGoogleAuthUrl();
    window.location.href = authUrl;
  };

  const handleDisconnect = () => {
    startTransition(async () => {
      const result = await disconnectGoogle();
      if (result.success) {
        toast.success('Google account disconnected');
      } else {
        toast.error(result.error || 'Failed to disconnect');
      }
    });
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <GoogleIcon />
          Google Sheets Connection
        </CardTitle>
        <CardDescription>
          Connect your Google account to read and write weekly report data.
        </CardDescription>
      </CardHeader>
      <CardContent>
        {isConnected ? (
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <div className="h-2 w-2 rounded-full bg-green-500" />
              <span className="text-sm">
                Connected{spreadsheetName ? ` - ${spreadsheetName}` : ''}
              </span>
            </div>
            <Button
              variant="outline"
              size="sm"
              onClick={handleDisconnect}
              disabled={isPending}
            >
              Disconnect
            </Button>
          </div>
        ) : (
          <div className="flex items-center justify-between">
            <span className="text-sm text-muted-foreground">
              Not connected
            </span>
            <Button size="sm" onClick={handleConnect}>
              Connect Google Account
            </Button>
          </div>
        )}
      </CardContent>
    </Card>
  );
}

function GoogleIcon() {
  return (
    <svg className="h-5 w-5" viewBox="0 0 24 24">
      <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
      <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
      <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
      <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
    </svg>
  );
}
```

The handleConnect uses the getGoogleAuthUrl server action which retrieves session data and constructs the URL with workspaceId/userId query params.
  </action>
  <verify>
`npm run build --workspace=web-portal` compiles.
`npm run build --workspace=slack-backend` compiles.
Reports page shows Google connection card.
Connect button redirects to Google OAuth.
Disconnect button removes integration.
  </verify>
  <done>
Reports page shows Google connection status.
User can click "Connect Google Account" to start OAuth flow.
User can click "Disconnect" to remove stored tokens.
Success/error messages shown via toast.
  </done>
</task>

</tasks>

<verification>
1. `npm run build --workspace=slack-backend` compiles
2. `npm run build --workspace=web-portal` compiles
3. Visit /reports page - shows Google connection card
4. Click "Connect Google Account" - redirects to Google OAuth consent
5. After consent - redirected back to /reports with success toast
6. Click "Disconnect" - removes connection and updates UI
</verification>

<success_criteria>
- /oauth/google/start route generates auth URL and redirects
- /oauth/google/callback handles code exchange and stores tokens
- Reports page displays Google connection status
- Connect button initiates OAuth flow
- Disconnect button removes stored tokens
- Success/error feedback via toast notifications
</success_criteria>

<output>
After completion, create `.planning/phases/05-weekly-reports/05-02-SUMMARY.md`
</output>
