---
phase: 05-weekly-reports
plan: 07
type: execute
wave: 5
depends_on: ["05-05"]
files_modified:
  - apps/slack-backend/src/handlers/actions/report-actions.ts
  - apps/slack-backend/src/handlers/actions/index.ts
  - apps/slack-backend/src/handlers/views/report-refinement-modal.ts
  - apps/slack-backend/src/handlers/views/index.ts
  - apps/slack-backend/src/services/report-generator.ts
autonomous: true

must_haves:
  truths:
    - "User can click Copy button to get report text"
    - "User can click Refine button to open refinement modal"
    - "User can enter feedback and receive refined report"
    - "Refined report can be copied or refined further"
  artifacts:
    - path: "apps/slack-backend/src/handlers/actions/report-actions.ts"
      provides: "Action handlers for report buttons"
      exports: ["registerReportActionHandlers"]
    - path: "apps/slack-backend/src/handlers/views/report-refinement-modal.ts"
      provides: "Report refinement modal handler"
      exports: ["registerReportRefinementViewHandler"]
  key_links:
    - from: "apps/slack-backend/src/handlers/actions/report-actions.ts"
      to: "apps/slack-backend/src/handlers/views/report-refinement-modal.ts"
      via: "Opens modal on refine button click"
      pattern: "views\\.open"
    - from: "apps/slack-backend/src/handlers/views/report-refinement-modal.ts"
      to: "apps/slack-backend/src/services/report-generator.ts"
      via: "refineReport call"
      pattern: "refineReport"
---

<objective>
Implement report interaction handlers - Copy button and Refine modal for iterating on generated reports.

Purpose: Allow users to copy the generated report for use or refine it with AI feedback before copying. The refinement modal follows the same pattern as suggestion refinement.

Output: Action handlers for Copy/Refine buttons, refinement modal with AI-powered iteration, copy confirmation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-weekly-reports/05-RESEARCH.md
@.planning/phases/05-weekly-reports/05-05-SUMMARY.md

# Existing patterns - follow these closely
@apps/slack-backend/src/handlers/actions/copy-suggestion.ts
@apps/slack-backend/src/handlers/views/refinement-modal.ts
@apps/slack-backend/src/services/ai.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add refineReport function to report generator service</name>
  <files>apps/slack-backend/src/services/report-generator.ts</files>
  <action>
Add report refinement function to the report generator service.

```typescript
export interface RefineReportOptions {
  currentReport: string;
  feedback: string;
  history: Array<{ role: 'user' | 'assistant'; content: string }>;
}

export interface RefineReportResult {
  refinedReport: string;
  processingTimeMs: number;
}

/**
 * Refine a report based on user feedback
 */
export async function refineReport(
  options: RefineReportOptions
): Promise<RefineReportResult> {
  const startTime = Date.now();
  const { currentReport, feedback, history } = options;

  const messages: Anthropic.MessageParam[] = [
    ...history.map((h) => ({
      role: h.role as 'user' | 'assistant',
      content: h.content,
    })),
    {
      role: 'user',
      content: `Here is the current report:\n\n${currentReport}\n\nPlease refine it based on this feedback: ${feedback}\n\nProvide only the refined report, no explanations.`,
    },
  ];

  const response = await anthropic.messages.create({
    model: 'claude-sonnet-4-20250514',
    max_tokens: 2048,
    system: 'You are a professional report editor. Refine reports based on user feedback while maintaining professional tone and structure. Output only the refined report.',
    messages,
  });

  const refinedReport = response.content
    .filter((block): block is Anthropic.TextBlock => block.type === 'text')
    .map((block) => block.text)
    .join('\n');

  return {
    refinedReport,
    processingTimeMs: Date.now() - startTime,
  };
}
```
  </action>
  <verify>
`npm run build --workspace=slack-backend` compiles.
refineReport function is exported.
  </verify>
  <done>
refineReport function takes current report, feedback, and history and returns AI-refined report.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create report action handlers (Copy and Refine buttons)</name>
  <files>
apps/slack-backend/src/handlers/actions/report-actions.ts
apps/slack-backend/src/handlers/actions/index.ts
  </files>
  <action>
Create action handlers for report Copy and Refine buttons. Follow patterns from copy-suggestion.ts.

Create handlers/actions/report-actions.ts:
```typescript
import type { App } from '@slack/bolt';
import { logger } from '../../utils/logger.js';

/**
 * Register action handlers for report buttons
 */
export function registerReportActionHandlers(app: App): void {
  // Copy Report button - shows copyable text
  app.action('report_copy', async ({ action, ack, client, body }) => {
    await ack();

    try {
      const actionValue = (action as any).value;
      const { report } = JSON.parse(actionValue);

      // Open modal with copyable report text
      await client.views.open({
        trigger_id: (body as any).trigger_id,
        view: {
          type: 'modal',
          title: {
            type: 'plain_text',
            text: 'Copy Report',
          },
          close: {
            type: 'plain_text',
            text: 'Close',
          },
          blocks: [
            {
              type: 'section',
              text: {
                type: 'mrkdwn',
                text: 'Triple-click to select all text, then copy:',
              },
            },
            {
              type: 'section',
              text: {
                type: 'mrkdwn',
                text: '```' + report + '```',
              },
            },
          ],
        },
      });
    } catch (error) {
      logger.error({ error, action: 'report_copy' }, 'Failed to open copy modal');
    }
  });

  // Refine Report button - opens refinement modal
  app.action('report_refine', async ({ action, ack, client, body }) => {
    await ack();

    try {
      const actionValue = (action as any).value;
      const { report } = JSON.parse(actionValue);
      const userId = (body as any).user?.id;

      // Store initial report in private_metadata
      const privateMetadata = JSON.stringify({
        currentReport: report,
        history: [],
      });

      await client.views.open({
        trigger_id: (body as any).trigger_id,
        view: {
          type: 'modal',
          callback_id: 'report_refinement_submit',
          private_metadata: privateMetadata,
          title: {
            type: 'plain_text',
            text: 'Refine Report',
          },
          submit: {
            type: 'plain_text',
            text: 'Refine',
          },
          close: {
            type: 'plain_text',
            text: 'Cancel',
          },
          blocks: [
            {
              type: 'section',
              text: {
                type: 'mrkdwn',
                text: '*Current Report:*',
              },
            },
            {
              type: 'section',
              text: {
                type: 'mrkdwn',
                text: report.substring(0, 2900), // Slack limit
              },
            },
            {
              type: 'divider',
            },
            {
              type: 'input',
              block_id: 'feedback_block',
              element: {
                type: 'plain_text_input',
                action_id: 'feedback_input',
                multiline: true,
                placeholder: {
                  type: 'plain_text',
                  text: 'How would you like to change the report? (e.g., "Make it more concise", "Add more detail to blockers", "Reorganize for executive audience")',
                },
              },
              label: {
                type: 'plain_text',
                text: 'Your Feedback',
              },
            },
          ],
        },
      });

      logger.info({ userId }, 'Opened report refinement modal');
    } catch (error) {
      logger.error({ error, action: 'report_refine' }, 'Failed to open refinement modal');
    }
  });
}
```

Update handlers/actions/index.ts:
```typescript
import { registerReportActionHandlers } from './report-actions.js';

export function registerActionHandlers(app: App): void {
  // ... existing handlers
  registerReportActionHandlers(app);
}
```
  </action>
  <verify>
`npm run build --workspace=slack-backend` compiles.
Action handlers are registered.
  </verify>
  <done>
report_copy action opens modal with copyable report text.
report_refine action opens refinement modal with feedback input.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create report refinement modal view handler</name>
  <files>
apps/slack-backend/src/handlers/views/report-refinement-modal.ts
apps/slack-backend/src/handlers/views/index.ts
  </files>
  <action>
Create view handler for report refinement modal submission. Follow pattern from refinement-modal.ts.

Create handlers/views/report-refinement-modal.ts:
```typescript
import type { App } from '@slack/bolt';
import { refineReport } from '../../services/report-generator.js';
import { logger } from '../../utils/logger.js';

interface ReportRefinementMetadata {
  currentReport: string;
  history: Array<{ role: 'user' | 'assistant'; content: string }>;
}

/**
 * Register view handler for report refinement modal
 */
export function registerReportRefinementViewHandler(app: App): void {
  app.view('report_refinement_submit', async ({ ack, view, client, body }) => {
    const userId = body.user.id;

    // Get feedback from input
    const feedback = view.state.values.feedback_block?.feedback_input?.value || '';

    if (!feedback.trim()) {
      await ack({
        response_action: 'errors',
        errors: {
          feedback_block: 'Please provide feedback on how to refine the report',
        },
      });
      return;
    }

    // Acknowledge and update to loading state
    await ack({
      response_action: 'update',
      view: {
        type: 'modal',
        title: {
          type: 'plain_text',
          text: 'Refining Report...',
        },
        blocks: [
          {
            type: 'section',
            text: {
              type: 'mrkdwn',
              text: 'AI is refining your report based on your feedback...',
            },
          },
        ],
      },
    });

    try {
      // Parse metadata
      const metadata: ReportRefinementMetadata = JSON.parse(view.private_metadata || '{}');
      const { currentReport, history } = metadata;

      // Refine the report
      const result = await refineReport({
        currentReport,
        feedback,
        history,
      });

      // Update history for next refinement round
      const updatedHistory = [
        ...history,
        { role: 'user' as const, content: `Current report:\n${currentReport}\n\nFeedback: ${feedback}` },
        { role: 'assistant' as const, content: result.refinedReport },
      ];

      // Truncate history if too long
      const maxHistoryLength = 2000;
      let historyStr = JSON.stringify(updatedHistory);
      while (historyStr.length > maxHistoryLength && updatedHistory.length > 2) {
        updatedHistory.splice(0, 2); // Remove oldest exchange
        historyStr = JSON.stringify(updatedHistory);
      }

      const newMetadata: ReportRefinementMetadata = {
        currentReport: result.refinedReport,
        history: updatedHistory,
      };

      // Update modal with refined report
      await client.views.update({
        view_id: view.id,
        view: {
          type: 'modal',
          callback_id: 'report_refinement_submit',
          private_metadata: JSON.stringify(newMetadata),
          title: {
            type: 'plain_text',
            text: 'Refined Report',
          },
          submit: {
            type: 'plain_text',
            text: 'Refine More',
          },
          close: {
            type: 'plain_text',
            text: 'Done',
          },
          blocks: [
            {
              type: 'section',
              text: {
                type: 'mrkdwn',
                text: '*Refined Report:*',
              },
            },
            {
              type: 'section',
              text: {
                type: 'mrkdwn',
                text: result.refinedReport.substring(0, 2900),
              },
            },
            {
              type: 'actions',
              elements: [
                {
                  type: 'button',
                  text: {
                    type: 'plain_text',
                    text: 'Copy Report',
                  },
                  action_id: 'report_copy_from_modal',
                  value: JSON.stringify({ report: result.refinedReport.substring(0, 2000) }),
                },
              ],
            },
            {
              type: 'divider',
            },
            {
              type: 'input',
              block_id: 'feedback_block',
              element: {
                type: 'plain_text_input',
                action_id: 'feedback_input',
                multiline: true,
                placeholder: {
                  type: 'plain_text',
                  text: 'Want more changes? Describe them here...',
                },
              },
              label: {
                type: 'plain_text',
                text: 'Additional Feedback (optional)',
              },
              optional: true,
            },
          ],
        },
      });

      logger.info({
        userId,
        processingTimeMs: result.processingTimeMs,
        historyLength: updatedHistory.length,
      }, 'Report refined successfully');
    } catch (error) {
      logger.error({ error, userId }, 'Failed to refine report');

      await client.views.update({
        view_id: view.id,
        view: {
          type: 'modal',
          title: {
            type: 'plain_text',
            text: 'Error',
          },
          close: {
            type: 'plain_text',
            text: 'Close',
          },
          blocks: [
            {
              type: 'section',
              text: {
                type: 'mrkdwn',
                text: 'Failed to refine report. Please try again.',
              },
            },
          ],
        },
      });
    }
  });

  // Handle copy button from within refinement modal
  app.action('report_copy_from_modal', async ({ action, ack, client, body }) => {
    await ack();

    try {
      const actionValue = (action as any).value;
      const { report } = JSON.parse(actionValue);

      // Update current modal to show copyable text
      await client.views.update({
        view_id: (body as any).view?.id,
        view: {
          type: 'modal',
          title: {
            type: 'plain_text',
            text: 'Copy Report',
          },
          close: {
            type: 'plain_text',
            text: 'Close',
          },
          blocks: [
            {
              type: 'section',
              text: {
                type: 'mrkdwn',
                text: 'Triple-click to select all text, then copy:',
              },
            },
            {
              type: 'section',
              text: {
                type: 'mrkdwn',
                text: '```' + report + '```',
              },
            },
          ],
        },
      });
    } catch (error) {
      logger.error({ error }, 'Failed to show copy modal');
    }
  });
}
```

Update handlers/views/index.ts:
```typescript
import { registerReportRefinementViewHandler } from './report-refinement-modal.js';

export function registerViewHandlers(app: App): void {
  // ... existing handlers
  registerReportRefinementViewHandler(app);
}
```
  </action>
  <verify>
`npm run build --workspace=slack-backend` compiles.
View handler is registered.
  </verify>
  <done>
Report refinement modal processes feedback and shows AI-refined report.
User can continue refining or copy final report.
History maintained for multi-turn refinement.
  </done>
</task>

</tasks>

<verification>
1. `npm run build --workspace=slack-backend` compiles
2. All handlers registered (report_copy, report_refine, report_refinement_submit, report_copy_from_modal)
3. Refinement modal correctly passes metadata between iterations
4. History truncation prevents metadata overflow
</verification>

<success_criteria>
- Copy button opens modal with copyable report text
- Refine button opens modal with feedback input
- Feedback submission triggers AI refinement
- Refined report shown with Copy and Refine More options
- Multi-turn refinement works with history
- All builds pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-weekly-reports/05-07-SUMMARY.md`
</output>
