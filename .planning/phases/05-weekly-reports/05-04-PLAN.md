---
phase: 05-weekly-reports
plan: 04
type: execute
wave: 3
depends_on: ["05-03"]
files_modified:
  - apps/slack-backend/src/services/report-generator.ts
  - apps/slack-backend/src/services/index.ts
autonomous: true

must_haves:
  truths:
    - "AI can summarize multiple submissions into board-ready format"
    - "Report includes achievements, focus, blockers, and shoutouts sections"
    - "Report format adapts to user's configured format (concise/detailed)"
    - "Missing submitters can be identified"
  artifacts:
    - path: "apps/slack-backend/src/services/report-generator.ts"
      provides: "AI report generation service"
      exports: ["generateWeeklyReport", "getMissingSubmitters"]
  key_links:
    - from: "apps/slack-backend/src/services/report-generator.ts"
      to: "apps/slack-backend/src/services/google-sheets.ts"
      via: "getSubmissions call"
      pattern: "getSubmissions"
    - from: "apps/slack-backend/src/services/report-generator.ts"
      to: "@anthropic-ai/sdk"
      via: "AI summarization"
      pattern: "anthropic\\.messages\\.create"
---

<objective>
Create AI-powered report generation service that aggregates Google Sheets submissions into board-ready format.

Purpose: Transform raw team submissions into a polished weekly report suitable for board presentation. The AI summarizes achievements, identifies focus areas, consolidates blockers, and highlights shoutouts.

Output: Report generator service that reads submissions, identifies missing team members, and produces formatted report via Claude AI.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-weekly-reports/05-RESEARCH.md
@.planning/phases/05-weekly-reports/05-03-SUMMARY.md

# Existing AI pattern
@apps/slack-backend/src/services/ai.ts
@apps/slack-backend/src/services/google-sheets.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create report generator service</name>
  <files>
apps/slack-backend/src/services/report-generator.ts
apps/slack-backend/src/services/index.ts
  </files>
  <action>
Create report generator service that aggregates submissions and produces AI-summarized reports.

```typescript
// apps/slack-backend/src/services/report-generator.ts
import Anthropic from '@anthropic-ai/sdk';
import { getSubmissions, getSubmissionStatus, type WorkflowSubmission } from './google-sheets.js';
import { db, reportSettings, workspaces } from '@slack-speak/database';
import { eq, and } from 'drizzle-orm';
import { logger } from '../utils/logger.js';
import { startOfWeek } from 'date-fns';

const anthropic = new Anthropic();

export interface ReportGenerationResult {
  report: string;
  missingSubmitters: string[];
  submitterCount: number;
  processingTimeMs: number;
}

export interface GenerateReportOptions {
  workspaceId: string;
  userId: string;
  spreadsheetId: string;
  format: 'concise' | 'detailed';
  sections: string[];
  teamMemberSlackIds?: string[]; // Optional list of expected team members
}

/**
 * Generate a weekly report from Google Sheets submissions
 */
export async function generateWeeklyReport(
  options: GenerateReportOptions
): Promise<ReportGenerationResult> {
  const startTime = Date.now();
  const { workspaceId, userId, spreadsheetId, format, sections, teamMemberSlackIds } = options;

  // Get start of current week (Monday)
  const weekStart = startOfWeek(new Date(), { weekStartsOn: 1 });

  // Fetch submissions from Google Sheets
  const submissions = await getSubmissions(workspaceId, userId, spreadsheetId, weekStart);

  if (submissions.length === 0) {
    return {
      report: 'No submissions received this week.',
      missingSubmitters: teamMemberSlackIds || [],
      submitterCount: 0,
      processingTimeMs: Date.now() - startTime,
    };
  }

  // Identify missing submitters
  const submitterIds = new Set(submissions.map(s => s.submitterSlackId));
  const missingSubmitters = (teamMemberSlackIds || []).filter(id => !submitterIds.has(id));

  // Build prompt for AI summarization
  const prompt = buildReportPrompt(submissions, format, sections);

  logger.info({
    workspaceId,
    userId,
    submissionCount: submissions.length,
    format,
    sections,
  }, 'Generating weekly report');

  const response = await anthropic.messages.create({
    model: 'claude-sonnet-4-20250514',
    max_tokens: 2048,
    messages: [
      {
        role: 'user',
        content: prompt,
      },
    ],
  });

  const report = response.content
    .filter((block): block is Anthropic.TextBlock => block.type === 'text')
    .map((block) => block.text)
    .join('\n');

  const processingTimeMs = Date.now() - startTime;

  logger.info({
    workspaceId,
    userId,
    processingTimeMs,
    inputTokens: response.usage.input_tokens,
    outputTokens: response.usage.output_tokens,
  }, 'Weekly report generated');

  return {
    report,
    missingSubmitters,
    submitterCount: submissions.length,
    processingTimeMs,
  };
}

function buildReportPrompt(
  submissions: WorkflowSubmission[],
  format: 'concise' | 'detailed',
  sections: string[]
): string {
  const submissionsText = submissions
    .map((s) => `
--- ${s.submitterName} (${s.timestamp.toLocaleDateString()}) ---
Achievements: ${s.achievements || 'None reported'}
Focus: ${s.focus || 'None reported'}
Blockers: ${s.blockers || 'None reported'}
Shoutouts: ${s.shoutouts || 'None reported'}
`.trim())
    .join('\n\n');

  const sectionInstructions = sections
    .map((section) => {
      switch (section) {
        case 'achievements':
          return '- **Achievements**: Summarize key accomplishments and wins from the team';
        case 'focus':
          return '- **Focus Areas**: Identify main priorities and what the team is working on';
        case 'blockers':
          return '- **Blockers/Risks**: Highlight any obstacles or concerns that need attention';
        case 'shoutouts':
          return '- **Recognition**: Highlight team members who were called out for great work';
        default:
          return '';
      }
    })
    .filter(Boolean)
    .join('\n');

  const formatInstructions = format === 'concise'
    ? 'Keep the report brief and to the point. Use bullet points. Aim for 200-300 words total.'
    : 'Provide comprehensive detail. Include context and specifics. Group similar items together.';

  return `You are a professional report writer. Create a weekly team status report from the following individual submissions.

## Format Requirements
${formatInstructions}

## Sections to Include
${sectionInstructions}

## Team Submissions
${submissionsText}

## Instructions
1. Synthesize the individual submissions into a cohesive team report
2. Do not simply list each person's input - instead, aggregate and summarize themes
3. Use professional, board-ready language
4. If someone reported "None" for a section, skip them for that section
5. For shoutouts, include the specific names mentioned
6. Format with clear section headers using ## markdown

Generate the report now:`;
}

/**
 * Get list of team members who haven't submitted this week
 */
export async function getMissingSubmitters(
  workspaceId: string,
  userId: string,
  spreadsheetId: string,
  teamMemberSlackIds: string[]
): Promise<{ slackId: string; name?: string }[]> {
  const weekStart = startOfWeek(new Date(), { weekStartsOn: 1 });
  const status = await getSubmissionStatus(workspaceId, userId, spreadsheetId, weekStart);

  const submittedIds = new Set(status.map(s => s.submitterSlackId));

  return teamMemberSlackIds
    .filter(id => !submittedIds.has(id))
    .map(slackId => ({ slackId }));
}

/**
 * Get user's report settings
 */
export async function getReportSettings(workspaceId: string, userId: string) {
  const [settings] = await db
    .select()
    .from(reportSettings)
    .where(
      and(
        eq(reportSettings.workspaceId, workspaceId),
        eq(reportSettings.userId, userId)
      )
    )
    .limit(1);

  return settings;
}
```

Add export to services/index.ts:
```typescript
export * from './report-generator.js';
```
  </action>
  <verify>
`npm run build --workspace=slack-backend` compiles.
Service exports generateWeeklyReport, getMissingSubmitters, getReportSettings.
  </verify>
  <done>
Report generator service aggregates submissions from Google Sheets.
AI summarizes into board-ready format with configurable sections.
Missing submitters identified from expected team list.
Format adapts to concise or detailed based on settings.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for report generator</name>
  <files>apps/slack-backend/src/services/report-generator.test.ts</files>
  <action>
Create unit tests for the report generator service, mocking Google Sheets and Anthropic calls.

```typescript
// apps/slack-backend/src/services/report-generator.test.ts
import { describe, it, expect, vi, beforeEach } from 'vitest';

// Mock external dependencies
vi.mock('./google-sheets.js', () => ({
  getSubmissions: vi.fn(),
  getSubmissionStatus: vi.fn(),
}));

vi.mock('@anthropic-ai/sdk', () => {
  return {
    default: vi.fn().mockImplementation(() => ({
      messages: {
        create: vi.fn(),
      },
    })),
  };
});

import { generateWeeklyReport, getMissingSubmitters } from './report-generator.js';
import { getSubmissions, getSubmissionStatus } from './google-sheets.js';
import Anthropic from '@anthropic-ai/sdk';

describe('report-generator', () => {
  const mockSubmissions = [
    {
      timestamp: new Date('2026-01-27'),
      submitterName: 'Alice',
      submitterSlackId: 'U123',
      achievements: 'Shipped feature X',
      focus: 'Working on feature Y',
      blockers: 'API access pending',
      shoutouts: 'Thanks to Bob for code review',
    },
    {
      timestamp: new Date('2026-01-27'),
      submitterName: 'Bob',
      submitterSlackId: 'U456',
      achievements: 'Fixed critical bug',
      focus: 'Performance optimization',
      blockers: '',
      shoutouts: '',
    },
  ];

  beforeEach(() => {
    vi.clearAllMocks();
  });

  describe('generateWeeklyReport', () => {
    it('should generate report from submissions', async () => {
      vi.mocked(getSubmissions).mockResolvedValue(mockSubmissions);

      const mockAnthropicInstance = new Anthropic();
      vi.mocked(mockAnthropicInstance.messages.create).mockResolvedValue({
        content: [{ type: 'text', text: '## Achievements\n- Team shipped feature X...' }],
        usage: { input_tokens: 100, output_tokens: 200 },
      } as any);

      const result = await generateWeeklyReport({
        workspaceId: 'ws-123',
        userId: 'U789',
        spreadsheetId: 'sheet-123',
        format: 'detailed',
        sections: ['achievements', 'focus', 'blockers', 'shoutouts'],
      });

      expect(result.submitterCount).toBe(2);
      expect(result.report).toContain('Achievements');
      expect(getSubmissions).toHaveBeenCalled();
    });

    it('should return empty report when no submissions', async () => {
      vi.mocked(getSubmissions).mockResolvedValue([]);

      const result = await generateWeeklyReport({
        workspaceId: 'ws-123',
        userId: 'U789',
        spreadsheetId: 'sheet-123',
        format: 'concise',
        sections: ['achievements'],
      });

      expect(result.submitterCount).toBe(0);
      expect(result.report).toContain('No submissions');
    });

    it('should identify missing submitters', async () => {
      vi.mocked(getSubmissions).mockResolvedValue(mockSubmissions);

      const mockAnthropicInstance = new Anthropic();
      vi.mocked(mockAnthropicInstance.messages.create).mockResolvedValue({
        content: [{ type: 'text', text: 'Report content' }],
        usage: { input_tokens: 100, output_tokens: 200 },
      } as any);

      const result = await generateWeeklyReport({
        workspaceId: 'ws-123',
        userId: 'U789',
        spreadsheetId: 'sheet-123',
        format: 'concise',
        sections: ['achievements'],
        teamMemberSlackIds: ['U123', 'U456', 'U789'], // U789 is missing
      });

      expect(result.missingSubmitters).toEqual(['U789']);
    });
  });

  describe('getMissingSubmitters', () => {
    it('should return members who have not submitted', async () => {
      vi.mocked(getSubmissionStatus).mockResolvedValue([
        { submitterSlackId: 'U123', submitterName: 'Alice', submittedAt: new Date() },
      ]);

      const missing = await getMissingSubmitters(
        'ws-123',
        'U789',
        'sheet-123',
        ['U123', 'U456', 'U789']
      );

      expect(missing).toEqual([
        { slackId: 'U456' },
        { slackId: 'U789' },
      ]);
    });
  });
});
```
  </action>
  <verify>
`npm test --workspace=slack-backend -- src/services/report-generator.test.ts` passes.
Tests cover: report generation, empty submissions, missing submitter identification.
  </verify>
  <done>
Unit tests verify report generator handles normal submissions, empty submissions, and missing submitter tracking.
  </done>
</task>

</tasks>

<verification>
1. `npm run build --workspace=slack-backend` compiles
2. `npm test --workspace=slack-backend -- src/services/report-generator.test.ts` passes
3. Service exports all required functions
4. AI prompt includes format and section customization
</verification>

<success_criteria>
- Report generator service reads from Google Sheets and produces AI summary
- Format setting (concise/detailed) affects output style
- Sections setting controls which parts appear in report
- Missing submitters identified from team list
- Unit tests cover core functionality
</success_criteria>

<output>
After completion, create `.planning/phases/05-weekly-reports/05-04-SUMMARY.md`
</output>
