---
phase: 05-weekly-reports
plan: 06
type: execute
wave: 4
depends_on: ["05-04"]
files_modified:
  - apps/slack-backend/src/jobs/schedulers.ts
  - apps/slack-backend/src/jobs/index.ts
  - apps/slack-backend/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Scheduled reports run at configured day/time in user's timezone"
    - "Scheduler creates/updates when user saves report settings"
    - "Scheduler removes when user disables scheduled reports"
    - "Scheduled jobs survive server restarts"
  artifacts:
    - path: "apps/slack-backend/src/jobs/schedulers.ts"
      provides: "BullMQ job scheduler management"
      exports: ["upsertReportScheduler", "removeReportScheduler", "syncAllReportSchedulers"]
  key_links:
    - from: "apps/slack-backend/src/jobs/schedulers.ts"
      to: "apps/slack-backend/src/jobs/queues.ts"
      via: "upsertJobScheduler on reportQueue"
      pattern: "reportQueue\\.upsertJobScheduler"
    - from: "apps/slack-backend/src/index.ts"
      to: "apps/slack-backend/src/jobs/schedulers.ts"
      via: "syncAllReportSchedulers on startup"
      pattern: "syncAllReportSchedulers"
---

<objective>
Implement BullMQ Job Schedulers for automated weekly report generation based on user settings.

Purpose: Enable users to configure automated report generation at their preferred day and time. Reports are generated and delivered without manual intervention on the configured schedule.

Output: Scheduler management service that creates/updates/removes BullMQ Job Schedulers based on reportSettings, with startup sync to restore schedulers after restart.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-weekly-reports/05-RESEARCH.md
@.planning/phases/05-weekly-reports/05-04-SUMMARY.md

# Existing patterns
@apps/slack-backend/src/jobs/queues.ts
@apps/slack-backend/src/jobs/workers.ts
@packages/database/src/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create scheduler management service</name>
  <files>
apps/slack-backend/src/jobs/schedulers.ts
apps/slack-backend/src/jobs/index.ts
  </files>
  <action>
Create service to manage BullMQ Job Schedulers for report generation.

Create jobs/schedulers.ts:
```typescript
import { db, reportSettings, googleIntegrations, workspaces } from '@slack-speak/database';
import { eq, and } from 'drizzle-orm';
import { reportQueue } from './queues.js';
import { logger } from '../utils/logger.js';

/**
 * Convert day of week and time to cron pattern
 * dayOfWeek: 0 (Sunday) - 6 (Saturday)
 * timeOfDay: "HH:mm" format
 */
function toCronPattern(dayOfWeek: number, timeOfDay: string): string {
  const [hours, minutes] = timeOfDay.split(':').map(Number);
  // Cron format: minute hour * * dayOfWeek
  return `${minutes} ${hours} * * ${dayOfWeek}`;
}

/**
 * Get scheduler ID for a user's report settings
 */
function getSchedulerId(workspaceId: string, userId: string): string {
  return `report-${workspaceId}-${userId}`;
}

/**
 * Create or update a report scheduler based on user settings
 */
export async function upsertReportScheduler(
  workspaceId: string,
  userId: string
): Promise<{ created: boolean; schedulerId: string } | null> {
  // Get user's report settings
  const [settings] = await db
    .select()
    .from(reportSettings)
    .where(
      and(
        eq(reportSettings.workspaceId, workspaceId),
        eq(reportSettings.userId, userId)
      )
    )
    .limit(1);

  if (!settings || !settings.enabled) {
    // If disabled, remove any existing scheduler
    await removeReportScheduler(workspaceId, userId);
    return null;
  }

  // Check Google integration
  const [integration] = await db
    .select()
    .from(googleIntegrations)
    .where(
      and(
        eq(googleIntegrations.workspaceId, workspaceId),
        eq(googleIntegrations.userId, userId)
      )
    )
    .limit(1);

  if (!integration?.spreadsheetId) {
    logger.warn({
      workspaceId,
      userId,
    }, 'Cannot create scheduler - no Google Sheets configured');
    return null;
  }

  const schedulerId = getSchedulerId(workspaceId, userId);
  const cronPattern = toCronPattern(
    settings.dayOfWeek ?? 1,
    settings.timeOfDay ?? '09:00'
  );
  const timezone = settings.timezone ?? 'UTC';

  await reportQueue.upsertJobScheduler(
    schedulerId,
    {
      pattern: cronPattern,
      tz: timezone,
    },
    {
      name: 'scheduled-report',
      data: {
        workspaceId,
        userId,
        slackUserId: userId,
        spreadsheetId: integration.spreadsheetId,
        format: (settings.format as 'concise' | 'detailed') || 'detailed',
        sections: (settings.sections as string[]) || ['achievements', 'focus', 'blockers', 'shoutouts'],
        triggeredBy: 'scheduled' as const,
      },
      opts: {
        attempts: 3,
        backoff: {
          type: 'exponential',
          delay: 5000,
        },
      },
    }
  );

  logger.info({
    schedulerId,
    workspaceId,
    userId,
    cronPattern,
    timezone,
  }, 'Report scheduler upserted');

  return { created: true, schedulerId };
}

/**
 * Remove a report scheduler
 */
export async function removeReportScheduler(
  workspaceId: string,
  userId: string
): Promise<boolean> {
  const schedulerId = getSchedulerId(workspaceId, userId);

  try {
    await reportQueue.removeJobScheduler(schedulerId);
    logger.info({ schedulerId }, 'Report scheduler removed');
    return true;
  } catch (error) {
    // Scheduler might not exist, which is fine
    logger.debug({ schedulerId, error }, 'Failed to remove scheduler (may not exist)');
    return false;
  }
}

/**
 * Sync all report schedulers from database
 * Called on server startup to restore schedulers after restart
 */
export async function syncAllReportSchedulers(): Promise<{
  created: number;
  skipped: number;
  errors: number;
}> {
  const stats = { created: 0, skipped: 0, errors: 0 };

  // Get all enabled report settings
  const enabledSettings = await db
    .select({
      settings: reportSettings,
      workspace: workspaces,
      integration: googleIntegrations,
    })
    .from(reportSettings)
    .innerJoin(workspaces, eq(reportSettings.workspaceId, workspaces.id))
    .leftJoin(googleIntegrations, and(
      eq(googleIntegrations.workspaceId, reportSettings.workspaceId),
      eq(googleIntegrations.userId, reportSettings.userId)
    ))
    .where(eq(reportSettings.enabled, true));

  logger.info({ count: enabledSettings.length }, 'Syncing report schedulers');

  for (const { settings, integration } of enabledSettings) {
    if (!integration?.spreadsheetId) {
      stats.skipped++;
      continue;
    }

    try {
      await upsertReportScheduler(settings.workspaceId, settings.userId);
      stats.created++;
    } catch (error) {
      logger.error({
        error,
        workspaceId: settings.workspaceId,
        userId: settings.userId,
      }, 'Failed to create scheduler');
      stats.errors++;
    }
  }

  logger.info(stats, 'Report scheduler sync complete');
  return stats;
}

/**
 * Get all active report schedulers
 */
export async function getReportSchedulers(): Promise<string[]> {
  const jobSchedulers = await reportQueue.getJobSchedulers();
  return jobSchedulers.map(s => s.id);
}
```

Update jobs/index.ts:
```typescript
export * from './schedulers.js';
```
  </action>
  <verify>
`npm run build --workspace=slack-backend` compiles.
Scheduler functions are exported.
  </verify>
  <done>
upsertReportScheduler creates/updates BullMQ scheduler from settings.
removeReportScheduler removes scheduler when disabled.
syncAllReportSchedulers restores all schedulers on startup.
Cron pattern and timezone correctly converted from settings.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add scheduler sync on server startup</name>
  <files>apps/slack-backend/src/index.ts</files>
  <action>
Add scheduler synchronization to server startup after workers are initialized.

In the main startup function, after startWorkers():
```typescript
import { syncAllReportSchedulers } from './jobs/schedulers.js';

// After startWorkers() call
await syncAllReportSchedulers();
logger.info('Report schedulers synchronized');
```

This ensures all enabled report settings have their corresponding BullMQ schedulers recreated after server restart.
  </action>
  <verify>
`npm run build --workspace=slack-backend` compiles.
Server startup includes scheduler sync.
  </verify>
  <done>
Server startup synchronizes all report schedulers from database.
Schedulers survive server restarts by being recreated on startup.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for scheduler service</name>
  <files>apps/slack-backend/src/jobs/schedulers.test.ts</files>
  <action>
Create unit tests for the scheduler service.

```typescript
// apps/slack-backend/src/jobs/schedulers.test.ts
import { describe, it, expect, vi, beforeEach } from 'vitest';

// Mock database
vi.mock('@slack-speak/database', () => ({
  db: {
    select: vi.fn(() => ({
      from: vi.fn(() => ({
        where: vi.fn(() => ({
          limit: vi.fn(() => Promise.resolve([])),
        })),
        innerJoin: vi.fn(() => ({
          leftJoin: vi.fn(() => ({
            where: vi.fn(() => Promise.resolve([])),
          })),
        })),
      })),
    })),
  },
  reportSettings: {},
  googleIntegrations: {},
  workspaces: {},
}));

// Mock queue
vi.mock('./queues.js', () => ({
  reportQueue: {
    upsertJobScheduler: vi.fn(),
    removeJobScheduler: vi.fn(),
    getJobSchedulers: vi.fn(() => Promise.resolve([])),
  },
}));

import { upsertReportScheduler, removeReportScheduler, syncAllReportSchedulers } from './schedulers.js';
import { reportQueue } from './queues.js';
import { db } from '@slack-speak/database';

describe('schedulers', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  describe('upsertReportScheduler', () => {
    it('should create scheduler when settings enabled and Google connected', async () => {
      // Mock settings query
      vi.mocked(db.select).mockImplementation(() => ({
        from: () => ({
          where: () => ({
            limit: () => Promise.resolve([{
              id: 'settings-1',
              workspaceId: 'ws-123',
              userId: 'U123',
              enabled: true,
              dayOfWeek: 1, // Monday
              timeOfDay: '09:00',
              timezone: 'America/New_York',
              format: 'detailed',
              sections: ['achievements', 'focus'],
            }]),
          }),
        }),
      } as any));

      // Second call for Google integration
      vi.mocked(db.select).mockImplementationOnce(() => ({
        from: () => ({
          where: () => ({
            limit: () => Promise.resolve([{
              spreadsheetId: 'sheet-123',
            }]),
          }),
        }),
      } as any));

      const result = await upsertReportScheduler('ws-123', 'U123');

      expect(result).not.toBeNull();
      expect(result?.created).toBe(true);
      expect(reportQueue.upsertJobScheduler).toHaveBeenCalled();
    });

    it('should remove scheduler when settings disabled', async () => {
      vi.mocked(db.select).mockImplementation(() => ({
        from: () => ({
          where: () => ({
            limit: () => Promise.resolve([{
              enabled: false,
            }]),
          }),
        }),
      } as any));

      const result = await upsertReportScheduler('ws-123', 'U123');

      expect(result).toBeNull();
      expect(reportQueue.removeJobScheduler).toHaveBeenCalled();
    });
  });

  describe('removeReportScheduler', () => {
    it('should remove scheduler successfully', async () => {
      vi.mocked(reportQueue.removeJobScheduler).mockResolvedValue(undefined);

      const result = await removeReportScheduler('ws-123', 'U123');

      expect(result).toBe(true);
      expect(reportQueue.removeJobScheduler).toHaveBeenCalledWith('report-ws-123-U123');
    });
  });
});
```
  </action>
  <verify>
`npm test --workspace=slack-backend -- src/jobs/schedulers.test.ts` passes.
  </verify>
  <done>
Unit tests verify scheduler creation, removal, and sync logic.
  </done>
</task>

</tasks>

<verification>
1. `npm run build --workspace=slack-backend` compiles
2. `npm test --workspace=slack-backend -- src/jobs/schedulers.test.ts` passes
3. Scheduler functions correctly convert cron pattern
4. Startup includes syncAllReportSchedulers call
</verification>

<success_criteria>
- upsertReportScheduler creates/updates BullMQ Job Scheduler with cron pattern and timezone
- removeReportScheduler removes scheduler when reports disabled
- syncAllReportSchedulers recreates all schedulers on server startup
- Cron pattern correctly formed from dayOfWeek and timeOfDay settings
- Timezone passed to BullMQ for correct local time execution
- Unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/05-weekly-reports/05-06-SUMMARY.md`
</output>
