---
phase: 11-individual-billing
plan: 05
type: execute
wave: 3
depends_on: ["11-03"]
files_modified:
  - apps/web-portal/app/settings/billing/page.tsx
  - apps/web-portal/components/dashboard/sidebar.tsx
  - apps/web-portal/app/dashboard/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Individual billing settings page exists at /settings/billing"
    - "Page shows individual subscription status and management options"
    - "Individual users see simplified dashboard without admin features"
    - "Sidebar includes Settings link for all users"
  artifacts:
    - path: "apps/web-portal/app/settings/billing/page.tsx"
      provides: "Individual billing management page"
      contains: "Personal Billing"
    - path: "apps/web-portal/components/dashboard/sidebar.tsx"
      provides: "Settings navigation link"
      contains: "Settings"
  key_links:
    - from: "apps/web-portal/app/settings/billing/page.tsx"
      to: "/api/stripe/user-portal"
      via: "form action for Stripe portal"
      pattern: "user-portal"
    - from: "apps/web-portal/app/settings/billing/page.tsx"
      to: "/pricing"
      via: "link for users without subscription"
      pattern: "pricing.*individual"
---

<objective>
Create individual billing settings page and integrate access checking into dashboard.

Purpose: Individual users need a dedicated page to manage their personal subscription. The dashboard should reflect whether access comes from individual or org subscription.
Output: /settings/billing page with subscription management, integrated access checking in dashboard.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-individual-billing/11-RESEARCH.md
@.planning/phases/11-individual-billing/11-03-SUMMARY.md
@apps/web-portal/app/dashboard/layout.tsx
@apps/web-portal/components/dashboard/sidebar.tsx
@apps/web-portal/lib/billing/access-check.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create individual billing settings page</name>
  <files>apps/web-portal/app/settings/billing/page.tsx</files>
  <action>
Create the settings/billing directory and page:

```bash
mkdir -p apps/web-portal/app/settings/billing
```

Create apps/web-portal/app/settings/billing/page.tsx:

```typescript
import Link from 'next/link';
import { verifySession } from '@/lib/auth/dal';
import {
  getIndividualSubscription,
  checkUserAccess
} from '@/lib/billing/access-check';
import { getSubscription } from '@/lib/stripe';
import { Button } from '@/components/ui/button';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';

export const metadata = {
  title: 'Billing Settings - Speak for Me',
};

function formatDate(date: Date | null): string {
  if (!date) return 'N/A';
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}

function StatusBadge({ status }: { status: string | null }) {
  if (!status) return <Badge variant="secondary">No subscription</Badge>;

  const variants: Record<string, 'default' | 'secondary' | 'destructive' | 'outline'> = {
    active: 'default',
    trialing: 'default',
    past_due: 'secondary',
    paused: 'secondary',
    canceled: 'destructive',
  };

  return (
    <Badge variant={variants[status] || 'secondary'}>
      {status.charAt(0).toUpperCase() + status.slice(1)}
    </Badge>
  );
}

export default async function IndividualBillingPage() {
  const session = await verifySession();

  if (!session.email) {
    return (
      <div className="p-8">
        <h1 className="text-3xl font-bold mb-4">Personal Billing</h1>
        <Card>
          <CardContent className="pt-6">
            <p className="text-muted-foreground">
              Email is required for individual billing. Please sign out and sign back in.
            </p>
          </CardContent>
        </Card>
      </div>
    );
  }

  const [userSub, accessResult] = await Promise.all([
    getIndividualSubscription(session.email),
    checkUserAccess(session.email, session.workspaceId),
  ]);

  // Get Stripe subscription details if exists
  const stripeSubscription = userSub?.stripeSubscriptionId
    ? await getSubscription(userSub.stripeSubscriptionId)
    : null;

  const hasIndividualSub = userSub &&
    (userSub.subscriptionStatus === 'active' || userSub.subscriptionStatus === 'trialing');

  const hasOrgAccess = accessResult.hasAccess && accessResult.source === 'organization';

  return (
    <div className="p-8 space-y-6 max-w-3xl">
      <div>
        <h1 className="text-3xl font-bold">Personal Billing</h1>
        <p className="text-muted-foreground mt-1">
          Manage your individual subscription - works across all your Slack workspaces
        </p>
      </div>

      {/* Access Source Info */}
      {accessResult.hasAccess && (
        <Card className="border-green-200 bg-green-50">
          <CardContent className="pt-6">
            <div className="flex items-center gap-2">
              <svg className="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
              </svg>
              <span className="text-green-800 font-medium">
                {accessResult.source === 'individual'
                  ? 'You have an active personal subscription'
                  : 'You have access through your organization'
                }
              </span>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Individual Subscription Card */}
      <Card>
        <CardHeader>
          <CardTitle>Personal Subscription</CardTitle>
          <CardDescription>
            Your individual subscription tied to {session.email}
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          {userSub ? (
            <>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <p className="text-sm text-muted-foreground">Plan</p>
                  <p className="font-medium">
                    {userSub.planId === 'individual_pro' ? 'Pro' : 'Starter'}
                  </p>
                </div>
                <div>
                  <p className="text-sm text-muted-foreground">Status</p>
                  <StatusBadge status={userSub.subscriptionStatus} />
                </div>
                {userSub.subscriptionStatus === 'trialing' && userSub.trialEndsAt && (
                  <div className="col-span-2">
                    <p className="text-sm text-muted-foreground">Trial Ends</p>
                    <p className="font-medium">{formatDate(userSub.trialEndsAt)}</p>
                  </div>
                )}
                {stripeSubscription?.current_period_end && (
                  <div className="col-span-2">
                    <p className="text-sm text-muted-foreground">Next Billing Date</p>
                    <p className="font-medium">
                      {formatDate(new Date(stripeSubscription.current_period_end * 1000))}
                    </p>
                  </div>
                )}
              </div>

              <div className="pt-4 border-t">
                <form action="/api/stripe/user-portal" method="POST">
                  <Button type="submit">
                    Manage Subscription
                  </Button>
                </form>
              </div>
            </>
          ) : (
            <div className="space-y-4">
              <p className="text-muted-foreground">
                You don't have a personal subscription.
                {hasOrgAccess && ' You currently have access through your organization.'}
              </p>
              <Link href="/pricing?mode=individual">
                <Button>
                  {hasOrgAccess ? 'Add Personal Subscription' : 'Subscribe Now'}
                </Button>
              </Link>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Org Access Info (if applicable) */}
      {hasOrgAccess && (
        <Card>
          <CardHeader>
            <CardTitle>Organization Access</CardTitle>
            <CardDescription>
              You also have access through your organization
            </CardDescription>
          </CardHeader>
          <CardContent>
            <p className="text-sm text-muted-foreground">
              Your organization provides access to Speak for Me. If you leave the organization,
              you can maintain access with a personal subscription.
            </p>
            <div className="mt-4">
              <Link href="/admin/billing">
                <Button variant="outline" size="sm">
                  View Organization Billing
                </Button>
              </Link>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Overlap Warning */}
      {hasIndividualSub && hasOrgAccess && (
        <Card className="border-amber-200 bg-amber-50">
          <CardContent className="pt-6">
            <div className="flex items-start gap-3">
              <svg className="w-5 h-5 text-amber-600 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
              <div>
                <p className="font-medium text-amber-800">You have overlapping subscriptions</p>
                <p className="text-sm text-amber-700 mt-1">
                  You have both a personal subscription and organization access. Consider pausing
                  your personal subscription while you have organization coverage to avoid duplicate charges.
                </p>
              </div>
            </div>
          </CardContent>
        </Card>
      )}
    </div>
  );
}
```

Key design decisions:
- Shows individual subscription status and management
- Detects overlapping subscriptions and shows warning
- Links to Stripe portal for subscription management
- Shows organization access info if user has both
- Works across all workspaces (email-based identity)
  </action>
  <verify>
Run `npm run typecheck --workspace=web-portal` to verify types.
Verify page structure and imports are correct.
  </verify>
  <done>/settings/billing page exists with individual subscription management UI.</done>
</task>

<task type="auto">
  <name>Task 2: Add Settings link to sidebar and integrate access checking</name>
  <files>
    apps/web-portal/components/dashboard/sidebar.tsx
    apps/web-portal/app/dashboard/layout.tsx
  </files>
  <action>
1. Update sidebar.tsx to include Settings link for all users:

Add Settings link before the admin section (visible to all users, not just admins):

```typescript
// Add Settings icon import at top
import { Settings } from 'lucide-react';

// In the nav items section (after existing links like Conversations, AI Learning, etc.):
<NavItem href="/settings/billing" icon={<Settings className="h-4 w-4" />}>
  Settings
</NavItem>
```

The Settings link should appear for ALL users (not just admins) since individual billing is user-specific.

2. Update dashboard layout to use access checking for subscription status display:

In apps/web-portal/app/dashboard/layout.tsx, import and use checkUserAccess:

```typescript
import { checkUserAccess } from '@/lib/billing/access-check';

// In the layout component, after getting session:
const session = await verifySession();
const accessResult = await checkUserAccess(session.email, session.workspaceId);

// Update subscription status banner to use accessResult:
// If accessResult.source === 'individual', show "Personal subscription"
// If accessResult.source === 'organization', show existing org-based messaging
```

This integrates the dual-path access checking into the existing subscription banner, making it aware of both individual and org subscription sources.
  </action>
  <verify>
Run `npm run typecheck --workspace=web-portal` to verify types.
Verify Settings link appears in sidebar.
  </verify>
  <done>Settings link added to sidebar, dashboard layout uses checkUserAccess for subscription status.</done>
</task>

</tasks>

<verification>
1. /settings/billing page renders with individual subscription info
2. Page shows Manage Subscription button linked to user portal
3. Page shows Subscribe Now link when no individual subscription
4. Overlapping subscription warning displays when user has both
5. Settings link visible in sidebar for all users
6. Dashboard layout uses checkUserAccess for access determination
</verification>

<success_criteria>
- Individual billing page exists at /settings/billing
- Page shows subscription status, plan, trial info
- Manage Subscription opens Stripe portal
- Subscribe Now links to /pricing?mode=individual
- Overlap warning shows when user has both individual and org access
- Settings link in sidebar navigates to billing page
- Dashboard correctly identifies access source (individual vs org)
</success_criteria>

<output>
After completion, create `.planning/phases/11-individual-billing/11-05-SUMMARY.md`
</output>
