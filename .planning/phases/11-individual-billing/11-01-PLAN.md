---
phase: 11-individual-billing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/src/schema.ts
  - apps/web-portal/lib/auth/session.ts
  - apps/web-portal/lib/auth/dal.ts
  - apps/web-portal/app/api/auth/callback/route.ts
  - apps/web-portal/lib/db/index.ts
autonomous: true

must_haves:
  truths:
    - "User subscriptions table exists in database"
    - "Session includes user email for cross-workspace identity"
    - "Email is stored lowercase for consistent lookup"
  artifacts:
    - path: "packages/database/src/schema.ts"
      provides: "userSubscriptions table definition"
      contains: "userSubscriptions"
    - path: "apps/web-portal/lib/auth/session.ts"
      provides: "Session payload with email field"
      contains: "email"
    - path: "apps/web-portal/lib/auth/dal.ts"
      provides: "verifySession returns email"
      contains: "email"
  key_links:
    - from: "apps/web-portal/app/api/auth/callback/route.ts"
      to: "session.createSession"
      via: "email passed to session creation"
      pattern: "email.*createSession|createSession.*email"
---

<objective>
Create the database schema for individual subscriptions and extend the session to include user email.

Purpose: Email is the stable identifier across Slack workspaces (Slack user IDs are workspace-scoped). Individual billing requires linking subscriptions to email rather than workspace.
Output: userSubscriptions table and session with email field for cross-workspace identity.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-individual-billing/11-RESEARCH.md
@packages/database/src/schema.ts
@apps/web-portal/lib/auth/session.ts
@apps/web-portal/lib/auth/dal.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add userSubscriptions table to database schema</name>
  <files>
    packages/database/src/schema.ts
    apps/web-portal/lib/db/index.ts
  </files>
  <action>
Add userSubscriptions table to schema.ts after auditLogs table:

```typescript
// Individual user subscriptions (email-based for cross-workspace identity)
export const userSubscriptions = pgTable('user_subscriptions', {
  id: uuid('id').primaryKey().defaultRandom(),

  // Identity - email is the stable identifier across workspaces
  email: text('email').notNull(),

  // Stripe billing
  stripeCustomerId: text('stripe_customer_id'),
  stripeSubscriptionId: text('stripe_subscription_id'),
  subscriptionStatus: text('subscription_status'), // 'active' | 'trialing' | 'paused' | 'canceled'
  planId: text('plan_id'), // 'individual_starter' | 'individual_pro'
  trialEndsAt: timestamp('trial_ends_at'),

  createdAt: timestamp('created_at').defaultNow(),
  updatedAt: timestamp('updated_at').defaultNow(),
}, (table) => ({
  emailIdx: uniqueIndex('user_subscriptions_email_idx').on(table.email),
  stripeCustomerIdx: index('user_subscriptions_stripe_customer_idx').on(table.stripeCustomerId),
}));
```

Key design decisions:
- Email is unique index (not primary key) for flexibility
- Email normalized to lowercase on insert (enforced at application layer)
- planId stores 'individual_starter' or 'individual_pro' to distinguish from org plans
- subscriptionStatus matches Stripe statuses for consistency

Export userSubscriptions from apps/web-portal/lib/db/index.ts by adding to the schema object.
  </action>
  <verify>
Run `npm run typecheck --workspace=@slack-speak-for-me/database` to verify schema compiles.
Run `npm run db:push --workspace=@slack-speak-for-me/database` to apply schema (or verify it would succeed in dry-run).
  </verify>
  <done>userSubscriptions table definition exists in schema.ts with email unique index and stripe fields.</done>
</task>

<task type="auto">
  <name>Task 2: Extend session to include email</name>
  <files>
    apps/web-portal/lib/auth/session.ts
    apps/web-portal/lib/auth/dal.ts
    apps/web-portal/app/api/auth/callback/route.ts
  </files>
  <action>
1. Update SessionPayload type in session.ts to include email:

```typescript
export type SessionPayload = {
  userId: string; // Slack user ID
  workspaceId: string; // Internal workspace UUID
  teamId: string; // Slack team ID
  email: string; // User email for individual billing lookup
  expiresAt: Date;
};
```

2. Update encrypt/decrypt functions to handle email field (already handles all fields, just ensure email is included in JWT payload).

3. Update verifySession in dal.ts to return email:

```typescript
return {
  isAuth: true,
  userId: session.userId,
  email: session.email,
  workspaceId: session.workspaceId,
  teamId: session.teamId,
};
```

4. Update getOptionalSession in dal.ts similarly.

5. Update callback route to pass email to createSession. The callback should already have access to user identity from Slack OAuth - find where user info is fetched and extract email.

If email is not currently fetched from Slack during OAuth:
- The users.identity scope should provide email
- Or fetch email via users.info API call after OAuth
- Store email in users table if not already there

IMPORTANT: Always normalize email to lowercase before storing or comparing:
```typescript
const normalizedEmail = userEmail?.toLowerCase() || '';
```
  </action>
  <verify>
Run `npm run typecheck --workspace=web-portal` to verify session types compile.
Check that callback route includes email in createSession call.
  </verify>
  <done>Session includes email field, dal.ts returns email in session, callback route passes email to session creation.</done>
</task>

</tasks>

<verification>
1. Database schema includes userSubscriptions table with correct columns
2. TypeScript types compile without errors across packages
3. Session payload includes email field
4. verifySession returns object with email property
</verification>

<success_criteria>
- userSubscriptions table defined in schema.ts
- userSubscriptions exported from web-portal db index
- SessionPayload type includes email: string
- verifySession returns {isAuth, userId, email, workspaceId, teamId}
- Email normalized to lowercase in callback route
</success_criteria>

<output>
After completion, create `.planning/phases/11-individual-billing/11-01-SUMMARY.md`
</output>
