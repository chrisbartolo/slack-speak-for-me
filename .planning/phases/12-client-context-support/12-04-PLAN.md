---
phase: 12-client-context-support
plan: 04
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - apps/slack-backend/src/services/sentiment-detector.ts
  - apps/slack-backend/src/services/index.ts
autonomous: true

must_haves:
  truths:
    - "Sentiment detector analyzes conversation messages and returns tone, confidence, indicators, and risk level"
    - "Uses Claude prompt engineering (not external API) for zero incremental cost"
    - "Risk levels: low, medium, high, critical with defined thresholds"
    - "Returns structured JSON with SentimentAnalysis interface"
  artifacts:
    - path: "apps/slack-backend/src/services/sentiment-detector.ts"
      provides: "Sentiment analysis using Claude prompting"
      exports: ["analyzeSentiment", "SentimentAnalysis"]
  key_links:
    - from: "apps/slack-backend/src/services/sentiment-detector.ts"
      to: "@anthropic-ai/sdk"
      via: "Claude API call for sentiment analysis"
      pattern: "anthropic\\.messages\\.create"
---

<objective>
Build sentiment detection service that analyzes client message tone and tension level using Claude prompting.

Purpose: The AI needs to detect when client messages show frustration, tension, or anger to switch into de-escalation mode. This service provides the analysis that drives de-escalation suggestions and escalation alerts.
Output: Sentiment detector service with structured analysis output.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/slack-backend/src/services/ai.ts
@apps/slack-backend/src/env.ts
@.planning/phases/12-client-context-support/12-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sentiment detector service</name>
  <files>apps/slack-backend/src/services/sentiment-detector.ts, apps/slack-backend/src/services/index.ts</files>
  <action>
Create `apps/slack-backend/src/services/sentiment-detector.ts`:

**Export SentimentAnalysis interface:**
```typescript
export interface SentimentAnalysis {
  tone: 'neutral' | 'positive' | 'tense' | 'frustrated' | 'angry';
  confidence: number; // 0.0-1.0
  indicators: string[]; // Human-readable indicators like "used all caps", "short terse replies"
  riskLevel: 'low' | 'medium' | 'high' | 'critical';
}
```

**Export analyzeSentiment function:**
```typescript
export async function analyzeSentiment(params: {
  conversationMessages: Array<{ userId: string; text: string; ts: string }>;
  targetMessage: string;
}): Promise<SentimentAnalysis>
```

Implementation:
1. Import Anthropic from '@anthropic-ai/sdk', env, logger
2. Create Anthropic client using env.ANTHROPIC_API_KEY (same pattern as ai.ts)
3. Format conversation messages as `[{ts}] {text}` lines
4. Create a focused prompt that asks Claude to analyze emotional tone:

```
Analyze the emotional tone and tension level in this conversation, focusing on the most recent message.

Conversation:
{formatted messages}

Most recent message: "{targetMessage}"

Respond ONLY with valid JSON (no markdown, no explanation):
{
  "tone": "neutral|positive|tense|frustrated|angry",
  "confidence": 0.0-1.0,
  "indicators": ["specific phrases or patterns indicating this tone"],
  "riskLevel": "low|medium|high|critical"
}

Risk level guidelines:
- low: Normal professional conversation, no tension
- medium: Minor frustration or impatience visible, needs careful response
- high: Clear tension, complaints about service, potential escalation risk
- critical: Anger, threats to leave/escalate, demands for management, explicit dissatisfaction

Be conservative - default to lower risk levels unless clear evidence of tension.
```

5. Use claude-sonnet-4-20250514 model, max_tokens: 256 (small output needed)
6. Parse JSON from response. Wrap in try/catch with fallback to neutral/low if parsing fails:
   ```typescript
   const fallback: SentimentAnalysis = {
     tone: 'neutral',
     confidence: 0,
     indicators: ['analysis_failed'],
     riskLevel: 'low',
   };
   ```
7. Validate parsed values (tone must be one of valid values, confidence must be 0-1, riskLevel must be valid)
8. Log analysis result with processingTimeMs

**Important design decisions:**
- Use a SEPARATE Claude call (not inline with suggestion generation) so sentiment can be cached/reused
- Keep max_tokens low (256) since output is small structured JSON
- Be conservative on risk levels to avoid alert fatigue
- Always return valid SentimentAnalysis (never throw on analysis failure)
- Set a 3-second timeout on the API call (cancel if takes too long, return fallback)

Export analyzeSentiment and SentimentAnalysis from services/index.ts.
  </action>
  <verify>Run `npx tsc --noEmit` in apps/slack-backend. Grep sentiment-detector.ts for 'analyzeSentiment' and 'SentimentAnalysis' exports.</verify>
  <done>Sentiment detector returns structured SentimentAnalysis with tone, confidence, indicators, and riskLevel. Uses Claude prompting with conservative thresholds. Never throws - returns neutral fallback on failure.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. analyzeSentiment function exported and importable
3. SentimentAnalysis type exported for use by other services
4. Fallback behavior prevents crashes when analysis fails
5. Response validated before returning
</verification>

<success_criteria>
- analyzeSentiment returns structured JSON with tone, confidence, indicators, riskLevel
- Conservative default behavior (neutral/low on failure)
- Prompt engineering approach (no external sentiment API)
- 3-second timeout prevents blocking suggestion generation
</success_criteria>

<output>
After completion, create `.planning/phases/12-client-context-support/12-04-SUMMARY.md`
</output>
