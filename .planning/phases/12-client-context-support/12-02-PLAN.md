---
phase: 12-client-context-support
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - apps/slack-backend/src/services/client-profiles.ts
  - apps/slack-backend/src/services/index.ts
  - apps/web-portal/app/admin/clients/page.tsx
  - apps/web-portal/app/api/admin/clients/route.ts
autonomous: true

must_haves:
  truths:
    - "Admin can create client profiles with company name, services, contract details"
    - "Admin can edit and delete client profiles"
    - "Client contacts can be mapped to Slack users"
    - "Client profiles are scoped to organization"
  artifacts:
    - path: "apps/slack-backend/src/services/client-profiles.ts"
      provides: "CRUD operations for client profiles and contacts"
      exports: ["createClientProfile", "updateClientProfile", "deleteClientProfile", "getClientProfiles", "getClientContactBySlackUserId", "addClientContact", "removeClientContact"]
    - path: "apps/web-portal/app/admin/clients/page.tsx"
      provides: "Admin UI for managing client profiles"
    - path: "apps/web-portal/app/api/admin/clients/route.ts"
      provides: "API endpoints for client profile CRUD"
      exports: ["GET", "POST"]
  key_links:
    - from: "apps/web-portal/app/admin/clients/page.tsx"
      to: "apps/web-portal/app/api/admin/clients/route.ts"
      via: "server action or fetch"
      pattern: "api/admin/clients"
    - from: "apps/slack-backend/src/services/client-profiles.ts"
      to: "packages/database/src/schema.ts"
      via: "drizzle queries"
      pattern: "clientProfiles|clientContacts"
---

<objective>
Build client profile CRUD service and admin management page.

Purpose: Users need to create and manage client profiles so the AI can use client context when generating suggestions. This is the core data entry for the entire client support feature set.
Output: Backend service for client profile operations + admin web page for managing profiles and contacts.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-client-context-support/12-01-SUMMARY.md
@packages/database/src/schema.ts
@apps/slack-backend/src/services/watch.ts
@apps/web-portal/app/admin/organizations/page.tsx
@apps/web-portal/lib/auth/admin.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create client profiles service in slack-backend</name>
  <files>apps/slack-backend/src/services/client-profiles.ts, apps/slack-backend/src/services/index.ts</files>
  <action>
Create `apps/slack-backend/src/services/client-profiles.ts` with these functions:

1. `getClientProfiles(organizationId: string)` - Returns all client profiles for an org, ordered by updatedAt desc
2. `getClientProfileById(id: string, organizationId: string)` - Single profile with org check
3. `createClientProfile(data: { organizationId: string; companyName: string; domain?: string; servicesProvided?: string[]; contractDetails?: string; accountManager?: string; relationshipStatus?: string; startDate?: Date; renewalDate?: Date })` - Insert and return new profile. Validate contractDetails max 2000 chars.
4. `updateClientProfile(id: string, organizationId: string, data: Partial<...>)` - Update with org scope check, set updatedAt
5. `deleteClientProfile(id: string, organizationId: string)` - Delete profile and cascade to contacts
6. `getClientContactBySlackUserId(workspaceId: string, slackUserId: string)` - Look up if a Slack user is a client contact. Returns clientContact with clientProfileId or null. This is critical for AI integration.
7. `getClientContactsByProfile(clientProfileId: string)` - List all contacts for a profile
8. `addClientContact(data: { clientProfileId: string; workspaceId: string; slackUserId: string; slackUserName?: string; role?: string })` - Upsert contact (use onConflictDoNothing)
9. `removeClientContact(id: string)` - Delete contact by ID

Use existing patterns: import db from @slack-speak/database, use eq/and from drizzle-orm, import logger. Follow the pattern in watch.ts for query structure.

Export all functions from `services/index.ts`.
  </action>
  <verify>Run `npx tsc --noEmit` in apps/slack-backend. Grep client-profiles.ts for all 9 function exports.</verify>
  <done>Client profile service has 9 functions for CRUD operations on profiles and contacts, all scoped by organizationId.</done>
</task>

<task type="auto">
  <name>Task 2: Create admin client profiles page and API</name>
  <files>apps/web-portal/app/api/admin/clients/route.ts, apps/web-portal/app/api/admin/clients/[id]/route.ts, apps/web-portal/app/api/admin/clients/[id]/contacts/route.ts, apps/web-portal/app/admin/clients/page.tsx</files>
  <action>
Create API routes and admin page for client management.

**API Route: `apps/web-portal/app/api/admin/clients/route.ts`**
- GET: List all client profiles for admin's organization. Use requireAdmin() from lib/auth/admin.ts to get organizationId. Query clientProfiles table where organizationId matches.
- POST: Create new client profile. Accept JSON body with { companyName, domain?, servicesProvided?, contractDetails?, accountManager?, relationshipStatus?, startDate?, renewalDate? }. Validate with Zod. Insert into clientProfiles table.

**API Route: `apps/web-portal/app/api/admin/clients/[id]/route.ts`**
- PUT: Update client profile. Validate org ownership. Update fields.
- DELETE: Delete client profile. Validate org ownership. Delete associated contacts first, then profile.

**API Route: `apps/web-portal/app/api/admin/clients/[id]/contacts/route.ts`**
- GET: List contacts for a client profile
- POST: Add contact { slackUserId, slackUserName?, role? }
- DELETE: Remove contact by contactId in body

**Admin Page: `apps/web-portal/app/admin/clients/page.tsx`**
Create a server component page (follow pattern in admin/organizations/page.tsx):
- Use requireAdmin() for auth
- Fetch client profiles from database directly (server component, no API call needed)
- Display cards for each client with: companyName, domain, relationshipStatus badge, servicesProvided list, accountManager, renewalDate
- Status badge colors: active=default, at_risk=destructive, churned=secondary
- "Add Client" button that opens a dialog/form (client component section)
- Each card has Edit and Delete buttons
- Each card has "Manage Contacts" button to expand contacts section
- Use shadcn/ui Card, Badge, Button, Input, Textarea, Dialog components
- Include a client component form for create/edit using Dialog pattern

The form should have fields: companyName (required), domain, servicesProvided (comma-separated input), contractDetails (textarea, max 2000), accountManager, relationshipStatus (select), startDate, renewalDate.
  </action>
  <verify>Run `npx tsc --noEmit` in apps/web-portal. Navigate to /admin/clients page (visual check if dev server running).</verify>
  <done>Admin can view, create, edit, and delete client profiles. Client contacts can be managed per profile. All operations scoped to organization.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors in both workspaces
2. Client profiles service exports all CRUD functions
3. Admin page renders client list with proper organization scoping
4. API routes handle create, read, update, delete operations
</verification>

<success_criteria>
- getClientContactBySlackUserId can look up a Slack user's client association (critical for AI)
- Admin page shows client profiles with status badges and management actions
- All operations scoped to admin's organization
</success_criteria>

<output>
After completion, create `.planning/phases/12-client-context-support/12-02-SUMMARY.md`
</output>
