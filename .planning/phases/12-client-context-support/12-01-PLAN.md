---
phase: 12-client-context-support
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/src/schema.ts
  - apps/web-portal/lib/db/index.ts
autonomous: true

must_haves:
  truths:
    - "Database has tables for client profiles, client contacts, brand voice templates, knowledge base documents, and escalation alerts"
    - "All new tables reference organizationId for multi-tenant isolation"
    - "Schema exports are available in both slack-backend and web-portal"
  artifacts:
    - path: "packages/database/src/schema.ts"
      provides: "5 new table definitions with proper indexes and relations"
      contains: "clientProfiles"
    - path: "apps/web-portal/lib/db/index.ts"
      provides: "Schema exports for web-portal queries"
      contains: "clientProfiles"
  key_links:
    - from: "packages/database/src/schema.ts"
      to: "organizations table"
      via: "organizationId foreign key"
      pattern: "references.*organizations\\.id"
---

<objective>
Add 5 new database tables for Phase 12: clientProfiles, clientContacts, brandVoiceTemplates, knowledgeBaseDocuments, and escalationAlerts.

Purpose: Foundation schema for all client context and support features. Every subsequent plan depends on these tables.
Output: Updated schema.ts with new tables and updated web-portal schema exports.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/database/src/schema.ts
@apps/web-portal/lib/db/index.ts
@.planning/phases/12-client-context-support/12-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add 5 new tables to database schema</name>
  <files>packages/database/src/schema.ts</files>
  <action>
Add the following 5 tables to the end of schema.ts (before any type exports). Follow existing patterns exactly (pgTable, uuid primary key, defaultRandom, timestamp defaults, proper indexes).

1. **clientProfiles** table:
   - id: uuid PK defaultRandom
   - organizationId: uuid NOT NULL references organizations.id
   - companyName: text NOT NULL
   - domain: text (nullable, for auto-detection hint like "acme.com")
   - servicesProvided: jsonb typed as string[] (nullable)
   - contractDetails: text (nullable, max 2000 chars enforced at app level)
   - accountManager: text (nullable, Slack user ID)
   - relationshipStatus: text default 'active' (values: 'active' | 'at_risk' | 'churned')
   - lifetimeValue: integer (nullable, in cents)
   - startDate: timestamp (nullable)
   - renewalDate: timestamp (nullable)
   - createdAt: timestamp defaultNow
   - updatedAt: timestamp defaultNow
   - Indexes: orgIdx on organizationId, domainIdx on domain

2. **clientContacts** table:
   - id: uuid PK defaultRandom
   - clientProfileId: uuid NOT NULL references clientProfiles.id
   - workspaceId: uuid NOT NULL references workspaces.id
   - slackUserId: text NOT NULL
   - slackUserName: text (nullable)
   - role: text (nullable, e.g., "Technical Lead", "Product Owner")
   - createdAt: timestamp defaultNow
   - Indexes: unique index on (clientProfileId, workspaceId, slackUserId)

3. **brandVoiceTemplates** table:
   - id: uuid PK defaultRandom
   - organizationId: uuid NOT NULL references organizations.id
   - name: text NOT NULL
   - description: text (nullable)
   - toneGuidelines: text NOT NULL
   - approvedPhrases: jsonb typed as string[] (nullable)
   - forbiddenPhrases: jsonb typed as string[] (nullable)
   - responsePatterns: jsonb typed as Array<{ situation: string; pattern: string }> (nullable)
   - isDefault: boolean default false
   - applicableTo: text (nullable, values: 'all' | 'client_conversations' | 'internal_only')
   - createdAt: timestamp defaultNow
   - updatedAt: timestamp defaultNow
   - Indexes: orgIdx on organizationId

4. **knowledgeBaseDocuments** table:
   - id: uuid PK defaultRandom
   - organizationId: uuid NOT NULL references organizations.id
   - title: text NOT NULL
   - content: text NOT NULL
   - category: text (nullable)
   - tags: jsonb typed as string[] (nullable)
   - embedding: text NOT NULL (stored as vector string, pgvector handles casting)
   - sourceUrl: text (nullable)
   - lastReviewedAt: timestamp (nullable)
   - isActive: boolean default true
   - createdAt: timestamp defaultNow
   - updatedAt: timestamp defaultNow
   - Indexes: orgIdx on organizationId, categoryIdx on category

5. **escalationAlerts** table:
   - id: uuid PK defaultRandom
   - organizationId: uuid NOT NULL references organizations.id
   - workspaceId: uuid NOT NULL references workspaces.id
   - clientProfileId: uuid (nullable) references clientProfiles.id
   - channelId: text NOT NULL
   - messageTs: text NOT NULL
   - alertType: text NOT NULL (values: 'tension_detected' | 'sla_breach' | 'churn_risk')
   - severity: text NOT NULL (values: 'medium' | 'high' | 'critical')
   - summary: text NOT NULL
   - suggestedAction: text (nullable)
   - sentiment: jsonb (nullable, stores SentimentAnalysis object)
   - status: text default 'open' (values: 'open' | 'acknowledged' | 'resolved' | 'false_positive')
   - acknowledgedBy: text (nullable, Slack user ID)
   - acknowledgedAt: timestamp (nullable)
   - resolvedAt: timestamp (nullable)
   - resolutionNotes: text (nullable)
   - createdAt: timestamp defaultNow
   - Indexes: orgIdx on organizationId, statusIdx on status, severityIdx on severity

Also add type exports at the end:
```typescript
export type ClientProfile = typeof clientProfiles.$inferSelect;
export type NewClientProfile = typeof clientProfiles.$inferInsert;
export type ClientContact = typeof clientContacts.$inferSelect;
export type NewClientContact = typeof clientContacts.$inferInsert;
export type BrandVoiceTemplate = typeof brandVoiceTemplates.$inferSelect;
export type NewBrandVoiceTemplate = typeof brandVoiceTemplates.$inferInsert;
export type KnowledgeBaseDocument = typeof knowledgeBaseDocuments.$inferSelect;
export type NewKnowledgeBaseDocument = typeof knowledgeBaseDocuments.$inferInsert;
export type EscalationAlert = typeof escalationAlerts.$inferSelect;
export type NewEscalationAlert = typeof escalationAlerts.$inferInsert;
```
  </action>
  <verify>Run `npx tsc --noEmit` in packages/database to verify types compile. Grep schema.ts for all 5 table names.</verify>
  <done>schema.ts contains clientProfiles, clientContacts, brandVoiceTemplates, knowledgeBaseDocuments, escalationAlerts tables with proper indexes and type exports.</done>
</task>

<task type="auto">
  <name>Task 2: Export new tables in web-portal schema</name>
  <files>apps/web-portal/lib/db/index.ts</files>
  <action>
Add the 5 new table exports to the web-portal schema object in lib/db/index.ts. Follow the existing pattern where tables are added to the schema object export.

Add these to the schema export:
- clientProfiles
- clientContacts
- brandVoiceTemplates
- knowledgeBaseDocuments
- escalationAlerts

Also ensure the type exports (ClientProfile, NewClientProfile, etc.) are re-exported so web-portal pages can import them.
  </action>
  <verify>Run `npx tsc --noEmit` in apps/web-portal to verify types compile.</verify>
  <done>Web-portal can import all 5 new tables and their TypeScript types from lib/db.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes in packages/database
2. `npx tsc --noEmit` passes in apps/web-portal
3. schema.ts contains all 5 new tables with proper foreign keys to organizations
4. All type exports exist
</verification>

<success_criteria>
- 5 new tables defined in schema.ts with correct column types, foreign keys, and indexes
- Types exported and available in both workspaces
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-client-context-support/12-01-SUMMARY.md`
</output>
