---
phase: 08-production-security-compliance
plan: 05
type: execute
wave: 2
depends_on: ["08-02"]
files_modified:
  - apps/web-portal/lib/gdpr/data-export.ts
  - apps/web-portal/app/api/gdpr/export/route.ts
  - apps/web-portal/app/dashboard/settings/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can request data export from dashboard settings"
    - "API endpoint returns JSON with all user data from all tables"
    - "Data export is logged in audit trail"
    - "Export includes user info, preferences, activity, and integrations"
  artifacts:
    - path: "apps/web-portal/lib/gdpr/data-export.ts"
      provides: "Data aggregation logic for GDPR export"
      exports: ["exportUserData", "ExportedUserData"]
    - path: "apps/web-portal/app/api/gdpr/export/route.ts"
      provides: "GDPR data export API endpoint"
      exports: ["GET"]
  key_links:
    - from: "apps/web-portal/app/api/gdpr/export/route.ts"
      to: "apps/web-portal/lib/gdpr/data-export.ts"
      via: "exportUserData function call"
      pattern: "exportUserData"
    - from: "apps/web-portal/app/api/gdpr/export/route.ts"
      to: "apps/web-portal/lib/audit.ts"
      via: "audit logging"
      pattern: "logAuditEvent|auditDataExport"
---

<objective>
Implement GDPR-compliant data export endpoint allowing users to download all their personal data.

Purpose: GDPR Article 20 grants users the right to data portability - receiving their personal data in a structured, commonly used, machine-readable format (JSON). This endpoint aggregates all user data across tables for download.

Output: Data export service, API endpoint, and UI button in dashboard settings
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-production-security-compliance/08-RESEARCH.md
@.planning/phases/08-production-security-compliance/08-02-SUMMARY.md
@packages/database/src/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create data export service</name>
  <files>apps/web-portal/lib/gdpr/data-export.ts</files>
  <action>
Create apps/web-portal/lib/gdpr/data-export.ts:

1. Import db from '@/lib/db'
2. Import all relevant tables from '@slack-speak/database':
   - users, workspaces, watchedConversations, userStylePreferences
   - personContext, refinementFeedback, suggestionFeedback, gdprConsent
   - reportSettings, googleIntegrations, workflowConfig, messageEmbeddings
   - threadParticipants

3. Define ExportedUserData interface:
```typescript
export interface ExportedUserData {
  exportedAt: string;
  user: {
    id: string;
    slackUserId: string;
    email: string | null;
    role: string | null;
    createdAt: string;
  };
  workspace: {
    id: string;
    name: string | null;
    teamId: string;
  };
  preferences: {
    stylePreferences: object | null;
    reportSettings: object | null;
    personContexts: object[];
  };
  activity: {
    watchedConversations: object[];
    suggestionFeedback: object[];
    refinementFeedback: object[];
    threadParticipants: object[];
  };
  integrations: {
    googleConnected: boolean;
    spreadsheetName: string | null;
    workflowConfigs: object[];
  };
  consent: {
    records: object[];
  };
  messageHistory: {
    embeddingCount: number;
    // Don't export raw embeddings - just count
  };
}
```

4. Create exportUserData(userId: string, workspaceId: string, slackUserId: string) function:
   - Query all tables for user's data using workspaceId + slackUserId filters
   - Format dates as ISO strings
   - Redact sensitive fields (OAuth tokens - just indicate "connected")
   - Return structured ExportedUserData object

Use eq and and from drizzle-orm for filtering.
  </action>
  <verify>
TypeScript compiles without errors.
Function exports correctly.
  </verify>
  <done>
Data export service aggregates all user data from 12+ tables into portable JSON format.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GDPR export API endpoint</name>
  <files>apps/web-portal/app/api/gdpr/export/route.ts</files>
  <action>
Create apps/web-portal/app/api/gdpr/export/route.ts:

1. Import getSession from '@/lib/auth/session'
2. Import exportUserData from '@/lib/gdpr/data-export'
3. Import auditDataExport from '@/lib/audit' (or logAuditEvent)
4. Import NextRequest/NextResponse from 'next/server'

Create GET handler:
1. Get session and validate authenticated user
2. Return 401 if not authenticated
3. Log audit event: data_export_requested
4. Call exportUserData with session.userId, session.workspaceId, session.slackUserId
5. Log audit event: data_export_completed
6. Return JSON response with:
   - Content-Type: application/json
   - Content-Disposition: attachment; filename="speak-for-me-data-export.json"
   - The exported data

Handle errors:
- Catch and log errors
- Return 500 with generic error message (don't leak details)

Note: This endpoint could be resource-intensive for users with lots of data. The research suggests queuing large exports, but for MVP we'll do synchronous export since data volume is likely small.
  </action>
  <verify>
Start dev server.
Authenticate via /login.
Call endpoint: `curl http://localhost:3001/api/gdpr/export` (with auth cookie).
Should return JSON with user data or 401 if not authenticated.
  </verify>
  <done>
GDPR export endpoint returns user's data as downloadable JSON file with audit logging.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add export button to dashboard settings</name>
  <files>apps/web-portal/app/dashboard/settings/page.tsx</files>
  <action>
First, check if settings page exists. If not, create a basic settings page.

Add a "Data & Privacy" section to the settings page:

1. Add section with heading "Data & Privacy"
2. Add "Export My Data" card/section:
   - Description: "Download a copy of all your personal data stored by Speak for Me"
   - Button: "Export Data" that triggers download

3. Button behavior:
   - On click, fetch /api/gdpr/export
   - If successful, trigger browser download of JSON file
   - Show loading state while fetching
   - Show error toast on failure

Implementation:
```typescript
const handleExportData = async () => {
  setExporting(true);
  try {
    const response = await fetch('/api/gdpr/export');
    if (!response.ok) throw new Error('Export failed');

    const data = await response.json();
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'speak-for-me-data-export.json';
    a.click();
    URL.revokeObjectURL(url);

    toast.success('Data exported successfully');
  } catch (error) {
    toast.error('Failed to export data');
  } finally {
    setExporting(false);
  }
};
```

If creating new settings page, include basic layout with sidebar navigation context.
  </action>
  <verify>
Navigate to dashboard settings page.
Click "Export Data" button.
JSON file downloads with user's data.
  </verify>
  <done>
Users can export their data from dashboard settings with one click.
  </done>
</task>

</tasks>

<verification>
1. Build web-portal: `npm run build --workspace=web-portal` - no errors
2. Login to dashboard
3. Navigate to settings
4. Click "Export Data" button
5. JSON file downloads with structured user data
6. Check database for audit log entry
</verification>

<success_criteria>
- Data export service aggregates data from all user tables
- API endpoint returns JSON with all user data
- Audit logging tracks export request and completion
- Dashboard settings has working "Export Data" button
- Downloaded JSON is well-structured and human-readable
</success_criteria>

<output>
After completion, create `.planning/phases/08-production-security-compliance/08-05-SUMMARY.md`
</output>
