---
phase: 08-production-security-compliance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web-portal/next.config.ts
  - apps/web-portal/components/cookie-consent.tsx
  - apps/web-portal/app/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Security headers (CSP, HSTS, X-Frame-Options) are present on all HTTP responses"
    - "Cookie consent banner appears on first visit when no consent cookie exists"
    - "Accepting consent sets a cookie and hides banner"
    - "Declining consent sets a cookie and hides banner"
  artifacts:
    - path: "apps/web-portal/next.config.ts"
      provides: "Security headers configuration"
      contains: "Content-Security-Policy"
    - path: "apps/web-portal/components/cookie-consent.tsx"
      provides: "Cookie consent banner component"
      exports: ["CookieConsentBanner"]
  key_links:
    - from: "apps/web-portal/app/layout.tsx"
      to: "CookieConsentBanner"
      via: "component import and render"
      pattern: "CookieConsentBanner"
---

<objective>
Configure HTTP security headers and implement cookie consent banner for GDPR compliance.

Purpose: Protect users with security headers and ensure GDPR-compliant cookie handling. Security headers prevent XSS, clickjacking, and MIME sniffing attacks. Cookie consent ensures compliance with GDPR requirements for tracking cookies.

Output: next.config.ts with security headers, CookieConsentBanner component, updated layout.tsx
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-production-security-compliance/08-RESEARCH.md
@apps/web-portal/next.config.ts
@apps/web-portal/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add security headers to Next.js config</name>
  <files>apps/web-portal/next.config.ts</files>
  <action>
Update next.config.ts to add security headers using the headers() async function:

1. Add `securityHeaders` array with:
   - Strict-Transport-Security: `max-age=63072000; includeSubDomains; preload`
   - X-Content-Type-Options: `nosniff`
   - X-Frame-Options: `SAMEORIGIN`
   - X-XSS-Protection: `1; mode=block` (legacy browser support)
   - Referrer-Policy: `strict-origin-when-cross-origin`
   - Permissions-Policy: `camera=(), microphone=(), geolocation=()`
   - Content-Security-Policy with:
     - `default-src 'self'`
     - `script-src 'self' 'unsafe-inline' 'unsafe-eval' https://js.stripe.com` (Stripe requires unsafe-eval)
     - `style-src 'self' 'unsafe-inline' https://fonts.googleapis.com`
     - `img-src 'self' data: https: blob:`
     - `font-src 'self' https://fonts.gstatic.com`
     - `connect-src 'self' https://api.stripe.com`
     - `frame-src 'self' https://js.stripe.com`
     - `frame-ancestors 'self'`

2. Add `async headers()` function returning headers for `/:path*` pattern

Keep existing `output: 'standalone'` and `transpilePackages` config.
  </action>
  <verify>
Run `npm run build --workspace=web-portal` and verify no build errors.
Start dev server and check response headers with: `curl -I http://localhost:3001 | grep -i "content-security-policy\|strict-transport\|x-frame"`.
  </verify>
  <done>
Security headers are configured: CSP, HSTS, X-Frame-Options, X-Content-Type-Options, Referrer-Policy, Permissions-Policy all present in HTTP responses.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create cookie consent banner component</name>
  <files>apps/web-portal/components/cookie-consent.tsx</files>
  <action>
Install react-cookie-consent in web-portal workspace:
```bash
npm install react-cookie-consent --workspace=web-portal
```

Create CookieConsentBanner component:

1. Mark as 'use client' (client-side only for cookie detection)
2. Use react-cookie-consent's CookieConsent component and getCookieConsentValue
3. Only show banner if cookie-consent cookie doesn't exist (check in useEffect)
4. Configure:
   - location="bottom"
   - cookieName="cookie-consent"
   - expires=365
   - enableDeclineButton
   - flipButtons (Accept on right)
   - buttonText="Accept All"
   - declineButtonText="Essential Only"
5. Style to match app design:
   - Dark slate background (#1e293b)
   - Blue accept button (#3b82f6)
   - Ghost-style decline button with border
   - Include link to /privacy page
6. onAccept callback: placeholder for future analytics init
7. onDecline callback: placeholder for analytics opt-out

Export CookieConsentBanner as named export.
  </action>
  <verify>
File exists at apps/web-portal/components/cookie-consent.tsx with CookieConsentBanner export.
TypeScript compiles without errors.
  </verify>
  <done>
CookieConsentBanner component exists with accept/decline functionality, styled appropriately, and links to privacy policy.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add cookie consent banner to root layout</name>
  <files>apps/web-portal/app/layout.tsx</files>
  <action>
1. Import CookieConsentBanner from '@/components/cookie-consent'
2. Add CookieConsentBanner component after Toaster in the body
3. Ensure proper placement (after children, before closing body tag)

The banner will only render on client side when consent hasn't been given.
  </action>
  <verify>
Start dev server: `npm run dev --workspace=web-portal`
Visit http://localhost:3001 in incognito window (no cookies)
Cookie consent banner should appear at bottom of page.
Click "Accept All" or "Essential Only" - banner should disappear.
Refresh page - banner should NOT appear (cookie is set).
  </verify>
  <done>
Cookie consent banner renders on first visit, disappears after user makes choice, and doesn't reappear on subsequent visits.
  </done>
</task>

</tasks>

<verification>
1. Build web-portal: `npm run build --workspace=web-portal` - no errors
2. Check security headers in response:
   ```bash
   curl -I http://localhost:3001 2>&1 | grep -E "(content-security|strict-transport|x-frame|x-content-type|referrer-policy)"
   ```
3. Test cookie consent in incognito browser - banner appears, accepts, persists across refresh
</verification>

<success_criteria>
- Security headers present on all routes (CSP, HSTS, X-Frame-Options, X-Content-Type-Options)
- Cookie consent banner appears for users without consent cookie
- Accept/decline both set cookie and hide banner
- Banner doesn't reappear after choice made
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/08-production-security-compliance/08-01-SUMMARY.md`
</output>
