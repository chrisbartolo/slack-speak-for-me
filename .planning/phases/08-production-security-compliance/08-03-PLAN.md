---
phase: 08-production-security-compliance
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/slack-backend/src/middleware/rate-limiter.ts
  - apps/slack-backend/src/app.ts
  - apps/web-portal/app/api/middleware.ts
autonomous: true

must_haves:
  truths:
    - "Rate limiting applies to all public API endpoints"
    - "Rate limit info is returned in response headers (X-RateLimit-*)"
    - "Exceeding rate limit returns 429 Too Many Requests"
    - "Rate limits are distributed (use Redis store)"
  artifacts:
    - path: "apps/slack-backend/src/middleware/rate-limiter.ts"
      provides: "Rate limiting middleware with Redis store"
      exports: ["apiRateLimiter", "authRateLimiter"]
  key_links:
    - from: "apps/slack-backend/src/app.ts"
      to: "rate-limiter middleware"
      via: "Express app.use() registration"
      pattern: "apiRateLimiter"
---

<objective>
Implement rate limiting for API endpoints to prevent abuse and ensure fair usage.

Purpose: Rate limiting protects the application from abuse, denial-of-service attacks, and excessive API usage. Using Redis for distributed rate limiting ensures limits work correctly across multiple server instances.

Output: Rate limiting middleware for slack-backend, applied to all routes
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-production-security-compliance/08-RESEARCH.md
@apps/slack-backend/src/app.ts
@apps/slack-backend/src/jobs/connection.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install rate limiting packages</name>
  <files>apps/slack-backend/package.json</files>
  <action>
Install express-rate-limit and rate-limit-redis in slack-backend workspace:

```bash
npm install express-rate-limit rate-limit-redis --workspace=slack-backend
```

Note: The project already uses ioredis via BullMQ, so no need to install ioredis separately.
  </action>
  <verify>
Check package.json includes express-rate-limit and rate-limit-redis.
`npm ls express-rate-limit --workspace=slack-backend` shows package installed.
  </verify>
  <done>
Rate limiting packages installed in slack-backend workspace.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create rate limiting middleware</name>
  <files>apps/slack-backend/src/middleware/rate-limiter.ts</files>
  <action>
Create apps/slack-backend/src/middleware/rate-limiter.ts:

1. Import rateLimit from 'express-rate-limit'
2. Import RedisStore from 'rate-limit-redis'
3. Import Redis from 'ioredis'
4. Import env configuration (REDIS_HOST, REDIS_PORT, REDIS_URL, REDIS_TLS)

Create Redis client for rate limiting:
- Use existing REDIS_URL or REDIS_HOST/REDIS_PORT pattern from env
- Handle TLS configuration like jobs/connection.ts does

Create rate limiters:

a) General API limiter (apiRateLimiter):
   - windowMs: 15 * 60 * 1000 (15 minutes)
   - max: 100 requests per window per IP
   - standardHeaders: true (return X-RateLimit-* headers)
   - legacyHeaders: false
   - prefix: 'rl:api:'
   - message: { error: 'Too many requests, please try again later.' }

b) Auth rate limiter (authRateLimiter):
   - windowMs: 60 * 60 * 1000 (1 hour)
   - max: 10 attempts per hour per IP
   - prefix: 'rl:auth:'
   - message: { error: 'Too many authentication attempts.' }

c) GDPR rate limiter (gdprRateLimiter):
   - windowMs: 24 * 60 * 60 * 1000 (24 hours)
   - max: 5 requests per day per IP
   - prefix: 'rl:gdpr:'
   - message: { error: 'Data export/deletion limit reached. Try again tomorrow.' }

Export all three limiters.

Handle connection errors gracefully - if Redis is unavailable, fall back to memory store with a warning.
  </action>
  <verify>
TypeScript compiles without errors.
File exports apiRateLimiter, authRateLimiter, gdprRateLimiter.
  </verify>
  <done>
Rate limiting middleware created with three tiers: general API, auth, and GDPR endpoints.
  </done>
</task>

<task type="auto">
  <name>Task 3: Apply rate limiting to slack-backend routes</name>
  <files>apps/slack-backend/src/app.ts</files>
  <action>
Update apps/slack-backend/src/app.ts to apply rate limiting:

1. Import apiRateLimiter from './middleware/rate-limiter.js'
2. Apply apiRateLimiter to all routes BEFORE the Slack app routes:
   - Apply to /health route
   - Apply to /oauth routes (consider using authRateLimiter for OAuth start)
   - The Slack event routes (/slack/events, /slack/actions) have their own rate limiting via Slack's infrastructure

Apply middleware order:
1. Express JSON/URL encoded parsers (already exists)
2. Rate limiter (new)
3. Slack app receiver routes (already exists)
4. Other routes

Note: Don't apply rate limiting to Slack webhook endpoints - Slack has its own rate limiting and we need to accept all valid webhook requests. Only apply to user-facing endpoints like OAuth and health.

```typescript
// Apply rate limiting to non-Slack routes
app.use('/health', apiRateLimiter);
app.use('/oauth', authRateLimiter);
```
  </action>
  <verify>
Start the server: `npm run dev --workspace=slack-backend`
Test rate limiting:
```bash
# Should return rate limit headers
curl -I http://localhost:3000/health
# Check for X-RateLimit-Limit, X-RateLimit-Remaining headers
```
  </verify>
  <done>
Rate limiting applied to appropriate routes with Redis-backed distributed limiting.
  </done>
</task>

</tasks>

<verification>
1. Build slack-backend: `npm run build --workspace=slack-backend` - no errors
2. Start server and verify rate limit headers:
   ```bash
   curl -I http://localhost:3000/health 2>&1 | grep -i "x-ratelimit"
   ```
3. Verify rate limiting works by making many requests (should see 429 after limit)
</verification>

<success_criteria>
- express-rate-limit and rate-limit-redis packages installed
- Rate limiting middleware created with Redis store
- Rate limit headers returned on responses
- Different limits for API, auth, and GDPR endpoints
- Exceeding limit returns 429 status
</success_criteria>

<output>
After completion, create `.planning/phases/08-production-security-compliance/08-03-SUMMARY.md`
</output>
