---
phase: 08-production-security-compliance
plan: 07
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/security.yml
  - audit-ci.jsonc
autonomous: true

must_haves:
  truths:
    - "Security workflow runs on push to main and PRs to main"
    - "Vulnerability scan runs before npm ci (before postinstall scripts)"
    - "Workflow fails if moderate or higher vulnerabilities found"
    - "Weekly scheduled scan runs to catch new CVEs"
  artifacts:
    - path: ".github/workflows/security.yml"
      provides: "GitHub Actions security scanning workflow"
      contains: "audit-ci"
    - path: "audit-ci.jsonc"
      provides: "audit-ci configuration with thresholds"
      contains: "moderate"
  key_links:
    - from: ".github/workflows/security.yml"
      to: "audit-ci.jsonc"
      via: "--config flag"
      pattern: "audit-ci.*--config.*audit-ci.jsonc"
---

<objective>
Set up automated dependency vulnerability scanning in CI pipeline using audit-ci.

Purpose: Dependency vulnerabilities are a major attack vector. Running security scans in CI ensures vulnerabilities are caught before merge, and weekly scheduled scans catch newly discovered CVEs in existing dependencies.

Output: GitHub Actions workflow for security scanning with audit-ci configuration
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-production-security-compliance/08-RESEARCH.md
@.github/workflows/test.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create audit-ci configuration file</name>
  <files>audit-ci.jsonc</files>
  <action>
Create audit-ci.jsonc in the repository root:

```jsonc
{
  "$schema": "https://github.com/IBM/audit-ci/raw/main/docs/schema.json",
  // Fail on moderate or higher vulnerabilities
  "moderate": true,
  // Output format
  "output-format": "text",
  // Allow specific advisories if needed (with justification)
  "allowlist": [
    // Example: "GHSA-xxxx-xxxx-xxxx" // Reason: No fix available, mitigated by X
  ],
  // Skip dev dependencies for faster scans (optional - comment out to include)
  // "skip-dev": true
}
```

The file uses JSONC (JSON with comments) format which audit-ci supports.
Setting "moderate": true means the scan fails on moderate, high, or critical severity vulnerabilities.
  </action>
  <verify>
File exists at repository root: audit-ci.jsonc
JSON syntax is valid.
  </verify>
  <done>
audit-ci configuration file created with moderate severity threshold.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create security scanning workflow</name>
  <files>.github/workflows/security.yml</files>
  <action>
Create .github/workflows/security.yml:

```yaml
name: Security

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Allow manual triggers

jobs:
  dependency-audit:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # IMPORTANT: Run audit BEFORE npm ci to avoid executing potentially malicious postinstall scripts
      - name: Audit dependencies
        run: npx audit-ci@^7 --config ./audit-ci.jsonc

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      # Run npm audit for additional report (doesn't fail build)
      - name: Generate npm audit report
        run: npm audit --audit-level=moderate || true
        continue-on-error: true

  # Create issue for new vulnerabilities found on scheduled runs
  notify-on-failure:
    needs: dependency-audit
    if: failure() && github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - name: Create security issue
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'security,automated',
              state: 'open'
            });

            // Don't create duplicate issues
            const existingIssue = issues.data.find(
              issue => issue.title.includes('Dependency vulnerabilities detected')
            );

            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸ”’ Security: Dependency vulnerabilities detected',
                body: `## Automated Security Scan Failed

The weekly security scan found vulnerabilities in project dependencies.

**Action Required:**
1. Run \`npm audit\` locally to see details
2. Update vulnerable packages with \`npm update\` or \`npm audit fix\`
3. If no fix is available, add advisory to allowlist in \`audit-ci.jsonc\` with justification

**Workflow Run:** [View Details](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})

---
*This issue was automatically created by the security workflow.*`,
                labels: ['security', 'automated', 'dependencies']
              });
            }
```

Key points:
- Runs audit-ci BEFORE npm ci (security best practice)
- Uses npx to always get latest audit-ci
- Weekly scheduled scan catches new CVEs
- Creates GitHub issue on scheduled failure (not on PR/push)
- Checks for existing open issue to avoid duplicates
  </action>
  <verify>
File exists at .github/workflows/security.yml
YAML syntax is valid.
Workflow defines dependency-audit and notify-on-failure jobs.
  </verify>
  <done>
Security workflow created with audit-ci scanning on push, PR, and weekly schedule.
  </done>
</task>

<task type="auto">
  <name>Task 3: Test vulnerability scanning locally</name>
  <files>package.json</files>
  <action>
Add audit-ci as a dev dependency at root level for local testing:

```bash
npm install -D audit-ci
```

Add npm script for local security scanning:

```json
"scripts": {
  "security": "audit-ci --config ./audit-ci.jsonc"
}
```

Run local test:
```bash
npm run security
```

This allows developers to run the same security check locally before pushing.

If vulnerabilities are found:
1. Try `npm audit fix` to auto-fix what's possible
2. For unfixable issues, evaluate risk and add to allowlist with justification
3. Document any allowlisted vulnerabilities in PR description
  </action>
  <verify>
Run `npm run security` locally.
If no vulnerabilities: command exits 0.
If vulnerabilities found: command exits non-zero and shows which packages.
  </verify>
  <done>
Local security scanning enabled with npm run security command.
  </done>
</task>

</tasks>

<verification>
1. Run `npm run security` locally - should pass or show vulnerabilities
2. Push changes to branch and create PR
3. Check GitHub Actions - security workflow should run
4. Verify workflow runs audit-ci before npm ci
5. If vulnerabilities exist, workflow should fail with details
</verification>

<success_criteria>
- audit-ci.jsonc configuration exists with moderate threshold
- Security workflow runs on push, PR, and weekly schedule
- Audit runs before npm ci (before postinstall scripts)
- Local npm run security command works
- Weekly failures create GitHub issues
</success_criteria>

<output>
After completion, create `.planning/phases/08-production-security-compliance/08-07-SUMMARY.md`
</output>
