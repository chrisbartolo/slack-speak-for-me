---
phase: 08-production-security-compliance
plan: 06
type: execute
wave: 2
depends_on: ["08-02"]
files_modified:
  - apps/web-portal/lib/gdpr/data-deletion.ts
  - apps/web-portal/app/api/gdpr/delete/route.ts
  - apps/web-portal/app/dashboard/settings/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can request account deletion from dashboard settings"
    - "API endpoint deletes all user data from all tables"
    - "Deletion is transactional (all or nothing)"
    - "Data deletion is logged in audit trail"
    - "User is logged out after deletion"
  artifacts:
    - path: "apps/web-portal/lib/gdpr/data-deletion.ts"
      provides: "Data deletion logic for GDPR right to be forgotten"
      exports: ["deleteUserData"]
    - path: "apps/web-portal/app/api/gdpr/delete/route.ts"
      provides: "GDPR data deletion API endpoint"
      exports: ["POST"]
  key_links:
    - from: "apps/web-portal/app/api/gdpr/delete/route.ts"
      to: "apps/web-portal/lib/gdpr/data-deletion.ts"
      via: "deleteUserData function call"
      pattern: "deleteUserData"
    - from: "apps/web-portal/app/api/gdpr/delete/route.ts"
      to: "apps/web-portal/lib/audit.ts"
      via: "audit logging"
      pattern: "logAuditEvent|auditDataDeletion"
---

<objective>
Implement GDPR-compliant data deletion endpoint allowing users to exercise their "right to be forgotten".

Purpose: GDPR Article 17 grants users the right to erasure - having all their personal data deleted. This endpoint removes user data from all tables in the correct order to respect foreign key constraints, while preserving anonymized audit records for compliance.

Output: Data deletion service, API endpoint, and confirmation flow in dashboard settings
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/08-production-security-compliance/08-RESEARCH.md
@.planning/phases/08-production-security-compliance/08-02-SUMMARY.md
@packages/database/src/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create data deletion service</name>
  <files>apps/web-portal/lib/gdpr/data-deletion.ts</files>
  <action>
Create apps/web-portal/lib/gdpr/data-deletion.ts:

1. Import db from '@/lib/db'
2. Import all user data tables from '@slack-speak/database':
   - users, watchedConversations, userStylePreferences, personContext
   - refinementFeedback, suggestionFeedback, gdprConsent, reportSettings
   - googleIntegrations, workflowConfig, messageEmbeddings, threadParticipants

3. Create deleteUserData(userId: string, workspaceId: string, slackUserId: string) function:

The function must delete in order respecting foreign key constraints (tables with no FKs first):

```typescript
export async function deleteUserData(
  userId: string,
  workspaceId: string,
  slackUserId: string
): Promise<void> {
  await db.transaction(async (tx) => {
    // Delete from tables with no foreign keys pointing to them
    // Order matters for FK constraints

    // Message embeddings (no FKs)
    await tx.delete(messageEmbeddings)
      .where(and(
        eq(messageEmbeddings.workspaceId, workspaceId),
        eq(messageEmbeddings.userId, slackUserId)
      ));

    // Thread participants
    await tx.delete(threadParticipants)
      .where(and(
        eq(threadParticipants.workspaceId, workspaceId),
        eq(threadParticipants.userId, slackUserId)
      ));

    // Watched conversations
    await tx.delete(watchedConversations)
      .where(and(
        eq(watchedConversations.workspaceId, workspaceId),
        eq(watchedConversations.userId, slackUserId)
      ));

    // Style preferences
    await tx.delete(userStylePreferences)
      .where(and(
        eq(userStylePreferences.workspaceId, workspaceId),
        eq(userStylePreferences.userId, slackUserId)
      ));

    // Person context
    await tx.delete(personContext)
      .where(and(
        eq(personContext.workspaceId, workspaceId),
        eq(personContext.userId, slackUserId)
      ));

    // Refinement feedback
    await tx.delete(refinementFeedback)
      .where(and(
        eq(refinementFeedback.workspaceId, workspaceId),
        eq(refinementFeedback.userId, slackUserId)
      ));

    // Suggestion feedback
    await tx.delete(suggestionFeedback)
      .where(and(
        eq(suggestionFeedback.workspaceId, workspaceId),
        eq(suggestionFeedback.userId, slackUserId)
      ));

    // Report settings
    await tx.delete(reportSettings)
      .where(and(
        eq(reportSettings.workspaceId, workspaceId),
        eq(reportSettings.userId, slackUserId)
      ));

    // Google integrations
    await tx.delete(googleIntegrations)
      .where(and(
        eq(googleIntegrations.workspaceId, workspaceId),
        eq(googleIntegrations.userId, slackUserId)
      ));

    // Workflow config
    await tx.delete(workflowConfig)
      .where(and(
        eq(workflowConfig.workspaceId, workspaceId),
        eq(workflowConfig.userId, slackUserId)
      ));

    // Mark consent as revoked (keep for compliance records, remove personal data)
    await tx.update(gdprConsent)
      .set({ revokedAt: new Date() })
      .where(and(
        eq(gdprConsent.workspaceId, workspaceId),
        eq(gdprConsent.userId, slackUserId)
      ));

    // Finally delete user record
    await tx.delete(users)
      .where(eq(users.id, userId));
  });
}
```

Transaction ensures atomicity - if any delete fails, all are rolled back.
  </action>
  <verify>
TypeScript compiles without errors.
Function exports correctly.
  </verify>
  <done>
Data deletion service removes all user data transactionally while preserving anonymized consent records.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GDPR deletion API endpoint</name>
  <files>apps/web-portal/app/api/gdpr/delete/route.ts</files>
  <action>
Create apps/web-portal/app/api/gdpr/delete/route.ts:

1. Import getSession and destroySession from '@/lib/auth/session'
2. Import deleteUserData from '@/lib/gdpr/data-deletion'
3. Import logAuditEvent from '@/lib/audit'
4. Import NextRequest/NextResponse from 'next/server'

Create POST handler (POST for destructive action):

1. Get session and validate authenticated user
2. Return 401 if not authenticated
3. Require confirmation in request body: { confirm: "DELETE MY ACCOUNT" }
4. Return 400 if confirmation doesn't match
5. Log audit event: data_delete_requested
6. Call deleteUserData with session.userId, session.workspaceId, session.slackUserId
7. Log audit event: data_delete_completed (with anonymized user reference)
8. Destroy session (log out user)
9. Return success response with redirect hint to homepage

Error handling:
- Wrap in try/catch
- Log errors
- Return 500 with generic message

```typescript
export async function POST(request: NextRequest) {
  const session = await getSession();
  if (!session?.userId || !session?.workspaceId) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  const body = await request.json();
  if (body.confirm !== 'DELETE MY ACCOUNT') {
    return NextResponse.json(
      { error: 'Confirmation required. Send { confirm: "DELETE MY ACCOUNT" }' },
      { status: 400 }
    );
  }

  const { userId, workspaceId, slackUserId } = session;

  // Log request
  await logAuditEvent({
    action: 'data_delete_requested',
    userId: slackUserId,
    workspaceId,
    ipAddress: request.headers.get('x-forwarded-for') || undefined,
  });

  try {
    await deleteUserData(userId, workspaceId, slackUserId);

    // Log completion (user ID preserved for audit trail)
    await logAuditEvent({
      action: 'data_delete_completed',
      userId: slackUserId,
      workspaceId,
    });

    // Destroy session
    await destroySession();

    return NextResponse.json({
      success: true,
      message: 'Your account and all associated data have been deleted.',
      redirect: '/',
    });
  } catch (error) {
    console.error('Data deletion error:', error);
    return NextResponse.json(
      { error: 'Failed to delete data. Please contact support.' },
      { status: 500 }
    );
  }
}
```
  </action>
  <verify>
TypeScript compiles without errors.
Endpoint requires POST method.
Endpoint requires confirmation body.
  </verify>
  <done>
GDPR deletion endpoint deletes all user data and logs out user upon successful deletion.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add delete account UI to dashboard settings</name>
  <files>apps/web-portal/app/dashboard/settings/page.tsx</files>
  <action>
Update dashboard settings page to add "Delete Account" section:

1. Add "Danger Zone" section at bottom with red border/styling
2. Add "Delete Account" card:
   - Warning text: "This will permanently delete all your data including preferences, watched conversations, feedback history, and integrations. This action cannot be undone."
   - Button: "Delete My Account" (red/destructive style)

3. Button triggers confirmation dialog:
   - Use shadcn AlertDialog component
   - Title: "Are you absolutely sure?"
   - Description: "This will permanently delete your account and all associated data. You will be logged out immediately."
   - Input field: "Type DELETE MY ACCOUNT to confirm"
   - Cancel button
   - Delete button (disabled until confirmation text matches)

4. On confirm:
   - POST to /api/gdpr/delete with { confirm: "DELETE MY ACCOUNT" }
   - Show loading state
   - On success: toast success, redirect to homepage
   - On error: toast error message

Implementation notes:
- Use useState for dialog open state
- Use useState for confirmation input
- Compare input to "DELETE MY ACCOUNT" to enable delete button
- Use router.push('/') for redirect after deletion
  </action>
  <verify>
Navigate to dashboard settings.
Click "Delete My Account" in danger zone.
Dialog appears with confirmation input.
Button is disabled until typing "DELETE MY ACCOUNT".
Submitting makes API call and redirects on success.
  </verify>
  <done>
Users can delete their account with a confirmation flow from dashboard settings.
  </done>
</task>

</tasks>

<verification>
1. Build web-portal: `npm run build --workspace=web-portal` - no errors
2. Login to dashboard
3. Navigate to settings
4. Click "Delete My Account" in danger zone
5. Confirmation dialog appears
6. Type "DELETE MY ACCOUNT" to enable button
7. Click delete - data is removed, user is logged out
8. Verify user cannot login (account deleted)
9. Check database for audit log entries
</verification>

<success_criteria>
- Data deletion service removes data from all 12+ user tables
- Deletion is transactional (all-or-nothing)
- API endpoint requires confirmation text
- Audit logging tracks deletion request and completion
- User is logged out after deletion
- Dashboard settings has confirmation flow for deletion
</success_criteria>

<output>
After completion, create `.planning/phases/08-production-security-compliance/08-06-SUMMARY.md`
</output>
