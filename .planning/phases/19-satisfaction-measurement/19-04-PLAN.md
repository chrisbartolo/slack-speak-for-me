---
phase: 19-satisfaction-measurement
plan: 04
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - apps/web-portal/lib/admin/satisfaction-analytics.ts
  - apps/web-portal/app/api/admin/satisfaction/route.ts
autonomous: true

must_haves:
  truths:
    - "Query functions return health score trends, NPS distribution, survey stats, before/after comparison, and thumbs ratio"
    - "All queries are React-cached with 'server-only' import for Next.js server components"
    - "API route supports CSV export of satisfaction data"
    - "Before/after comparison shows baseline vs current health scores"
  artifacts:
    - path: "apps/web-portal/lib/admin/satisfaction-analytics.ts"
      provides: "7 cached query functions for satisfaction analytics"
      exports: ["getHealthScoreOverview", "getHealthScoreTrend", "getNPSDistribution", "getSurveyStats", "getBeforeAfterComparison", "getThumbsRatioTrend", "getUserHealthScores"]
    - path: "apps/web-portal/app/api/admin/satisfaction/route.ts"
      provides: "GET endpoint for satisfaction data with CSV export"
      exports: ["GET"]
  key_links:
    - from: "apps/web-portal/lib/admin/satisfaction-analytics.ts"
      to: "apps/web-portal/lib/db/index.ts"
      via: "db and schema imports"
      pattern: "import.*from.*lib/db"
    - from: "apps/web-portal/app/api/admin/satisfaction/route.ts"
      to: "apps/web-portal/lib/admin/satisfaction-analytics.ts"
      via: "query function imports"
      pattern: "import.*from.*satisfaction-analytics"
---

<objective>
Create the web portal query library for satisfaction analytics data, providing cached query functions used by both the admin dashboard page (server components) and the API route (CSV export).

Purpose: This library centralizes all satisfaction data queries in one module, following the established pattern from response-time-analytics.ts and communication-insights.ts.
Output: 7 cached query functions and 1 API route for satisfaction data.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-satisfaction-measurement/19-RESEARCH.md
@apps/web-portal/lib/admin/response-time-analytics.ts
@apps/web-portal/lib/admin/communication-insights.ts
@apps/web-portal/lib/db/index.ts
@apps/web-portal/app/api/admin/response-times/route.ts
@packages/database/src/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create satisfaction analytics query library</name>
  <files>apps/web-portal/lib/admin/satisfaction-analytics.ts</files>
  <action>
Create `apps/web-portal/lib/admin/satisfaction-analytics.ts` following the exact pattern of response-time-analytics.ts and communication-insights.ts:

Start with:
```typescript
import 'server-only';
import { cache } from 'react';
import { sql, eq, and, gte, desc, count } from 'drizzle-orm';
import { db, schema } from '../db';
```

Destructure needed tables:
```typescript
const { communicationHealthScores, satisfactionSurveys, suggestionFeedback, suggestionMetrics } = schema;
```

**Interface definitions:**

```typescript
export interface HealthScoreOverview {
  currentScore: number | null;       // Most recent team aggregate
  previousScore: number | null;      // Previous period team aggregate
  changePercent: number | null;      // % change
  totalUsersScored: number;
  insufficientDataUsers: number;     // Users below 5-suggestion threshold
  avgAcceptance: number | null;
  avgResponseTime: number | null;
  avgSentiment: number | null;
  avgSatisfaction: number | null;
  avgEngagement: number | null;
}

export interface HealthScoreTrendPoint {
  date: string;
  healthScore: number;
  acceptanceRate: number | null;
  avgResponseTimeMs: number | null;
  sentimentScore: number | null;
  satisfactionScore: number | null;
  engagementRate: number | null;
}

export interface NPSDistribution {
  promoters: number;
  passives: number;
  detractors: number;
  totalResponses: number;
  npsScore: number;               // % promoters - % detractors
  responseRate: number;           // completed / delivered
}

export interface SurveyStats {
  totalDelivered: number;
  totalCompleted: number;
  totalExpired: number;
  totalDismissed: number;
  avgRating: number | null;
  responseRate: number;
}

export interface BeforeAfterComparison {
  baselineScore: number | null;      // Avg health score during baseline (isBaseline=true)
  currentScore: number | null;       // Avg health score post-baseline (isBaseline=false)
  improvement: number | null;        // currentScore - baselineScore
  improvementPercent: number | null; // ((current - baseline) / baseline) * 100
  baselineWeeks: number;
  currentWeeks: number;
}

export interface ThumbsRatioPoint {
  date: string;
  thumbsUp: number;
  thumbsDown: number;
  total: number;
  ratio: number;                    // thumbsUp / total as 0-100
}

export interface UserHealthScore {
  userId: string;
  healthScore: number | null;
  acceptanceRate: number | null;
  engagementRate: number | null;
  totalSuggestions: number;
  isBaseline: boolean;
  scoreDate: string;
}
```

**7 query functions (all wrapped with `cache()`):**

1. **getHealthScoreOverview = cache(async (organizationId: string, workspaceId: string, days: number = 30): Promise<HealthScoreOverview>)**
   - Get most recent team aggregate score (userId IS NULL) from communicationHealthScores
   - Get previous team aggregate score (second most recent)
   - Count users scored vs insufficient data
   - Return overview with component averages from most recent score

2. **getHealthScoreTrend = cache(async (organizationId: string, workspaceId: string, weeks: number = 12): Promise<HealthScoreTrendPoint[]>)**
   - Query communicationHealthScores WHERE userId IS NULL (team aggregate) AND scoreDate >= weeks ago
   - ORDER BY scoreDate ASC
   - Return array of trend points with formatted dates (YYYY-MM-DD)

3. **getNPSDistribution = cache(async (organizationId: string, days: number = 90): Promise<NPSDistribution>)**
   - Query satisfactionSurveys WHERE organizationId and respondedAt >= days ago
   - Count promoters (rating 9-10), passives (7-8), detractors (0-6) using CASE WHEN
   - Calculate NPS = (promoters% - detractors%)
   - Count total delivered and completed for response rate

4. **getSurveyStats = cache(async (organizationId: string, days: number = 90): Promise<SurveyStats>)**
   - Count surveys by status (delivered, completed, expired, dismissed) WHERE organizationId
   - Calculate avg rating from completed surveys
   - responseRate = completed / delivered

5. **getBeforeAfterComparison = cache(async (organizationId: string, workspaceId: string): Promise<BeforeAfterComparison>)**
   - AVG(healthScore) WHERE isBaseline=true AND userId IS NULL (team aggregate baseline)
   - AVG(healthScore) WHERE isBaseline=false AND userId IS NULL (team post-baseline)
   - Count weeks in each period
   - Calculate improvement and improvement percent

6. **getThumbsRatioTrend = cache(async (organizationId: string, workspaceId: string, days: number = 90): Promise<ThumbsRatioPoint[]>)**
   - Query suggestionFeedback grouped by DATE(createdAt)
   - Count action='accepted' OR action='sent' as thumbsUp, action='dismissed' as thumbsDown
   - Use raw SQL: `SELECT DATE(created_at) as date, COUNT(*) FILTER (WHERE action IN ('accepted','sent')) as thumbs_up, COUNT(*) FILTER (WHERE action = 'dismissed') as thumbs_down FROM suggestion_feedback WHERE workspace_id = $1 AND created_at >= NOW() - INTERVAL '${days} days' GROUP BY DATE(created_at) ORDER BY date ASC`
   - Calculate ratio as (thumbsUp / total) * 100

7. **getUserHealthScores = cache(async (organizationId: string, workspaceId: string): Promise<UserHealthScore[]>)**
   - Get most recent health score per user (userId IS NOT NULL)
   - Use DISTINCT ON (userId) ORDER BY scoreDate DESC pattern in raw SQL
   - Return array sorted by healthScore DESC (best scores first)

Use raw SQL (db.execute(sql`...`)) for complex queries, following the pattern in response-time-analytics.ts. Use parameterized queries for all user inputs.
  </action>
  <verify>Run `npx tsc --noEmit --project apps/web-portal/tsconfig.json` to verify no type errors.</verify>
  <done>7 cached query functions created for satisfaction analytics, all following existing codebase patterns.</done>
</task>

<task type="auto">
  <name>Task 2: Create satisfaction API route for CSV export</name>
  <files>apps/web-portal/app/api/admin/satisfaction/route.ts</files>
  <action>
Create `apps/web-portal/app/api/admin/satisfaction/route.ts` following the exact pattern of `apps/web-portal/app/api/admin/response-times/route.ts`:

```typescript
import { NextRequest, NextResponse } from 'next/server';
import Papa from 'papaparse';
import { requireAdmin } from '@/lib/auth/admin';
import { getHealthScoreTrend, getUserHealthScores, getSurveyStats, getNPSDistribution } from '@/lib/admin/satisfaction-analytics';

export async function GET(request: NextRequest) {
  try {
    const session = await requireAdmin();
    if (!session.organizationId) {
      return NextResponse.json({ error: 'Organization not found' }, { status: 404 });
    }

    const searchParams = request.nextUrl.searchParams;
    const format = searchParams.get('format');
    const type = searchParams.get('type') || 'health-scores'; // 'health-scores' | 'surveys' | 'users'

    if (format === 'csv') {
      let data: any[];
      let filename: string;

      switch (type) {
        case 'users':
          data = await getUserHealthScores(session.organizationId, session.workspaceId);
          filename = 'user-health-scores';
          break;
        case 'surveys':
          // Return survey stats as single row
          const stats = await getSurveyStats(session.organizationId);
          const nps = await getNPSDistribution(session.organizationId);
          data = [{ ...stats, ...nps }];
          filename = 'satisfaction-surveys';
          break;
        default:
          data = await getHealthScoreTrend(session.organizationId, session.workspaceId, 52);
          filename = 'health-score-trends';
      }

      const csv = Papa.unparse(data, { header: true });
      return new NextResponse(csv, {
        headers: {
          'Content-Type': 'text/csv',
          'Content-Disposition': `attachment; filename="${filename}-${new Date().toISOString().split('T')[0]}.csv"`,
        },
      });
    }

    // Default JSON: return all data
    const [healthScoreTrend, userScores, surveyStats, npsDistribution] = await Promise.all([
      getHealthScoreTrend(session.organizationId, session.workspaceId),
      getUserHealthScores(session.organizationId, session.workspaceId),
      getSurveyStats(session.organizationId),
      getNPSDistribution(session.organizationId),
    ]);

    return NextResponse.json({ healthScoreTrend, userScores, surveyStats, npsDistribution });
  } catch (error) {
    console.error('Satisfaction API error:', error);
    return NextResponse.json({ error: 'Failed to fetch satisfaction data' }, { status: 500 });
  }
}
```

Ensure the directory `apps/web-portal/app/api/admin/satisfaction/` is created.
  </action>
  <verify>Run `npx tsc --noEmit --project apps/web-portal/tsconfig.json` to verify no type errors.</verify>
  <done>Satisfaction API route created with CSV export for health scores, user scores, and survey data.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit --project apps/web-portal/tsconfig.json` passes
- All 7 query functions export correctly from satisfaction-analytics.ts
- API route handles CSV export with format=csv query parameter
- API route handles different data types via type parameter
- All queries use parameterized SQL (no injection risk)
- Functions follow cache() wrapping pattern from existing analytics modules
</verification>

<success_criteria>
- 7 query functions: overview, trend, NPS distribution, survey stats, before/after, thumbs ratio, user scores
- API route with CSV export for 3 data types
- All queries scoped by organizationId for multi-tenant isolation
- Before/after comparison correctly separates baseline vs post-baseline scores
- NPS score calculated as promoters% minus detractors%
</success_criteria>

<output>
After completion, create `.planning/phases/19-satisfaction-measurement/19-04-SUMMARY.md`
</output>
