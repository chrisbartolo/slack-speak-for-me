---
phase: 19-satisfaction-measurement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/database/src/schema.ts
  - apps/web-portal/lib/db/index.ts
autonomous: true

must_haves:
  truths:
    - "satisfaction_surveys table exists with NPS rating (0-10), feedback text, and delivery/response tracking"
    - "communication_health_scores table exists with weighted component scores and composite health score"
    - "Both tables have organizationId for org-wide queries and proper indexes"
  artifacts:
    - path: "packages/database/src/schema.ts"
      provides: "satisfactionSurveys and communicationHealthScores table definitions"
      contains: "satisfactionSurveys"
    - path: "apps/web-portal/lib/db/index.ts"
      provides: "Schema exports for new tables"
      contains: "satisfactionSurveys"
  key_links:
    - from: "packages/database/src/schema.ts"
      to: "apps/web-portal/lib/db/index.ts"
      via: "schema import and re-export"
      pattern: "satisfactionSurveys|communicationHealthScores"
---

<objective>
Add satisfaction_surveys and communication_health_scores tables to the database schema for Phase 19 satisfaction measurement.

Purpose: These two tables are the foundation for all Phase 19 features -- survey delivery, health score computation, trend visualization, and before/after comparisons.
Output: Two new Drizzle ORM table definitions with proper indexes, types, and web portal schema registration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-satisfaction-measurement/19-RESEARCH.md
@packages/database/src/schema.ts
@apps/web-portal/lib/db/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add satisfactionSurveys and communicationHealthScores tables to schema.ts</name>
  <files>packages/database/src/schema.ts</files>
  <action>
Add two new tables at the end of schema.ts (before any closing exports), following existing patterns (uuid PKs, timestamp defaults, proper indexes):

**satisfactionSurveys table:**
- id: uuid PK defaultRandom
- organizationId: uuid, references organizations.id, notNull
- workspaceId: uuid, references workspaces.id, notNull
- userId: text, notNull (Slack user ID)
- surveyType: text, notNull (values: 'nps' | 'quarterly' | 'milestone')
- rating: integer (0-10, nullable until user responds)
- npsCategory: text (nullable, computed: 'promoter' | 'passive' | 'detractor')
- feedbackText: text (nullable, free-form user feedback)
- status: text, default 'delivered' (values: 'delivered' | 'completed' | 'expired' | 'dismissed')
- deliveredAt: timestamp, defaultNow, notNull
- respondedAt: timestamp (nullable)
- expiredAt: timestamp (nullable, set after 7 days if no response)
- slackMessageTs: text (nullable, for updating the original DM message)
- createdAt: timestamp, defaultNow, notNull
- Indexes: orgTimeIdx on (organizationId, deliveredAt), userIdx on (userId, deliveredAt), statusIdx on (status)
- Unique constraint: uniqueSurveyIdx on (workspaceId, userId, surveyType, deliveredAt) to prevent duplicate deliveries

**communicationHealthScores table:**
- id: uuid PK defaultRandom
- organizationId: uuid, references organizations.id, notNull
- workspaceId: uuid, references workspaces.id, notNull
- userId: text (nullable -- null means team aggregate, non-null means individual user score)
- scoreDate: timestamp, notNull (the start of the scoring period)
- scorePeriod: text, notNull (values: 'weekly' | 'monthly')
- healthScore: integer, notNull (0-100 composite)
- acceptanceRate: integer (0-100, nullable if insufficient data)
- avgResponseTimeMs: integer (nullable)
- avgSentimentScore: integer (0-100, nullable)
- avgSatisfactionScore: integer (0-100, nullable -- from NPS normalized)
- engagementRate: integer (0-100, nullable)
- totalSuggestions: integer, default 0 (data volume indicator)
- isBaseline: boolean, default false (true for first 30-day scores, used in before/after)
- createdAt: timestamp, defaultNow, notNull
- Indexes: orgDateIdx unique on (organizationId, userId, scoreDate, scorePeriod), userDateIdx on (userId, scoreDate), orgScoreIdx on (organizationId, healthScore)

Add type exports after each table:
```typescript
export type SatisfactionSurvey = typeof satisfactionSurveys.$inferSelect;
export type NewSatisfactionSurvey = typeof satisfactionSurveys.$inferInsert;
export type CommunicationHealthScore = typeof communicationHealthScores.$inferSelect;
export type NewCommunicationHealthScore = typeof communicationHealthScores.$inferInsert;
```

Use the same patterns as existing tables (e.g., topicClassifications, kbCandidates) -- pgTable, uuid, text, timestamp, integer, boolean, index, uniqueIndex from drizzle-orm/pg-core.
  </action>
  <verify>Run `npx tsc --noEmit --project packages/database/tsconfig.json` to verify no type errors in schema.</verify>
  <done>satisfactionSurveys and communicationHealthScores tables defined in schema.ts with all columns, indexes, and type exports.</done>
</task>

<task type="auto">
  <name>Task 2: Register new tables in web portal db/index.ts and push schema</name>
  <files>apps/web-portal/lib/db/index.ts</files>
  <action>
1. In apps/web-portal/lib/db/index.ts, add the new table imports from '@slack-speak/database':
   - Add `satisfactionSurveys` and `communicationHealthScores` to the import statement
   - Add both to the `schema` object
   - Add type exports: `SatisfactionSurvey, NewSatisfactionSurvey, CommunicationHealthScore, NewCommunicationHealthScore`

2. Run `npm run db:push --workspace=@slack-speak-for-me/database` to apply the schema changes to the database.

Follow the exact same pattern as existing entries (alphabetical ordering within the import, schema object, and type exports).
  </action>
  <verify>Run `npx tsc --noEmit --project apps/web-portal/tsconfig.json` to verify web portal compiles with new schema imports.</verify>
  <done>New tables registered in web portal schema, database migration applied, TypeScript compiles cleanly.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit --project packages/database/tsconfig.json` passes
- `npx tsc --noEmit --project apps/web-portal/tsconfig.json` passes
- Schema push completes without errors (or skipped if no local DB running)
- satisfactionSurveys and communicationHealthScores tables exist in schema.ts with correct columns and indexes
</verification>

<success_criteria>
- Two new tables defined with all specified columns, types, indexes, and constraints
- Type exports available for both tables
- Web portal can import and reference both tables
- Database schema pushed successfully
</success_criteria>

<output>
After completion, create `.planning/phases/19-satisfaction-measurement/19-01-SUMMARY.md`
</output>
