---
phase: 19-satisfaction-measurement
plan: 05
type: execute
wave: 3
depends_on: ["19-04"]
files_modified:
  - apps/web-portal/components/admin/satisfaction-charts.tsx
  - apps/web-portal/app/admin/satisfaction/page.tsx
  - apps/web-portal/components/dashboard/sidebar.tsx
  - apps/web-portal/components/dashboard/responsive-sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Admin satisfaction dashboard shows health score gauge, NPS distribution, trend charts, and before/after comparison"
    - "Thumbs up/down ratio trends visible over time as a chart"
    - "Before/after comparison shows baseline vs current with improvement percentage"
    - "User health scores table shows individual user scores with insufficient data state"
    - "Sidebar has Satisfaction link in Organization section"
    - "Manager can see team communication quality trends"
  artifacts:
    - path: "apps/web-portal/components/admin/satisfaction-charts.tsx"
      provides: "6 chart/visualization components for satisfaction dashboard"
      exports: ["HealthScoreGauge", "HealthScoreTrendChart", "NPSDistributionChart", "BeforeAfterCard", "ThumbsRatioChart", "UserHealthScoreTable"]
    - path: "apps/web-portal/app/admin/satisfaction/page.tsx"
      provides: "Admin satisfaction dashboard page with parallel data fetching"
      exports: ["default"]
    - path: "apps/web-portal/components/dashboard/sidebar.tsx"
      provides: "Updated sidebar with Satisfaction link"
      contains: "Satisfaction"
  key_links:
    - from: "apps/web-portal/app/admin/satisfaction/page.tsx"
      to: "apps/web-portal/lib/admin/satisfaction-analytics.ts"
      via: "direct imports of query functions"
      pattern: "getHealthScoreOverview|getHealthScoreTrend|getNPSDistribution"
    - from: "apps/web-portal/app/admin/satisfaction/page.tsx"
      to: "apps/web-portal/components/admin/satisfaction-charts.tsx"
      via: "chart component imports"
      pattern: "HealthScoreGauge|HealthScoreTrendChart|NPSDistributionChart"
    - from: "apps/web-portal/components/admin/satisfaction-charts.tsx"
      to: "apps/web-portal/lib/admin/satisfaction-analytics.ts"
      via: "type imports for component props"
      pattern: "import.*HealthScoreTrendPoint|NPSDistribution|BeforeAfterComparison|ThumbsRatioPoint|UserHealthScore"
    - from: "apps/web-portal/components/dashboard/sidebar.tsx"
      to: "apps/web-portal/app/admin/satisfaction/page.tsx"
      via: "navigation link"
      pattern: "/admin/satisfaction"
---

<objective>
Build the admin satisfaction dashboard with health score gauges, NPS distribution, trend charts, before/after comparison, and thumbs ratio visualization. Add Satisfaction link to the admin sidebar.

Purpose: This is the manager-facing dashboard showing team communication quality trends, enabling data-driven decisions about team communication health. It's the visible output of all Phase 19 backend work.
Output: Dashboard page with 6 chart components and sidebar navigation link.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-satisfaction-measurement/19-RESEARCH.md
@apps/web-portal/app/admin/communication-insights/page.tsx
@apps/web-portal/app/admin/response-times/page.tsx
@apps/web-portal/components/admin/communication-insights-charts.tsx
@apps/web-portal/components/admin/response-time-charts.tsx
@apps/web-portal/components/dashboard/sidebar.tsx
@apps/web-portal/components/dashboard/responsive-sidebar.tsx
@apps/web-portal/lib/admin/satisfaction-analytics.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create satisfaction chart components</name>
  <files>apps/web-portal/components/admin/satisfaction-charts.tsx</files>
  <action>
Create `apps/web-portal/components/admin/satisfaction-charts.tsx` with 'use client' directive. Follow the exact pattern from communication-insights-charts.tsx and response-time-charts.tsx:

Import from '@tremor/react': LineChart, BarChart, DonutChart, Card, Metric, Text, Flex, ProgressBar, Badge, Color.

Import types from satisfaction-analytics for proper prop typing. Each component MUST accept properly typed props imported from the analytics module:
```typescript
import type {
  HealthScoreTrendPoint,
  NPSDistribution,
  BeforeAfterComparison,
  ThumbsRatioPoint,
  UserHealthScore,
} from '@/lib/admin/satisfaction-analytics';
```

**1. HealthScoreGauge component:**
Props: { score: number | null; previousScore: number | null; changePercent: number | null }
- Display the current health score as a large number (use Tremor Metric component)
- Show a colored badge: green if >= 70, yellow if >= 40, red if < 40. Show "Insufficient Data" if null.
- Show change from previous: green up arrow if positive, red down arrow if negative
- Use a ProgressBar (0-100) with color based on score tier
- Show breakdown labels below: "Excellent (80-100)", "Good (60-79)", "Fair (40-59)", "Needs Attention (0-39)"

**2. HealthScoreTrendChart component:**
Props: { data: HealthScoreTrendPoint[] }
- Tremor LineChart with index="date"
- Categories: ['healthScore'] as primary line
- Additional optional toggle lines: acceptanceRate, sentimentScore, satisfactionScore, engagementRate (use multi-category LineChart)
- Colors: blue for health score, green for acceptance, purple for sentiment, orange for satisfaction, cyan for engagement
- Y-axis 0-100, show grid lines and legend
- className="h-80"
- If data is empty, show "No health score data yet" message

**3. NPSDistributionChart component:**
Props: { data: NPSDistribution }
- Tremor DonutChart showing promoters/passives/detractors as segments
- Colors: green for promoters, yellow for passives, red for detractors
- Show NPS score as the center label (formatted with + for positive)
- Below chart, show response rate as percentage text
- Category labels with counts

**4. BeforeAfterCard component:**
Props: { data: BeforeAfterComparison }
- Two columns: "Baseline" and "Current"
- Show baseline score and current score as large Metric numbers
- Arrow between them showing direction
- Improvement percentage in green (positive) or red (negative)
- Show weeks count for each period
- If either score is null, show "Insufficient data for comparison"

**5. ThumbsRatioChart component:**
Props: { data: ThumbsRatioPoint[] }
- Tremor LineChart with index="date"
- Show ratio (0-100) as primary line in blue
- Optionally show stacked area of thumbsUp (green) and thumbsDown (red)
- Y-axis 0-100 with label "Approval Rate %"
- If data is empty, show "No feedback data yet"

**6. UserHealthScoreTable component:**
Props: { data: UserHealthScore[] }
- HTML table (not TanStack -- simple list, following existing patterns)
- Columns: User ID, Health Score, Acceptance Rate, Engagement, Suggestions, Status
- Health Score column: colored badge (green/yellow/red), show "Insufficient" if null
- Status column: "Baseline" badge if isBaseline, otherwise "Active"
- Sort by healthScore descending (already sorted from query)
- If empty, show "No user scores available yet"

All components should handle empty/null data gracefully with placeholder messages.
  </action>
  <verify>Run `npx tsc --noEmit --project apps/web-portal/tsconfig.json` to verify no type errors.</verify>
  <done>6 chart components created with proper empty state handling, consistent Tremor styling, properly typed props from satisfaction-analytics, and data visualization.</done>
</task>

<task type="auto">
  <name>Task 2: Create dashboard page and add sidebar navigation</name>
  <files>apps/web-portal/app/admin/satisfaction/page.tsx, apps/web-portal/components/dashboard/sidebar.tsx, apps/web-portal/components/dashboard/responsive-sidebar.tsx</files>
  <action>
**1. Create dashboard page** at `apps/web-portal/app/admin/satisfaction/page.tsx`:

Follow the exact pattern of communication-insights/page.tsx:

```typescript
import { requireAdmin } from '@/lib/auth/admin';
import {
  getHealthScoreOverview,
  getHealthScoreTrend,
  getNPSDistribution,
  getSurveyStats,
  getBeforeAfterComparison,
  getThumbsRatioTrend,
  getUserHealthScores,
} from '@/lib/admin/satisfaction-analytics';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import {
  HealthScoreGauge,
  HealthScoreTrendChart,
  NPSDistributionChart,
  BeforeAfterCard,
  ThumbsRatioChart,
  UserHealthScoreTable,
} from '@/components/admin/satisfaction-charts';
import { Download } from 'lucide-react';
```

Server component (no 'use client'). Fetch all 7 data sources with Promise.all:
```typescript
const [overview, trend, npsDistribution, surveyStats, beforeAfter, thumbsRatio, userScores] = await Promise.all([
  getHealthScoreOverview(session.organizationId, session.workspaceId),
  getHealthScoreTrend(session.organizationId, session.workspaceId, 12),
  getNPSDistribution(session.organizationId),
  getSurveyStats(session.organizationId),
  getBeforeAfterComparison(session.organizationId, session.workspaceId),
  getThumbsRatioTrend(session.organizationId, session.workspaceId, 90),
  getUserHealthScores(session.organizationId, session.workspaceId),
]);
```

Layout with sections (use same p-6 space-y-6 pattern):

**Header** with title "Satisfaction & Health Scores", description, and CSV export link (Download icon button linking to /api/admin/satisfaction?format=csv)

**Row 1: Overview Cards** (3 columns on lg, 1 on mobile)
- Card 1: Health Score Gauge (HealthScoreGauge component with overview data)
- Card 2: NPS Score (NPSDistributionChart)
- Card 3: Survey Stats summary card (delivered, completed, response rate, avg rating)

**Row 2: Health Score Trend** (full width)
- Card with HealthScoreTrendChart

**Row 3: Before/After and Thumbs Ratio** (2 columns on lg)
- Card 1: BeforeAfterCard
- Card 2: ThumbsRatioChart

**Row 4: User Health Scores** (full width)
- Card with UserHealthScoreTable, title "Individual User Scores", link to CSV export for user scores (/api/admin/satisfaction?format=csv&type=users)

Wrap all data fetching in try/catch. On error, show "No satisfaction data available yet" with helpful message about when data appears (after first week of health score computation).

**2. Update sidebar** in `apps/web-portal/components/dashboard/sidebar.tsx`:
Add 'Satisfaction' to the Organization NavGroup items array, after 'Learning Loop':
```typescript
{ href: '/admin/satisfaction', label: 'Satisfaction' },
```

**3. Update responsive sidebar** in `apps/web-portal/components/dashboard/responsive-sidebar.tsx`:
If the responsive sidebar has a similar items array for Organization, add the same Satisfaction entry. Check the file first -- it may share the same items definition or have its own. Add consistently.
  </action>
  <verify>Run `npx tsc --noEmit --project apps/web-portal/tsconfig.json` to verify no type errors.</verify>
  <done>Admin satisfaction dashboard page created with 7 data visualizations, sidebar navigation link added for both desktop and mobile.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit --project apps/web-portal/tsconfig.json` passes
- Dashboard page renders with all 7 data sections
- Empty state handled gracefully (no crashes on zero data)
- Sidebar shows "Satisfaction" link in Organization section
- CSV export links work (3 types: health-scores, surveys, users)
- Health score gauge shows correct color tiers
- NPS distribution shows promoter/passive/detractor breakdown
- Before/after card shows improvement metrics
- Chart components import types from satisfaction-analytics (not using any/unknown)
</verification>

<success_criteria>
- Health score gauge with 0-100 progress bar and color coding (green/yellow/red)
- Health score trend chart shows 12-week history with optional metric overlay
- NPS distribution donut chart with promoter/passive/detractor segments
- Before/after comparison card shows baseline vs current improvement
- Thumbs ratio trend chart shows approval rate over time
- User health scores table with individual scores and insufficient data state
- Sidebar navigation link accessible to admin users
- All visualizations handle empty data with helpful messages
</success_criteria>

<output>
After completion, create `.planning/phases/19-satisfaction-measurement/19-05-SUMMARY.md`
</output>
