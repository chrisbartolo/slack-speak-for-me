---
phase: 07-monetization-pricing
plan: 07
type: execute
wave: 3
depends_on: ["07-04"]
files_modified:
  - apps/web-portal/lib/email/resend.ts
  - apps/web-portal/lib/email/templates.ts
  - apps/web-portal/app/api/stripe/webhook/route.ts
  - apps/slack-backend/src/jobs/email.ts
autonomous: true
user_setup:
  - service: resend
    why: "Transactional email delivery for billing notifications"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard -> API Keys -> Create API Key"
      - name: EMAIL_FROM
        source: "Configure in .env, e.g., 'Speak for Me <noreply@speakforme.app>'"
    dashboard_config:
      - task: "Verify domain for sending"
        location: "Resend Dashboard -> Domains -> Add Domain"

must_haves:
  truths:
    - "Trial ending email sent 3 days before trial expires"
    - "Subscription paused email sent when trial ends without payment"
    - "Payment failed email sent on invoice.payment_failed"
    - "Subscription resumed email sent when payment method added"
  artifacts:
    - path: "apps/web-portal/lib/email/resend.ts"
      provides: "Resend email client wrapper"
      exports: ["sendEmail"]
    - path: "apps/web-portal/lib/email/templates.ts"
      provides: "Email template functions for billing events"
      exports: ["trialEndingEmail", "subscriptionPausedEmail", "paymentFailedEmail", "subscriptionResumedEmail"]
    - path: "apps/web-portal/app/api/stripe/webhook/route.ts"
      provides: "Webhook handlers that trigger email sending"
      contains: "sendEmail"
  key_links:
    - from: "apps/web-portal/app/api/stripe/webhook/route.ts"
      to: "lib/email/resend.ts"
      via: "import sendEmail"
      pattern: "import.*sendEmail"
    - from: "apps/web-portal/lib/email/resend.ts"
      to: "Resend API"
      via: "resend.emails.send"
      pattern: "resend\\.emails\\.send"
---

<objective>
Implement email notification system for billing events using Resend.

Purpose: Users need to be notified about important billing events (trial ending, payment failed, subscription paused/resumed) to take action before losing access.
Output: Email infrastructure with templates for billing events, integrated into Stripe webhook handlers.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-monetization-pricing/07-RESEARCH.md
@.planning/phases/07-monetization-pricing/07-04-SUMMARY.md

@apps/web-portal/app/api/stripe/webhook/route.ts
@packages/database/src/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Resend email client and billing email templates</name>
  <files>
    apps/web-portal/lib/email/resend.ts
    apps/web-portal/lib/email/templates.ts
  </files>
  <action>
Set up email infrastructure with Resend:

1. Install Resend: `npm install resend --workspace=web-portal`

2. Create `apps/web-portal/lib/email/resend.ts`:
   ```typescript
   import 'server-only';
   import { Resend } from 'resend';

   const resend = new Resend(process.env.RESEND_API_KEY);

   interface SendEmailOptions {
     to: string;
     subject: string;
     html: string;
     text?: string;
   }

   export async function sendEmail(options: SendEmailOptions): Promise<{ success: boolean; error?: string }> {
     const from = process.env.EMAIL_FROM || 'Speak for Me <noreply@speakforme.app>';

     try {
       const { error } = await resend.emails.send({
         from,
         to: options.to,
         subject: options.subject,
         html: options.html,
         text: options.text,
       });

       if (error) {
         console.error('Email send error:', error);
         return { success: false, error: error.message };
       }

       return { success: true };
     } catch (err) {
       console.error('Email send exception:', err);
       return { success: false, error: err instanceof Error ? err.message : 'Unknown error' };
     }
   }
   ```

3. Create `apps/web-portal/lib/email/templates.ts`:
   ```typescript
   const baseUrl = process.env.NEXT_PUBLIC_APP_URL || 'https://speakforme.app';

   interface EmailTemplate {
     subject: string;
     html: string;
     text: string;
   }

   export function trialEndingEmail(daysRemaining: number): EmailTemplate {
     const subject = `Your Speak for Me trial ends in ${daysRemaining} days`;
     const html = `
       <h1>Your trial is ending soon</h1>
       <p>Your 14-day free trial of Speak for Me will end in <strong>${daysRemaining} days</strong>.</p>
       <p>To continue using AI-powered response suggestions without interruption, add a payment method now.</p>
       <p><a href="${baseUrl}/admin/billing" style="background-color: #4F46E5; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">Add Payment Method</a></p>
       <p>If you don't add a payment method, your subscription will be paused and you'll lose access to the app features.</p>
       <p>Questions? Reply to this email - we're here to help!</p>
     `;
     const text = `Your trial is ending soon\n\nYour 14-day free trial of Speak for Me will end in ${daysRemaining} days.\n\nTo continue using AI-powered response suggestions without interruption, add a payment method: ${baseUrl}/admin/billing\n\nIf you don't add a payment method, your subscription will be paused.`;

     return { subject, html, text };
   }

   export function subscriptionPausedEmail(): EmailTemplate {
     const subject = 'Your Speak for Me subscription has been paused';
     const html = `
       <h1>Your subscription is paused</h1>
       <p>Your trial has ended and we don't have a payment method on file, so your Speak for Me subscription has been paused.</p>
       <p>Your data is safe, but you won't be able to use the app features until you add a payment method.</p>
       <p><a href="${baseUrl}/admin/billing" style="background-color: #4F46E5; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">Resume Subscription</a></p>
       <p>When you add a payment method, your subscription will resume immediately.</p>
     `;
     const text = `Your subscription is paused\n\nYour trial has ended and we don't have a payment method on file.\n\nAdd a payment method to resume: ${baseUrl}/admin/billing`;

     return { subject, html, text };
   }

   export function paymentFailedEmail(invoiceUrl?: string): EmailTemplate {
     const subject = 'Payment failed for your Speak for Me subscription';
     const html = `
       <h1>We couldn't process your payment</h1>
       <p>We tried to charge your payment method for your Speak for Me subscription, but the payment was declined.</p>
       <p>Please update your payment method to avoid any interruption to your service.</p>
       <p><a href="${baseUrl}/admin/billing" style="background-color: #4F46E5; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">Update Payment Method</a></p>
       ${invoiceUrl ? `<p>You can also <a href="${invoiceUrl}">view your invoice</a> directly.</p>` : ''}
       <p>We'll automatically retry the payment in a few days. If you need help, just reply to this email.</p>
     `;
     const text = `Payment failed\n\nWe couldn't process your payment for Speak for Me.\n\nUpdate your payment method: ${baseUrl}/admin/billing`;

     return { subject, html, text };
   }

   export function subscriptionResumedEmail(): EmailTemplate {
     const subject = 'Your Speak for Me subscription is now active';
     const html = `
       <h1>Welcome back!</h1>
       <p>Your Speak for Me subscription is now active. You have full access to all features again.</p>
       <p><a href="${baseUrl}/dashboard" style="background-color: #4F46E5; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; display: inline-block;">Go to Dashboard</a></p>
       <p>Thank you for being a Speak for Me customer!</p>
     `;
     const text = `Welcome back!\n\nYour Speak for Me subscription is now active.\n\nGo to your dashboard: ${baseUrl}/dashboard`;

     return { subject, html, text };
   }
   ```
  </action>
  <verify>
    - `npm run build --workspace=web-portal` succeeds
    - Grep for 'resend.emails.send' in resend.ts
    - Grep for 'trialEndingEmail' in templates.ts
    - Grep for 'paymentFailedEmail' in templates.ts
  </verify>
  <done>
    - Resend email client wrapper with error handling
    - Email templates for: trial ending, subscription paused, payment failed, subscription resumed
    - All templates include CTA buttons linking to billing page
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate email sending into Stripe webhook handlers</name>
  <files>apps/web-portal/app/api/stripe/webhook/route.ts</files>
  <action>
Update webhook handlers to send emails on billing events:

1. Add imports at top of webhook route:
   ```typescript
   import { sendEmail } from '@/lib/email/resend';
   import {
     trialEndingEmail,
     subscriptionPausedEmail,
     paymentFailedEmail,
     subscriptionResumedEmail,
   } from '@/lib/email/templates';
   ```

2. Update the `customer.subscription.trial_will_end` handler (replace the console.log stub):
   ```typescript
   case 'customer.subscription.trial_will_end': {
     const subscription = event.data.object as Stripe.Subscription;
     const customerId = subscription.customer as string;

     // Get organization to find billing email
     const org = await db.query.organizations.findFirst({
       where: eq(organizations.stripeCustomerId, customerId),
     });

     if (org?.billingEmail) {
       const daysRemaining = subscription.trial_end
         ? Math.ceil((subscription.trial_end * 1000 - Date.now()) / (1000 * 60 * 60 * 24))
         : 3;
       const template = trialEndingEmail(daysRemaining);
       await sendEmail({
         to: org.billingEmail,
         subject: template.subject,
         html: template.html,
         text: template.text,
       });
       console.log(`Trial ending email sent to ${org.billingEmail}`);
     }
     break;
   }
   ```

3. Update the `customer.subscription.paused` handler to send email:
   ```typescript
   case 'customer.subscription.paused': {
     const subscription = event.data.object as Stripe.Subscription;
     const customerId = subscription.customer as string;

     const org = await db.query.organizations.findFirst({
       where: eq(organizations.stripeCustomerId, customerId),
     });

     await db
       .update(organizations)
       .set({
         subscriptionStatus: 'paused',
         updatedAt: new Date(),
       })
       .where(eq(organizations.stripeCustomerId, customerId));

     if (org?.billingEmail) {
       const template = subscriptionPausedEmail();
       await sendEmail({
         to: org.billingEmail,
         subject: template.subject,
         html: template.html,
         text: template.text,
       });
       console.log(`Subscription paused email sent to ${org.billingEmail}`);
     }
     break;
   }
   ```

4. Update the `customer.subscription.resumed` handler to send email:
   ```typescript
   case 'customer.subscription.resumed': {
     const subscription = event.data.object as Stripe.Subscription;
     const customerId = subscription.customer as string;

     const org = await db.query.organizations.findFirst({
       where: eq(organizations.stripeCustomerId, customerId),
     });

     await db
       .update(organizations)
       .set({
         subscriptionStatus: 'active',
         updatedAt: new Date(),
       })
       .where(eq(organizations.stripeCustomerId, customerId));

     if (org?.billingEmail) {
       const template = subscriptionResumedEmail();
       await sendEmail({
         to: org.billingEmail,
         subject: template.subject,
         html: template.html,
         text: template.text,
       });
       console.log(`Subscription resumed email sent to ${org.billingEmail}`);
     }
     break;
   }
   ```

5. Update the `invoice.payment_failed` handler to send email:
   ```typescript
   case 'invoice.payment_failed': {
     const invoice = event.data.object as Stripe.Invoice;
     const customerId = invoice.customer as string;

     const org = await db.query.organizations.findFirst({
       where: eq(organizations.stripeCustomerId, customerId),
     });

     if (org?.billingEmail) {
       const template = paymentFailedEmail(invoice.hosted_invoice_url || undefined);
       await sendEmail({
         to: org.billingEmail,
         subject: template.subject,
         html: template.html,
         text: template.text,
       });
       console.log(`Payment failed email sent to ${org.billingEmail}`);
     }
     break;
   }
   ```

6. Add RESEND_API_KEY and EMAIL_FROM to .env.example if it exists
  </action>
  <verify>
    - `npm run build --workspace=web-portal` succeeds
    - Grep webhook/route.ts for 'sendEmail' shows multiple uses
    - Grep webhook/route.ts for 'trialEndingEmail' shows import and use
    - Grep webhook/route.ts for 'paymentFailedEmail' shows import and use
  </verify>
  <done>
    - trial_will_end handler sends email with days remaining
    - subscription.paused handler sends paused notification email
    - subscription.resumed handler sends welcome back email
    - invoice.payment_failed handler sends payment failed email with invoice link
    - All handlers query organization for billing email
  </done>
</task>

</tasks>

<verification>
1. Build completes without errors
2. Webhook handler imports email utilities
3. Each billing event handler includes email sending
4. Email templates include CTAs to billing page
</verification>

<success_criteria>
- Resend client configured with API key
- Email templates for 4 billing events (trial ending, paused, payment failed, resumed)
- Webhook handlers send appropriate emails on each event
- Emails include actionable CTAs to billing/dashboard pages
</success_criteria>

<output>
After completion, create `.planning/phases/07-monetization-pricing/07-07-SUMMARY.md`
</output>
