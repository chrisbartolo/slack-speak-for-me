---
phase: 07-monetization-pricing
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web-portal/app/api/stripe/checkout/route.ts
  - apps/web-portal/lib/stripe.ts
  - packages/database/src/schema.ts
autonomous: true
user_setup:
  - service: stripe
    why: "Configure trial period and products"
    env_vars:
      - name: STRIPE_PRICE_ID_STARTER
        source: "Stripe Dashboard -> Products -> Starter plan -> Price ID"
      - name: STRIPE_PRICE_ID_PRO
        source: "Stripe Dashboard -> Products -> Pro plan -> Price ID"
      - name: TRIAL_DAYS
        source: "Environment variable, default 14"
    dashboard_config:
      - task: "Create Starter and Pro products with per-seat recurring prices"
        location: "Stripe Dashboard -> Products"

must_haves:
  truths:
    - "Users can start 14-day free trial without payment method"
    - "Trial uses payment_method_collection: 'if_required'"
    - "Missing payment pauses subscription instead of canceling"
    - "Organization trialEndsAt field tracks trial expiration"
  artifacts:
    - path: "apps/web-portal/app/api/stripe/checkout/route.ts"
      provides: "Checkout session with trial support"
      contains: "trial_period_days"
    - path: "apps/web-portal/lib/stripe.ts"
      provides: "createTrialCheckout helper"
      exports: ["createTrialCheckout"]
    - path: "packages/database/src/schema.ts"
      provides: "trialEndsAt column on organizations"
      contains: "trialEndsAt"
  key_links:
    - from: "apps/web-portal/app/api/stripe/checkout/route.ts"
      to: "lib/stripe.ts"
      via: "createTrialCheckout function"
      pattern: "createTrialCheckout"
    - from: "Stripe Checkout"
      to: "trial_settings.end_behavior"
      via: "missing_payment_method: 'pause'"
      pattern: "missing_payment_method.*pause"
---

<objective>
Extend Stripe checkout to support free trials without payment upfront.

Purpose: Users should start 14-day trial without entering credit card, reducing signup friction.
Output: Modified checkout route with trial support, trialEndsAt tracking in database.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-monetization-pricing/07-RESEARCH.md

@apps/web-portal/app/api/stripe/checkout/route.ts
@apps/web-portal/lib/stripe.ts
@packages/database/src/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add trialEndsAt column to organizations schema</name>
  <files>packages/database/src/schema.ts</files>
  <action>
Add trial tracking field to organizations table:

1. Add new column to organizations table:
   ```typescript
   trialEndsAt: timestamp('trial_ends_at'), // When free trial expires
   ```

2. Add it after seatCount field, before billingEmail

3. Run database push after: `npm run db:push --workspace=@slack-speak-for-me/database`

Note: This column tracks when the trial ends, allowing the app to show trial status and countdown in UI.
  </action>
  <verify>
    - `npm run db:push --workspace=@slack-speak-for-me/database` succeeds
    - Grep schema.ts for 'trial_ends_at' shows column definition
  </verify>
  <done>
    - trialEndsAt column exists on organizations table
    - Database schema pushed successfully
  </done>
</task>

<task type="auto">
  <name>Task 2: Create trial checkout helper and update checkout route</name>
  <files>
    apps/web-portal/lib/stripe.ts
    apps/web-portal/app/api/stripe/checkout/route.ts
  </files>
  <action>
Add trial-enabled checkout functionality:

1. Update `apps/web-portal/lib/stripe.ts`:
   - Add createTrialCheckout function:
     ```typescript
     export async function createTrialCheckout(options: {
       customerId: string;
       priceId: string;
       quantity: number;
       organizationId: string;
       planId: string;
       successUrl: string;
       cancelUrl: string;
     }): Promise<Stripe.Checkout.Session> {
       const trialDays = parseInt(process.env.TRIAL_DAYS || '14');

       return getStripe().checkout.sessions.create({
         customer: options.customerId,
         mode: 'subscription',
         success_url: options.successUrl,
         cancel_url: options.cancelUrl,
         line_items: [{ price: options.priceId, quantity: options.quantity }],
         subscription_data: {
           trial_period_days: trialDays,
           trial_settings: {
             end_behavior: { missing_payment_method: 'pause' }
           },
           metadata: { organizationId: options.organizationId, planId: options.planId }
         },
         payment_method_collection: 'if_required',
         metadata: { organizationId: options.organizationId, planId: options.planId }
       });
     }
     ```

2. Update `apps/web-portal/app/api/stripe/checkout/route.ts`:
   - Import createTrialCheckout from lib/stripe
   - Accept body parameters: { planId: 'starter' | 'pro', startTrial?: boolean }
   - Get priceId from env: STRIPE_PRICE_ID_STARTER or STRIPE_PRICE_ID_PRO based on planId
   - If startTrial is true or no existing subscription, use createTrialCheckout
   - Otherwise use existing immediate checkout (for upgrades)
   - Update success_url to include trial_started=true query param when trial

3. Add TRIAL_DAYS to .env.example if it exists (default: 14)
  </action>
  <verify>
    - `npm run build --workspace=web-portal` succeeds
    - Grep checkout/route.ts for 'trial_period_days' shows trial configuration
    - Grep lib/stripe.ts for 'payment_method_collection.*if_required' shows trial mode
  </verify>
  <done>
    - createTrialCheckout function creates trial session without payment
    - Checkout route supports planId parameter for plan selection
    - Missing payment pauses subscription (not cancels)
  </done>
</task>

</tasks>

<verification>
1. Database push succeeds with new column
2. Build completes without errors
3. Checkout route accepts planId and startTrial parameters
4. Trial checkout uses payment_method_collection: 'if_required'
</verification>

<success_criteria>
- Organizations table has trialEndsAt column
- Checkout creates 14-day trial without requiring payment
- trial_settings.end_behavior.missing_payment_method = 'pause'
- Supports both Starter and Pro plan price IDs
</success_criteria>

<output>
After completion, create `.planning/phases/07-monetization-pricing/07-03-SUMMARY.md`
</output>
